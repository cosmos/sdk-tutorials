(window.webpackJsonp=window.webpackJsonp||[]).push([[149],{766:function(t,e,o){"use strict";o.r(e);var a=o(1),c=Object(a.a)({},(function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[o("h1",{attrs:{id:"simulate-a-migration-in-docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#simulate-a-migration-in-docker"}},[t._v("#")]),t._v(" Simulate a Migration in Docker")]),t._v(" "),o("HighlightBox",{attrs:{type:"prerequisite"}},[o("p",[t._v("Make sure you have all you need before proceeding:")]),t._v(" "),o("ul",[o("li",[t._v("You understand the concepts of "),o("RouterLink",{attrs:{to:"/academy/2-cosmos-concepts/16-migrations.html"}},[t._v("migrations")]),t._v(", "),o("RouterLink",{attrs:{to:"/tutorials/9-path-to-prod/"}},[t._v("production")]),t._v(", and "),o("RouterLink",{attrs:{to:"/tutorials/9-path-to-prod/7-migration.html"}},[t._v("migrations in production")]),t._v(".")],1),t._v(" "),o("li",[t._v("Docker is installed and you "),o("RouterLink",{attrs:{to:"/tutorials/5-docker-intro/"}},[t._v("understand it")]),t._v(".")],1),t._v(" "),o("li",[t._v("You have the checkers blockchain codebase up to the migrations. If not, follow the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/4-migration-leaderboard.html"}},[t._v("previous steps")]),t._v(" or check out the "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/tree/leaderboard-migration",target:"_blank",rel:"noopener noreferrer"}},[t._v("relevant version"),o("OutboundLink")],1),t._v(".")],1)])]),t._v(" "),o("HighlightBox",{attrs:{type:"learning"}},[o("p",[t._v("In this section, you will:")]),t._v(" "),o("ul",[o("li",[t._v("Prepare Docker elements.")]),t._v(" "),o("li",[t._v("Deal with data migrations.")]),t._v(" "),o("li",[t._v("Upgrade your blockchain in production with Cosmovisor.")]),t._v(" "),o("li",[t._v("Compose everything in one orchestrated ensemble.")]),t._v(" "),o("li",[t._v("Test it.")])])]),t._v(" "),o("p",[t._v("In previous sections, you have:")]),t._v(" "),o("ul",[o("li",[t._v("Simulated a production setup with the help of Docker Compose.")]),t._v(" "),o("li",[t._v("Learned how to implement an in-place migration.")])]),t._v(" "),o("p",[t._v("This section is about:")]),t._v(" "),o("ul",[o("li",[t._v("Running an in-place migration...")]),t._v(" "),o("li",[t._v("...in a simulated production setup...")]),t._v(" "),o("li",[t._v("...with the help of Docker Compose.")])]),t._v(" "),o("p",[t._v("You will reuse the nodes, validators, and sentries created for Alice, Bob, and Carol in a "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/1-run-prod-docker.html"}},[t._v("previous section")]),t._v(".")],1),t._v(" "),o("h2",{attrs:{id:"what-to-expect"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#what-to-expect"}},[t._v("#")]),t._v(" What to expect")]),t._v(" "),o("p",[t._v("In this section, you will accomplish the following steps:")]),t._v(" "),o("ol",[o("li",[t._v("Build the checkers v2 software.")]),t._v(" "),o("li",[t._v("Build the checkers v1.1 software.")]),t._v(" "),o("li",[t._v("Build the checkers v1 software.")]),t._v(" "),o("li",[t._v("Build Cosmovisor and set it up for two consecutive known upgrades on all nodes.")]),t._v(" "),o("li",[t._v("Launch everything.")]),t._v(" "),o("li",[t._v("Create the first upgrade governance proposal, "),o("code",[t._v("v1tov1_1")]),t._v(".")]),t._v(" "),o("li",[t._v("Have the first proposal pass.")]),t._v(" "),o("li",[t._v("Repeat with the second upgrade governance proposal, "),o("code",[t._v("v1_1tov2")]),t._v(".")]),t._v(" "),o("li",[t._v("Observe the first migration take place.")]),t._v(" "),o("li",[t._v("Have the second proposal pass.")]),t._v(" "),o("li",[t._v("Observe the second migration take place.")]),t._v(" "),o("li",[t._v("Stop everything and start it again safely in v2.")])]),t._v(" "),o("p",[t._v("In a real production situation, node operators would wait for a named upgrade governance proposal to be on the ballot (if not wait for it to be approved) before they went to the trouble of setting up Cosmovisor; therefore point 6 would happen some time before points 2 and 4. However, because we know that the proposal will go through, we will use the above order in the interest of time.")]),t._v(" "),o("p",[t._v("Also, both proposals will be created before the first upgrade, and the second proposal with be "),o("em",[t._v("passed")]),t._v(" after the first upgrade. That is in the interest of the exercise, so as to see the second proposal cross the first upgrade in its pending state.")]),t._v(" "),o("h2",{attrs:{id:"prepare-checkers-executables"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#prepare-checkers-executables"}},[t._v("#")]),t._v(" Prepare checkers executables")]),t._v(" "),o("p",[t._v("At this stage, your checkers code already has the migration elements. It is therefore in its v2 configuration. Create the corresponding Docker image:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgYnVpbGQgLiBcCiAgICAtZiBwcm9kLXNpbS9Eb2NrZXJmaWxlLWNoZWNrZXJzZC1hbHBpbmUgXAogICAgLXQgY2hlY2tlcnNkX2k6djItYWxwaW5lCg=="}}),t._v(" "),o("p",[t._v("To build v1 and v1.1, you first need to check out the code before the migration code steps were added. Depending on your branch names, this would be:")]),t._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Build v1.1"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnaXQgY2hlY2tvdXQgcGxheWVyLWluZm8tbWlncmF0aW9uCiQgZG9ja2VyIGJ1aWxkIC4gXAogICAgLWYgcHJvZC1zaW0vRG9ja2VyZmlsZS1jaGVja2Vyc2QtYWxwaW5lIFwKICAgIC10IGNoZWNrZXJzZF9pOnYxLjEtYWxwaW5lCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/tree/player-info-migration"}})],1),t._v(" "),o("CodeGroupItem",{attrs:{title:"Build v1"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnaXQgY2hlY2tvdXQgcnVuLXByb2QKJCBkb2NrZXIgYnVpbGQgLiBcCiAgICAtZiBwcm9kLXNpbS9Eb2NrZXJmaWxlLWNoZWNrZXJzZC1hbHBpbmUgXAogICAgLXQgY2hlY2tlcnNkX2k6djEtYWxwaW5lCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/tree/run-prod"}})],1)],1),t._v(" "),o("p",[t._v("Do not forget to come back to your v2 branch. For instance, with:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnaXQgY2hlY2tvdXQgbGVhZGVyYm9hcmQtbWlncmF0aW9uCg=="}}),t._v(" "),o("h2",{attrs:{id:"blockchain-elements"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#blockchain-elements"}},[t._v("#")]),t._v(" Blockchain elements")]),t._v(" "),o("p",[t._v("Your genesis elements should still be in v1 as they were created in the "),o("code",[t._v("run-prod")]),t._v(" branch. You can confirm this by verifying that there are no player infos and no leaderboards in the "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/run-prod/prod-sim/node-carol/config/genesis.json#L85",target:"_blank",rel:"noopener noreferrer"}},[t._v("checkers genesis store"),o("OutboundLink")],1),t._v(".")]),t._v(" "),o("p",[t._v("As you did in the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/2-migration-info.html"}},[t._v("migration section")]),t._v(", you need to reduce the voting period from 2 days to 10 minutes to make the exercise bearable:")],1),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBqcSAtaiAnLmFwcF9zdGF0ZS5nb3Yudm90aW5nX3BhcmFtcy52b3RpbmdfcGVyaW9kID0gJnF1b3Q7NjAwcyZxdW90OycgcHJvZC1zaW0vZGVzay1hbGljZS9jb25maWcvZ2VuZXNpcy5qc29uICZndDsgcHJvZC1zaW0vZGVzay1hbGljZS9jb25maWcvZ2VuZXNpcy0yLmpzb24gJmFtcDsmYW1wOyBtdiBwcm9kLXNpbS9kZXNrLWFsaWNlL2NvbmZpZy9nZW5lc2lzLTIuanNvbiBwcm9kLXNpbS9kZXNrLWFsaWNlL2NvbmZpZy9nZW5lc2lzLmpzb24KJCBqcSAtaiAnLmFwcF9zdGF0ZS5nb3Yudm90aW5nX3BhcmFtcy52b3RpbmdfcGVyaW9kID0gJnF1b3Q7NjAwcyZxdW90OycgcHJvZC1zaW0vZGVzay1ib2IvY29uZmlnL2dlbmVzaXMuanNvbiAmZ3Q7IHByb2Qtc2ltL2Rlc2stYm9iL2NvbmZpZy9nZW5lc2lzLTIuanNvbiAmYW1wOyZhbXA7IG12IHByb2Qtc2ltL2Rlc2stYm9iL2NvbmZpZy9nZW5lc2lzLTIuanNvbiBwcm9kLXNpbS9kZXNrLWJvYi9jb25maWcvZ2VuZXNpcy5qc29uCiQganEgLWogJy5hcHBfc3RhdGUuZ292LnZvdGluZ19wYXJhbXMudm90aW5nX3BlcmlvZCA9ICZxdW90OzYwMHMmcXVvdDsnIHByb2Qtc2ltL3NlbnRyeS1hbGljZS9jb25maWcvZ2VuZXNpcy5qc29uICZndDsgcHJvZC1zaW0vc2VudHJ5LWFsaWNlL2NvbmZpZy9nZW5lc2lzLTIuanNvbiAmYW1wOyZhbXA7IG12IHByb2Qtc2ltL3NlbnRyeS1hbGljZS9jb25maWcvZ2VuZXNpcy0yLmpzb24gcHJvZC1zaW0vc2VudHJ5LWFsaWNlL2NvbmZpZy9nZW5lc2lzLmpzb24KJCBqcSAtaiAnLmFwcF9zdGF0ZS5nb3Yudm90aW5nX3BhcmFtcy52b3RpbmdfcGVyaW9kID0gJnF1b3Q7NjAwcyZxdW90OycgcHJvZC1zaW0vc2VudHJ5LWJvYi9jb25maWcvZ2VuZXNpcy5qc29uICZndDsgcHJvZC1zaW0vc2VudHJ5LWJvYi9jb25maWcvZ2VuZXNpcy0yLmpzb24gJmFtcDsmYW1wOyBtdiBwcm9kLXNpbS9zZW50cnktYm9iL2NvbmZpZy9nZW5lc2lzLTIuanNvbiBwcm9kLXNpbS9zZW50cnktYm9iL2NvbmZpZy9nZW5lc2lzLmpzb24KJCBqcSAtaiAnLmFwcF9zdGF0ZS5nb3Yudm90aW5nX3BhcmFtcy52b3RpbmdfcGVyaW9kID0gJnF1b3Q7NjAwcyZxdW90OycgcHJvZC1zaW0vdmFsLWFsaWNlL2NvbmZpZy9nZW5lc2lzLmpzb24gJmd0OyBwcm9kLXNpbS92YWwtYWxpY2UvY29uZmlnL2dlbmVzaXMtMi5qc29uICZhbXA7JmFtcDsgbXYgcHJvZC1zaW0vdmFsLWFsaWNlL2NvbmZpZy9nZW5lc2lzLTIuanNvbiBwcm9kLXNpbS92YWwtYWxpY2UvY29uZmlnL2dlbmVzaXMuanNvbgokIGpxIC1qICcuYXBwX3N0YXRlLmdvdi52b3RpbmdfcGFyYW1zLnZvdGluZ19wZXJpb2QgPSAmcXVvdDs2MDBzJnF1b3Q7JyBwcm9kLXNpbS92YWwtYm9iL2NvbmZpZy9nZW5lc2lzLmpzb24gJmd0OyBwcm9kLXNpbS92YWwtYm9iL2NvbmZpZy9nZW5lc2lzLTIuanNvbiAmYW1wOyZhbXA7IG12IHByb2Qtc2ltL3ZhbC1ib2IvY29uZmlnL2dlbmVzaXMtMi5qc29uIHByb2Qtc2ltL3ZhbC1ib2IvY29uZmlnL2dlbmVzaXMuanNvbgokIGpxIC1qICcuYXBwX3N0YXRlLmdvdi52b3RpbmdfcGFyYW1zLnZvdGluZ19wZXJpb2QgPSAmcXVvdDs2MDBzJnF1b3Q7JyBwcm9kLXNpbS9ub2RlLWNhcm9sL2NvbmZpZy9nZW5lc2lzLmpzb24gJmd0OyBwcm9kLXNpbS9ub2RlLWNhcm9sL2NvbmZpZy9nZW5lc2lzLTIuanNvbiAmYW1wOyZhbXA7IG12IHByb2Qtc2ltL25vZGUtY2Fyb2wvY29uZmlnL2dlbmVzaXMtMi5qc29uIHByb2Qtc2ltL25vZGUtY2Fyb2wvY29uZmlnL2dlbmVzaXMuanNvbgo="}}),t._v(" "),o("p",[t._v("The names of the upgrade proposals will be "),o("code",[t._v("v1tov2_1")]),t._v(" and "),o("code",[t._v("v1_1tov2")]),t._v(". The names are important, as they are defined in the code, and Cosmovisor uses them to determine which executable to run.")]),t._v(" "),o("h2",{attrs:{id:"prepare-the-cosmovisor-executable"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-cosmovisor-executable"}},[t._v("#")]),t._v(" Prepare the Cosmovisor executable")]),t._v(" "),o("p",[t._v("Because the project in its current state uses Cosmos SDK v0.45.4, to avoid any surprise you will prepare Cosmovisor at the "),o("a",{attrs:{href:"https://docs.cosmos.network/v0.45/run-node/cosmovisor.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("v0.45.4"),o("OutboundLink")],1),t._v(" version too.")]),t._v(" "),o("p",[t._v("You can describe the steps in a new Dockerfile "),o("code",[t._v("prod-sim/Dockerfile-cosmovisor-alpine")]),t._v(", described here logically (before a recap lower down):")]),t._v(" "),o("ol",[o("li",[o("p",[t._v("You need to build Cosmovisor from its code:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"ockerfile",base64:"RlJPTSAtLXBsYXRmb3JtPWxpbnV4IGdvbGFuZzoxLjE4LjctYWxwaW5lIEFTIGJ1aWxkZXIKCkVOViBDT1NNT1NfVkVSU0lPTj12MC40NS40CgpSVU4gYXBrIHVwZGF0ZQpSVU4gYXBrIGFkZCBtYWtlIGdpdAoKV09SS0RJUiAvcm9vdApSVU4gZ2l0IGNsb25lIC0tZGVwdGggMSAtLWJyYW5jaCAke0NPU01PU19WRVJTSU9OfSBodHRwczovL2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsuZ2l0CgpXT1JLRElSIC9yb290L2Nvc21vcy1zZGsvY29zbW92aXNvcgoKUlVOIG1ha2UgY29zbW92aXNvcgoKRlJPTSAtLXBsYXRmb3JtPWxpbnV4IGFscGluZQoKRU5WIExPQ0FMPS91c3IvbG9jYWwKCkNPUFkgLS1mcm9tPWJ1aWxkZXIgL3Jvb3QvY29zbW9zLXNkay9jb3Ntb3Zpc29yL2Nvc21vdmlzb3IgJHtMT0NBTH0vYmluL2Nvc21vdmlzb3IK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/Dockerfile-cosmovisor-alpine#L1-L26"}})],1),t._v(" "),o("li",[o("p",[t._v("Cosmovisor is instructed via "),o("a",{attrs:{href:"https://docs.cosmos.network/v0.45/run-node/cosmovisor.html#command-line-arguments-and-environment-variables",target:"_blank",rel:"noopener noreferrer"}},[t._v("environment variables"),o("OutboundLink")],1),t._v(". In the eventual containers, the "),o("code",[t._v("/root/.checkers")]),t._v(" folder comes from a volume mount, so to avoid any conflict it is better not to put the "),o("code",[t._v("cosmovisor")]),t._v(" folder directly inside it. Instead pick "),o("code",[t._v("/root/.checkers-upgrade")]),t._v(":")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff",base64:"ICAgIC4uLgogICAgRlJPTSAtLXBsYXRmb3JtPWxpbnV4IGFscGluZQoKICAgIEVOViBMT0NBTD0vdXNyL2xvY2FsCisgIEVOViBEQUVNT05fSE9NRT0vcm9vdC8uY2hlY2tlcnMtdXBncmFkZQorICBFTlYgREFFTU9OX05BTUU9Y2hlY2tlcnNkCisgIEVOViBEQUVNT05fQUxMT1dfRE9XTkxPQURfQklOQVJJRVM9ZmFsc2UKKyAgRU5WIERBRU1PTl9SRVNUQVJUX0FGVEVSX1VQR1JBREU9dHJ1ZQogICAgLi4uCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/Dockerfile-cosmovisor-alpine#L21-L24"}})],1),t._v(" "),o("li",[o("p",[t._v("With the folder decided, you can introduce all three checkers executables. They can be conveniently taken from their respective Docker images:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff",base64:"KyAgRlJPTSAtLXBsYXRmb3JtPWxpbnV4IGNoZWNrZXJzZF9pOnYxLWFscGluZSBBUyB2MQorICBGUk9NIC0tcGxhdGZvcm09bGludXggY2hlY2tlcnNkX2k6djEuMS1hbHBpbmUgQVMgdjEuMQorICBGUk9NIC0tcGxhdGZvcm09bGludXggY2hlY2tlcnNkX2k6djItYWxwaW5lIEFTIHYyCiAgICBGUk9NIC0tcGxhdGZvcm09bGludXggYWxwaW5lCiAgICAuLi4KICAgIENPUFkgLS1mcm9tPWJ1aWxkZXIgL3Jvb3QvY29zbW9zLXNkay9jb3Ntb3Zpc29yL2Nvc21vdmlzb3IgJHtMT0NBTH0vYmluL2Nvc21vdmlzb3IKKyAgQ09QWSAtLWZyb209djEgL3Vzci9sb2NhbC9iaW4vY2hlY2tlcnNkICREQUVNT05fSE9NRS9jb3Ntb3Zpc29yL2dlbmVzaXMvYmluL2NoZWNrZXJzZAorICBDT1BZIC0tZnJvbT12MS4xIC91c3IvbG9jYWwvYmluL2NoZWNrZXJzZCAkREFFTU9OX0hPTUUvY29zbW92aXNvci91cGdyYWRlcy92MXRvdjFfMS9iaW4vY2hlY2tlcnNkCisgIENPUFkgLS1mcm9tPXYyIC91c3IvbG9jYWwvYmluL2NoZWNrZXJzZCAkREFFTU9OX0hPTUUvY29zbW92aXNvci91cGdyYWRlcy92MXRvdjIvYmluL2NoZWNrZXJzZAogICAgLi4uCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/Dockerfile-cosmovisor-alpine#L15-L29"}}),t._v(" "),o("p",[t._v("Checkers starts at v1, therefore the v1 executable goes into "),o("code",[t._v(".../genesis")]),t._v(". We know that:")]),t._v(" "),o("ul",[o("li",[t._v("The executable of the eventual upgrade named "),o("code",[t._v("v1tov1_1")]),t._v(" is the v1.1 one.")]),t._v(" "),o("li",[t._v("The executable of the eventual upgrade named "),o("code",[t._v("v1_1tov2")]),t._v(" is the v2 one.")])]),t._v(" "),o("p",[t._v("Note also the decision to use "),o("code",[t._v("/usr/local")]),t._v(" explicitly, as this is knowledge that is kept in a separate Docker image.")])],1),t._v(" "),o("li",[o("p",[t._v("Now make Cosmovisor start by default:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff",base64:"ICAgIENPUFkgLS1mcm9tPXYyIC91c3IvbG9jYWwvYmluL2NoZWNrZXJzZCAkREFFTU9OX0hPTUUvY29zbW92aXNvci91cGdyYWRlcy92MXRvdjIvYmluL2NoZWNrZXJzZAoKKyAgRU5UUllQT0lOVCBbICZxdW90O2Nvc21vdmlzb3ImcXVvdDsgXQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/Dockerfile-cosmovisor-alpine#L31"}})],1)]),t._v(" "),o("p",[t._v("When you put all this together, you get:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"ockerfile",base64:"RlJPTSAtLXBsYXRmb3JtPWxpbnV4IGdvbGFuZzoxLjE4LjctYWxwaW5lIEFTIGJ1aWxkZXIKCkVOViBDT1NNT1NfVkVSU0lPTj12MC40NS40CgpSVU4gYXBrIHVwZGF0ZQpSVU4gYXBrIGFkZCBtYWtlIGdpdAoKV09SS0RJUiAvcm9vdApSVU4gZ2l0IGNsb25lIC0tZGVwdGggMSAtLWJyYW5jaCAke0NPU01PU19WRVJTSU9OfSBodHRwczovL2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsuZ2l0CgpXT1JLRElSIC9yb290L2Nvc21vcy1zZGsvY29zbW92aXNvcgoKUlVOIG1ha2UgY29zbW92aXNvcgoKRlJPTSAtLXBsYXRmb3JtPWxpbnV4IGNoZWNrZXJzZF9pOnYxLWFscGluZSBBUyB2MQpGUk9NIC0tcGxhdGZvcm09bGludXggY2hlY2tlcnNkX2k6djEuMS1hbHBpbmUgQVMgdjEuMQpGUk9NIC0tcGxhdGZvcm09bGludXggY2hlY2tlcnNkX2k6djItYWxwaW5lIEFTIHYyCkZST00gLS1wbGF0Zm9ybT1saW51eCBhbHBpbmUKCkVOViBMT0NBTD0vdXNyL2xvY2FsCkVOViBEQUVNT05fSE9NRT0vcm9vdC8uY2hlY2tlcnMtdXBncmFkZQpFTlYgREFFTU9OX05BTUU9Y2hlY2tlcnNkCkVOViBEQUVNT05fQUxMT1dfRE9XTkxPQURfQklOQVJJRVM9ZmFsc2UKRU5WIERBRU1PTl9SRVNUQVJUX0FGVEVSX1VQR1JBREU9dHJ1ZQoKQ09QWSAtLWZyb209YnVpbGRlciAvcm9vdC9jb3Ntb3Mtc2RrL2Nvc21vdmlzb3IvY29zbW92aXNvciAke0xPQ0FMfS9iaW4vY29zbW92aXNvcgpDT1BZIC0tZnJvbT12MSAvdXNyL2xvY2FsL2Jpbi9jaGVja2Vyc2QgJERBRU1PTl9IT01FL2Nvc21vdmlzb3IvZ2VuZXNpcy9iaW4vY2hlY2tlcnNkCkNPUFkgLS1mcm9tPXYxLjEgL3Vzci9sb2NhbC9iaW4vY2hlY2tlcnNkICREQUVNT05fSE9NRS9jb3Ntb3Zpc29yL3VwZ3JhZGVzL3YxdG92MV8xL2Jpbi9jaGVja2Vyc2QKQ09QWSAtLWZyb209djIgL3Vzci9sb2NhbC9iaW4vY2hlY2tlcnNkICREQUVNT05fSE9NRS9jb3Ntb3Zpc29yL3VwZ3JhZGVzL3YxXzF0b3YyL2Jpbi9jaGVja2Vyc2QKCkVOVFJZUE9JTlQgWyAmcXVvdDtjb3Ntb3Zpc29yJnF1b3Q7IF0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/Dockerfile-cosmovisor-alpine"}}),t._v(" "),o("p",[t._v("Now you can create the Cosmovisor Docker image with a meaningful tag:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgYnVpbGQgLiBcCiAgICAtZiBwcm9kLXNpbS9Eb2NrZXJmaWxlLWNvc21vdmlzb3ItYWxwaW5lIFwKICAgIC10IGNvc21vdmlzb3JfaTp2MXRvdjItYWxwaW5lCg=="}}),t._v(" "),o("h2",{attrs:{id:"docker-compose-elements"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-elements"}},[t._v("#")]),t._v(" Docker Compose elements")]),t._v(" "),o("p",[t._v("With the executables and the blockchain elements ready, you can now define the "),o("em",[t._v("production setup")]),t._v(". You already defined one in the previous "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/1-run-prod-docker.html"}},[t._v("run checkers in prod section")]),t._v(". In this new setup, the only things that change are the Docker images you call: "),o("code",[t._v("cosmovisor_i")]),t._v(" instead of "),o("code",[t._v("checkersd_i")]),t._v(". Even the "),o("code",[t._v("start")]),t._v(" command does not need to change.")],1),t._v(" "),o("p",[t._v("To avoid rewriting everything, you can declare a Docker Compose "),o("a",{attrs:{href:"https://docs.docker.com/compose/extends/",target:"_blank",rel:"noopener noreferrer"}},[t._v("extension"),o("OutboundLink")],1),t._v(" in a new file "),o("code",[t._v("prod-sim/docker-compose-cosmovisor.yml")]),t._v(". Each "),o("code",[t._v("checkersd")]),t._v(" type of service is extended, and in the end is replaced, with a new "),o("code",[t._v("image")]),t._v(":")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"yaml",base64:"dmVyc2lvbjogJnF1b3Q7My43JnF1b3Q7CgpzZXJ2aWNlczoKCiAgdmFsLWFsaWNlOgogICAgZXh0ZW5kczoKICAgICAgZmlsZTogZG9ja2VyLWNvbXBvc2UueW1sCiAgICAgIHNlcnZpY2U6IHZhbC1hbGljZQogICAgaW1hZ2U6IGNvc21vdmlzb3JfaTp2MXRvdjItYWxwaW5lCgogIHNlbnRyeS1hbGljZToKICAgIGV4dGVuZHM6CiAgICAgIGZpbGU6IGRvY2tlci1jb21wb3NlLnltbAogICAgICBzZXJ2aWNlOiBzZW50cnktYWxpY2UKICAgIGltYWdlOiBjb3Ntb3Zpc29yX2k6djF0b3YyLWFscGluZQoKICB2YWwtYm9iOgogICAgZXh0ZW5kczoKICAgICAgZmlsZTogZG9ja2VyLWNvbXBvc2UueW1sCiAgICAgIHNlcnZpY2U6IHZhbC1ib2IKICAgIGltYWdlOiBjb3Ntb3Zpc29yX2k6djF0b3YyLWFscGluZQoKICBzZW50cnktYm9iOgogICAgZXh0ZW5kczoKICAgICAgZmlsZTogZG9ja2VyLWNvbXBvc2UueW1sCiAgICAgIHNlcnZpY2U6IHNlbnRyeS1ib2IKICAgIGltYWdlOiBjb3Ntb3Zpc29yX2k6djF0b3YyLWFscGluZQoKICBub2RlLWNhcm9sOgogICAgZXh0ZW5kczoKICAgICAgZmlsZTogZG9ja2VyLWNvbXBvc2UueW1sCiAgICAgIHNlcnZpY2U6IG5vZGUtY2Fyb2wKICAgIGltYWdlOiBjb3Ntb3Zpc29yX2k6djF0b3YyLWFscGluZQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/docker-compose-cosmovisor.yml"}}),t._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[o("code",[t._v("docker-compose-cosmovisor.yml")]),t._v("'s "),o("code",[t._v("val-alice")]),t._v(" extends "),o("code",[t._v("docker-compose.yml")]),t._v("'s "),o("code",[t._v("val-alice")]),t._v(", while keeping the same name. In effect this overwrites "),o("code",[t._v("val-alice")]),t._v(", instead of starting another validator working on the same shared "),o("code",[t._v("prod-sim/val-alice")]),t._v(" folder.")])]),t._v(" "),o("h2",{attrs:{id:"run-all-the-elements"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#run-all-the-elements"}},[t._v("#")]),t._v(" Run all the elements")]),t._v(" "),o("p",[t._v("Now you can run everything and confirm that all services start:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgY29tcG9zZSBcCiAgICAtLWZpbGUgcHJvZC1zaW0vZG9ja2VyLWNvbXBvc2UueW1sIFwKICAgIC0tZmlsZSBwcm9kLXNpbS9kb2NrZXItY29tcG9zZS1jb3Ntb3Zpc29yLnltbCBcCiAgICAtLXByb2plY3QtbmFtZSBjaGVja2Vycy1wcm9kIHVwIFwKICAgIC0tZGV0YWNoCg=="}}),t._v(" "),o("p",[t._v("In fact, at this stage there is no difference from the previous prod setup, which was what you now call v1. Blocks are being created.")]),t._v(" "),o("p",[t._v("Confirm you are on v1:")]),t._v(" "),o("ul",[o("li",[o("p",[t._v("One way to confirm is to use checkers v1.1 to query Carol's node for the player infos:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEuMS1hbHBpbmUgXAogICAgcXVlcnkgY2hlY2tlcnMgbGlzdC1wbGF5ZXItaW5mbyBcCiAgICAtLW5vZGUgJnF1b3Q7dGNwOi8vbm9kZS1jYXJvbDoyNjY1NyZxdW90Owo="}}),t._v(" "),o("p",[t._v("It returns:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"RXJyb3I6IHJwYyBlcnJvcjogY29kZSA9IFVua25vd24gZGVzYyA9IHVua25vd24gcXVlcnkgcGF0aDogdW5rbm93biByZXF1ZXN0Cg=="}}),t._v(" "),o("p",[t._v("This confirms that the anwering node does not know about such structure.")])],1),t._v(" "),o("li",[o("p",[t._v("Another way to confirm is to see to which folder Cosmovisor's "),o("code",[t._v("current")]),t._v(" folder is symbolically linking:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgbm9kZS1jYXJvbCBcCiAgICBscyAtbCAvcm9vdC8uY2hlY2tlcnMtdXBncmFkZS9jb3Ntb3Zpc29yL2N1cnJlbnQK"}}),t._v(" "),o("p",[t._v("This should return:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Li4uIC9yb290Ly5jaGVja2Vycy11cGdyYWRlL2Nvc21vdmlzb3IvY3VycmVudCAtJmd0OyAvcm9vdC8uY2hlY2tlcnMtdXBncmFkZS9jb3Ntb3Zpc29yL2dlbmVzaXMK"}}),t._v(" "),o("p",[t._v("Again, this confirms that it is running v1, as found in "),o("code",[t._v(".../genesis")]),t._v(".")])],1)]),t._v(" "),o("h2",{attrs:{id:"add-games"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#add-games"}},[t._v("#")]),t._v(" Add games")]),t._v(" "),o("p",[t._v("You will now need Alice and Bob's addresses, so take them from the keyrings found on their respective "),o("em",[t._v("desktops")]),t._v(".")]),t._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Alice"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBhbGljZT0kKGVjaG8gcGFzc3dvcmQgfCBkb2NrZXIgcnVuIC0tcm0gLWkgXAogICAgLXYgJChwd2QpL3Byb2Qtc2ltL2Rlc2stYWxpY2U6L3Jvb3QvLmNoZWNrZXJzIFwKICAgIGNoZWNrZXJzZF9pOnYxLWFscGluZSBcCiAgICBrZXlzIFwKICAgIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICBzaG93IGFsaWNlIC0tYWRkcmVzcykK"}})],1),t._v(" "),o("CodeGroupItem",{attrs:{title:"Bob"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBib2I9JChlY2hvIHBhc3N3b3JkIHwgZG9ja2VyIHJ1biAtLXJtIC1pIFwKICAgIC12ICQocHdkKS9wcm9kLXNpbS9kZXNrLWJvYjovcm9vdC8uY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIFwKICAgIGtleXMgXAogICAgLS1rZXlyaW5nLWJhY2tlbmQgZmlsZSAtLWtleXJpbmctZGlyIC9yb290Ly5jaGVja2Vycy9rZXlzIFwKICAgIHNob3cgYm9iIC0tYWRkcmVzcykK"}})],1)],1),t._v(" "),o("p",[t._v("The CosmJS tests use "),o("code",[t._v("stake")]),t._v(" and "),o("code",[t._v("token")]),t._v(" whereas this production setup uses only "),o("code",[t._v("upawn")]),t._v(". Therefore, do a text search and change all occurrences of "),o("code",[t._v("stake")]),t._v(" and "),o("code",[t._v("token")]),t._v(" to "),o("code",[t._v("upawn")]),t._v(" in "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/main/test/integration/stored-game-action.ts",target:"_blank",rel:"noopener noreferrer"}},[o("code",[t._v("client/test/integration/stored-game-action.ts")]),o("OutboundLink")],1),t._v(". Also remove the "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/main/test/integration/stored-game-action.ts#L56-L60",target:"_blank",rel:"noopener noreferrer"}},[o("code",[t._v("upawn: 1,")]),o("OutboundLink")],1),t._v(" lines that prevent compilation.")]),t._v(" "),o("p",[t._v("Copying what you did in "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/4-migration-leaderboard.html"}},[t._v("leaderboard migration section")]),t._v(", credit the test accounts so that the CosmJS tests do not attempt to call a missing faucet:")],1),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBlY2hvIHBhc3N3b3JkIHwgZG9ja2VyIHJ1biAtLXJtIC1pIFwKICAgIC12ICQocHdkKS9wcm9kLXNpbS9kZXNrLWFsaWNlOi9yb290Ly5jaGVja2VycyBcCiAgICAtLW5ldHdvcmsgY2hlY2tlcnMtcHJvZF9uZXQtcHVibGljIFwKICAgIGNoZWNrZXJzZF9pOnYxLWFscGluZSB0eCBiYW5rIFwKICAgIHNlbmQgJGFsaWNlIGNvc21vczFmeDZxbHh3dGVlcXhneHdzdzgzd2tmNHM5ZmNubndrOHo4NnNxbCAzMDB1cGF3biBcCiAgICAtLWZyb20gJGFsaWNlIFwKICAgIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICAtLWNoYWluLWlkIGNoZWNrZXJzLTEgXAogICAgLS1ub2RlIGh0dHA6Ly9ub2RlLWNhcm9sOjI2NjU3IFwKICAgIC0tYnJvYWRjYXN0LW1vZGUgYmxvY2sgLS15ZXMKJCBlY2hvIHBhc3N3b3JkIHwgZG9ja2VyIHJ1biAtLXJtIC1pIFwKICAgIC12ICQocHdkKS9wcm9kLXNpbS9kZXNrLWJvYjovcm9vdC8uY2hlY2tlcnMgXAogICAgLS1uZXR3b3JrIGNoZWNrZXJzLXByb2RfbmV0LXB1YmxpYyBcCiAgICBjaGVja2Vyc2RfaTp2MS1hbHBpbmUgdHggYmFuayBcCiAgICBzZW5kICRib2IgY29zbW9zMW1xbDlhYXV4MzQ1M3RkZ2hrNnJ6a21rNDNzdHh2bnZoYTRudjIyIDMwMHVwYXduIFwKICAgIC0tZnJvbSAkYm9iIFwKICAgIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICAtLWNoYWluLWlkIGNoZWNrZXJzLTEgXAogICAgLS1ub2RlIGh0dHA6Ly9ub2RlLWNhcm9sOjI2NjU3IFwKICAgIC0tYnJvYWRjYXN0LW1vZGUgYmxvY2sgLS15ZXMK"}}),t._v(" "),o("p",[t._v("Then run the tests. One run of the tests creates one completed game. It is okay do this multiple times:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKS9jbGllbnQ6L2NsaWVudCBcCiAgICAtdyAvY2xpZW50IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgLS1lbnYgUlBDX1VSTD0mcXVvdDtodHRwOi8vbm9kZS1jYXJvbDoyNjY1NyZxdW90OyBcCiAgICBub2RlOjE4Ljctc2xpbSBcCiAgICBucG0gdGVzdAo="}}),t._v(" "),o("p",[t._v("Note how the "),o("code",[t._v("RPC_URL")]),t._v(" is passed via an environment variable. This uses the fact that "),o("code",[t._v("dotenv")]),t._v("'s "),o("code",[t._v("config()")]),t._v(" function does not overwrite existing variables.")]),t._v(" "),o("p",[t._v("The completed game will count for the future leaderboard.")]),t._v(" "),o("h2",{attrs:{id:"prepare-the-upgrade-proposals"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-upgrade-proposals"}},[t._v("#")]),t._v(" Prepare the upgrade proposals")]),t._v(" "),o("p",[t._v("Copying what was done in the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/2-migration-info.html#governance-proposal"}},[t._v("previous migration section")]),t._v(", with one block every 5 seconds, you make:")],1),t._v(" "),o("ul",[o("li",[t._v("The first upgrade proposal to be run in 15 minutes (i.e. 180 blocks).")]),t._v(" "),o("li",[t._v("The second upgrade proposal to be run in 25 minutes (i.e. 300 blocks).")])]),t._v(" "),o("p",[t._v("Remember that both proposals will have a voting period of 10 minutes, with the second one straddling the first upgrade:")]),t._v(" "),o("ul",[o("li",[t._v("At "),o("em",[t._v("t=0")]),t._v(", the first proposal is in its voting period, for an upgrade 15 minutes later ("),o("em",[t._v("t=+15 min")]),t._v(").")]),t._v(" "),o("li",[t._v("At "),o("em",[t._v("t=+10 min")]),t._v(", the first proposal should pass, and at about the same time, you create the second proposal (it does not matter if it is a bit before or a bit after) for an upgrade 15 minutes later ("),o("em",[t._v("t=+25 min")]),t._v(").")]),t._v(" "),o("li",[t._v("At "),o("em",[t._v("t=+15 min")]),t._v(", the first upgrade happens automatically thanks to Cosmovisor. You will now be running v1.1.")]),t._v(" "),o("li",[t._v("At "),o("em",[t._v("t=+20 min")]),t._v(", the second proposal should pass.")]),t._v(" "),o("li",[t._v("At "),o("em",[t._v("t=+25 min")]),t._v(", the second upgrade happens. You will now be running v2.")])]),t._v(" "),o("p",[t._v("Find the current block height with:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIHN0YXR1cyBcCiAgICAtLW5vZGUgJnF1b3Q7dGNwOi8vbm9kZS1jYXJvbDoyNjY1NyZxdW90OyBcCiAgICB8IGpxIC1yICZxdW90Oy5TeW5jSW5mby5sYXRlc3RfYmxvY2tfaGVpZ2h0JnF1b3Q7Cg=="}}),t._v(" "),o("p",[t._v("This returns something like:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"MTAwMAo="}}),t._v(" "),o("h3",{attrs:{id:"send-the-first-upgrade-proposal"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#send-the-first-upgrade-proposal"}},[t._v("#")]),t._v(" Send the first upgrade proposal")]),t._v(" "),o("p",[t._v("With a minimum deposit of 10,000,000 upawn, you can now have Alice send the governance proposal from her desktop to Carol's public node:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBlY2hvIHBhc3N3b3JkIHwgZG9ja2VyIHJ1biAtLXJtIC1pIFwKICAgIC12ICQocHdkKS9wcm9kLXNpbS9kZXNrLWFsaWNlOi9yb290Ly5jaGVja2VycyBcCiAgICAtLW5ldHdvcmsgY2hlY2tlcnMtcHJvZF9uZXQtcHVibGljIFwKICAgIGNoZWNrZXJzZF9pOnYxLWFscGluZSBcCiAgICB0eCBnb3Ygc3VibWl0LXByb3Bvc2FsIHNvZnR3YXJlLXVwZ3JhZGUgdjF0b3YxXzEgXAogICAgLS1ub2RlICZxdW90O3RjcDovL25vZGUtY2Fyb2w6MjY2NTcmcXVvdDsgXAogICAgLS10aXRsZSAmcXVvdDt2MV8xdG92MiZxdW90OyBcCiAgICAtLWRlc2NyaXB0aW9uICZxdW90O0ZpcnN0IHN0ZXAgLSBhZGQgcGxheWVyIGluZm9zJnF1b3Q7IFwKICAgIC0tdXBncmFkZS1oZWlnaHQgMTE4MCBcCiAgICAtLWRlcG9zaXQgMTAwMDAwMDB1cGF3biBcCiAgICAtLWZyb20gJGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIFwKICAgIC0teWVzCg=="}}),t._v(" "),o("p",[t._v("The command is long but it makes sense when you look at it carefully. It returns you the proposal id:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"yaml",base64:"LSBhdHRyaWJ1dGVzOgogIC0ga2V5OiBwcm9wb3NhbF9pZAogICAgdmFsdWU6ICZxdW90OzEmcXVvdDsKICAtIGtleTogcHJvcG9zYWxfdHlwZQogICAgdmFsdWU6IFNvZnR3YXJlVXBncmFkZQogIC0ga2V5OiB2b3RpbmdfcGVyaW9kX3N0YXJ0CiAgICB2YWx1ZTogJnF1b3Q7MSZxdW90Owo="}}),t._v(" "),o("h3",{attrs:{id:"vote-on-the-first-proposal"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#vote-on-the-first-proposal"}},[t._v("#")]),t._v(" Vote on the first proposal")]),t._v(" "),o("p",[t._v('Have both Alice and Bob vote "yes" on the proposal:')]),t._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Alice"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"ZWNobyBwYXNzd29yZCB8IGRvY2tlciBydW4gLS1ybSAtaSBcCiAgICAtdiAkKHB3ZCkvcHJvZC1zaW0vZGVzay1hbGljZTovcm9vdC8uY2hlY2tlcnMgXAogICAgLS1uZXR3b3JrIGNoZWNrZXJzLXByb2RfbmV0LXB1YmxpYyBcCiAgICBjaGVja2Vyc2RfaTp2MS1hbHBpbmUgXAogICAgdHggZ292IHZvdGUgMSB5ZXMgXAogICAgLS1ub2RlICZxdW90O3RjcDovL25vZGUtY2Fyb2w6MjY2NTcmcXVvdDsgXAogICAgLS1mcm9tICRhbGljZSAtLWtleXJpbmctYmFja2VuZCBmaWxlIC0ta2V5cmluZy1kaXIgL3Jvb3QvLmNoZWNrZXJzL2tleXMgXAogICAgLS15ZXMK"}})],1),t._v(" "),o("CodeGroupItem",{attrs:{title:"Bob"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"ZWNobyBwYXNzd29yZCB8IGRvY2tlciBydW4gLS1ybSAtaSBcCiAgICAtdiAkKHB3ZCkvcHJvZC1zaW0vZGVzay1ib2I6L3Jvb3QvLmNoZWNrZXJzIFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIFwKICAgIHR4IGdvdiB2b3RlIDEgeWVzIFwKICAgIC0tbm9kZSAmcXVvdDt0Y3A6Ly9ub2RlLWNhcm9sOjI2NjU3JnF1b3Q7IFwKICAgIC0tZnJvbSAkYm9iIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICAtLXllcwo="}})],1)],1),t._v(" "),o("h3",{attrs:{id:"refill-your-cup"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#refill-your-cup"}},[t._v("#")]),t._v(" Refill your cup")]),t._v(" "),o("p",[t._v("Wait 10 minutes from the time you created the first proposal.")]),t._v(" "),o("p",[t._v("When the proposal voting period ends, check that the votes went through and what the latest block height is:")]),t._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Votes"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIFwKICAgIHF1ZXJ5IGdvdiB2b3RlcyAxIFwKICAgIC0tbm9kZSAmcXVvdDt0Y3A6Ly9ub2RlLWNhcm9sOjI2NjU3JnF1b3Q7Cg=="}})],1),t._v(" "),o("CodeGroupItem",{attrs:{title:"Period"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIFwKICAgIHF1ZXJ5IGdvdiBwcm9wb3NhbCAxIFwKICAgIC0tbm9kZSAmcXVvdDt0Y3A6Ly9ub2RlLWNhcm9sOjI2NjU3JnF1b3Q7Cg=="}})],1),t._v(" "),o("CodeGroupItem",{attrs:{title:"Block Height"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIHN0YXR1cyBcCiAgICAtLW5vZGUgJnF1b3Q7dGNwOi8vbm9kZS1jYXJvbDoyNjY1NyZxdW90OyBcCiAgICB8IGpxIC1yICZxdW90Oy5TeW5jSW5mby5sYXRlc3RfYmxvY2tfaGVpZ2h0JnF1b3Q7Cg=="}})],1)],1),t._v(" "),o("p",[t._v("The proposal's current status will be:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"c3RhdHVzOiBQUk9QT1NBTF9TVEFUVVNfVk9USU5HX1BFUklPRAo="}}),t._v(" "),o("p",[t._v("You must wait until after the proposal status changes to:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"c3RhdHVzOiBQUk9QT1NBTF9TVEFUVVNfUEFTU0VECg=="}}),t._v(" "),o("p",[t._v("You must now wait longer, this time for the upgrade block to be reached. In the mean time...")]),t._v(" "),o("h3",{attrs:{id:"send-the-second-upgrade-proposal"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#send-the-second-upgrade-proposal"}},[t._v("#")]),t._v(" Send the second upgrade proposal")]),t._v(" "),o("p",[t._v("Between the time the first proposal has passed and the first upgrade takes place, send the second proposal, this time by Bob:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBlY2hvIHBhc3N3b3JkIHwgZG9ja2VyIHJ1biAtLXJtIC1pIFwKICAgIC12ICQocHdkKS9wcm9kLXNpbS9kZXNrLWJvYjovcm9vdC8uY2hlY2tlcnMgXAogICAgLS1uZXR3b3JrIGNoZWNrZXJzLXByb2RfbmV0LXB1YmxpYyBcCiAgICBjaGVja2Vyc2RfaTp2MS1hbHBpbmUgXAogICAgdHggZ292IHN1Ym1pdC1wcm9wb3NhbCBzb2Z0d2FyZS11cGdyYWRlIHYxXzF0b3YyIFwKICAgIC0tbm9kZSAmcXVvdDt0Y3A6Ly9ub2RlLWNhcm9sOjI2NjU3JnF1b3Q7IFwKICAgIC0tdGl0bGUgJnF1b3Q7djFfMXRvdjImcXVvdDsgXAogICAgLS1kZXNjcmlwdGlvbiAmcXVvdDtMZWFkZXJib2FyZCBpbnRyb2R1Y3Rpb24mcXVvdDsgXAogICAgLS11cGdyYWRlLWhlaWdodCAxMzAwIFwKICAgIC0tZGVwb3NpdCAxMDAwMDAwMHVwYXduIFwKICAgIC0tZnJvbSAkYm9iIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIFwKICAgIC0teWVzCg=="}}),t._v(" "),o("p",[t._v("This returns you the second proposal id:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"yaml",base64:"LSBhdHRyaWJ1dGVzOgogIC0ga2V5OiBwcm9wb3NhbF9pZAogICAgdmFsdWU6ICZxdW90OzImcXVvdDsKICAtIGtleTogcHJvcG9zYWxfdHlwZQogICAgdmFsdWU6IFNvZnR3YXJlVXBncmFkZQogIC0ga2V5OiB2b3RpbmdfcGVyaW9kX3N0YXJ0CiAgICB2YWx1ZTogJnF1b3Q7MiZxdW90Owo="}}),t._v(" "),o("p",[t._v("Similarly, have Alice and Bob vote on it:")]),t._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Alice"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"ZWNobyBwYXNzd29yZCB8IGRvY2tlciBydW4gLS1ybSAtaSBcCiAgICAtdiAkKHB3ZCkvcHJvZC1zaW0vZGVzay1hbGljZTovcm9vdC8uY2hlY2tlcnMgXAogICAgLS1uZXR3b3JrIGNoZWNrZXJzLXByb2RfbmV0LXB1YmxpYyBcCiAgICBjaGVja2Vyc2RfaTp2MS1hbHBpbmUgXAogICAgdHggZ292IHZvdGUgMiB5ZXMgXAogICAgLS1ub2RlICZxdW90O3RjcDovL25vZGUtY2Fyb2w6MjY2NTcmcXVvdDsgXAogICAgLS1mcm9tICRhbGljZSAtLWtleXJpbmctYmFja2VuZCBmaWxlIC0ta2V5cmluZy1kaXIgL3Jvb3QvLmNoZWNrZXJzL2tleXMgXAogICAgLS15ZXMK"}})],1),t._v(" "),o("CodeGroupItem",{attrs:{title:"Bob"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"ZWNobyBwYXNzd29yZCB8IGRvY2tlciBydW4gLS1ybSAtaSBcCiAgICAtdiAkKHB3ZCkvcHJvZC1zaW0vZGVzay1ib2I6L3Jvb3QvLmNoZWNrZXJzIFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEtYWxwaW5lIFwKICAgIHR4IGdvdiB2b3RlIDIgeWVzIFwKICAgIC0tbm9kZSAmcXVvdDt0Y3A6Ly9ub2RlLWNhcm9sOjI2NjU3JnF1b3Q7IFwKICAgIC0tZnJvbSAkYm9iIC0ta2V5cmluZy1iYWNrZW5kIGZpbGUgLS1rZXlyaW5nLWRpciAvcm9vdC8uY2hlY2tlcnMva2V5cyBcCiAgICAtLXllcwo="}})],1)],1),t._v(" "),o("h2",{attrs:{id:"the-first-live-upgrade"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#the-first-live-upgrade"}},[t._v("#")]),t._v(" The first live upgrade")]),t._v(" "),o("p",[t._v("If you are scanning the logs of one of the containers, for instance from Docker's GUI, you should see something like:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"RVJSIFVQR1JBREUgJnF1b3Q7djF0b3YxXzEmcXVvdDsgTkVFREVEIGF0IGhlaWdodDogMTE4MDoKSU5GIHN0YXJ0aW5nIG5vZGUgd2l0aCBBQkNJIFRlbmRlcm1pbnQgaW4tcHJvY2Vzcwo="}}),t._v(" "),o("p",[t._v("That was v1's last message, followed by v1_1's first message.")]),t._v(" "),o("p",[t._v("After that, you should be able to query for the presence of player infos:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEuMS1hbHBpbmUgXAogICAgcXVlcnkgY2hlY2tlcnMgbGlzdC1wbGF5ZXItaW5mbyBcCiAgICAtLW5vZGUgJnF1b3Q7dGNwOi8vbm9kZS1jYXJvbDoyNjY1NyZxdW90Owo="}}),t._v(" "),o("p",[t._v("This should return:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"yaml",base64:"cGxheWVySW5mbzoKLSBmb3JmZWl0ZWRDb3VudDogJnF1b3Q7MCZxdW90OwogIGluZGV4OiBjb3Ntb3MxZng2cWx4d3RlZXF4Z3h3c3c4M3drZjRzOWZjbm53azh6ODZzcWwKICBsb3N0Q291bnQ6ICZxdW90OzAmcXVvdDsKICB3b25Db3VudDogJnF1b3Q7MiZxdW90OwotIGZvcmZlaXRlZENvdW50OiAmcXVvdDswJnF1b3Q7CiAgaW5kZXg6IGNvc21vczFtcWw5YWF1eDM0NTN0ZGdoazZyemttazQzc3R4dm52aGE0bnYyMgogIGxvc3RDb3VudDogJnF1b3Q7MiZxdW90Owo="}}),t._v(" "),o("p",[t._v("You can also confirm that the leaderboard is still missing:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djItYWxwaW5lIFwKICAgIHF1ZXJ5IGxlYWRlcmJvYXJkIHNob3ctbGVhZGVyYm9hcmQgXAogICAgLS1ub2RlICZxdW90O3RjcDovL25vZGUtY2Fyb2w6MjY2NTcmcXVvdDsK"}}),t._v(" "),o("p",[t._v("This still returns:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"RXJyb3I6IHJwYyBlcnJvcjogY29kZSA9IFVua25vd24gZGVzYyA9IHVua25vd24gcXVlcnkgcGF0aDogdW5rbm93biByZXF1ZXN0Cg=="}}),t._v(" "),o("p",[t._v("You can also verify with Cosmosvisor that it is now running v1.1:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgbm9kZS1jYXJvbCBcCiAgICBscyAtbCAvcm9vdC8uY2hlY2tlcnMtdXBncmFkZS9jb3Ntb3Zpc29yL2N1cnJlbnQK"}}),t._v(" "),o("p",[t._v("This should return:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Li4uIC9yb290Ly5jaGVja2Vycy11cGdyYWRlL2Nvc21vdmlzb3IvY3VycmVudCAtJmd0OyAvcm9vdC8uY2hlY2tlcnMtdXBncmFkZS9jb3Ntb3Zpc29yL3VwZ3JhZGUvdjF0b3YxXzEK"}}),t._v(" "),o("h2",{attrs:{id:"the-second-live-upgrade"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#the-second-live-upgrade"}},[t._v("#")]),t._v(" The second live upgrade")]),t._v(" "),o("p",[t._v("You can follow the status of the second proposal with:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djEuMS1hbHBpbmUgXAogICAgcXVlcnkgZ292IHByb3Bvc2FsIDIgXAogICAgLS1ub2RlICZxdW90O3RjcDovL25vZGUtY2Fyb2w6MjY2NTcmcXVvdDsK"}}),t._v(" "),o("p",[t._v("Observe that it changes to "),o("code",[t._v("PASSED")]),t._v(" after the first upgrade. After that, if you are scanning the logs of one of the containers (for instance from Docker's GUI) you should see something like:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"RVJSIFVQR1JBREUgJnF1b3Q7djFfMXRvdjImcXVvdDsgTkVFREVEIGF0IGhlaWdodDogMTMwMDoKSU5GIHN0YXJ0aW5nIG5vZGUgd2l0aCBBQkNJIFRlbmRlcm1pbnQgaW4tcHJvY2Vzcwo="}}),t._v(" "),o("p",[t._v("That was v1.1's last message, followed by v2's first message. You can confirm that the leaderboard has been populated:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1wcm9kX25ldC1wdWJsaWMgXAogICAgY2hlY2tlcnNkX2k6djItYWxwaW5lIFwKICAgIHF1ZXJ5IGxlYWRlcmJvYXJkIHNob3ctbGVhZGVyYm9hcmQgXAogICAgLS1ub2RlICZxdW90O3RjcDovL25vZGUtY2Fyb2w6MjY2NTcmcXVvdDsK"}}),t._v(" "),o("p",[t._v("This returns:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"yaml",base64:"TGVhZGVyYm9hcmQ6CiAgd2lubmVyczoKICAtIGFkZGVkQXQ6ICZxdW90OzE2ODMyMTM4MzEmcXVvdDsKICAgIGFkZHJlc3M6IGNvc21vczFmeDZxbHh3dGVlcXhneHdzdzgzd2tmNHM5ZmNubndrOHo4NnNxbAogICAgd29uQ291bnQ6ICZxdW90OzImcXVvdDsK"}}),t._v(" "),o("h2",{attrs:{id:"what-about-stop-and-restart"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#what-about-stop-and-restart"}},[t._v("#")]),t._v(" What about stop and restart?")]),t._v(" "),o("p",[t._v("All checkers containers are now running checkersd v2. You can see that Cosmovisor has swapped the "),o("code",[t._v("current")]),t._v(" executable:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgbm9kZS1jYXJvbCBcCiAgICBscyAtbCAvcm9vdC8uY2hlY2tlcnMtdXBncmFkZS9jb3Ntb3Zpc29yL2N1cnJlbnQK"}}),t._v(" "),o("p",[t._v("This should return:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Li4uIC9yb290Ly5jaGVja2Vycy11cGdyYWRlL2Nvc21vdmlzb3IvY3VycmVudCAtJmd0OyAvcm9vdC8uY2hlY2tlcnMtdXBncmFkZS9jb3Ntb3Zpc29yL3VwZ3JhZGUvdjFfMXRvdjIK"}}),t._v(" "),o("p",[t._v("It will return this "),o("strong",[t._v("until the containers are stopped")]),t._v(" and deleted, that is.")]),t._v(" "),o("HighlightBox",{attrs:{type:"warn"}},[o("p",[t._v("Remember that the containers are loaded from a Docker image configured with Cosmovisor. In the current configuration, Cosmovisor starts with what it finds at "),o("code",[t._v("genesis/bin/checkersd")]),t._v(", i.e. v1.\n"),o("br"),o("br"),t._v("\nAll this is to say that you should not expect it to work if you stop and start your Cosmovisor Compose setup as is.")])]),t._v(" "),o("p",[t._v("If you were using real production servers, Cosmovisor's symbolic link would not reset itself on restart, so you would be safe in this regard. You would have time to revisit your server's configuration so as to launch "),o("code",[t._v("checkersd")]),t._v(" v2 natively.")]),t._v(" "),o("p",[t._v("In this example you can prepare yet another Compose file, this time specifically for v2:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"yaml",base64:"dmVyc2lvbjogJnF1b3Q7My43JnF1b3Q7CgpzZXJ2aWNlczoKCiAgdmFsLWFsaWNlOgogICAgZXh0ZW5kczoKICAgICAgZmlsZTogZG9ja2VyLWNvbXBvc2UueW1sCiAgICAgIHNlcnZpY2U6IHZhbC1hbGljZQogICAgaW1hZ2U6IGNoZWNrZXJzZF9pOnYyLWFscGluZQoKICBzZW50cnktYWxpY2U6CiAgICBleHRlbmRzOgogICAgICBmaWxlOiBkb2NrZXItY29tcG9zZS55bWwKICAgICAgc2VydmljZTogc2VudHJ5LWFsaWNlCiAgICBpbWFnZTogY2hlY2tlcnNkX2k6djItYWxwaW5lCgogIHZhbC1ib2I6CiAgICBleHRlbmRzOgogICAgICBmaWxlOiBkb2NrZXItY29tcG9zZS55bWwKICAgICAgc2VydmljZTogdmFsLWJvYgogICAgaW1hZ2U6IGNoZWNrZXJzZF9pOnYyLWFscGluZQoKICBzZW50cnktYm9iOgogICAgZXh0ZW5kczoKICAgICAgZmlsZTogZG9ja2VyLWNvbXBvc2UueW1sCiAgICAgIHNlcnZpY2U6IHNlbnRyeS1ib2IKICAgIGltYWdlOiBjaGVja2Vyc2RfaTp2Mi1hbHBpbmUKCiAgbm9kZS1jYXJvbDoKICAgIGV4dGVuZHM6CiAgICAgIGZpbGU6IGRvY2tlci1jb21wb3NlLnltbAogICAgICBzZXJ2aWNlOiBub2RlLWNhcm9sCiAgICBpbWFnZTogY2hlY2tlcnNkX2k6djItYWxwaW5lCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration-prod/prod-sim/docker-compose-v2.yml"}}),t._v(" "),o("p",[t._v("Now you can safely stop the Cosmovisor setup:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgY29tcG9zZSAtLXByb2plY3QtbmFtZSBjaGVja2Vycy1wcm9kIGRvd24K"}}),t._v(" "),o("p",[t._v("And start the v2 setup:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgY29tcG9zZSBcCiAgICAtLWZpbGUgcHJvZC1zaW0vZG9ja2VyLWNvbXBvc2UueW1sIFwKICAgIC0tZmlsZSBwcm9kLXNpbS9kb2NrZXItY29tcG9zZS12Mi55bWwgXAogICAgLS1wcm9qZWN0LW5hbWUgY2hlY2tlcnMtcHJvZCB1cCBcCiAgICAtLWRldGFjaAo="}}),t._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[t._v("If you want to test other migration configurations, for instance where Carol "),o("em",[t._v("forgot")]),t._v(" to put Cosmovisor on her node, you can revert all your blockchain files to v1 with:")]),t._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3Byb2Qtc2ltL3Vuc2FmZS1yZXNldC1zdGF0ZS5zaAo="}}),t._v(" "),o("p",[t._v("Another exercise you can attempt is create a "),o("code",[t._v("v1tov2")]),t._v(" upgrade that does "),o("strong",[t._v("both")]),t._v(" upgrades in one go. You would have to add this "),o("code",[t._v("v1tov2")]),t._v(" name into the Go code, and make sure it is handled correctly.")])],1),t._v(" "),o("HighlightBox",{attrs:{type:"synopsis"}},[o("p",[t._v("To summarize, this section has explored:")]),t._v(" "),o("ul",[o("li",[t._v("How to prepare multi-stage Docker images for different executable versions.")]),t._v(" "),o("li",[t._v("How to prepare Cosmovisor for a simulated production migration.")]),t._v(" "),o("li",[t._v("How to upgrade a blockchain in production, by live migrating from v1 of the blockchain to v1.1 and then v2.")]),t._v(" "),o("li",[t._v("How to launch all that with the help of Docker Compose.")]),t._v(" "),o("li",[t._v("A complete procedure for how to conduct the update via the CLI.")])])])],1)}),[],!1,null,null,null);e.default=c.exports}}]);