(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{723:function(e,t,o){"use strict";o.r(t);var a=o(1),l=Object(a.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h1",{attrs:{id:"introduce-a-leaderboard-after-production"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#introduce-a-leaderboard-after-production"}},[e._v("#")]),e._v(" Introduce a Leaderboard After Production")]),e._v(" "),o("HighlightBox",{attrs:{type:"prerequisite"}},[o("p",[e._v("Make sure you have all you need before proceeding:")]),e._v(" "),o("ul",[o("li",[e._v("You understand the concepts of "),o("RouterLink",{attrs:{to:"/academy/2-cosmos-concepts/6-protobuf.html"}},[e._v("Protobuf")]),e._v(" and "),o("RouterLink",{attrs:{to:"/academy/2-cosmos-concepts/12-migrations.html"}},[e._v("migrations")]),e._v(".")],1),e._v(" "),o("li",[e._v("Go is installed.")]),e._v(" "),o("li",[e._v("You have the checkers blockchain codebase up to the wager denomination. If not, follow the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/4-ibc-adv/1-wager-denom.html"}},[e._v("previous steps")]),e._v(" or check out the "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/tree/v1-wager-denomination",target:"_blank",rel:"noopener noreferrer"}},[e._v("relevant version"),o("OutboundLink")],1),e._v(".")],1)])]),e._v(" "),o("HighlightBox",{attrs:{type:"learning"}},[o("p",[e._v("In this section, you will:")]),e._v(" "),o("ul",[o("li",[e._v("Add a leaderboard.")]),e._v(" "),o("li",[e._v("Upgrade your blockchain in production.")]),e._v(" "),o("li",[e._v("Deal with data migrations and logic upgrades.")])])]),e._v(" "),o("p",[e._v("If you have been running "),o("em",[e._v("v1")]),e._v(" of your checkers blockchain for a while, games have been created, played on, won, and lost. In this section, you will introduce "),o("em",[e._v("v2")]),e._v(" of your blockchain with leaderboard support. A good leaderboard fulfills these conditions:")]),e._v(" "),o("ul",[o("li",[e._v("Any player who has "),o("strong",[e._v("ever")]),e._v(" played should have a tally of games won, lost, and forfeited.")]),e._v(" "),o("li",[e._v("The leaderboard should list the players with the most wins up to a pre-determined number. For example, the leaderboard could only include the top 100 scores.")]),e._v(" "),o("li",[e._v("To avoid squatting and increase engagement, when equal in value the most recent score takes precedence over an "),o("em",[e._v("older")]),e._v(" one, so the player with the recent score is listed higher on the leaderboard.")])]),e._v(" "),o("p",[e._v("When you introduce the leaderboard, you also have to decide what to do with your existing players and their scores from your v1 checkers blockchain.")]),e._v(" "),o("p",[e._v("Start your v2's leaderboard as if all played past games had been counted for the leaderboard. You "),o("em",[e._v("only")]),e._v(" need to go through all played games, update the players with their tallies, and add a leaderboard including the information. This is possible because all past games and their outcomes are kept in the chain's state. Migration is a good method to tackle the initial leaderboard.")]),e._v(" "),o("p",[e._v("For the avoidance of doubt, "),o("strong",[e._v("v1 and v2 refer to the overall versions of the application")]),e._v(", and not to the "),o("em",[e._v("consensus versions")]),e._v(" of individual modules, which may change or not.")]),e._v(" "),o("h2",{attrs:{id:"introducing-a-leaderboard"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#introducing-a-leaderboard"}},[e._v("#")]),e._v(" Introducing a leaderboard")]),e._v(" "),o("p",[e._v("Several things need to be addressed before you can focus all your attention on the migration:")]),e._v(" "),o("ol",[o("li",[e._v("Save and mark as v1 the current data types about to be modified with the new version. Data types that will remain unmodified need not be identified as such.")]),e._v(" "),o("li",[e._v("Prepare your v2 blockchain:\n"),o("ol",[o("li",[e._v("Define your new data types.")]),e._v(" "),o("li",[e._v("Add helper functions to encapsulate clearly defined actions, like leaderboard sorting.")]),e._v(" "),o("li",[e._v("Adjust the existing code to make use of and update the new data types.")])])]),e._v(" "),o("li",[e._v("Prepare for your v1-to-v2 migration:\n"),o("ol",[o("li",[e._v("Add helper functions to process large amounts of data from the latest chain state of type v1.")]),e._v(" "),o("li",[e._v("Add a function to migrate your state from v1 to v2.")]),e._v(" "),o("li",[e._v("Make sure you can handle large amounts of data.")])])])]),e._v(" "),o("p",[o("em",[e._v("Why do you need to make sure you can handle large amounts of data?")]),e._v(" The full state at the point of migration may well have millions of games. You do not want your process to grind to a halt because of a lack of memory or I/O capacity.")]),e._v(" "),o("h2",{attrs:{id:"save-your-v1"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#save-your-v1"}},[e._v("#")]),e._v(" Save your v1")]),e._v(" "),o("p",[e._v("Your migration steps will be handled in a new folder, "),o("code",[e._v("x/checkers/migrations/v1tov2")]),e._v(", which needs to be created:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBta2RpciAtcCB4L2NoZWNrZXJzL21pZ3JhdGlvbnMvdjF0b3YyCg=="}}),e._v(" "),o("p",[e._v("The only "),o("strong",[e._v("data structure")]),e._v(" you will eventually change is the checkers genesis structure. The other data structures are new, so you can treat them "),o("em",[e._v("as usual")]),e._v(". Although in this specific case it is not strictly necessary, it is good to make this practice habitual. Copy and paste your compiled Protobuf v1 genesis from the current commit and save it under the same name in "),o("code",[e._v("x/checkers/migrations/v1/types/")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBta2RpciAtcCB4L2NoZWNrZXJzL21pZ3JhdGlvbnMvdjEvdHlwZXMKJCBjcCB4L2NoZWNrZXJzL3R5cGVzL2dlbmVzaXMucGIuZ28geC9jaGVja2Vycy9taWdyYXRpb25zL3YxL3R5cGVzCg=="}}),e._v(" "),o("p",[e._v("Your current genesis definition eventually becomes your v2 genesis. This should be the only data structure requiring a change. However, if for example you also changed the structure of "),o("code",[e._v("StoredGame")]),e._v(", then you would have to save its v1 version in the same "),o("code",[e._v("v1/types")]),e._v(" folder.")]),e._v(" "),o("h2",{attrs:{id:"new-v2-information"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#new-v2-information"}},[e._v("#")]),e._v(" New v2 information")]),e._v(" "),o("p",[e._v("It is time to take a closer look at the new data structures being introduced with the version upgrade.")]),e._v(" "),o("HighlightBox",{attrs:{type:"tip"}},[o("p",[e._v("If you feel unsure about creating new data structures with Ignite CLI, look at the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/1-ignite-cli/4-create-message.html"}},[e._v("previous sections")]),e._v(" of the exercise again.")],1)]),e._v(" "),o("p",[e._v("To give the new v2 information a data structure, you need the following:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("Add a set of "),o("strong",[e._v("stats per player")]),e._v(": it makes sense to save one "),o("code",[e._v("struct")]),e._v(" for each player and to map it by address. Remember that a game is stored at a "),o("em",[e._v("notional")]),e._v(" "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/stored_game.go#L24-L28",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("StoredGame/value/123/")]),o("OutboundLink")],1),e._v(", where "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/key_stored_game.go#L9",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("StoredGame/value/")]),o("OutboundLink")],1),e._v(" is a constant prefix. Similarly, Ignite CLI creates a new constant to use as the prefix for players:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgc2NhZmZvbGQgbWFwIHBsYXllckluZm8gd29uQ291bnQ6dWludCBsb3N0Q291bnQ6dWludCBmb3JmZWl0ZWRDb3VudDp1aW50IC0tbW9kdWxlIGNoZWNrZXJzIC0tbm8tbWVzc2FnZQo="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IC12ICQocHdkKTovY2hlY2tlcnMgLXcgL2NoZWNrZXJzIGNoZWNrZXJzX2kgaWduaXRlIHNjYWZmb2xkIG1hcCBwbGF5ZXJJbmZvIHdvbkNvdW50OnVpbnQgbG9zdENvdW50OnVpbnQgZm9yZmVpdGVkQ291bnQ6dWludCAtLW1vZHVsZSBjaGVja2VycyAtLW5vLW1lc3NhZ2UK"}})],1)],1),e._v(" "),o("HighlightBox",{attrs:{type:"info"}},[o("p",[e._v("The new "),o("code",[e._v("PlayerInfo/value/")]),e._v(" prefix for players helps differentiate between the value for players and the value for games prefixed with "),o("code",[e._v("StoredGame/value/")]),e._v(".")]),e._v(" "),o("p",[e._v("Now you can safely have both "),o("code",[e._v("StoredGame/value/123/")]),e._v(" and "),o("code",[e._v("PlayerInfo/value/123/")]),e._v(" side by side in storage.")])]),e._v(" "),o("p",[e._v("This creates a Protobuf file:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBQbGF5ZXJJbmZvIHsKICAgIHN0cmluZyBpbmRleCA9IDE7CiAgICB1aW50NjQgd29uQ291bnQgPSAyOwogICAgdWludDY0IGxvc3RDb3VudCA9IDM7CiAgICB1aW50NjQgZm9yZmVpdGVkQ291bnQgPSA0Owp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/proto/checkers/player_info.proto#L6-L11"}}),e._v(" "),o("p",[e._v("It also added the map of new objects to the genesis, effectively your v2 genesis:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"aW1wb3J0ICZxdW90O2NoZWNrZXJzL3BsYXllcl9pbmZvLnByb3RvJnF1b3Q7OwoKbWVzc2FnZSBHZW5lc2lzU3RhdGUgewogICAgLi4uCiAgICByZXBlYXRlZCBQbGF5ZXJJbmZvIHBsYXllckluZm9MaXN0ID0gNCBbKGdvZ29wcm90by5udWxsYWJsZSkgPSBmYWxzZV07Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/proto/checkers/genesis.proto#L19"}}),e._v(" "),o("p",[e._v("You will use the player's address as a key to the map.")])],1),e._v(" "),o("li",[o("p",[e._v("Adjust in "),o("code",[e._v("types/genesis_test.go")]),e._v(" for the expectation that you get an empty list to start with:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0RGVmYXVsdEdlbmVzaXNTdGF0ZV9FeHBlY3RlZEluaXRpYWxOZXh0SWQodCAqdGVzdGluZy5UKSB7CiAgICAuLi4KICAgIFBsYXllckluZm9MaXN0OiBbXXR5cGVzLlBsYXllckluZm97fSwKICAgIC4uLgp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/genesis_test.go#L124"}})],1),e._v(" "),o("li",[o("p",[e._v("Add a "),o("strong",[e._v("leaderboard rung structure")]),e._v(" to be repeated inside the leaderboard: this stores the information of a player scoring high enough to be included in the leaderboard. It is not meant to be kept directly in storage as it is only a part of the leaderboard. Instead of involving Ignite CLI, create the structure by hand in a new file:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBXaW5uaW5nUGxheWVyIHsKICAgIHN0cmluZyBwbGF5ZXJBZGRyZXNzID0gMTsKICAgIHVpbnQ2NCB3b25Db3VudCA9IDI7CiAgICBzdHJpbmcgZGF0ZUFkZGVkID0gMzsKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/proto/checkers/winning_player.proto#L6-L10"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("code",[e._v("playerAddress")]),e._v(" indicates the player, and gives information regarding "),o("code",[e._v("PlayerInfo.index")]),e._v(".")]),e._v(" "),o("li",[o("code",[e._v("wonCount")]),e._v(" determines the ranking on the leaderboard - the higher the count, the closer to the "),o("code",[e._v("0")]),e._v(" index in the array. This should exactly match the value found in the corresponding player stats. This duplication of data is a lesser evil because if "),o("code",[e._v("wonCount")]),e._v(" was missing you would have to access the player stats to sort the leaderboard.")]),e._v(" "),o("li",[o("code",[e._v("dateAdded")]),e._v(" indicates when the player's "),o("code",[e._v("wonCount")]),e._v(" was last updated and determines the ranking when there is a tie in "),o("code",[e._v("wonCount")]),e._v(" - the more recent, the closer to the "),o("code",[e._v("0")]),e._v(" index in the array.")])])])],1),e._v(" "),o("li",[o("p",[e._v("Add a structure for "),o("strong",[e._v("the leaderboard")]),e._v(": there is a single stored leaderboard for the whole application. Let Ignite CLI help you implement a structure:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgc2NhZmZvbGQgc2luZ2xlIGxlYWRlcmJvYXJkIHdpbm5lcnMgLS1tb2R1bGUgY2hlY2tlcnMgLS1uby1tZXNzYWdlCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IC12ICQocHdkKTovY2hlY2tlcnMgLXcgL2NoZWNrZXJzIGNoZWNrZXJzX2kgaWduaXRlIHNjYWZmb2xkIHNpbmdsZSBsZWFkZXJib2FyZCB3aW5uZXJzIC0tbW9kdWxlIGNoZWNrZXJzIC0tbm8tbWVzc2FnZQo="}})],1)],1)],1),e._v(" "),o("li",[o("p",[e._v("This creates a Protobuf file with "),o("code",[e._v("string winners")]),e._v(". You update it with your preferred type and its "),o("code",[e._v("import")]),e._v(". Add that each element in the map is not nullable. This will compile each "),o("code",[e._v("WinningPlayer")]),e._v(" to a Go object instead of a pointer:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"aW1wb3J0ICZxdW90O2dvZ29wcm90by9nb2dvLnByb3RvJnF1b3Q7OwppbXBvcnQgJnF1b3Q7Y2hlY2tlcnMvd2lubmluZ19wbGF5ZXIucHJvdG8mcXVvdDs7CgptZXNzYWdlIExlYWRlcmJvYXJkIHsKICAgIHJlcGVhdGVkIFdpbm5pbmdQbGF5ZXIgd2lubmVycyA9IDEgWyhnb2dvcHJvdG8ubnVsbGFibGUpID0gZmFsc2VdOwp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/proto/checkers/leaderboard.proto#L9-L11"}})],1),e._v(" "),o("li",[o("p",[e._v("The v2 genesis was also updated with the leaderboard. Tell it that the leaderboard should always be there (even if empty):")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"aW1wb3J0ICZxdW90O2NoZWNrZXJzL2xlYWRlcmJvYXJkLnByb3RvJnF1b3Q7OwoKbWVzc2FnZSBHZW5lc2lzU3RhdGUgewogICAgLi4uCiAgICBMZWFkZXJib2FyZCBsZWFkZXJib2FyZCA9IDUgWyhnb2dvcHJvdG8ubnVsbGFibGUpID0gZmFsc2VdOwp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/proto/checkers/genesis.proto#L20"}}),e._v(" "),o("p",[e._v("At this point, you should run "),o("code",[e._v("ignite generate proto-go")]),e._v(" so that the corresponding Go objects are re-created.")])],1),e._v(" "),o("li",[o("p",[e._v("Remember to make sure the initial value stored for the leaderboard is not "),o("code",[e._v("nil")]),e._v(" but instead is empty. In "),o("code",[e._v("genesis.go")]),e._v(" adjust:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBEZWZhdWx0R2VuZXNpcygpICpHZW5lc2lzU3RhdGUgewogICAgcmV0dXJuICZhbXA7R2VuZXNpc1N0YXRlewogICAgICAgIC4uLgogICAgICAgIExlYWRlcmJvYXJkOiBMZWFkZXJib2FyZHsKICAgICAgICAgICAgV2lubmVyczogW11XaW5uaW5nUGxheWVye30sCiAgICAgICAgfSwKICAgIH0KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/genesis.go#L20-L22"}}),e._v(" "),o("p",[e._v('This function returns a default genesis. This step is important if you start fresh. In your case, you do not begin with an "empty" genesis but with one resulting from the upcoming genesis migration in this exercise.')]),e._v(" "),o("p",[e._v("In particular, update the initial genesis test:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0RGVmYXVsdEdlbmVzaXNTdGF0ZV9FeHBlY3RlZEluaXRpYWxOZXh0SWQodCAqdGVzdGluZy5UKSB7CiAgICAuLi4KICAgICAgICBMZWFkZXJib2FyZDogdHlwZXMuTGVhZGVyYm9hcmR7CiAgICAgICAgICAgIFdpbm5lcnM6IFtddHlwZXMuV2lubmluZ1BsYXllcnt9LAogICAgICAgIH0sCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/genesis_test.go#L125-L127"}})],1),e._v(" "),o("li",[o("p",[e._v("Also adjust the compilation errors:")]),e._v(" "),o("p",[e._v("On "),o("code",[e._v("genesis.go")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ay5TZXRMZWFkZXJib2FyZChjdHgsIGdlblN0YXRlLkxlYWRlcmJvYXJkKSAvLyBOb3QgdGVzdGluZyBmb3IgbmlsCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/genesis.go#L23"}}),e._v(" "),o("p",[e._v("On "),o("code",[e._v("genesis_test.go")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCkxlYWRlcmJvYXJkOiAmYW1wO3R5cGVzLkxlYWRlcmJvYXJkewogICAgV2lubmVyczogW10qdHlwZXMuV2lubmluZ1BsYXllcnsKICAgICAgICB7CiAgICAgICAgICAgIFBsYXllckFkZHJlc3M6ICZxdW90O2Nvc21vczEyMyZxdW90OywKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgUGxheWVyQWRkcmVzczogJnF1b3Q7Y29zbW9zNDU2JnF1b3Q7LAogICAgICAgIH0sCiAgICB9LAp9LAouLi4K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/genesis_test.go#L36-L45"}}),e._v(" "),o("p",[e._v("At this point you can add a test case that catches a duplicated winner player:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ewogICAgZGVzYzogJnF1b3Q7ZHVwbGljYXRlZCB3aW5uZXJQbGF5ZXImcXVvdDssCiAgICBnZW5TdGF0ZTogJmFtcDt0eXBlcy5HZW5lc2lzU3RhdGV7CiAgICAgICAgTGVhZGVyYm9hcmQ6IHR5cGVzLkxlYWRlcmJvYXJkewogICAgICAgICAgICBXaW5uZXJzOiBbXXR5cGVzLldpbm5pbmdQbGF5ZXJ7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgUGxheWVyQWRkcmVzczogJnF1b3Q7MCZxdW90OywKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgUGxheWVyQWRkcmVzczogJnF1b3Q7MCZxdW90OywKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSwKICAgIH0sCiAgICB2YWxpZDogZmFsc2UsCn0sCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/genesis_test.go#L86-L101"}})],1),e._v(" "),o("li",[o("p",[e._v("This latest test case will pass, unless you update the "),o("code",[e._v("Validate()")]),e._v(" method of the genesis to not allow duplicate player addresses. This is inspired by "),o("code",[e._v("types/genesis.go")]),e._v(" and best kept in a separate "),o("code",[e._v("types/leaderboard.go")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAobGVhZGVyYm9hcmQgTGVhZGVyYm9hcmQpIFZhbGlkYXRlKCkgZXJyb3IgewogICAgLy8gQ2hlY2sgZm9yIGR1cGxpY2F0ZWQgcGxheWVyIGFkZHJlc3MgaW4gd2lubmVycwogICAgd2lubmVySW5mb0luZGV4TWFwIDo9IG1ha2UobWFwW3N0cmluZ11zdHJ1Y3R7fSkKCiAgICBmb3IgXywgZWxlbSA6PSByYW5nZSBsZWFkZXJib2FyZC5XaW5uZXJzIHsKICAgICAgICBpbmRleCA6PSBzdHJpbmcoUGxheWVySW5mb0tleShlbGVtLlBsYXllckFkZHJlc3MpKQogICAgICAgIGlmIF8sIG9rIDo9IHdpbm5lckluZm9JbmRleE1hcFtpbmRleF07IG9rIHsKICAgICAgICAgICAgcmV0dXJuIGZtdC5FcnJvcmYoJnF1b3Q7ZHVwbGljYXRlZCBwbGF5ZXJBZGRyZXNzIGZvciB3aW5uZXImcXVvdDspCiAgICAgICAgfQogICAgICAgIHdpbm5lckluZm9JbmRleE1hcFtpbmRleF0gPSBzdHJ1Y3R7fXt9CiAgICB9CiAgICByZXR1cm4gbmlsCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L12-L24"}}),e._v(" "),o("p",[e._v("After this, you can adjust the "),o("code",[e._v("types/genesis.go")]),e._v(" files:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCi8vIFZhbGlkYXRlIExlYWRlcmJvYXJkCmlmIGVyciA6PSBncy5MZWFkZXJib2FyZC5WYWxpZGF0ZSgpOyBlcnIgIT0gbmlsIHsKICAgIHJldHVybiBlcnIKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/genesis.go#L51-L54"}})],1)]),e._v(" "),o("p",[e._v("With the structure set up, it is time to add the code using these new elements in normal operations.")]),e._v(" "),o("h2",{attrs:{id:"v2-player-information-helpers"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v2-player-information-helpers"}},[e._v("#")]),e._v(" v2 player information helpers")]),e._v(" "),o("p",[e._v("When a game reaches its resolution, one of the "),o("code",[e._v("count")]),e._v("s needs to add "),o("code",[e._v("+1")]),e._v(".")]),e._v(" "),o("ExpansionPanel",{attrs:{title:"A detailed look into the code"}},[o("p",[e._v("To start, add a private helper function that gets the stats from the storage, updates the numbers as instructed, and saves it back:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBtdXN0QWRkRGVsdGFHYW1lUmVzdWx0VG9QbGF5ZXIoCiAgICBrICpLZWVwZXIsCiAgICBjdHggc2RrLkNvbnRleHQsCiAgICBwbGF5ZXIgc2RrLkFjY0FkZHJlc3MsCiAgICB3b25EZWx0YSB1aW50NjQsCiAgICBsb3N0RGVsdGEgdWludDY0LAogICAgZm9yZmVpdGVkRGVsdGEgdWludDY0LAopIChwbGF5ZXJJbmZvIHR5cGVzLlBsYXllckluZm8pIHsKICAgIHBsYXllckluZm8sIGZvdW5kIDo9IGsuR2V0UGxheWVySW5mbyhjdHgsIHBsYXllci5TdHJpbmcoKSkKICAgIGlmICFmb3VuZCB7CiAgICAgICAgcGxheWVySW5mbyA9IHR5cGVzLlBsYXllckluZm97CiAgICAgICAgICAgIEluZGV4OiAgICAgICAgICBwbGF5ZXIuU3RyaW5nKCksCiAgICAgICAgICAgIFdvbkNvdW50OiAgICAgICAwLAogICAgICAgICAgICBMb3N0Q291bnQ6ICAgICAgMCwKICAgICAgICAgICAgRm9yZmVpdGVkQ291bnQ6IDAsCiAgICAgICAgfQogICAgfQogICAgcGxheWVySW5mby5Xb25Db3VudCArPSB3b25EZWx0YQogICAgcGxheWVySW5mby5Mb3N0Q291bnQgKz0gbG9zdERlbHRhCiAgICBwbGF5ZXJJbmZvLkZvcmZlaXRlZENvdW50ICs9IGZvcmZlaXRlZERlbHRhCiAgICBrLlNldFBsYXllckluZm8oY3R4LCBwbGF5ZXJJbmZvKQogICAgcmV0dXJuIHBsYXllckluZm8KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/player_info_handler.go#L11-L33"}}),e._v(" "),o("p",[e._v("You can easily call this from these public one-liner functions added to the keeper:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBNdXN0QWRkV29uR2FtZVJlc3VsdFRvUGxheWVyKGN0eCBzZGsuQ29udGV4dCwgcGxheWVyIHNkay5BY2NBZGRyZXNzKSB0eXBlcy5QbGF5ZXJJbmZvIHsKICAgIHJldHVybiBtdXN0QWRkRGVsdGFHYW1lUmVzdWx0VG9QbGF5ZXIoaywgY3R4LCBwbGF5ZXIsIDEsIDAsIDApCn0KCmZ1bmMgKGsgKktlZXBlcikgTXVzdEFkZExvc3RHYW1lUmVzdWx0VG9QbGF5ZXIoY3R4IHNkay5Db250ZXh0LCBwbGF5ZXIgc2RrLkFjY0FkZHJlc3MpIHR5cGVzLlBsYXllckluZm8gewogICAgcmV0dXJuIG11c3RBZGREZWx0YUdhbWVSZXN1bHRUb1BsYXllcihrLCBjdHgsIHBsYXllciwgMCwgMSwgMCkKfQoKZnVuYyAoayAqS2VlcGVyKSBNdXN0QWRkRm9yZmVpdGVkR2FtZVJlc3VsdFRvUGxheWVyKGN0eCBzZGsuQ29udGV4dCwgcGxheWVyIHNkay5BY2NBZGRyZXNzKSB0eXBlcy5QbGF5ZXJJbmZvIHsKICAgIHJldHVybiBtdXN0QWRkRGVsdGFHYW1lUmVzdWx0VG9QbGF5ZXIoaywgY3R4LCBwbGF5ZXIsIDAsIDAsIDEpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/player_info_handler.go#L35-L45"}}),e._v(" "),o("p",[e._v("Which player should get "),o("code",[e._v("+1")]),e._v(", and on what count? You need to identify the loser and the winner of a game to determine this. Create another private helper:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBnZXRXaW5uZXJBbmRMb3NlckFkZHJlc3NlcyhzdG9yZWRHYW1lICp0eXBlcy5TdG9yZWRHYW1lKSAod2lubmVyQWRkcmVzcyBzZGsuQWNjQWRkcmVzcywgbG9zZXJBZGRyZXNzIHNkay5BY2NBZGRyZXNzKSB7CiAgICBpZiBzdG9yZWRHYW1lLldpbm5lciA9PSBydWxlcy5QaWVjZVN0cmluZ3NbcnVsZXMuTk9fUExBWUVSXSB7CiAgICAgICAgcGFuaWModHlwZXMuRXJyVGhlcmVJc05vV2lubmVyLkVycm9yKCkpCiAgICB9CiAgICByZWRBZGRyZXNzLCBlcnIgOj0gc3RvcmVkR2FtZS5HZXRSZWRBZGRyZXNzKCkKICAgIGlmIGVyciAhPSBuaWwgewogICAgICAgIHBhbmljKGVyci5FcnJvcigpKQogICAgfQogICAgYmxhY2tBZGRyZXNzLCBlcnIgOj0gc3RvcmVkR2FtZS5HZXRCbGFja0FkZHJlc3MoKQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcGFuaWMoZXJyLkVycm9yKCkpCiAgICB9CiAgICBpZiBzdG9yZWRHYW1lLldpbm5lciA9PSBydWxlcy5QaWVjZVN0cmluZ3NbcnVsZXMuUkVEX1BMQVlFUl0gewogICAgICAgIHdpbm5lckFkZHJlc3MgPSByZWRBZGRyZXNzCiAgICAgICAgbG9zZXJBZGRyZXNzID0gYmxhY2tBZGRyZXNzCiAgICB9IGVsc2UgaWYgc3RvcmVkR2FtZS5XaW5uZXIgPT0gcnVsZXMuUGllY2VTdHJpbmdzW3J1bGVzLkJMQUNLX1BMQVlFUl0gewogICAgICAgIHdpbm5lckFkZHJlc3MgPSBibGFja0FkZHJlc3MKICAgICAgICBsb3NlckFkZHJlc3MgPSByZWRBZGRyZXNzCiAgICB9IGVsc2UgewogICAgICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVycldpbm5lck5vdFBhcnNlYWJsZS5FcnJvcigpLCBzdG9yZWRHYW1lLldpbm5lcikpCiAgICB9CiAgICByZXR1cm4gd2lubmVyQWRkcmVzcywgbG9zZXJBZGRyZXNzCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/player_info_handler.go#L47-L69"}}),e._v(" "),o("p",[e._v("You can call this from these public helper functions added to the keeper:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBNdXN0UmVnaXN0ZXJQbGF5ZXJXaW4oY3R4IHNkay5Db250ZXh0LCBzdG9yZWRHYW1lICp0eXBlcy5TdG9yZWRHYW1lKSAod2lubmVySW5mbyB0eXBlcy5QbGF5ZXJJbmZvLCBsb3NlckluZm8gdHlwZXMuUGxheWVySW5mbykgewogICAgd2lubmVyQWRkcmVzcywgbG9zZXJBZGRyZXNzIDo9IGdldFdpbm5lckFuZExvc2VyQWRkcmVzc2VzKHN0b3JlZEdhbWUpCiAgICByZXR1cm4gay5NdXN0QWRkV29uR2FtZVJlc3VsdFRvUGxheWVyKGN0eCwgd2lubmVyQWRkcmVzcyksCiAgICAgICAgay5NdXN0QWRkTG9zdEdhbWVSZXN1bHRUb1BsYXllcihjdHgsIGxvc2VyQWRkcmVzcykKfQoKZnVuYyAoayAqS2VlcGVyKSBNdXN0UmVnaXN0ZXJQbGF5ZXJGb3JmZWl0KGN0eCBzZGsuQ29udGV4dCwgc3RvcmVkR2FtZSAqdHlwZXMuU3RvcmVkR2FtZSkgKHdpbm5lckluZm8gdHlwZXMuUGxheWVySW5mbywgZm9yZmVpdGVySW5mbyB0eXBlcy5QbGF5ZXJJbmZvKSB7CiAgICB3aW5uZXJBZGRyZXNzLCBsb3NlckFkZHJlc3MgOj0gZ2V0V2lubmVyQW5kTG9zZXJBZGRyZXNzZXMoc3RvcmVkR2FtZSkKICAgIHJldHVybiBrLk11c3RBZGRXb25HYW1lUmVzdWx0VG9QbGF5ZXIoY3R4LCB3aW5uZXJBZGRyZXNzKSwKICAgICAgICBrLk11c3RBZGRGb3JmZWl0ZWRHYW1lUmVzdWx0VG9QbGF5ZXIoY3R4LCBsb3NlckFkZHJlc3MpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/player_info_handler.go#L71-L81"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("Be aware of the two new error types: "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/errors.go#L30",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("ErrThereIsNoWinner")]),o("OutboundLink")],1),e._v(" and "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/errors.go#L29",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("ErrWinnerNotParseable")]),o("OutboundLink")],1),e._v(".")])])],1),e._v(" "),o("h2",{attrs:{id:"v2-player-information-handling"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v2-player-information-handling"}},[e._v("#")]),e._v(" v2 player information handling")]),e._v(" "),o("p",[e._v("Now call your helper functions:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("On a win:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCmlmIHN0b3JlZEdhbWUuV2lubmVyID09IHJ1bGVzLlBpZWNlU3RyaW5nc1tydWxlcy5OT19QTEFZRVJdIHsKICAgIC4uLgp9IGVsc2UgewogICAgLi4uCiAgICBrLktlZXBlci5NdXN0UGF5V2lubmluZ3MoY3R4LCAmYW1wO3N0b3JlZEdhbWUpCiAgICBrLktlZXBlci5NdXN0UmVnaXN0ZXJQbGF5ZXJXaW4oY3R4LCAmYW1wO3N0b3JlZEdhbWUpCn0KLi4uCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move.go#L80"}})],1),e._v(" "),o("li",[o("p",[e._v("On a forfeit:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCmlmIHN0b3JlZEdhbWUuTW92ZUNvdW50ICZsdDs9IDEgewogICAgLi4uCn0gZWxzZSB7CiAgICAuLi4KICAgIGsuTXVzdFBheVdpbm5pbmdzKGN0eCwgJmFtcDtzdG9yZWRHYW1lKQogICAgay5NdXN0UmVnaXN0ZXJQbGF5ZXJGb3JmZWl0KGN0eCwgJmFtcDtzdG9yZWRHYW1lKQp9Ci4uLgo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/end_block_server_game.go#L57"}})],1)]),e._v(" "),o("h2",{attrs:{id:"v2-leaderboard-helpers"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v2-leaderboard-helpers"}},[e._v("#")]),e._v(" v2 leaderboard helpers")]),e._v(" "),o("p",[e._v("Continue completing your v2 before tackling the migration. Your leaderboard helpers should:")]),e._v(" "),o("ol",[o("li",[e._v("Add a new candidate to your array.")]),e._v(" "),o("li",[e._v("Sort the array according to the rules.")]),e._v(" "),o("li",[e._v("Clip the array to a length of 100 and save the result.")])]),e._v(" "),o("p",[e._v("Sorting entails comparing dates in cases of a score tie. This is potentially expensive if you are deserializing the date in the comparator itself. Instead, the comparator should be presented with data already deserialized. Prepare a data structure that has already deserialized the "),o("code",[e._v("dateAdded")]),e._v(", which allows you to:")]),e._v(" "),o("ol",[o("li",[e._v("Deserialize all the elements of the whole leaderboard's array.")]),e._v(" "),o("li",[e._v("Sort its elements.")]),e._v(" "),o("li",[e._v("Only then re-serialize its elements.")])]),e._v(" "),o("p",[e._v("Create a new file "),o("code",[e._v("leaderboard.go")]),e._v(" to encapsulate all your leaderboard helpers:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBXaW5uaW5nUGxheWVyUGFyc2VkIHN0cnVjdCB7CiAgICBQbGF5ZXJBZGRyZXNzIHN0cmluZwogICAgV29uQ291bnQgICAgICB1aW50NjQKICAgIERhdGVBZGRlZCAgICAgdGltZS5UaW1lCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L26-L30"}}),e._v(" "),o("ExpansionPanel",{attrs:{title:"How is dateAdded (de)serialized?"}},[o("p",[e._v("You can reuse the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/2-ignte-cli-adv/2-game-deadline.html"}},[e._v("date format used for the deadline")]),e._v(":")],1),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgKAogICAgRGF0ZUFkZGVkTGF5b3V0ID0gRGVhZGxpbmVMYXlvdXQKKQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/keys.go#L84"}}),e._v(" "),o("p",[e._v("Add similar functions to it, as you did when adding a deadline:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBQYXJzZURhdGVBZGRlZEFzVGltZShkYXRlQWRkZWQgc3RyaW5nKSAoZGF0ZUFkZGVkUGFyc2VkIHRpbWUuVGltZSwgZXJyIGVycm9yKSB7CiAgICBkYXRlQWRkZWRQYXJzZWQsIGVyckRhdGVBZGRlZCA6PSB0aW1lLlBhcnNlKERhdGVBZGRlZExheW91dCwgZGF0ZUFkZGVkKQogICAgcmV0dXJuIGRhdGVBZGRlZFBhcnNlZCwgc2RrZXJyb3JzLldyYXBmKGVyckRhdGVBZGRlZCwgRXJySW52YWxpZERhdGVBZGRlZC5FcnJvcigpLCBkYXRlQWRkZWQpCn0KCmZ1bmMgKHdpbm5pbmdQbGF5ZXIgV2lubmluZ1BsYXllcikgR2V0RGF0ZUFkZGVkQXNUaW1lKCkgKGRhdGVBZGRlZCB0aW1lLlRpbWUsIGVyciBlcnJvcikgewogICAgcmV0dXJuIFBhcnNlRGF0ZUFkZGVkQXNUaW1lKHdpbm5pbmdQbGF5ZXIuRGF0ZUFkZGVkKQp9CgpmdW5jIEdldERhdGVBZGRlZChjdHggc2RrLkNvbnRleHQpIHRpbWUuVGltZSB7CiAgICByZXR1cm4gY3R4LkJsb2NrVGltZSgpCn0KCmZ1bmMgRm9ybWF0RGF0ZUFkZGVkKGRhdGVBZGRlZCB0aW1lLlRpbWUpIHN0cmluZyB7CiAgICByZXR1cm4gZGF0ZUFkZGVkLlVUQygpLkZvcm1hdChEYXRlQWRkZWRMYXlvdXQpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L32-L47"}}),e._v(" "),o("p",[e._v("Do the same for the new error message:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"RXJySW52YWxpZERhdGVBZGRlZCA9IHNka2Vycm9ycy5SZWdpc3RlcihNb2R1bGVOYW1lLCAxMTIwLCAmcXVvdDtkYXRlQWRkZWQgY2Fubm90IGJlIHBhcnNlZDogJXMmcXVvdDspCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/errors.go#L31"}})],1),e._v(" "),o("ExpansionPanel",{attrs:{title:"Add functions to (de)serialize WinningPlayerParsed"}},[o("p",[e._v("Create the methods:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAod2lubmluZ1BsYXllciBXaW5uaW5nUGxheWVyKSBQYXJzZSgpIChwYXJzZWQgV2lubmluZ1BsYXllclBhcnNlZCwgZXJyIGVycm9yKSB7CiAgICBkYXRlQWRkZWQsIGVyciA6PSB3aW5uaW5nUGxheWVyLkdldERhdGVBZGRlZEFzVGltZSgpCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICByZXR1cm4gV2lubmluZ1BsYXllclBhcnNlZHt9LCBlcnIKICAgIH0KICAgIHJldHVybiBXaW5uaW5nUGxheWVyUGFyc2VkewogICAgICAgIFBsYXllckFkZHJlc3M6IHdpbm5pbmdQbGF5ZXIuUGxheWVyQWRkcmVzcywKICAgICAgICBXb25Db3VudDogICAgICB3aW5uaW5nUGxheWVyLldvbkNvdW50LAogICAgICAgIERhdGVBZGRlZDogICAgIGRhdGVBZGRlZCwKICAgIH0sIG5pbAp9CgpmdW5jIChwYXJzZWQgV2lubmluZ1BsYXllclBhcnNlZCkgU3RyaW5naWZ5KCkgV2lubmluZ1BsYXllciB7CiAgICByZXR1cm4gV2lubmluZ1BsYXllcnsKICAgICAgICBQbGF5ZXJBZGRyZXNzOiBwYXJzZWQuUGxheWVyQWRkcmVzcywKICAgICAgICBXb25Db3VudDogICAgICBwYXJzZWQuV29uQ291bnQsCiAgICAgICAgRGF0ZUFkZGVkOiAgICAgRm9ybWF0RGF0ZUFkZGVkKHBhcnNlZC5EYXRlQWRkZWQpLAogICAgfQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L49-L67"}}),e._v(" "),o("p",[e._v("The functions are called repeatedly when serializing or deserializing arrays:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBQYXJzZVdpbm5lcnMod2lubmVycyBbXVdpbm5pbmdQbGF5ZXIpIChwYXJzZWRXaW5uZXJzIFtdV2lubmluZ1BsYXllclBhcnNlZCwgZXJyIGVycm9yKSB7CiAgICBwYXJzZWRXaW5uZXJzID0gbWFrZShbXVdpbm5pbmdQbGF5ZXJQYXJzZWQsIGxlbih3aW5uZXJzKSkKICAgIHZhciBwYXJzZWQgV2lubmluZ1BsYXllclBhcnNlZAogICAgZm9yIGluZGV4LCB3aW5uaW5nUGxheWVyIDo9IHJhbmdlIHdpbm5lcnMgewogICAgICAgIHBhcnNlZCwgZXJyID0gd2lubmluZ1BsYXllci5QYXJzZSgpCiAgICAgICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgICAgIHJldHVybiBuaWwsIGVycgogICAgICAgIH0KICAgICAgICBwYXJzZWRXaW5uZXJzW2luZGV4XSA9IHBhcnNlZAogICAgfQogICAgcmV0dXJuIHBhcnNlZFdpbm5lcnMsIG5pbAp9CgpmdW5jIChsZWFkZXJib2FyZCBMZWFkZXJib2FyZCkgUGFyc2VXaW5uZXJzKCkgKHdpbm5lcnMgW11XaW5uaW5nUGxheWVyUGFyc2VkLCBlcnIgZXJyb3IpIHsKICAgIHJldHVybiBQYXJzZVdpbm5lcnMobGVhZGVyYm9hcmQuV2lubmVycykKfQoKZnVuYyBTdHJpbmdpZnlXaW5uZXJzKHdpbm5lcnMgW11XaW5uaW5nUGxheWVyUGFyc2VkKSBbXVdpbm5pbmdQbGF5ZXIgewogICAgc3RyaW5naWZpZWQgOj0gbWFrZShbXVdpbm5pbmdQbGF5ZXIsIGxlbih3aW5uZXJzKSkKICAgIGZvciBpbmRleCwgd2lubmVyIDo9IHJhbmdlIHdpbm5lcnMgewogICAgICAgIHN0cmluZ2lmaWVkW2luZGV4XSA9IHdpbm5lci5TdHJpbmdpZnkoKQogICAgfQogICAgcmV0dXJuIHN0cmluZ2lmaWVkCn0KCmZ1bmMgQ3JlYXRlTGVhZGVyYm9hcmRGcm9tUGFyc2VkV2lubmVycyh3aW5uZXJzIFtdV2lubmluZ1BsYXllclBhcnNlZCkgTGVhZGVyYm9hcmQgewogICAgcmV0dXJuIExlYWRlcmJvYXJkewogICAgICAgIFdpbm5lcnM6IFN0cmluZ2lmeVdpbm5lcnMod2lubmVycyksCiAgICB9Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L69-L98"}})],1),e._v(" "),o("p",[e._v("As you have a function to get an array of deserialized winning players, you can now add a function to sort the slice in place:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBTb3J0V2lubmVycyh3aW5uZXJzIFtdV2lubmluZ1BsYXllclBhcnNlZCkgewogICAgc29ydC5TbGljZVN0YWJsZSh3aW5uZXJzWzpdLCBmdW5jKGksIGogaW50KSBib29sIHsKICAgICAgICBpZiB3aW5uZXJzW2ldLldvbkNvdW50ICZndDsgd2lubmVyc1tqXS5Xb25Db3VudCB7CiAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIGlmIHdpbm5lcnNbaV0uV29uQ291bnQgJmx0OyB3aW5uZXJzW2pdLldvbkNvdW50IHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICAgIHJldHVybiB3aW5uZXJzW2ldLkRhdGVBZGRlZC5BZnRlcih3aW5uZXJzW2pdLkRhdGVBZGRlZCkKICAgIH0pCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L100-L110"}}),e._v(" "),o("p",[e._v("It tests in descending order, first for scores and then for the added dates. Note that there is no de-serialization in this "),o("code",[e._v("func(i, j int) bool")]),e._v(" callback. It is possible to write a one-liner inside this function but at the expense of readability.")]),e._v(" "),o("p",[e._v("Now you will make sure that your leaderboard never exceeds a certain length. Define the maximum length:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgKAogICAgTGVhZGVyYm9hcmRXaW5uZXJMZW5ndGggPSB1aW50NjQoMTAwKQopCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/keys.go#L83"}}),e._v(" "),o("p",[e._v("You now have the pieces in place to create the function that adds or updates a candidate to the leaderboard:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBVcGRhdGVQbGF5ZXJJbmZvQXROb3cod2lubmVycyBbXVdpbm5pbmdQbGF5ZXJQYXJzZWQsIG5vdyB0aW1lLlRpbWUsIGNhbmRpZGF0ZSBQbGF5ZXJJbmZvKSAodXBkYXRlZCBbXVdpbm5pbmdQbGF5ZXJQYXJzZWQpIHsKICAgIGlmIGNhbmRpZGF0ZS5Xb25Db3VudCAmbHQ7IDEgewogICAgICAgIHJldHVybiB3aW5uZXJzCiAgICB9CiAgICBmb3VuZCA6PSBmYWxzZQogICAgZm9yIGluZGV4LCB3aW5uZXIgOj0gcmFuZ2Ugd2lubmVycyB7CiAgICAgICAgaWYgd2lubmVyLlBsYXllckFkZHJlc3MgPT0gY2FuZGlkYXRlLkluZGV4IHsKICAgICAgICAgICAgaWYgd2lubmVyLldvbkNvdW50ICZsdDsgY2FuZGlkYXRlLldvbkNvdW50IHsKICAgICAgICAgICAgICAgIHdpbm5lcnNbaW5kZXhdID0gV2lubmluZ1BsYXllclBhcnNlZHsKICAgICAgICAgICAgICAgICAgICBQbGF5ZXJBZGRyZXNzOiBjYW5kaWRhdGUuSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgV29uQ291bnQ6ICAgICAgY2FuZGlkYXRlLldvbkNvdW50LAogICAgICAgICAgICAgICAgICAgIERhdGVBZGRlZDogICAgIG5vdywKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICB9CiAgICBpZiAhZm91bmQgewogICAgICAgIHVwZGF0ZWQgPSBhcHBlbmQod2lubmVycywgV2lubmluZ1BsYXllclBhcnNlZHsKICAgICAgICAgICAgUGxheWVyQWRkcmVzczogY2FuZGlkYXRlLkluZGV4LAogICAgICAgICAgICBXb25Db3VudDogICAgICBjYW5kaWRhdGUuV29uQ291bnQsCiAgICAgICAgICAgIERhdGVBZGRlZDogICAgIG5vdywKICAgICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgICB1cGRhdGVkID0gd2lubmVycwogICAgfQogICAgU29ydFdpbm5lcnModXBkYXRlZCkKICAgIGlmIExlYWRlcmJvYXJkV2lubmVyTGVuZ3RoICZsdDsgdWludDY0KGxlbih1cGRhdGVkKSkgewogICAgICAgIHVwZGF0ZWQgPSB1cGRhdGVkWzpMZWFkZXJib2FyZFdpbm5lckxlbmd0aF0KICAgIH0KICAgIHJldHVybiB1cGRhdGVkCn0KCmZ1bmMgKGxlYWRlcmJvYXJkICpMZWFkZXJib2FyZCkgVXBkYXRlUGxheWVySW5mb0F0Tm93KG5vdyB0aW1lLlRpbWUsIGNhbmRpZGF0ZSBQbGF5ZXJJbmZvKSBlcnJvciB7CiAgICB3aW5uZXJzLCBlcnIgOj0gbGVhZGVyYm9hcmQuUGFyc2VXaW5uZXJzKCkKICAgIGlmIGVyciAhPSBuaWwgewogICAgICAgIHJldHVybiBlcnIKICAgIH0KICAgIHVwZGF0ZWQgOj0gVXBkYXRlUGxheWVySW5mb0F0Tm93KHdpbm5lcnMsIG5vdywgY2FuZGlkYXRlKQogICAgbGVhZGVyYm9hcmQuV2lubmVycyA9IFN0cmluZ2lmeVdpbm5lcnModXBkYXRlZCkKICAgIGNhbmRpZGF0ZS5JbmRleCA9ICZxdW90O2Zha2UmcXVvdDsKICAgIHJldHVybiBuaWwKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard.go#L112-L155"}}),e._v(" "),o("h2",{attrs:{id:"v2-leaderboard-handling"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v2-leaderboard-handling"}},[e._v("#")]),e._v(" v2 leaderboard handling")]),e._v(" "),o("p",[e._v("You have created the leaderboard helper functions. In a separate file, add one last function to the keeper to implement the leaderboard. This function makes it possible to add a candidate winner and save the updated leaderboard:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBNdXN0QWRkVG9MZWFkZXJib2FyZChjdHggc2RrLkNvbnRleHQsIHdpbm5lckluZm8gdHlwZXMuUGxheWVySW5mbykgdHlwZXMuTGVhZGVyYm9hcmQgewogICAgbGVhZGVyYm9hcmQsIGZvdW5kIDo9IGsuR2V0TGVhZGVyYm9hcmQoY3R4KQogICAgaWYgIWZvdW5kIHsKICAgICAgICBwYW5pYygmcXVvdDtMZWFkZXJib2FyZCBub3QgZm91bmQmcXVvdDspCiAgICB9CiAgICBlcnIgOj0gbGVhZGVyYm9hcmQuVXBkYXRlUGxheWVySW5mb0F0Tm93KHR5cGVzLkdldERhdGVBZGRlZChjdHgpLCB3aW5uZXJJbmZvKQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcGFuaWMoZm10LlNwcmludGYodHlwZXMuRXJyQ2Fubm90QWRkVG9MZWFkZXJib2FyZC5FcnJvcigpLCBlcnIuRXJyb3IoKSkpCiAgICB9CiAgICBrLlNldExlYWRlcmJvYXJkKGN0eCwgbGVhZGVyYm9hcmQpCiAgICByZXR1cm4gbGVhZGVyYm9hcmQKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/leaderboard_handler.go#L10-L21"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("Be aware of the new error "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/errors.go#L32",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("ErrCannotAddToLeaderboard")]),o("OutboundLink")],1),e._v(".")])]),e._v(" "),o("p",[e._v("This completes most of the leaderboard preparation. The only task left is to call your new functions at the right junctures:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("On a win:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5XaW5uZXIgPT0gcnVsZXMuTk9fUExBWUVSLkNvbG9yIHsKICAgIC4uLgp9IGVsc2UgewogICAgLi4uCiAgICB3aW5uZXJJbmZvLCBfIDo9IGsuS2VlcGVyLk11c3RSZWdpc3RlclBsYXllcldpbihjdHgsICZhbXA7c3RvcmVkR2FtZSkKICAgIGsuS2VlcGVyLk11c3RBZGRUb0xlYWRlcmJvYXJkKGN0eCwgd2lubmVySW5mbykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move.go#L80-L81"}})],1),e._v(" "),o("li",[o("p",[e._v("On a forfeit:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgJmx0Oz0gMSB7CiAgICAuLi4KfSBlbHNlIHsKICAgIC4uLgogICAgd2lubmVySW5mbywgXyA6PSBrLk11c3RSZWdpc3RlclBsYXllckZvcmZlaXQoY3R4LCAmYW1wO3N0b3JlZEdhbWUpCiAgICBrLk11c3RBZGRUb0xlYWRlcmJvYXJkKGN0eCwgd2lubmVySW5mbykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/end_block_server_game.go#L57-L58"}})],1)]),e._v(" "),o("p",[e._v("Your leaderboard will now be updated and saved on an on-going basis as part of your v2 blockchain.")]),e._v(" "),o("h2",{attrs:{id:"unit-tests"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#unit-tests"}},[e._v("#")]),e._v(" Unit tests")]),e._v(" "),o("p",[e._v("With all these changes, it is worthwhile adding tests.")]),e._v(" "),o("h3",{attrs:{id:"player-info-handling-unit-tests"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#player-info-handling-unit-tests"}},[e._v("#")]),e._v(" Player info handling unit tests")]),e._v(" "),o("p",[e._v("Confirm with new tests that the player's information is created or updated on a win, a loss, and a forfeit. For instance, after a winning move:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0Q29tcGxldGVHYW1lQWRkUGxheWVySW5mbyh0ICp0ZXN0aW5nLlQpIHsKICAgIG1zZ1NlcnZlciwga2VlcGVyLCBjb250ZXh0LCBjdHJsLCBlc2Nyb3cgOj0gc2V0dXBNc2dTZXJ2ZXJXaXRoT25lR2FtZUZvclBsYXlNb3ZlKHQpCiAgICBjdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCkKICAgIGRlZmVyIGN0cmwuRmluaXNoKCkKICAgIGVzY3Jvdy5FeHBlY3RBbnkoY29udGV4dCkKCiAgICBwbGF5QWxsTW92ZXModCwgbXNnU2VydmVyLCBjb250ZXh0LCAmcXVvdDsxJnF1b3Q7LCBnYW1lMU1vdmVzKQoKICAgIGJvYkluZm8sIGZvdW5kIDo9IGtlZXBlci5HZXRQbGF5ZXJJbmZvKGN0eCwgYm9iKQogICAgcmVxdWlyZS5UcnVlKHQsIGZvdW5kKQogICAgcmVxdWlyZS5FcXVhbFZhbHVlcyh0LCB0eXBlcy5QbGF5ZXJJbmZvewogICAgICAgIEluZGV4OiAgICAgICAgICBib2IsCiAgICAgICAgV29uQ291bnQ6ICAgICAgIDEsCiAgICAgICAgTG9zdENvdW50OiAgICAgIDAsCiAgICAgICAgRm9yZmVpdGVkQ291bnQ6IDAsCiAgICB9LCBib2JJbmZvKQogICAgY2Fyb2xJbmZvLCBmb3VuZCA6PSBrZWVwZXIuR2V0UGxheWVySW5mbyhjdHgsIGNhcm9sKQogICAgcmVxdWlyZS5UcnVlKHQsIGZvdW5kKQogICAgcmVxdWlyZS5FcXVhbFZhbHVlcyh0LCB0eXBlcy5QbGF5ZXJJbmZvewogICAgICAgIEluZGV4OiAgICAgICAgICBjYXJvbCwKICAgICAgICBXb25Db3VudDogICAgICAgMCwKICAgICAgICBMb3N0Q291bnQ6ICAgICAgMSwKICAgICAgICBGb3JmZWl0ZWRDb3VudDogMCwKICAgIH0sIGNhcm9sSW5mbykKfQoKZnVuYyBUZXN0Q29tcGxldGVHYW1lVXBkYXRlUGxheWVySW5mbyh0ICp0ZXN0aW5nLlQpIHsKICAgIG1zZ1NlcnZlciwga2VlcGVyLCBjb250ZXh0LCBjdHJsLCBlc2Nyb3cgOj0gc2V0dXBNc2dTZXJ2ZXJXaXRoT25lR2FtZUZvclBsYXlNb3ZlKHQpCiAgICBjdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCkKICAgIGRlZmVyIGN0cmwuRmluaXNoKCkKICAgIGVzY3Jvdy5FeHBlY3RBbnkoY29udGV4dCkKCiAgICBrZWVwZXIuU2V0UGxheWVySW5mbyhjdHgsIHR5cGVzLlBsYXllckluZm97CiAgICAgICAgSW5kZXg6ICAgICAgICAgIGJvYiwKICAgICAgICBXb25Db3VudDogICAgICAgMSwKICAgICAgICBMb3N0Q291bnQ6ICAgICAgMiwKICAgICAgICBGb3JmZWl0ZWRDb3VudDogMywKICAgIH0pCiAgICBrZWVwZXIuU2V0UGxheWVySW5mbyhjdHgsIHR5cGVzLlBsYXllckluZm97CiAgICAgICAgSW5kZXg6ICAgICAgICAgIGNhcm9sLAogICAgICAgIFdvbkNvdW50OiAgICAgICA0LAogICAgICAgIExvc3RDb3VudDogICAgICA1LAogICAgICAgIEZvcmZlaXRlZENvdW50OiA2LAogICAgfSkKCiAgICBwbGF5QWxsTW92ZXModCwgbXNnU2VydmVyLCBjb250ZXh0LCAmcXVvdDsxJnF1b3Q7LCBnYW1lMU1vdmVzKQoKICAgIGJvYkluZm8sIGZvdW5kIDo9IGtlZXBlci5HZXRQbGF5ZXJJbmZvKGN0eCwgYm9iKQogICAgcmVxdWlyZS5UcnVlKHQsIGZvdW5kKQogICAgcmVxdWlyZS5FcXVhbFZhbHVlcyh0LCB0eXBlcy5QbGF5ZXJJbmZvewogICAgICAgIEluZGV4OiAgICAgICAgICBib2IsCiAgICAgICAgV29uQ291bnQ6ICAgICAgIDIsCiAgICAgICAgTG9zdENvdW50OiAgICAgIDIsCiAgICAgICAgRm9yZmVpdGVkQ291bnQ6IDMsCiAgICB9LCBib2JJbmZvKQogICAgY2Fyb2xJbmZvLCBmb3VuZCA6PSBrZWVwZXIuR2V0UGxheWVySW5mbyhjdHgsIGNhcm9sKQogICAgcmVxdWlyZS5UcnVlKHQsIGZvdW5kKQogICAgcmVxdWlyZS5FcXVhbFZhbHVlcyh0LCB0eXBlcy5QbGF5ZXJJbmZvewogICAgICAgIEluZGV4OiAgICAgICAgICBjYXJvbCwKICAgICAgICBXb25Db3VudDogICAgICAgNCwKICAgICAgICBMb3N0Q291bnQ6ICAgICAgNiwKICAgICAgICBGb3JmZWl0ZWRDb3VudDogNiwKICAgIH0sIGNhcm9sSW5mbykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move_winner_test.go#L143-L206"}}),e._v(" "),o("p",[e._v("You can add similar tests that confirm that nothing happens after a "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_create_game_test.go#L419-L498",target:"_blank",rel:"noopener noreferrer"}},[e._v("game creation"),o("OutboundLink")],1),e._v(", a "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_reject_game_test.go#L307-L381",target:"_blank",rel:"noopener noreferrer"}},[e._v("reject"),o("OutboundLink")],1),e._v(", or a "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move_test.go#L538-L596",target:"_blank",rel:"noopener noreferrer"}},[e._v("non-winning move"),o("OutboundLink")],1),e._v(". You should also check that a "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/end_block_server_game_test.go#L577-L682",target:"_blank",rel:"noopener noreferrer"}},[e._v("forfeit is registered"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("h3",{attrs:{id:"leaderboard-handling-unit-tests"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#leaderboard-handling-unit-tests"}},[e._v("#")]),e._v(" Leaderboard handling unit tests")]),e._v(" "),o("p",[e._v("Start by adding tests that confirm that the sorting of the leaderboard's winners works as expected. Here an array of test cases is a good choice:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0U29ydFN0cmluZ2lmaWVkV2lubmVycyh0ICp0ZXN0aW5nLlQpIHsKICAgIHRlc3RzIDo9IFtdc3RydWN0IHsKICAgICAgICBuYW1lICAgICBzdHJpbmcKICAgICAgICB1bnNvcnRlZCBbXXR5cGVzLldpbm5pbmdQbGF5ZXIKICAgICAgICBzb3J0ZWQgICBbXXR5cGVzLldpbm5pbmdQbGF5ZXIKICAgICAgICBlcnIgICAgICBlcnJvcgogICAgfXsKICAgICAgICB7CiAgICAgICAgICAgIG5hbWU6ICZxdW90O2Nhbm5vdCBwYXJzZSBkYXRlJnF1b3Q7LAogICAgICAgICAgICB1bnNvcnRlZDogW110eXBlcy5XaW5uaW5nUGxheWVyewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFBsYXllckFkZHJlc3M6ICZxdW90O2FsaWNlJnF1b3Q7LAogICAgICAgICAgICAgICAgICAgIFdvbkNvdW50OiAgICAgIDIsCiAgICAgICAgICAgICAgICAgICAgRGF0ZUFkZGVkOiAgICAgJnF1b3Q7MjAwVC0wMS0wMiAxNTowNTowNS45OTk5OTk5OTkgKzAwMDAgVVRDJnF1b3Q7LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc29ydGVkOiBbXXR5cGVzLldpbm5pbmdQbGF5ZXJ7fSwKICAgICAgICAgICAgZXJyOiAgICBlcnJvcnMuTmV3KCZxdW90O2RhdGVBZGRlZCBjYW5ub3QgYmUgcGFyc2VkOiAyMDBULTAxLTAyIDE1OjA1OjA1Ljk5OTk5OTk5OSArMDAwMCBVVEM6IHBhcnNpbmcgdGltZSBcJnF1b3Q7MjAwVC0wMS0wMiAxNTowNTowNS45OTk5OTk5OTkgKzAwMDAgVVRDXCZxdW90OyBhcyBcJnF1b3Q7MjAwNi0wMS0wMiAxNTowNDowNS45OTk5OTk5OTkgKzAwMDAgVVRDXCZxdW90OzogY2Fubm90IHBhcnNlIFwmcXVvdDstMDEtMDIgMTU6MDU6MDUuOTk5OTk5OTk5ICswMDAwIFVUQ1wmcXVvdDsgYXMgXCZxdW90OzIwMDZcJnF1b3Q7JnF1b3Q7KSwKICAgICAgICB9LAogICAgICAgIC4uLiAvLyBNb3JlIHRlc3QgY2FzZXMKICAgIH0KICAgIGZvciBfLCB0dCA6PSByYW5nZSB0ZXN0cyB7CiAgICAgICAgdC5SdW4odHQubmFtZSwgZnVuYyh0ICp0ZXN0aW5nLlQpIHsKICAgICAgICAgICAgbGVhZGVyYm9hcmQgOj0gdHlwZXMuTGVhZGVyYm9hcmR7CiAgICAgICAgICAgICAgICBXaW5uZXJzOiB0dC51bnNvcnRlZCwKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJzZWQsIGVyciA6PSBsZWFkZXJib2FyZC5QYXJzZVdpbm5lcnMoKQogICAgICAgICAgICBpZiB0dC5lcnIgIT0gbmlsIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUuRXF1YWxFcnJvcih0LCBlcnIsIHR0LmVyci5FcnJvcigpKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVxdWlyZS5Ob0Vycm9yKHQsIGVycikKICAgICAgICAgICAgfQogICAgICAgICAgICB0eXBlcy5Tb3J0V2lubmVycyhwYXJzZWQpCiAgICAgICAgICAgIHNvcnRlZCA6PSB0eXBlcy5TdHJpbmdpZnlXaW5uZXJzKHBhcnNlZCkKICAgICAgICAgICAgcmVxdWlyZS5FcXVhbCh0LCBsZW4odHQuc29ydGVkKSwgbGVuKHNvcnRlZCkpCiAgICAgICAgICAgIHJlcXVpcmUuRXF1YWxWYWx1ZXModCwgdHQuc29ydGVkLCBzb3J0ZWQpCiAgICAgICAgfSkKICAgIH0KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard_test.go#L12-L152"}}),e._v(" "),o("p",[e._v("With that done, you can confirm that the updating or addition of new player info to the leaderboard works as expected, again with an array of test cases:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0VXBkYXRlUGxheWVySW5mb0F0Tm93KHQgKnRlc3RpbmcuVCkgewogICAgdGVzdHMgOj0gW11zdHJ1Y3QgewogICAgICAgIG5hbWUgICAgICBzdHJpbmcKICAgICAgICBzb3J0ZWQgICAgW110eXBlcy5XaW5uaW5nUGxheWVyCiAgICAgICAgY2FuZGlkYXRlIHR5cGVzLlBsYXllckluZm8KICAgICAgICBub3cgICAgICAgc3RyaW5nCiAgICAgICAgZXhwZWN0ZWQgIFtddHlwZXMuV2lubmluZ1BsYXllcgogICAgfXsKICAgICAgICB7CiAgICAgICAgICAgIG5hbWU6ICAgJnF1b3Q7YWRkIHRvIGVtcHR5JnF1b3Q7LAogICAgICAgICAgICBzb3J0ZWQ6IFtddHlwZXMuV2lubmluZ1BsYXllcnt9LAogICAgICAgICAgICBjYW5kaWRhdGU6IHR5cGVzLlBsYXllckluZm97CiAgICAgICAgICAgICAgICBJbmRleDogICAgJnF1b3Q7YWxpY2UmcXVvdDssCiAgICAgICAgICAgICAgICBXb25Db3VudDogMiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbm93OiAmcXVvdDsyMDA2LTAxLTAyIDE1OjA1OjA1Ljk5OTk5OTk5OSArMDAwMCBVVEMmcXVvdDssCiAgICAgICAgICAgIGV4cGVjdGVkOiBbXXR5cGVzLldpbm5pbmdQbGF5ZXJ7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgUGxheWVyQWRkcmVzczogJnF1b3Q7YWxpY2UmcXVvdDssCiAgICAgICAgICAgICAgICAgICAgV29uQ291bnQ6ICAgICAgMiwKICAgICAgICAgICAgICAgICAgICBEYXRlQWRkZWQ6ICAgICAmcXVvdDsyMDA2LTAxLTAyIDE1OjA1OjA1Ljk5OTk5OTk5OSArMDAwMCBVVEMmcXVvdDssCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgICAgLi4uIC8vIE1vcmUgdGVzdCBjYXNlcwogICAgfQogICAgZm9yIF8sIHR0IDo9IHJhbmdlIHRlc3RzIHsKICAgICAgICB0LlJ1bih0dC5uYW1lLCBmdW5jKHQgKnRlc3RpbmcuVCkgewogICAgICAgICAgICBub3csIGVyciA6PSB0eXBlcy5QYXJzZURhdGVBZGRlZEFzVGltZSh0dC5ub3cpCiAgICAgICAgICAgIHJlcXVpcmUuTm9FcnJvcih0LCBlcnIpCiAgICAgICAgICAgIGxlYWRlcmJvYXJkIDo9IHR5cGVzLkxlYWRlcmJvYXJkewogICAgICAgICAgICAgICAgV2lubmVyczogdHQuc29ydGVkLAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVyciA9IGxlYWRlcmJvYXJkLlVwZGF0ZVBsYXllckluZm9BdE5vdyhub3csIHR0LmNhbmRpZGF0ZSkKICAgICAgICAgICAgcmVxdWlyZS5Ob0Vycm9yKHQsIGVycikKICAgICAgICAgICAgcmVxdWlyZS5FcXVhbCh0LCBsZW4odHQuZXhwZWN0ZWQpLCBsZW4obGVhZGVyYm9hcmQuV2lubmVycykpCiAgICAgICAgICAgIHJlcXVpcmUuRXF1YWxWYWx1ZXModCwgdHQuZXhwZWN0ZWQsIGxlYWRlcmJvYXJkLldpbm5lcnMpCiAgICAgICAgICAgIHJlcXVpcmUuTm9FcnJvcih0LCBsZWFkZXJib2FyZC5WYWxpZGF0ZSgpKQogICAgICAgIH0pCiAgICB9Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard_test.go#L154-L387"}}),e._v(" "),o("p",[e._v("Do not forget to also test at the length limit. For instance:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBtYWtlTWF4TGVuZ3RoU29ydGVkV2lubmluZ1BsYXllcnMoKSBbXXR5cGVzLldpbm5pbmdQbGF5ZXIgewogICAgc29ydGVkIDo9IG1ha2UoW110eXBlcy5XaW5uaW5nUGxheWVyLCAxMDApCiAgICBmb3IgaSA6PSB1aW50NjQoMCk7IGkgJmx0OyAxMDA7IGkrKyB7CiAgICAgICAgc29ydGVkW2ldID0gdHlwZXMuV2lubmluZ1BsYXllcnsKICAgICAgICAgICAgUGxheWVyQWRkcmVzczogc3RyY29udi5Gb3JtYXRVaW50KGksIDEwKSwKICAgICAgICAgICAgV29uQ291bnQ6ICAgICAgMTAxIC0gaSwKICAgICAgICAgICAgRGF0ZUFkZGVkOiAgICAgJnF1b3Q7MjAwNi0wMS0wMiAxNTowNTowNS45OTk5OTk5OTkgKzAwMDAgVVRDJnF1b3Q7LAogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBzb3J0ZWQKfQoKZnVuYyBUZXN0VXBkYXRlUGxheWVySW5mb0F0Tm93VG9vTG9uZ05vQWRkKHQgKnRlc3RpbmcuVCkgewogICAgYmVmb3JlV2lubmVycyA6PSBtYWtlTWF4TGVuZ3RoU29ydGVkV2lubmluZ1BsYXllcnMoKQogICAgbm93LCBlcnIgOj0gdHlwZXMuUGFyc2VEYXRlQWRkZWRBc1RpbWUoJnF1b3Q7MjAwNi0wMS0wMiAxNTowNTowNS45OTk5OTk5OTkgKzAwMDAgVVRDJnF1b3Q7KQogICAgcmVxdWlyZS5Ob0Vycm9yKHQsIGVycikKICAgIGxlYWRlcmJvYXJkIDo9IHR5cGVzLkxlYWRlcmJvYXJkewogICAgICAgIFdpbm5lcnM6IGJlZm9yZVdpbm5lcnMsCiAgICB9CiAgICBlcnIgPSBsZWFkZXJib2FyZC5VcGRhdGVQbGF5ZXJJbmZvQXROb3cobm93LCB0eXBlcy5QbGF5ZXJJbmZvewogICAgICAgIEluZGV4OiAgICAmcXVvdDsxMDAmcXVvdDssCiAgICAgICAgV29uQ291bnQ6IDEsCiAgICB9KQogICAgcmVxdWlyZS5Ob0Vycm9yKHQsIGVycikKICAgIHJlcXVpcmUuRXF1YWwodCwgbGVuKGJlZm9yZVdpbm5lcnMpLCBsZW4obGVhZGVyYm9hcmQuV2lubmVycykpCiAgICByZXF1aXJlLkVxdWFsVmFsdWVzKHQsIGJlZm9yZVdpbm5lcnMsIGxlYWRlcmJvYXJkLldpbm5lcnMpCiAgICByZXF1aXJlLk5vRXJyb3IodCwgbGVhZGVyYm9hcmQuVmFsaWRhdGUoKSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/types/leaderboard_test.go#L389-L416"}}),e._v(" "),o("p",[e._v("With the tests at the leaderboard level done, you can move to unit tests at the keeper level. Confirm that there are no changes on "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_create_game_test.go#L500-L553",target:"_blank",rel:"noopener noreferrer"}},[e._v("creating a game"),o("OutboundLink")],1),e._v(", "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_reject_game_test.go#L383-L444",target:"_blank",rel:"noopener noreferrer"}},[e._v("rejecting one"),o("OutboundLink")],1),e._v(", and on a "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move_test.go#L598-L651",target:"_blank",rel:"noopener noreferrer"}},[e._v("regular move"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("p",[e._v("Confirm that a new winner is either "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move_winner_test.go#L208-L225",target:"_blank",rel:"noopener noreferrer"}},[e._v("added"),o("OutboundLink")],1),e._v(" or updated in the leaderboard:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0Q29tcGxldGVHYW1lTGVhZGVyYm9hcmRVcGRhdGVkV2lubmVyKHQgKnRlc3RpbmcuVCkgewogICAgbXNnU2VydmVyLCBrZWVwZXIsIGNvbnRleHQsIGN0cmwsIGVzY3JvdyA6PSBzZXR1cE1zZ1NlcnZlcldpdGhPbmVHYW1lRm9yUGxheU1vdmUodCkKICAgIGN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjb250ZXh0KQogICAgZGVmZXIgY3RybC5GaW5pc2goKQogICAgZXNjcm93LkV4cGVjdEFueShjb250ZXh0KQogICAga2VlcGVyLlNldFBsYXllckluZm8oY3R4LCB0eXBlcy5QbGF5ZXJJbmZvewogICAgICAgIEluZGV4OiAgICBib2IsCiAgICAgICAgV29uQ291bnQ6IDIsCiAgICB9KQogICAga2VlcGVyLlNldExlYWRlcmJvYXJkKGN0eCwgdHlwZXMuTGVhZGVyYm9hcmR7CiAgICAgICAgV2lubmVyczogW110eXBlcy5XaW5uaW5nUGxheWVyewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBQbGF5ZXJBZGRyZXNzOiBib2IsCiAgICAgICAgICAgICAgICBXb25Db3VudDogICAgICAyLAogICAgICAgICAgICAgICAgRGF0ZUFkZGVkOiAgICAgJnF1b3Q7MjAwNi0wMS0wMiAxNTowNTowNi45OTk5OTk5OTkgKzAwMDAgVVRDJnF1b3Q7LAogICAgICAgICAgICB9LAogICAgICAgIH0sCiAgICB9KQoKICAgIHBsYXlBbGxNb3Zlcyh0LCBtc2dTZXJ2ZXIsIGNvbnRleHQsICZxdW90OzEmcXVvdDssIGdhbWUxTW92ZXMpCgogICAgbGVhZGVyYm9hcmQsIGZvdW5kIDo9IGtlZXBlci5HZXRMZWFkZXJib2FyZChjdHgpCiAgICByZXF1aXJlLlRydWUodCwgZm91bmQpCiAgICByZXF1aXJlLkVxdWFsVmFsdWVzKHQsIFtddHlwZXMuV2lubmluZ1BsYXllcnsKICAgICAgICB7CiAgICAgICAgICAgIFBsYXllckFkZHJlc3M6IGJvYiwKICAgICAgICAgICAgV29uQ291bnQ6ICAgICAgMywKICAgICAgICAgICAgRGF0ZUFkZGVkOiAgICAgdHlwZXMuRm9ybWF0RGF0ZUFkZGVkKHR5cGVzLkdldERhdGVBZGRlZChjdHgpKSwKICAgICAgICB9LAogICAgfSwgbGVhZGVyYm9hcmQuV2lubmVycykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/msg_server_play_move_winner_test.go#L227-L257"}}),e._v(" "),o("p",[e._v("Now do the same on "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/end_block_server_game_test.go#L684-L794",target:"_blank",rel:"noopener noreferrer"}},[e._v("a forfeit"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("p",[e._v("This completes your Checkers V2 chain. If you were to start it anew as is, it would work. However, you already have the V1 of Checkers running, so you need to migrate everything.")]),e._v(" "),o("h2",{attrs:{id:"v1-to-v2-player-information-migration-helper"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v1-to-v2-player-information-migration-helper"}},[e._v("#")]),e._v(" v1 to v2 player information migration helper")]),e._v(" "),o("p",[e._v("With your v2 blockchain now fully operational on its own, it is time to work on the issue of stored data migration.")]),e._v(" "),o("p",[e._v("First, tackle the creation of player information. You will build the player information by extracting it from all the existing stored games. In the "),o("a",{attrs:{href:"https://en.wikipedia.org/wiki/MapReduce",target:"_blank",rel:"noopener noreferrer"}},[e._v("map/reduce"),o("OutboundLink")],1),e._v(" parlance, you will "),o("em",[e._v("reduce")]),e._v(" this information from the stored games.")]),e._v(" "),o("h3",{attrs:{id:"problem-description"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#problem-description"}},[e._v("#")]),e._v(" Problem description")]),e._v(" "),o("p",[e._v("If performance was not an issue, an easy way to do it would be the following:")]),e._v(" "),o("ol",[o("li",[e._v("Call "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/stored_game.go#L50",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("keeper.GetAllStoredGame()")]),o("OutboundLink")],1),e._v(" to get an array with all the games.")]),e._v(" "),o("li",[e._v("Keep only the games that have a winner.")]),e._v(" "),o("li",[e._v("Then for each game:\n"),o("ol",[o("li",[e._v("Call "),o("code",[e._v("keeper.GetPlayerInfo")]),e._v(" or, if that is not found, create player info, both for the black player and the red player.")]),e._v(" "),o("li",[e._v("Do "),o("code",[e._v("+1")]),e._v(" on "),o("code",[e._v(".WonCount")]),e._v(" or "),o("code",[e._v(".LostCount")]),e._v(" according to the "),o("code",[e._v("game.Winner")]),e._v(" field.")]),e._v(" "),o("li",[e._v("Call "),o("code",[e._v("keeper.SetPlayerInfo")]),e._v(" for both black and red players.")])])])]),e._v(" "),o("p",[e._v("Of course, given inevitable resource limitations, you would run into the following problems:")]),e._v(" "),o("ol",[o("li",[e._v("Getting all the games in a single array may not be possible, because your node's RAM may not be able to keep a million of them in memory. Or maybe it fails at 100,000 of them.")]),e._v(" "),o("li",[e._v("Calling "),o("code",[e._v(".GetPlayerInfo")]),e._v(" and "),o("code",[e._v(".SetPlayerInfo")]),e._v(" twice per game just to do "),o("code",[e._v("+1")]),e._v(" adds up quickly. Remember that both of these calls are database calls. You could be confronted with a 12-hour job, during which your chain is offline.")]),e._v(" "),o("li",[e._v("Doing it all in a sequential manner would take even more time, as each blocking call blocks the whole process.")])]),e._v(" "),o("h3",{attrs:{id:"proposed-solution"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#proposed-solution"}},[e._v("#")]),e._v(" Proposed solution")]),e._v(" "),o("p",[e._v("Fortunately, there exist ways to mitigate these limitations:")]),e._v(" "),o("ol",[o("li",[e._v("You do not need to get all the games at once. The "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/keeper/grpc_query_stored_game.go#L14",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("keeper.StoredGameAll")]),o("OutboundLink")],1),e._v(" function offers pagination. With this, you can limit the impact on the RAM requirement, at the expense of multiple queries.")]),e._v(" "),o("li",[e._v("Within each subset of games, you can compute in memory the player list and how many wins and losses each player has. With this "),o("em",[e._v("mapping")]),e._v(" done, you can add the (in-memory) intermediary "),o("code",[e._v("WonCount")]),e._v(" and "),o("code",[e._v("LostCount")]),e._v(" sums to each player's stored sums. With this, a "),o("code",[e._v("+1")]),e._v(" is potentially replaced by a "),o("code",[e._v("+k")]),e._v(", at once reducing the number of calls to "),o("code",[e._v(".GetPlayerInfo")]),e._v(" and "),o("code",[e._v(".SetPlayerInfo")]),e._v(".")]),e._v(" "),o("li",[e._v("You can separate the different calls and computations into "),o("a",{attrs:{href:"https://gobyexample.com/goroutines",target:"_blank",rel:"noopener noreferrer"}},[e._v("Go routines"),o("OutboundLink")],1),e._v(" so that a blocking call does not prevent other computations from taking place in the meantime.")])]),e._v(" "),o("p",[e._v("The routines will use "),o("strong",[e._v("channels")]),e._v(" to communicate between themselves and the main function:")]),e._v(" "),o("ol",[o("li",[e._v("A "),o("em",[e._v("stored-game")]),e._v(" channel, that will pass along chunks of games in the "),o("code",[e._v("[]types.StoredGame")]),e._v(" format.")]),e._v(" "),o("li",[e._v("A "),o("em",[e._v("player-info")]),e._v(" channel, that will pass along intermediate computations of player information in the simple "),o("code",[e._v("types.PlayerInfo")]),e._v(" format.")]),e._v(" "),o("li",[e._v("A "),o("em",[e._v("done")]),e._v(" channel, whose only purpose is to flag to the main function when all has been processed.")])]),e._v(" "),o("p",[e._v("The processing "),o("strong",[e._v("routines")]),e._v(" will be divided as per the following:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("The "),o("strong",[e._v("game processing")]),e._v(" routine will:")]),e._v(" "),o("ul",[o("li",[e._v("Receive separate arrays of games from the "),o("em",[e._v("stored-game")]),e._v(" channel.")]),e._v(" "),o("li",[e._v("Compute the aggregate player info records from them. I.e. "),o("strong",[o("em",[e._v("map")])]),e._v(".")]),e._v(" "),o("li",[e._v("Send the results on the "),o("em",[e._v("player-info")]),e._v(" channel.")])]),e._v(" "),o("p",[e._v("Also, if it detects that no more games are coming, it will close the "),o("em",[e._v("player-info")]),e._v(" channel.")])]),e._v(" "),o("li",[o("p",[e._v("The "),o("strong",[e._v("player info processing")]),e._v(" routine will:")]),e._v(" "),o("ul",[o("li",[e._v("Receive individual player info records from the "),o("em",[e._v("player-info")]),e._v(" channel.")]),e._v(" "),o("li",[e._v("Fetch the existing (or not) corresponding player info from the store.")]),e._v(" "),o("li",[e._v("Update the won and lost counts, i.e. "),o("strong",[o("em",[e._v("reduce")])]),e._v(". Remember, here it is doing "),o("code",[e._v("+= k")]),e._v(", not "),o("code",[e._v("+= 1")]),e._v(".")]),e._v(" "),o("li",[e._v("Save it back to the store.")])]),e._v(" "),o("p",[e._v("Also, if it detects that no more player info records are coming, it will flag it on the "),o("em",[e._v("done")]),e._v(" channel.")])]),e._v(" "),o("li",[o("p",[e._v("The "),o("strong",[e._v("main function")]),e._v(" will:")]),e._v(" "),o("ul",[o("li",[e._v("Launch the above 2 routines.")]),e._v(" "),o("li",[e._v("Fetch all games in paginated arrays.")]),e._v(" "),o("li",[e._v("Send the separate arrays on the "),o("em",[e._v("stored-game")]),e._v(" channel.")]),e._v(" "),o("li",[e._v("Close the "),o("em",[e._v("stored-game")]),e._v(" channel after the last array.")]),e._v(" "),o("li",[e._v("Wait for the flag on the "),o("em",[e._v("done")]),e._v(" channel.")]),e._v(" "),o("li",[e._v("Exit.")])])])]),e._v(" "),o("h3",{attrs:{id:"implementation"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#implementation"}},[e._v("#")]),e._v(" Implementation")]),e._v(" "),o("p",[e._v("The player info processing will handle an in-memory map of player addresses to their information: "),o("code",[e._v("map[string]*types.PlayerInfo")]),e._v(". Create a new file to encapsulate this whole processing. Start by creating a helper that automatically populates it with empty values when information is missing:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBnZXRPck5ld1BsYXllckluZm9Jbk1hcChpbmZvU29GYXIgKm1hcFtzdHJpbmddKnR5cGVzLlBsYXllckluZm8sIHBsYXllckluZGV4IHN0cmluZykgKHBsYXllckluZm8gKnR5cGVzLlBsYXllckluZm8pIHsKICAgIHBsYXllckluZm8sIGZvdW5kIDo9ICgqaW5mb1NvRmFyKVtwbGF5ZXJJbmRleF0KICAgIGlmICFmb3VuZCB7CiAgICAgICAgcGxheWVySW5mbyA9ICZhbXA7dHlwZXMuUGxheWVySW5mb3sKICAgICAgICAgICAgSW5kZXg6ICAgICAgICAgIHBsYXllckluZGV4LAogICAgICAgICAgICBXb25Db3VudDogICAgICAgMCwKICAgICAgICAgICAgTG9zdENvdW50OiAgICAgIDAsCiAgICAgICAgICAgIEZvcmZlaXRlZENvdW50OiAwLAogICAgICAgIH0KICAgICAgICAoKmluZm9Tb0ZhcilbcGxheWVySW5kZXhdID0gcGxheWVySW5mbwogICAgfQogICAgcmV0dXJuIHBsYXllckluZm8KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_player_info.go#L11-L23"}}),e._v(" "),o("p",[e._v("Next, create the routine function to process the games:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBoYW5kbGVTdG9yZWRHYW1lQ2hhbm5lbChjdHggc2RrLkNvbnRleHQsCiAgICBrIGtlZXBlci5LZWVwZXIsCiAgICBnYW1lc0NoYW5uZWwgJmx0Oy1jaGFuIFtddHlwZXMuU3RvcmVkR2FtZSwKICAgIHBsYXllckluZm9DaGFubmVsIGNoYW4mbHQ7LSAqdHlwZXMuUGxheWVySW5mbykgewogICAgZm9yIGdhbWVzIDo9IHJhbmdlIGdhbWVzQ2hhbm5lbCB7CiAgICAgICAgcGxheWVySW5mb3MgOj0gbWFrZShtYXBbc3RyaW5nXSp0eXBlcy5QbGF5ZXJJbmZvLCBsZW4oZ2FtZXMpKQogICAgICAgIGZvciBfLCBnYW1lIDo9IHJhbmdlIGdhbWVzIHsKICAgICAgICAgICAgdmFyIHdpbm5lciBzdHJpbmcKICAgICAgICAgICAgdmFyIGxvc2VyIHN0cmluZwogICAgICAgICAgICBpZiBnYW1lLldpbm5lciA9PSBydWxlcy5QaWVjZVN0cmluZ3NbcnVsZXMuQkxBQ0tfUExBWUVSXSB7CiAgICAgICAgICAgICAgICB3aW5uZXIgPSBnYW1lLkJsYWNrCiAgICAgICAgICAgICAgICBsb3NlciA9IGdhbWUuUmVkCiAgICAgICAgICAgIH0gZWxzZSBpZiBnYW1lLldpbm5lciA9PSBydWxlcy5QaWVjZVN0cmluZ3NbcnVsZXMuUkVEX1BMQVlFUl0gewogICAgICAgICAgICAgICAgd2lubmVyID0gZ2FtZS5SZWQKICAgICAgICAgICAgICAgIGxvc2VyID0gZ2FtZS5CbGFjawogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgICBnZXRPck5ld1BsYXllckluZm9Jbk1hcCgmYW1wO3BsYXllckluZm9zLCB3aW5uZXIpLldvbkNvdW50KysKICAgICAgICAgICAgZ2V0T3JOZXdQbGF5ZXJJbmZvSW5NYXAoJmFtcDtwbGF5ZXJJbmZvcywgbG9zZXIpLkxvc3RDb3VudCsrCiAgICAgICAgfQogICAgICAgIGZvciBfLCBwbGF5ZXJJbmZvIDo9IHJhbmdlIHBsYXllckluZm9zIHsKICAgICAgICAgICAgcGxheWVySW5mb0NoYW5uZWwgJmx0Oy0gcGxheWVySW5mbwogICAgICAgIH0KICAgIH0KICAgIGNsb3NlKHBsYXllckluZm9DaGFubmVsKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_player_info.go#L25-L51"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("This function can handle the edge case where black and red both refer to the same player.")])]),e._v(" "),o("p",[e._v("Create the routine function to process the player info:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBoYW5kbGVQbGF5ZXJJbmZvQ2hhbm5lbChjdHggc2RrLkNvbnRleHQsIGsga2VlcGVyLktlZXBlciwKICAgIHBsYXllckluZm9DaGFubmVsICZsdDstY2hhbiAqdHlwZXMuUGxheWVySW5mbywKICAgIGRvbmUgY2hhbiZsdDstIGJvb2wpIHsKICAgIGZvciByZWNlaXZlZEluZm8gOj0gcmFuZ2UgcGxheWVySW5mb0NoYW5uZWwgewogICAgICAgIGlmIHJlY2VpdmVkSW5mbyAhPSBuaWwgewogICAgICAgICAgICBleGlzdGluZ0luZm8sIGZvdW5kIDo9IGsuR2V0UGxheWVySW5mbyhjdHgsIHJlY2VpdmVkSW5mby5JbmRleCkKICAgICAgICAgICAgaWYgZm91bmQgewogICAgICAgICAgICAgICAgZXhpc3RpbmdJbmZvLldvbkNvdW50ICs9IHJlY2VpdmVkSW5mby5Xb25Db3VudAogICAgICAgICAgICAgICAgZXhpc3RpbmdJbmZvLkxvc3RDb3VudCArPSByZWNlaXZlZEluZm8uTG9zdENvdW50CiAgICAgICAgICAgICAgICBleGlzdGluZ0luZm8uRm9yZmVpdGVkQ291bnQgKz0gcmVjZWl2ZWRJbmZvLkZvcmZlaXRlZENvdW50CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0luZm8gPSAqcmVjZWl2ZWRJbmZvCiAgICAgICAgICAgIH0KICAgICAgICAgICAgay5TZXRQbGF5ZXJJbmZvKGN0eCwgZXhpc3RpbmdJbmZvKQogICAgICAgIH0KICAgIH0KICAgIGRvbmUgJmx0Oy0gdHJ1ZQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_player_info.go#L53-L70"}}),e._v(" "),o("p",[e._v("Now you can create the main function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBNYXBTdG9yZWRHYW1lc1JlZHVjZVRvUGxheWVySW5mbyhjdHggc2RrLkNvbnRleHQsIGsga2VlcGVyLktlZXBlciwgY2h1bmsgdWludDY0KSBlcnJvciB7CiAgICBjb250ZXh0IDo9IHNkay5XcmFwU0RLQ29udGV4dChjdHgpCiAgICByZXNwb25zZSwgZXJyIDo9IGsuU3RvcmVkR2FtZUFsbChjb250ZXh0LCAmYW1wO3R5cGVzLlF1ZXJ5QWxsU3RvcmVkR2FtZVJlcXVlc3R7CiAgICAgICAgUGFnaW5hdGlvbjogJmFtcDtxdWVyeS5QYWdlUmVxdWVzdHsKICAgICAgICAgICAgTGltaXQ6IGNodW5rLAogICAgICAgIH0sCiAgICB9KQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcmV0dXJuIGVycgogICAgfQogICAgZ2FtZXNDaGFubmVsIDo9IG1ha2UoY2hhbiBbXXR5cGVzLlN0b3JlZEdhbWUpCiAgICBwbGF5ZXJJbmZvQ2hhbm5lbCA6PSBtYWtlKGNoYW4gKnR5cGVzLlBsYXllckluZm8pCiAgICBkb25lIDo9IG1ha2UoY2hhbiBib29sKQoKICAgIGdvIGhhbmRsZVN0b3JlZEdhbWVDaGFubmVsKGN0eCwgaywgZ2FtZXNDaGFubmVsLCBwbGF5ZXJJbmZvQ2hhbm5lbCkKICAgIGdvIGhhbmRsZVBsYXllckluZm9DaGFubmVsKGN0eCwgaywgcGxheWVySW5mb0NoYW5uZWwsIGRvbmUpCiAgICBnYW1lc0NoYW5uZWwgJmx0Oy0gcmVzcG9uc2UuU3RvcmVkR2FtZQoKICAgIGZvciByZXNwb25zZS5QYWdpbmF0aW9uLk5leHRLZXkgIT0gbmlsIHsKICAgICAgICByZXNwb25zZSwgZXJyID0gay5TdG9yZWRHYW1lQWxsKGNvbnRleHQsICZhbXA7dHlwZXMuUXVlcnlBbGxTdG9yZWRHYW1lUmVxdWVzdHsKICAgICAgICAgICAgUGFnaW5hdGlvbjogJmFtcDtxdWVyeS5QYWdlUmVxdWVzdHsKICAgICAgICAgICAgICAgIEtleTogICByZXNwb25zZS5QYWdpbmF0aW9uLk5leHRLZXksCiAgICAgICAgICAgICAgICBMaW1pdDogY2h1bmssCiAgICAgICAgICAgIH0sCiAgICAgICAgfSkKICAgICAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICAgICAgcmV0dXJuIGVycgogICAgICAgIH0KICAgICAgICBnYW1lc0NoYW5uZWwgJmx0Oy0gcmVzcG9uc2UuU3RvcmVkR2FtZQogICAgfQogICAgY2xvc2UoZ2FtZXNDaGFubmVsKQoKICAgICZsdDstZG9uZQogICAgcmV0dXJuIG5pbAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_player_info.go#L72-L106"}}),e._v(" "),o("h2",{attrs:{id:"v1-to-v2-leaderboard-migration-helper"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v1-to-v2-leaderboard-migration-helper"}},[e._v("#")]),e._v(" v1 to v2 leaderboard migration helper")]),e._v(" "),o("p",[e._v("You could decide to build the leaderboard as the player stats list is being built, mimicking the regular operation of your v2 checkers blockchain. Unfortunately, that would entail a lot of array sorting for what are just intermediate player stats. Instead, it is better to build the v2 leaderboard only after all player stats have been gathered.")]),e._v(" "),o("p",[e._v("In the process, there are two time-consuming parts:")]),e._v(" "),o("ol",[o("li",[e._v("Fetching the stored player info records in a paginated way, consuming mostly database resources.")]),e._v(" "),o("li",[e._v("Sorting each intermediate leaderboard, consuming mostly computation resources.")])]),e._v(" "),o("p",[e._v("It looks beneficial to use a Go routine in this case too, and a "),o("em",[e._v("player info")]),e._v(" channel to pass along arrays of player info records.")]),e._v(" "),o("p",[e._v("In practice, repeatedly building the intermediate leaderboard means adding "),o("em",[e._v("k")]),e._v(" new "),o("code",[e._v("winningPlayerParsed")]),e._v(" to the sorted array, sorting it, clipping it to "),o("code",[e._v("LeaderboardWinnerLength")]),e._v(", and repeating. What constitutes a good "),o("em",[e._v("k")]),e._v(" value should be dictated by testing and performance measurements. However, you can start with your best guess in a new file created for this purpose:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgUGxheWVySW5mb0NodW5rU2l6ZSA9IHR5cGVzLkxlYWRlcmJvYXJkV2lubmVyTGVuZ3RoICogMgo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/constants.go#L7"}}),e._v(" "),o("h3",{attrs:{id:"implementation-2"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#implementation-2"}},[e._v("#")]),e._v(" Implementation")]),e._v(" "),o("p",[e._v("Start by adding small helpers into a new file, so that you can easily append and sort player info records:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBhZGRQYXJzZWRDYW5kaWRhdGVzQW5kU29ydChwYXJzZWRXaW5uZXJzIFtddHlwZXMuV2lubmluZ1BsYXllclBhcnNlZCwgY2FuZGlkYXRlcyBbXXR5cGVzLldpbm5pbmdQbGF5ZXJQYXJzZWQpIFtddHlwZXMuV2lubmluZ1BsYXllclBhcnNlZCB7CiAgICB1cGRhdGVkIDo9IGFwcGVuZChwYXJzZWRXaW5uZXJzLCBjYW5kaWRhdGVzLi4uKQogICAgdHlwZXMuU29ydFdpbm5lcnModXBkYXRlZCkKICAgIGlmIHR5cGVzLkxlYWRlcmJvYXJkV2lubmVyTGVuZ3RoICZsdDsgdWludDY0KGxlbih1cGRhdGVkKSkgewogICAgICAgIHVwZGF0ZWQgPSB1cGRhdGVkWzp0eXBlcy5MZWFkZXJib2FyZFdpbm5lckxlbmd0aF0KICAgIH0KICAgIHJldHVybiB1cGRhdGVkCn0KCmZ1bmMgQWRkQ2FuZGlkYXRlc0FuZFNvcnRBdE5vdyhwYXJzZWRXaW5uZXJzIFtddHlwZXMuV2lubmluZ1BsYXllclBhcnNlZCwgbm93IHRpbWUuVGltZSwgcGxheWVySW5mb3MgW110eXBlcy5QbGF5ZXJJbmZvKSBbXXR5cGVzLldpbm5pbmdQbGF5ZXJQYXJzZWQgewogICAgcGFyc2VkUGxheWVycyA6PSBtYWtlKFtddHlwZXMuV2lubmluZ1BsYXllclBhcnNlZCwgMCwgbGVuKHBsYXllckluZm9zKSkKICAgIGZvciBfLCBwbGF5ZXJJbmZvIDo9IHJhbmdlIHBsYXllckluZm9zIHsKICAgICAgICBpZiBwbGF5ZXJJbmZvLldvbkNvdW50ICZndDsgMCB7CiAgICAgICAgICAgIHBhcnNlZFBsYXllcnMgPSBhcHBlbmQocGFyc2VkUGxheWVycywgdHlwZXMuV2lubmluZ1BsYXllclBhcnNlZHsKICAgICAgICAgICAgICAgIFBsYXllckFkZHJlc3M6IHBsYXllckluZm8uSW5kZXgsCiAgICAgICAgICAgICAgICBXb25Db3VudDogICAgICBwbGF5ZXJJbmZvLldvbkNvdW50LAogICAgICAgICAgICAgICAgRGF0ZUFkZGVkOiAgICAgbm93LAogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBhZGRQYXJzZWRDYW5kaWRhdGVzQW5kU29ydChwYXJzZWRXaW5uZXJzLCBwYXJzZWRQbGF5ZXJzKQp9CgpmdW5jIEFkZENhbmRpZGF0ZXNBbmRTb3J0KHBhcnNlZFdpbm5lcnMgW110eXBlcy5XaW5uaW5nUGxheWVyUGFyc2VkLCBjdHggc2RrLkNvbnRleHQsIHBsYXllckluZm9zIFtddHlwZXMuUGxheWVySW5mbykgW110eXBlcy5XaW5uaW5nUGxheWVyUGFyc2VkIHsKICAgIHJldHVybiBBZGRDYW5kaWRhdGVzQW5kU29ydEF0Tm93KHBhcnNlZFdpbm5lcnMsIHR5cGVzLkdldERhdGVBZGRlZChjdHgpLCBwbGF5ZXJJbmZvcykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_leaderboard.go#L12-L37"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[o("code",[e._v("addParsedCandidatesAndSort")]),e._v(" is not exported because it already assumes that the "),o("code",[e._v("candidates")]),e._v(" do not contain any with "),o("code",[e._v("WinCount == 0")]),e._v(". This is an assumption that is not enforced.")])]),e._v(" "),o("p",[e._v("With this, you can create the routine function that builds the leaderboard in memory and saves it to storage once at the end:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBoYW5kbGVQbGF5ZXJJbmZvc0NoYW5uZWwoY3R4IHNkay5Db250ZXh0LCBrIGtlZXBlci5LZWVwZXIsCiAgICBwbGF5ZXJJbmZvc0NoYW5uZWwgJmx0Oy1jaGFuIFtddHlwZXMuUGxheWVySW5mbywKICAgIGRvbmUgY2hhbiZsdDstIGJvb2wsCiAgICBjaHVuayB1aW50NjQpIHsKICAgIHdpbm5lcnMgOj0gbWFrZShbXXR5cGVzLldpbm5pbmdQbGF5ZXJQYXJzZWQsIDAsIHR5cGVzLkxlYWRlcmJvYXJkV2lubmVyTGVuZ3RoK2NodW5rKQogICAgZm9yIHJlY2VpdmVkSW5mbyA6PSByYW5nZSBwbGF5ZXJJbmZvc0NoYW5uZWwgewogICAgICAgIGlmIHJlY2VpdmVkSW5mbyAhPSBuaWwgewogICAgICAgICAgICB3aW5uZXJzID0gQWRkQ2FuZGlkYXRlc0FuZFNvcnQod2lubmVycywgY3R4LCByZWNlaXZlZEluZm8pCiAgICAgICAgfQogICAgfQogICAgay5TZXRMZWFkZXJib2FyZChjdHgsIHR5cGVzLkNyZWF0ZUxlYWRlcmJvYXJkRnJvbVBhcnNlZFdpbm5lcnMod2lubmVycykpCiAgICBkb25lICZsdDstIHRydWUKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_leaderboard.go#L39-L51"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("The winners are initialized at a "),o("code",[e._v("0")]),e._v(" size but with a capacity of "),o("code",[e._v("types.LeaderboardWinnerLength+chunk")]),e._v(", which is the expected maximum intermediate size it will reach. This initialization should ensure that the slice does not need to have its capacity increased mid-process.")])]),e._v(" "),o("p",[e._v("Declare the main function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBNYXBQbGF5ZXJJbmZvc1JlZHVjZVRvTGVhZGVyYm9hcmQoY3R4IHNkay5Db250ZXh0LCBrIGtlZXBlci5LZWVwZXIsIGNodW5rIHVpbnQ2NCkgZXJyb3IgewogICAgY29udGV4dCA6PSBzZGsuV3JhcFNES0NvbnRleHQoY3R4KQogICAgcmVzcG9uc2UsIGVyciA6PSBrLlBsYXllckluZm9BbGwoY29udGV4dCwgJmFtcDt0eXBlcy5RdWVyeUFsbFBsYXllckluZm9SZXF1ZXN0ewogICAgICAgIFBhZ2luYXRpb246ICZhbXA7cXVlcnkuUGFnZVJlcXVlc3R7CiAgICAgICAgICAgIExpbWl0OiBQbGF5ZXJJbmZvQ2h1bmtTaXplLAogICAgICAgIH0sCiAgICB9KQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcmV0dXJuIGVycgogICAgfQogICAgcGxheWVySW5mb3NDaGFubmVsIDo9IG1ha2UoY2hhbiBbXXR5cGVzLlBsYXllckluZm8pCiAgICBkb25lIDo9IG1ha2UoY2hhbiBib29sKQoKICAgIGdvIGhhbmRsZVBsYXllckluZm9zQ2hhbm5lbChjdHgsIGssIHBsYXllckluZm9zQ2hhbm5lbCwgZG9uZSwgY2h1bmspCiAgICBwbGF5ZXJJbmZvc0NoYW5uZWwgJmx0Oy0gcmVzcG9uc2UuUGxheWVySW5mbwoKICAgIGZvciByZXNwb25zZS5QYWdpbmF0aW9uLk5leHRLZXkgIT0gbmlsIHsKICAgICAgICByZXNwb25zZSwgZXJyID0gay5QbGF5ZXJJbmZvQWxsKGNvbnRleHQsICZhbXA7dHlwZXMuUXVlcnlBbGxQbGF5ZXJJbmZvUmVxdWVzdHsKICAgICAgICAgICAgUGFnaW5hdGlvbjogJmFtcDtxdWVyeS5QYWdlUmVxdWVzdHsKICAgICAgICAgICAgICAgIEtleTogICByZXNwb25zZS5QYWdpbmF0aW9uLk5leHRLZXksCiAgICAgICAgICAgICAgICBMaW1pdDogUGxheWVySW5mb0NodW5rU2l6ZSwKICAgICAgICAgICAgfSwKICAgICAgICB9KQogICAgICAgIGlmIGVyciAhPSBuaWwgewogICAgICAgICAgICByZXR1cm4gZXJyCiAgICAgICAgfQogICAgICAgIHBsYXllckluZm9zQ2hhbm5lbCAmbHQ7LSByZXNwb25zZS5QbGF5ZXJJbmZvCiAgICB9CiAgICBjbG9zZShwbGF5ZXJJbmZvc0NoYW5uZWwpCgogICAgJmx0Oy1kb25lCiAgICByZXR1cm4gbmlsCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration_leaderboard.go#L53-L85"}}),e._v(" "),o("h2",{attrs:{id:"v1-to-v2-migration-proper"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#v1-to-v2-migration-proper"}},[e._v("#")]),e._v(" v1 to v2 migration proper")]),e._v(" "),o("p",[e._v("The migration proper needs to execute the previous functions in a specific order. You can encapsulate this knowledge in a function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBQZXJmb3JtTWlncmF0aW9uKGN0eCBzZGsuQ29udGV4dCwgayBrZWVwZXIuS2VlcGVyLCBzdG9yZWRHYW1lQ2h1bmsgdWludDY0LCBwbGF5ZXJJbmZvQ2h1bmsgdWludDY0KSBlcnJvciB7CiAgICBjdHguTG9nZ2VyKCkuSW5mbygmcXVvdDtTdGFydCB0byBjb21wdXRlIGNoZWNrZXJzIGdhbWVzIHRvIHBsYXllciBpbmZvIGNhbGN1bGF0aW9uLi4uJnF1b3Q7KQogICAgZXJyIDo9IE1hcFN0b3JlZEdhbWVzUmVkdWNlVG9QbGF5ZXJJbmZvKGN0eCwgaywgc3RvcmVkR2FtZUNodW5rKQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcmV0dXJuIGVycgogICAgfQogICAgY3R4LkxvZ2dlcigpLkluZm8oJnF1b3Q7Q2hlY2tlcnMgZ2FtZXMgdG8gcGxheWVyIGluZm8gY29tcHV0YXRpb24gZG9uZSZxdW90OykKICAgIGN0eC5Mb2dnZXIoKS5JbmZvKCZxdW90O1N0YXJ0IHRvIGNvbXB1dGUgY2hlY2tlcnMgcGxheWVyIGluZm8gdG8gbGVhZGVyYm9hcmQgY2FsY3VsYXRpb24uLi4mcXVvdDspCiAgICBlcnIgPSBNYXBQbGF5ZXJJbmZvc1JlZHVjZVRvTGVhZGVyYm9hcmQoY3R4LCBrLCBwbGF5ZXJJbmZvQ2h1bmspCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICByZXR1cm4gZXJyCiAgICB9CiAgICBjdHguTG9nZ2VyKCkuSW5mbygmcXVvdDtDaGVja2VycyBwbGF5ZXIgaW5mbyB0byBsZWFkZXJib2FyZCBjb21wdXRhdGlvbiBkb25lJnF1b3Q7KQogICAgcmV0dXJuIG5pbAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1tov2/migration.go#L8-L22"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("This does not panic in case of an error. To avoid carrying on a faulty state, the caller of this function will have to handle the panic.")])]),e._v(" "),o("p",[e._v("You have in place the functions that will handle the store migration. Now you have to set up the chain of command for these functions to be called by the node at the right point in time.")]),e._v(" "),o("h3",{attrs:{id:"consensus-version-and-name"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#consensus-version-and-name"}},[e._v("#")]),e._v(" Consensus version and name")]),e._v(" "),o("p",[e._v("The "),o("code",[e._v("upgrade")]),e._v(" module keeps in its store the "),o("a",{attrs:{href:"https://docs.cosmos.network/master/core/upgrade.html#tracking-module-versions",target:"_blank",rel:"noopener noreferrer"}},[e._v("different module versions"),o("OutboundLink")],1),e._v(" that are currently running. To signal an upgrade, your module needs to return a different value when queried by the "),o("code",[e._v("upgrade")]),e._v(" module. Change it from "),o("code",[e._v("2")]),e._v(" to "),o("code",[e._v("3")]),e._v(", or whichever number works for you. First, keep both these values in their respective locations:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"v1"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgVGFyZ2V0Q29uc2Vuc3VzVmVyc2lvbiA9IDIK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v1/constants.go#L4"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"v2"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgVGFyZ2V0Q29uc2Vuc3VzVmVyc2lvbiA9IDMK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/migrations/v2/constants.go#L4"}})],1)],1),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("The consensus version number bears no resemblance to v1 or v2. The consensus version number is for the module, whereas v1 or v2 is for the whole application.")])]),e._v(" "),o("p",[e._v("Now that you are in v2, have the module return it when asked:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoQXBwTW9kdWxlKSBDb25zZW5zdXNWZXJzaW9uKCkgdWludDY0IHsgcmV0dXJuIHYyLlRhcmdldENvbnNlbnN1c1ZlcnNpb24gfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/module.go#L175"}}),e._v(" "),o("p",[e._v("You also have to pick a name for the upgrade you have prepared. This name will identify your specific upgrade when it is mentioned in a "),o("code",[e._v("Plan")]),e._v(", i.e. an upgrade governance proposal. This is a name relevant at the application level:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgVXBncmFkZU5hbWUgPSAmcXVvdDt2MXRvdjImcXVvdDsK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/app/upgrades/v1tov2/constants.go#L4"}}),e._v(" "),o("p",[e._v("You have to inform your app about:")]),e._v(" "),o("ol",[o("li",[e._v("The mapping between the consensus version(s) and the migration process(es).")]),e._v(" "),o("li",[e._v("The mapping between this name and the module(s) consensus versions.")])]),e._v(" "),o("p",[e._v("Prepare these in turn.")]),e._v(" "),o("h3",{attrs:{id:"callback-in-checkers-module"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#callback-in-checkers-module"}},[e._v("#")]),e._v(" Callback in checkers module")]),e._v(" "),o("p",[e._v("Indicate that the checkers module needs to perform some upgrade steps when it is coming out of the old consensus version by calling "),o("code",[e._v("RegisterMigration")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoYW0gQXBwTW9kdWxlKSBSZWdpc3RlclNlcnZpY2VzKGNmZyBtb2R1bGUuQ29uZmlndXJhdG9yKSB7CiAgICAuLi4KICAgIGlmIGVyciA6PSBjZmcuUmVnaXN0ZXJNaWdyYXRpb24odHlwZXMuTW9kdWxlTmFtZSwgdjEuVGFyZ2V0Q29uc2Vuc3VzVmVyc2lvbiwgZnVuYyhjdHggc2RrLkNvbnRleHQpIGVycm9yIHsKICAgICAgICByZXR1cm4gdjF0b3YyLlBlcmZvcm1NaWdyYXRpb24oY3R4LCBhbS5rZWVwZXIsIHYxdG92Mi5TdG9yZWRHYW1lQ2h1bmtTaXplLCB2MXRvdjIuUGxheWVySW5mb0NodW5rU2l6ZSkKICAgIH0pOyBlcnIgIT0gbmlsIHsKICAgICAgICBwYW5pYyhmbXQuRXJyb3JmKCZxdW90O2ZhaWxlZCB0byByZWdpc3RlciBtaWdyYXRpb24gb2YgJXMgdG8gdjI6ICV3JnF1b3Q7LCB0eXBlcy5Nb2R1bGVOYW1lLCBlcnIpKQogICAgfQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/x/checkers/module.go#L146-L150"}}),e._v(" "),o("p",[e._v("Note it decides on the chunk sizes to use.")]),e._v(" "),o("h3",{attrs:{id:"callback-in-app"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#callback-in-app"}},[e._v("#")]),e._v(" Callback in "),o("code",[e._v("app")])]),e._v(" "),o("p",[e._v("The command that you are going to write needs a "),o("code",[e._v("Configurator")]),e._v(". This is already created as part of your "),o("code",[e._v("app")]),e._v(" preparation but is not kept. Instead of recreating one, adjust your code to make it easily available. Add this field to your "),o("code",[e._v("app")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBBcHAgc3RydWN0IHsKICAgIC4uLgogICAgY29uZmlndXJhdG9yIG1vZHVsZS5Db25maWd1cmF0b3IKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/app/app.go#L246"}}),e._v(" "),o("p",[e._v("Now adjust the place where the configurator is created:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"YXBwLmNvbmZpZ3VyYXRvciA9IG1vZHVsZS5OZXdDb25maWd1cmF0b3IoYXBwLmFwcENvZGVjLCBhcHAuTXNnU2VydmljZVJvdXRlcigpLCBhcHAuR1JQQ1F1ZXJ5Um91dGVyKCkpCmFwcC5tbS5SZWdpc3RlclNlcnZpY2VzKGFwcC5jb25maWd1cmF0b3IpCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/app/app.go#L560-L561"}}),e._v(" "),o("p",[e._v("Create a function that encapsulates knowledge about all possible upgrades, although there is a single one here. Since it includes "),o("em",[e._v("empty code")]),e._v(" for future use, avoid cluttering the already long "),o("code",[e._v("NewApp")]),e._v(" function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoYXBwICpBcHApIHNldHVwVXBncmFkZUhhbmRsZXJzKCkgewogICAgLy8gdjEgdG8gdjIgdXBncmFkZSBoYW5kbGVyCiAgICBhcHAuVXBncmFkZUtlZXBlci5TZXRVcGdyYWRlSGFuZGxlcigKICAgICAgICB2MXRvdjIuVXBncmFkZU5hbWUsCiAgICAgICAgZnVuYyhjdHggc2RrLkNvbnRleHQsIHBsYW4gdXBncmFkZXR5cGVzLlBsYW4sIHZtIG1vZHVsZS5WZXJzaW9uTWFwKSAobW9kdWxlLlZlcnNpb25NYXAsIGVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBhcHAubW0uUnVuTWlncmF0aW9ucyhjdHgsIGFwcC5jb25maWd1cmF0b3IsIHZtKQogICAgICAgIH0sCiAgICApCgogICAgLy8gV2hlbiBhIHBsYW5uZWQgdXBkYXRlIGhlaWdodCBpcyByZWFjaGVkLCB0aGUgb2xkIGJpbmFyeSB3aWxsIHBhbmljCiAgICAvLyB3cml0aW5nIG9uIGRpc2sgdGhlIGhlaWdodCBhbmQgbmFtZSBvZiB0aGUgdXBkYXRlIHRoYXQgdHJpZ2dlcmVkIGl0CiAgICAvLyBUaGlzIHdpbGwgcmVhZCB0aGF0IHZhbHVlLCBhbmQgZXhlY3V0ZSB0aGUgcHJlcGFyYXRpb25zIGZvciB0aGUgdXBncmFkZS4KICAgIHVwZ3JhZGVJbmZvLCBlcnIgOj0gYXBwLlVwZ3JhZGVLZWVwZXIuUmVhZFVwZ3JhZGVJbmZvRnJvbURpc2soKQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcGFuaWMoZm10LkVycm9yZigmcXVvdDtmYWlsZWQgdG8gcmVhZCB1cGdyYWRlIGluZm8gZnJvbSBkaXNrOiAldyZxdW90OywgZXJyKSkKICAgIH0KCiAgICBpZiBhcHAuVXBncmFkZUtlZXBlci5Jc1NraXBIZWlnaHQodXBncmFkZUluZm8uSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIHN0b3JlVXBncmFkZXMgKnN0b3JldHlwZXMuU3RvcmVVcGdyYWRlcwoKICAgIHN3aXRjaCB1cGdyYWRlSW5mby5OYW1lIHsKICAgIGNhc2UgdjF0b3YyLlVwZ3JhZGVOYW1lOgogICAgfQoKICAgIGlmIHN0b3JlVXBncmFkZXMgIT0gbmlsIHsKICAgICAgICAvLyBjb25maWd1cmUgc3RvcmUgbG9hZGVyIHRoYXQgY2hlY2tzIGlmIHZlcnNpb24gPT0gdXBncmFkZUhlaWdodCBhbmQgYXBwbGllcyBzdG9yZSB1cGdyYWRlcwogICAgICAgIGFwcC5TZXRTdG9yZUxvYWRlcih1cGdyYWRldHlwZXMuVXBncmFkZVN0b3JlTG9hZGVyKHVwZ3JhZGVJbmZvLkhlaWdodCwgc3RvcmVVcGdyYWRlcykpCiAgICB9Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/app/app.go#L753-L785"}}),e._v(" "),o("p",[e._v("Now you are ready to inform the app proper. You do this towards the end, after the call to "),o("code",[e._v("app.SetEndBlocker")]),e._v(" and before "),o("code",[e._v("if loadLatest")]),e._v(". At the correct location:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCmFwcC5TZXRFbmRCbG9ja2VyKGFwcC5FbmRCbG9ja2VyKQoKYXBwLnNldHVwVXBncmFkZUhhbmRsZXJzKCkKCmlmIGxvYWRMYXRlc3QgewogICAgLi4uCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/migration/app/app.go#L610"}}),e._v(" "),o("p",[e._v("Be aware that the "),o("code",[e._v("monitoring")]),e._v(" module added by Ignite causes difficulty when experimenting below with the CLI. To make it simple, you should remove "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/compare/leaderboard-handling..migration#diff-0f1d2976054440336a576d47a44a37b80cdf6701dd9113012bce0e3c425819b7L159",target:"_blank",rel:"noopener noreferrer"}},[e._v("all references to "),o("code",[e._v("monitoring")]),o("OutboundLink")],1),e._v(" from "),o("code",[e._v("app.go")]),e._v(".")]),e._v(" "),o("p",[e._v("When done right, adding the callbacks is a short and easy solution.")]),e._v(" "),o("h2",{attrs:{id:"interact-via-the-cli"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#interact-via-the-cli"}},[e._v("#")]),e._v(" Interact via the CLI")]),e._v(" "),o("p",[e._v("You can already execute a live upgrade from the command line. The following upgrade process takes inspiration from "),o("a",{attrs:{href:"https://hub.cosmos.network/main/hub-tutorials/live-upgrade-tutorial.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("this one"),o("OutboundLink")],1),e._v(" based on Gaia. You will:")]),e._v(" "),o("ul",[o("li",[e._v("Check out the checkers v1 code.")]),e._v(" "),o("li",[e._v("Build the v1 checkers executable.")]),e._v(" "),o("li",[e._v("Initialize a local blockchain and network.")]),e._v(" "),o("li",[e._v("Run v1 checkers.")]),e._v(" "),o("li",[e._v("Add one or more incomplete games.")]),e._v(" "),o("li",[e._v("Add one or more complete games with the help of a CosmJS integration test.")]),e._v(" "),o("li",[e._v("Create a governance proposal to upgrade with the right plan name at an appropriate block height.")]),e._v(" "),o("li",[e._v("Make the proposal pass.")]),e._v(" "),o("li",[e._v("Wait for v1 checkers to halt on its own at the upgrade height.")]),e._v(" "),o("li",[e._v("Check out the checkers v2 code.")]),e._v(" "),o("li",[e._v("Build the v2 checkers executable.")]),e._v(" "),o("li",[e._v("Run v2 checkers.")]),e._v(" "),o("li",[e._v("Confirm that you now have a correct leaderboard.")])]),e._v(" "),o("p",[e._v("Start your engines.")]),e._v(" "),o("h3",{attrs:{id:"launch-v1"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#launch-v1"}},[e._v("#")]),e._v(" Launch v1")]),e._v(" "),o("p",[e._v("In a shell, checkout v1 of checkers with the content of the CosmJS client work:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnaXQgY2hlY2tvdXQgY29zbWpzLWVsZW1lbnRzCiQgZ2l0IHN1Ym1vZHVsZSB1cGRhdGUgLS1pbml0Cg=="}}),e._v(" "),o("p",[e._v("Build the v1 executable for your platform:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnbyBidWlsZCAtbyByZWxlYXNlL3YxL2NoZWNrZXJzZCBjbWQvY2hlY2tlcnNkL21haW4uZ28K"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IC12ICQocHdkKTovY2hlY2tlcnMgLXcgL2NoZWNrZXJzIGNoZWNrZXJzX2kgZ28gYnVpbGQgLW8gcmVsZWFzZS92MS9jaGVja2Vyc2QgY21kL2NoZWNrZXJzZC9tYWluLmdvCg=="}})],1)],1),e._v(" "),o("p",[e._v("With the "),o("code",[e._v("release/v1/checkersd")]),e._v(" executable ready, you can initialize the network.")]),e._v(" "),o("HighlightBox",{attrs:{type:"warn"}},[o("p",[e._v("Because this is an exercise, to avoid messing with your keyring you must always specify "),o("code",[e._v("--keyring-backend test")]),e._v(".")])]),e._v(" "),o("p",[e._v("Add two players:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGtleXMgYWRkIGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QKJCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGtleXMgYWRkIGJvYiAtLWtleXJpbmctYmFja2VuZCB0ZXN0Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgY3JlYXRlIC0tbmFtZSBjaGVja2VycyAtaXQgXAogICAgLXYgJChwd2QpOi9jaGVja2VycyAtdyAvY2hlY2tlcnMgXAogICAgLXAgMTMxNzoxMzE3IC1wIDQ1MDA6NDUwMCAtcCA1MDAwOjUwMDAgLXAgMjY2NTc6MjY2NTcgXAogICAgY2hlY2tlcnNfaQokIGRvY2tlciBzdGFydCBjaGVja2VycwokIGRvY2tlciBleGVjIC1pdCBjaGVja2VycyAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGtleXMgYWRkIGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QKJCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBrZXlzIGFkZCBib2IgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdAo="}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("You should not use "),o("code",[e._v("docker run --rm")]),e._v(" here because, when "),o("code",[e._v("checkersd")]),e._v(" stops, you do not want to remove the container and thereby destroy the saved keys, and future genesis too. Instead, you reuse them all in the next calls.")])])],1)],1),e._v(" "),o("p",[e._v("Create a new genesis:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGluaXQgY2hlY2tlcnMK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBpbml0IGNoZWNrZXJzCg=="}})],1)],1),e._v(" "),o("p",[e._v("Give your players the same token amounts that were added by Ignite, as found in "),o("code",[e._v("config.yml")]),e._v(":")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGFkZC1nZW5lc2lzLWFjY291bnQgXAogICAgYWxpY2UgMjAwMDAwMDAwc3Rha2UsMjAwMDB0b2tlbiAtLWtleXJpbmctYmFja2VuZCB0ZXN0CiQgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBhZGQtZ2VuZXNpcy1hY2NvdW50IFwKICAgIGJvYiAxMDAwMDAwMDBzdGFrZSwxMDAwMHRva2VuIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBhZGQtZ2VuZXNpcy1hY2NvdW50IFwKICAgIGFsaWNlIDIwMDAwMDAwMHN0YWtlLDIwMDAwdG9rZW4gLS1rZXlyaW5nLWJhY2tlbmQgdGVzdAokIGRvY2tlciBleGVjIC1pdCBjaGVja2VycyAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGFkZC1nZW5lc2lzLWFjY291bnQgXAogICAgYm9iIDEwMDAwMDAwMHN0YWtlLDEwMDAwdG9rZW4gLS1rZXlyaW5nLWJhY2tlbmQgdGVzdAo="}})],1)],1),e._v(" "),o("p",[e._v("To be able to run a quick test, you need to change the voting period of a proposal. This is found in the genesis:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBqcSAnLmFwcF9zdGF0ZS5nb3Yudm90aW5nX3BhcmFtcy52b3RpbmdfcGVyaW9kJyB+Ly5jaGVja2Vycy9jb25maWcvZ2VuZXNpcy5qc29uCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMganEgJy5hcHBfc3RhdGUuZ292LnZvdGluZ19wYXJhbXMudm90aW5nX3BlcmlvZCcgL3Jvb3QvLmNoZWNrZXJzL2NvbmZpZy9nZW5lc2lzLmpzb24K"}})],1)],1),e._v(" "),o("p",[e._v("This returns something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"JnF1b3Q7MTcyODAwcyZxdW90Owo="}}),e._v(" "),o("p",[e._v("That is two days, which is too long to wait for CLI tests. Choose another value, perhaps 10 minutes, i.e. "),o("code",[e._v('"600s"')]),e._v(". Update it in place in the genesis:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjYXQgJmx0OyZsdDsmbHQ7ICQoanEgJy5hcHBfc3RhdGUuZ292LnZvdGluZ19wYXJhbXMudm90aW5nX3BlcmlvZCA9ICZxdW90OzYwMHMmcXVvdDsnIH4vLmNoZWNrZXJzL2NvbmZpZy9nZW5lc2lzLmpzb24pICZndDsgfi8uY2hlY2tlcnMvY29uZmlnL2dlbmVzaXMuanNvbgo="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgYmFzaCAtYyAmcXVvdDtjYXQgJmx0OyZsdDsmbHQ7IFwkKGpxICcuYXBwX3N0YXRlLmdvdi52b3RpbmdfcGFyYW1zLnZvdGluZ19wZXJpb2QgPSBcJnF1b3Q7NjAwc1wmcXVvdDsnIC9yb290Ly5jaGVja2Vycy9jb25maWcvZ2VuZXNpcy5qc29uKSAmZ3Q7IC9yb290Ly5jaGVja2Vycy9jb25maWcvZ2VuZXNpcy5qc29uJnF1b3Q7Cg=="}})],1)],1),e._v(" "),o("p",[e._v("You can confirm that the value is in using the earlier command.")]),e._v(" "),o("p",[e._v("Make Alice the chain's validator too by creating a genesis transaction modeled on that done by Ignite, as found in "),o("code",[e._v("config.yml")]),e._v(":")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGdlbnR4IGFsaWNlIDEwMDAwMDAwMHN0YWtlIFwKICAgIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QgLS1jaGFpbi1pZCBjaGVja2VycwokIC4vcmVsZWFzZS92MS9jaGVja2Vyc2QgY29sbGVjdC1nZW50eHMK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBnZW50eCBhbGljZSAxMDAwMDAwMDBzdGFrZSBcCiAgICAtLWtleXJpbmctYmFja2VuZCB0ZXN0IC0tY2hhaW4taWQgY2hlY2tlcnMKJCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBjb2xsZWN0LWdlbnR4cwo="}})],1)],1),e._v(" "),o("p",[e._v("Now you can start the chain proper:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHN0YXJ0Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBzdGFydCBcCiAgICAtLXJwYy5sYWRkciAmcXVvdDt0Y3A6Ly8wLjAuMC4wOjI2NjU3JnF1b3Q7Cg=="}}),e._v(" "),o("p",[e._v("Note that you need to force the node to listen on all IP addresses, not just "),o("code",[e._v("127.0.0.1")]),e._v(" as it would do by default.")])],1)],1),e._v(" "),o("p",[e._v("From another shell, create a few un-played games with:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBleHBvcnQgYWxpY2U9JCguL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGtleXMgc2hvdyBhbGljZSAtYSkKJCBleHBvcnQgYm9iPSQoLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBrZXlzIHNob3cgYm9iIC1hKQokIC4vcmVsZWFzZS92MS9jaGVja2Vyc2QgdHggY2hlY2tlcnMgY3JlYXRlLWdhbWUgXAogICAgJGFsaWNlICRib2IgMTAgc3Rha2UgXAogICAgLS1mcm9tICRhbGljZSAtLWtleXJpbmctYmFja2VuZCB0ZXN0IC0teWVzIFwKICAgIC0tYnJvYWRjYXN0LW1vZGUgYmxvY2sK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBleHBvcnQgYWxpY2U9JChkb2NrZXIgZXhlYyBjaGVja2VycyAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGtleXMgc2hvdyBhbGljZSAtYSAtLWtleXJpbmctYmFja2VuZCB0ZXN0KQokIGV4cG9ydCBib2I9JChkb2NrZXIgZXhlYyBjaGVja2VycyAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIGtleXMgc2hvdyBib2IgLWEgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCkKJCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBjaGVja2VycyBjcmVhdGUtZ2FtZSBcCiAgICAkYWxpY2UgJGJvYiAxMCBzdGFrZSBcCiAgICAtLWZyb20gJGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QgLS15ZXMgXAogICAgLS1icm9hZGNhc3QtbW9kZSBibG9jawo="}})],1)],1),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("The "),o("code",[e._v("--broadcast-mode block")]),e._v(" flag means that you can fire up many such games by just copying the command without facing any sequence errors.")])]),e._v(" "),o("p",[e._v("To get a few complete games, you are going to run the "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/test/integration/stored-game-action.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("integration tests"),o("OutboundLink")],1),e._v(" against it. These tests were built to run against a running chain started by Ignite. What is different here is that:")]),e._v(" "),o("ol",[o("li",[e._v("Blocks come slower, likely every five seconds instead of every one.")]),e._v(" "),o("li",[e._v("There are no longer any faucets.")])]),e._v(" "),o("p",[e._v("Therefore, to be able to run these tests you need to attend to the above problems, respectively:")]),e._v(" "),o("ol",[o("li",[e._v("Adjust the timeout of each "),o("code",[e._v("before")]),e._v(" and "),o("code",[e._v("it")]),e._v(". Make it "),o("code",[e._v("5*(the number of expected blocks + 1)")]),e._v(".\nFor instance, if you send 2 transactions that each go in a block, adjust "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/test/integration/stored-game-action.ts#L84",target:"_blank",rel:"noopener noreferrer"}},[e._v("the timeout"),o("OutboundLink")],1),e._v(" to "),o("code",[e._v("15")]),e._v(": "),o("code",[e._v("this.timeout(15_000)")]),e._v(".")]),e._v(" "),o("li",[e._v("Adjust the "),o("code",[e._v('"credit test accounts"')]),e._v(" "),o("code",[e._v("before")]),e._v(". Just "),o("code",[e._v("return")]),e._v(" before the "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/test/integration/stored-game-action.ts#L65",target:"_blank",rel:"noopener noreferrer"}},[e._v("first "),o("code",[e._v("await askFaucet")]),o("OutboundLink")],1),e._v(".")])]),e._v(" "),o("p",[e._v("Now that you cannot call the faucet, you have to credit your test accounts with standard "),o("code",[e._v("bank send")]),e._v(" transactions. You can use the same values as found in the "),o("code",[e._v("before")]),e._v(":")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHR4IGJhbmsgc2VuZCAkYWxpY2UgY29zbW9zMWZ4NnFseHd0ZWVxeGd4d3N3ODN3a2Y0czlmY25ud2s4ejg2c3FsIDMwMHN0YWtlIC0tZnJvbSAkYWxpY2UgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIC0teWVzCiQgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBiYW5rIHNlbmQgJGFsaWNlIGNvc21vczFmeDZxbHh3dGVlcXhneHdzdzgzd2tmNHM5ZmNubndrOHo4NnNxbCAxMHRva2VuIC0tZnJvbSAkYWxpY2UgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIC0teWVzCiQgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBiYW5rIHNlbmQgJGJvYiBjb3Ntb3MxbXFsOWFhdXgzNDUzdGRnaGs2cnprbWs0M3N0eHZudmhhNG52MjIgMzAwc3Rha2UgLS1mcm9tICRib2IgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIC0teWVzCiQgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBiYW5rIHNlbmQgJGJvYiBjb3Ntb3MxbXFsOWFhdXgzNDUzdGRnaGs2cnprbWs0M3N0eHZudmhhNG52MjIgMTB0b2tlbiAtLWZyb20gJGJvYiAtLWtleXJpbmctYmFja2VuZCB0ZXN0IC0tYnJvYWRjYXN0LW1vZGUgYmxvY2sgLS15ZXMK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBiYW5rIHNlbmQgJGFsaWNlIGNvc21vczFmeDZxbHh3dGVlcXhneHdzdzgzd2tmNHM5ZmNubndrOHo4NnNxbCAzMDBzdGFrZSAtLWZyb20gJGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QgLS1icm9hZGNhc3QtbW9kZSBibG9jayAtLXllcwokIGRvY2tlciBleGVjIC1pdCBjaGVja2VycyAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHR4IGJhbmsgc2VuZCAkYWxpY2UgY29zbW9zMWZ4NnFseHd0ZWVxeGd4d3N3ODN3a2Y0czlmY25ud2s4ejg2c3FsIDEwdG9rZW4gLS1mcm9tICRhbGljZSAtLWtleXJpbmctYmFja2VuZCB0ZXN0IC0tYnJvYWRjYXN0LW1vZGUgYmxvY2sgLS15ZXMKJCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBiYW5rIHNlbmQgJGJvYiBjb3Ntb3MxbXFsOWFhdXgzNDUzdGRnaGs2cnprbWs0M3N0eHZudmhhNG52MjIgMzAwc3Rha2UgLS1mcm9tICRib2IgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIC0teWVzCiQgZG9ja2VyIGV4ZWMgLWl0IGNoZWNrZXJzIC4vcmVsZWFzZS92MS9jaGVja2Vyc2QgdHggYmFuayBzZW5kICRib2IgY29zbW9zMW1xbDlhYXV4MzQ1M3RkZ2hrNnJ6a21rNDNzdHh2bnZoYTRudjIyIDEwdG9rZW4gLS1mcm9tICRib2IgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIC0teWVzCg=="}})],1)],1),e._v(" "),o("p",[e._v("With the test accounts sufficiently credited, you can now run the integration tests. Run them three times in a row to create three complete games:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBwdXNoZCBjbGllbnQgJmFtcDsmYW1wOyBucG0gdGVzdCAmYW1wOyZhbXA7IHBvcGQK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IC12ICQocHdkKS9jbGllbnQ6L2NsaWVudCAtdyAvY2xpZW50IG5vZGU6MTguNyBucG0gdGVzdAo="}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("Do not forget to first adjust your "),o("code",[e._v("client/.env")]),e._v(" file's "),o("code",[e._v("RPC_URL")]),e._v(" address to be that of your computer, so that it can access across to the "),o("code",[e._v("checkers")]),e._v(" container.")])])],1)],1),e._v(" "),o("p",[e._v("You can confirm that you have a mix of complete and incomplete games:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHF1ZXJ5IGNoZWNrZXJzIGxpc3Qtc3RvcmVkLWdhbWUgLS1vdXRwdXQganNvbiB8IGpxICcuc3RvcmVkR2FtZVtdIHwgeyAmcXVvdDtpbmRleCZxdW90OzouaW5kZXgsICZxdW90O3dpbm5lciZxdW90Ozoud2lubmVyIH0nCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgYmFzaCAtYyAmcXVvdDsuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHF1ZXJ5IGNoZWNrZXJzIGxpc3Qtc3RvcmVkLWdhbWUgLS1vdXRwdXQganNvbiB8IGpxICcuc3RvcmVkR2FtZVtdIHwgeyBcJnF1b3Q7aW5kZXhcJnF1b3Q7Oi5pbmRleCwgXCZxdW90O3dpbm5lclwmcXVvdDs6Lndpbm5lciB9JyZxdW90Owo="}})],1)],1),e._v(" "),o("p",[e._v("With enough games in the system, you can move to the software upgrade governance proposal.")]),e._v(" "),o("h3",{attrs:{id:"governance-proposal"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#governance-proposal"}},[e._v("#")]),e._v(" Governance proposal")]),e._v(" "),o("p",[e._v("For the software upgrade governance proposal, you want to make sure that it stops the chain not too far in the future but still after the voting period. With a voting period of 10 minutes, take 15 minutes. How many seconds does a block take?")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBqcSAtciAmcXVvdDsuYXBwX3N0YXRlLm1pbnQucGFyYW1zLmJsb2Nrc19wZXJfeWVhciZxdW90OyB+Ly5jaGVja2Vycy9jb25maWcvZ2VuZXNpcy5qc29uCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgYmFzaCAtYyAnanEgLXIgJnF1b3Q7LmFwcF9zdGF0ZS5taW50LnBhcmFtcy5ibG9ja3NfcGVyX3llYXImcXVvdDsgL3Jvb3QvLmNoZWNrZXJzL2NvbmZpZy9nZW5lc2lzLmpzb24nCg=="}})],1)],1),e._v(" "),o("p",[e._v("This returns something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"NjMxMTUyMAo="}}),e._v(" "),o("p",[e._v("That many "),o("code",[e._v("blocks_per_year")]),e._v(" computes down to 5 seconds per block. At this rate, 15 minutes mean 180 blocks.")]),e._v(" "),o("p",[e._v("What is the current block height? Check:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHN0YXR1cyB8IGpxIC1yICZxdW90Oy5TeW5jSW5mby5sYXRlc3RfYmxvY2tfaGVpZ2h0JnF1b3Q7Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgYmFzaCAtYyAnLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBzdGF0dXMgfCBqcSAtciAmcXVvdDsuU3luY0luZm8ubGF0ZXN0X2Jsb2NrX2hlaWdodCZxdW90OycK"}})],1)],1),e._v(" "),o("p",[e._v("This returns something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"MTAwMAo="}}),e._v(" "),o("p",[e._v("That means you will use:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"LS11cGdyYWRlLWhlaWdodCAxMTgwCg=="}}),e._v(" "),o("p",[e._v("What is the minimum deposit for a proposal? Check:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBqcSAmcXVvdDsuYXBwX3N0YXRlLmdvdi5kZXBvc2l0X3BhcmFtcy5taW5fZGVwb3NpdCZxdW90OyB+Ly5jaGVja2Vycy9jb25maWcvZ2VuZXNpcy5qc29uCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgYmFzaCAtYyAnanEgJnF1b3Q7LmFwcF9zdGF0ZS5nb3YuZGVwb3NpdF9wYXJhbXMubWluX2RlcG9zaXQmcXVvdDsgL3Jvb3QvLmNoZWNrZXJzL2NvbmZpZy9nZW5lc2lzLmpzb24nIAo="}})],1)],1),e._v(" "),o("p",[e._v("This returns something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"WwogICAgewogICAgICAgICZxdW90O2Rlbm9tJnF1b3Q7OiAmcXVvdDtzdGFrZSZxdW90OywKICAgICAgICAmcXVvdDthbW91bnQmcXVvdDs6ICZxdW90OzEwMDAwMDAwJnF1b3Q7CiAgICB9Cl0K"}}),e._v(" "),o("p",[e._v("This is the minimum amount that Alice has to deposit when submitting the proposal. This will do:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"LS1kZXBvc2l0IDEwMDAwMDAwc3Rha2UK"}}),e._v(" "),o("p",[e._v("Submit your governance proposal upgrade:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHR4IGdvdiBzdWJtaXQtcHJvcG9zYWwgc29mdHdhcmUtdXBncmFkZSB2MXRvdjIgXAogICAgLS10aXRsZSAmcXVvdDt2MXRvdjImcXVvdDsgXAogICAgLS1kZXNjcmlwdGlvbiAmcXVvdDtJbmNyZWFzZSBlbmdhZ2VtZW50IHZpYSB0aGUgdXNlIG9mIGEgbGVhZGVyYm9hcmQmcXVvdDsgXAogICAgLS1mcm9tICRhbGljZSAtLWtleXJpbmctYmFja2VuZCB0ZXN0IC0teWVzIFwKICAgIC0tYnJvYWRjYXN0LW1vZGUgYmxvY2sgXAogICAgLS11cGdyYWRlLWhlaWdodCAxMTgwIFwKICAgIC0tZGVwb3NpdCAxMDAwMDAwMHN0YWtlCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBnb3Ygc3VibWl0LXByb3Bvc2FsIHNvZnR3YXJlLXVwZ3JhZGUgdjF0b3YyIFwKICAgIC0tdGl0bGUgJnF1b3Q7djF0b3YyJnF1b3Q7IFwKICAgIC0tZGVzY3JpcHRpb24gJnF1b3Q7SW5jcmVhc2UgZW5nYWdlbWVudCB2aWEgdGhlIHVzZSBvZiBhIGxlYWRlcmJvYXJkJnF1b3Q7IFwKICAgIC0tZnJvbSAkYWxpY2UgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLXllcyBcCiAgICAtLWJyb2FkY2FzdC1tb2RlIGJsb2NrIFwKICAgIC0tdXBncmFkZS1oZWlnaHQgMTE4MCBcCiAgICAtLWRlcG9zaXQgMTAwMDAwMDBzdGFrZQo="}})],1)],1),e._v(" "),o("p",[e._v("This returns something with:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"ICAuLi4KICB0eXBlOiBwcm9wb3NhbF9kZXBvc2l0Ci0gYXR0cmlidXRlczoKICAtIGtleTogcHJvcG9zYWxfaWQKICAgIHZhbHVlOiAmcXVvdDsxJnF1b3Q7CiAgLSBrZXk6IHByb3Bvc2FsX3R5cGUKICAgIHZhbHVlOiBTb2Z0d2FyZVVwZ3JhZGUKICAtIGtleTogdm90aW5nX3BlcmlvZF9zdGFydAogICAgdmFsdWU6ICZxdW90OzEmcXVvdDsKICAuLi4K"}}),e._v(" "),o("p",[e._v("Where "),o("code",[e._v("1")]),e._v(" is the proposal ID you reuse. Have Alice and Bob vote yes on it:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHR4IGdvdiB2b3RlIDEgeWVzIFwKICAgIC0tZnJvbSAkYWxpY2UgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLXllcwokIC4vcmVsZWFzZS92MS9jaGVja2Vyc2QgdHggZ292IHZvdGUgMSB5ZXMgXAogICAgLS1mcm9tICRib2IgLS1rZXlyaW5nLWJhY2tlbmQgdGVzdCAtLXllcwo="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBnb3Ygdm90ZSAxIHllcyBcCiAgICAtLWZyb20gJGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QgLS15ZXMKJCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCB0eCBnb3Ygdm90ZSAxIHllcyBcCiAgICAtLWZyb20gJGJvYiAtLWtleXJpbmctYmFja2VuZCB0ZXN0IC0teWVzCg=="}})],1)],1),e._v(" "),o("p",[e._v("Confirm that it has collected the votes:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHF1ZXJ5IGdvdiB2b3RlcyAxCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBxdWVyeSBnb3Ygdm90ZXMgMQo="}})],1)],1),e._v(" "),o("p",[e._v("It should print:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"dm90ZXM6Ci0gb3B0aW9uOiBWT1RFX09QVElPTl9ZRVMKICBvcHRpb25zOgogIC0gb3B0aW9uOiBWT1RFX09QVElPTl9ZRVMKICAgIHdlaWdodDogJnF1b3Q7MS4wMDAwMDAwMDAwMDAwMDAwMDAmcXVvdDsKICBwcm9wb3NhbF9pZDogJnF1b3Q7MSZxdW90OwogIHZvdGVyOiBjb3Ntb3MxaHpmdG5zdG1senFmYWowcnozOWhuNXBlMnZwcHowcGh5NHg5Y3QKLSBvcHRpb246IFZPVEVfT1BUSU9OX1lFUwogIG9wdGlvbnM6CiAgLSBvcHRpb246IFZPVEVfT1BUSU9OX1lFUwogICAgd2VpZ2h0OiAmcXVvdDsxLjAwMDAwMDAwMDAwMDAwMDAwMCZxdW90OwogIHByb3Bvc2FsX2lkOiAmcXVvdDsxJnF1b3Q7CiAgdm90ZXI6IGNvc21vczFoajJ4ODJqNDlmdjkwdGd0ZHhyZHc1ZnozdzJ2cWVxcWpocnhsZQo="}}),e._v(" "),o("p",[e._v("See how long you have to wait for the chain to reach the end of the voting period:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHF1ZXJ5IGdvdiBwcm9wb3NhbCAxCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBxdWVyeSBnb3YgcHJvcG9zYWwgMQo="}})],1)],1),e._v(" "),o("p",[e._v("In the end this prints:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Li4uCnN0YXR1czogUFJPUE9TQUxfU1RBVFVTX1ZPVElOR19QRVJJT0QKLi4uCnZvdGluZ19lbmRfdGltZTogJnF1b3Q7MjAyMi0wOC0yNVQxMDozODoyMi4yNDA3NjYxMDNaJnF1b3Q7Ci4uLgo="}}),e._v(" "),o("p",[e._v("Wait for this period. Afterward, with the same command you should see:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Li4uCnN0YXR1czogUFJPUE9TQUxfU1RBVFVTX1BBU1NFRAouLi4K"}}),e._v(" "),o("p",[e._v("Now, wait for the chain to reach the desired block height, which should take five more minutes, as per your parameters. When it has reached that height, the shell with the running "),o("code",[e._v("checkersd")]),e._v(" should show something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"Li4uCjY6MjlQTSBJTkYgZmluYWxpemluZyBjb21taXQgb2YgYmxvY2sgaGFzaD1FNkNCNkYxRThDRjQ2OTk1NDM5NTBGNzU2RjNFMTVBRTQ0NzcwMUFCQUM0OThDREJBODY2MzNBQzkzQTczRUU3IGhlaWdodD0xMTgwIG1vZHVsZT1jb25zZW5zdXMgbnVtX3R4cz0wIHJvb3Q9MjFFNTFFNTJBQTNGMDZCRTU5Qzc4Q0UxMUQzMTcxRTZGNzI0MEQyOTdFNEJDRUFCMDdGQzVBODc5NTdCM0JFMgo2OjI5UE0gRVJSIFVQR1JBREUgJnF1b3Q7djF0b3YyJnF1b3Q7IE5FRURFRCBhdCBoZWlnaHQ6IDExODA6IAo2OjI5UE0gRVJSIENPTlNFTlNVUyBGQUlMVVJFISEhIGVycj0mcXVvdDtVUEdSQURFIFwmcXVvdDt2MXRvdjJcJnF1b3Q7IE5FRURFRCBhdCBoZWlnaHQ6IDExODA6ICZxdW90OyBtb2R1bGU9Y29uc2Vuc3VzIHN0YWNrPSZxdW90O2dvcm91dGluZSA2MiBbcnVubmluZ106XG5ydW50aW1lL2RlYnVnLlN0YWNrCi4uLgo2OjI5UE0gSU5GIFN0b3BwaW5nIGJhc2VXQUwgc2VydmljZSBpbXBsPXsmcXVvdDtMb2dnZXImcXVvdDs6e319IG1vZHVsZT1jb25zZW5zdXMgd2FsPS9yb290Ly5jaGVja2Vycy9kYXRhL2NzLndhbC93YWwKNjoyOVBNIElORiBTdG9wcGluZyBHcm91cCBzZXJ2aWNlIGltcGw9eyZxdW90O0RpciZxdW90OzomcXVvdDsvcm9vdC8uY2hlY2tlcnMvZGF0YS9jcy53YWwmcXVvdDssJnF1b3Q7SGVhZCZxdW90Ozp7JnF1b3Q7SUQmcXVvdDs6JnF1b3Q7WnNBbE43REVaQWJWOi9yb290Ly5jaGVja2Vycy9kYXRhL2NzLndhbC93YWwmcXVvdDssJnF1b3Q7UGF0aCZxdW90OzomcXVvdDsvcm9vdC8uY2hlY2tlcnMvZGF0YS9jcy53YWwvd2FsJnF1b3Q7fSwmcXVvdDtJRCZxdW90OzomcXVvdDtncm91cDpac0FsTjdERVpBYlY6L3Jvb3QvLmNoZWNrZXJzL2RhdGEvY3Mud2FsL3dhbCZxdW90OywmcXVvdDtMb2dnZXImcXVvdDs6e319IG1vZHVsZT1jb25zZW5zdXMgd2FsPS9yb290Ly5jaGVja2Vycy9kYXRhL2NzLndhbC93YWwKLi4uCg=="}}),e._v(" "),o("p",[e._v("At this point, run in another shell:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjEvY2hlY2tlcnNkIHN0YXR1cyB8IGpxIC1yICZxdW90Oy5TeW5jSW5mby5sYXRlc3RfYmxvY2tfaGVpZ2h0JnF1b3Q7Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgYmFzaCAtYyAnLi9yZWxlYXNlL3YxL2NoZWNrZXJzZCBzdGF0dXMgfCBqcSAtciAmcXVvdDsuU3luY0luZm8ubGF0ZXN0X2Jsb2NrX2hlaWdodCZxdW90OycK"}})],1)],1),e._v(" "),o("p",[e._v("You should always get the same value, no matter how many times you try. That is because the chain has stopped. For instance:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"MTE4MAo="}}),e._v(" "),o("p",[e._v("Stop "),o("code",[e._v("checkersd")]),e._v(" with "),o("kbd",[e._v("CTRL-C")]),e._v(". It has saved a new file:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjYXQgfi8uY2hlY2tlcnMvZGF0YS91cGdyYWRlLWluZm8uanNvbgo="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgY2F0IC9yb290Ly5jaGVja2Vycy9kYXRhL3VwZ3JhZGUtaW5mby5qc29uCg=="}})],1)],1),e._v(" "),o("p",[e._v("This prints:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"eyZxdW90O25hbWUmcXVvdDs6JnF1b3Q7djF0b3YyJnF1b3Q7LCZxdW90O2hlaWdodCZxdW90OzoxMTgwfQo="}}),e._v(" "),o("p",[e._v("With your node (and therefore your whole blockchain) down, you are ready to move to v2.")]),e._v(" "),o("h3",{attrs:{id:"launch-v2"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#launch-v2"}},[e._v("#")]),e._v(" Launch v2")]),e._v(" "),o("p",[e._v("With v1 stopped and its state saved, it is time to move to v2. Checkout v2 of checkers:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnaXQgY2hlY2tvdXQgbWlncmF0aW9uCg=="}}),e._v(" "),o("p",[e._v("Back in the first shell, build the v2 executable:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnbyBidWlsZCAtbyAuL3JlbGVhc2UvdjIvY2hlY2tlcnNkIC4vY21kL2NoZWNrZXJzZC9tYWluLmdvCg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IC12ICQocHdkKTovY2hlY2tlcnMgLXcgL2NoZWNrZXJzIGNoZWNrZXJzX2kgZ28gYnVpbGQgLW8gLi9yZWxlYXNlL3YyL2NoZWNrZXJzZCAuL2NtZC9jaGVja2Vyc2QvbWFpbi5nbwo="}})],1)],1),e._v(" "),o("p",[e._v("Launch it:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjIvY2hlY2tlcnNkIHN0YXJ0Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YyL2NoZWNrZXJzZCBzdGFydCBcCiAgICAtLXJwYy5sYWRkciAmcXVvdDt0Y3A6Ly8wLjAuMC4wOjI2NjU3JnF1b3Q7Cg=="}})],1)],1),e._v(" "),o("p",[e._v("It should start and display something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Li4uCjc6MDZQTSBJTkYgYXBwbHlpbmcgdXBncmFkZSAmcXVvdDt2MXRvdjImcXVvdDsgYXQgaGVpZ2h0OiAzNDIKNzowNlBNIElORiBtaWdyYXRpbmcgbW9kdWxlIGNoZWNrZXJzIGZyb20gdmVyc2lvbiAyIHRvIHZlcnNpb24gMwo3OjA2UE0gSU5GIFN0YXJ0IHRvIGNvbXB1dGUgY2hlY2tlcnMgZ2FtZXMgdG8gcGxheWVyIGluZm8gY2FsY3VsYXRpb24uLi4KNzowNlBNIElORiBDaGVja2VycyBnYW1lcyB0byBwbGF5ZXIgaW5mbyBjb21wdXRhdGlvbiBkb25lCjc6MDZQTSBJTkYgU3RhcnQgdG8gY29tcHV0ZSBjaGVja2VycyBwbGF5ZXIgaW5mbyB0byBsZWFkZXJib2FyZCBjYWxjdWxhdGlvbi4uLgo3OjA2UE0gSU5GIENoZWNrZXJzIHBsYXllciBpbmZvIHRvIGxlYWRlcmJvYXJkIGNvbXB1dGF0aW9uIGRvbmUKLi4uCg=="}}),e._v(" "),o("p",[e._v("After it has started, you can confirm in another shell that you have the expected leaderboard with:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCAuL3JlbGVhc2UvdjIvY2hlY2tlcnNkIHF1ZXJ5IGNoZWNrZXJzIHNob3ctbGVhZGVyYm9hcmQK"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgLi9yZWxlYXNlL3YyL2NoZWNrZXJzZCBxdWVyeSBjaGVja2VycyBzaG93LWxlYWRlcmJvYXJkCg=="}})],1)],1),e._v(" "),o("p",[e._v("This should print something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"TGVhZGVyYm9hcmQ6CiAgd2lubmVyczoKICAtIGRhdGVBZGRlZDogMjAyMi0wOS0wNiAxODoyOTo0NC4wMjAzMjM2ODIgKzAwMDAgVVRDCiAgICBwbGF5ZXJBZGRyZXNzOiBjb3Ntb3MxZng2cWx4d3RlZXF4Z3h3c3c4M3drZjRzOWZjbm53azh6ODZzcWwKICAgIHdvbkNvdW50OiAmcXVvdDszJnF1b3Q7Cg=="}}),e._v(" "),o("p",[e._v("Note how it took the time of the block when v1 stopped.")]),e._v(" "),o("p",[e._v("You can similarly confirm that the player info records are correctly saved. Congratulations, you have upgraded your blockchain almost as if in production.")]),e._v(" "),o("p",[e._v("Your checkers blockchain is done! It has a leaderboard, which was introduced later in production thanks to migrations.")]),e._v(" "),o("p",[e._v("You no doubt have many ideas about how to improve it. In particular, you could implement the missing "),o("em",[e._v("draw")]),e._v(" mechanism, which in effect has to be accepted by both players.")]),e._v(" "),o("HighlightBox",{attrs:{type:"synopsis"}},[o("p",[e._v("To summarize, this section has explored:")]),e._v(" "),o("ul",[o("li",[e._v("How to add a leaderboard to an existing blockchain, and the characteristics that a good leaderboard should boast.")]),e._v(" "),o("li",[e._v("How to upgrade a blockchain in production, by migrating from v1 of the blockchain to v2, and the new data structures that will be introduced by the upgrade.")]),e._v(" "),o("li",[e._v("How to handle the data migrations and logic upgrades implicit during migration, such as with the use of private helper functions.")]),e._v(" "),o("li",[e._v("Worthwhile unit tests with regard to player info and leaderboard handling.")]),e._v(" "),o("li",[e._v("A complete procedure for how to conduct the update via the CLI.")])])])],1)}),[],!1,null,null,null);t.default=l.exports}}]);