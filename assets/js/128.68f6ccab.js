(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{746:function(e,t,a){"use strict";a.r(t);var o=a(1),s=Object(o.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"keep-an-up-to-date-game-deadline"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#keep-an-up-to-date-game-deadline"}},[e._v("#")]),e._v(" Keep an Up-To-Date Game Deadline")]),e._v(" "),a("HighlightBox",{attrs:{type:"prerequisite"}},[a("p",[e._v("Make sure you have everything you need before proceeding:")]),e._v(" "),a("ul",[a("li",[e._v("You understand the concepts of "),a("RouterLink",{attrs:{to:"/academy/2-cosmos-concepts/6-protobuf.html"}},[e._v("Protobuf")]),e._v(".")],1),e._v(" "),a("li",[e._v("Go is installed.")]),e._v(" "),a("li",[e._v("You have the checkers blockchain codebase with the game winner. If not, follow the "),a("RouterLink",{attrs:{to:"/hands-on-exercise/1-ignite-cli/8-game-winner.html"}},[e._v("previous steps")]),e._v(" or check out the "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/tree/game-winner",target:"_blank",rel:"noopener noreferrer"}},[e._v("relevant version"),a("OutboundLink")],1),e._v(".")],1)])]),e._v(" "),a("HighlightBox",{attrs:{type:"learning"}},[a("p",[e._v("In this section, you will:")]),e._v(" "),a("ul",[a("li",[e._v("Implement a deadline.")]),e._v(" "),a("li",[e._v("Work with dates.")]),e._v(" "),a("li",[e._v("Extend your unit tests.")])])]),e._v(" "),a("p",[e._v("In a "),a("RouterLink",{attrs:{to:"/hands-on-exercise/1-ignite-cli/6-play-game.html"}},[e._v("previous step")]),e._v(", you made it possible for players to play, and you recorded the "),a("RouterLink",{attrs:{to:"/hands-on-exercise/1-ignite-cli/8-game-winner.html"}},[e._v("eventual winner")]),e._v(". Presumably "),a("em",[e._v("most")]),e._v(" players will play their games until they reach a resolution... but not 100% of them. Some players will forget about their games, no longer care, or simply stop playing when it is obvious they are losing.")],1),e._v(" "),a("p",[e._v("Therefore, your blockchain is at risk of accumulating stale games in its storage. Eventually you want to let players wager on the outcome of games, so you do not want games remaining in limbo if they have "),a("em",[e._v("value")]),e._v(" assigned. This is one more reason why you need a way for games to be forcibly resolved if one player stops participating.")]),e._v(" "),a("p",[e._v("To take care of this, you could imagine creating new messages. For instance, a player whose opponent has disappeared could raise a flag in order to seek a resolution. That would most likely require the introduction of a deadline to prevent malicious flag raising, and for the deadline to be pushed back every time a move is played.")]),e._v(" "),a("p",[e._v("Another way would be to have the blockchain system resolve "),a("em",[e._v("by forfeit")]),e._v(" the stale games on its own. This is the path that this exercise takes. To achieve that, it needs a deadline. This deadline, and its testing, is the object of this section.")]),e._v(" "),a("h2",{attrs:{id:"some-initial-thoughts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#some-initial-thoughts"}},[e._v("#")]),e._v(" Some initial thoughts")]),e._v(" "),a("p",[e._v("Before you begin touching your code, ask:")]),e._v(" "),a("ul",[a("li",[e._v("What conditions have to be satisfied for a game to be considered stale and for the blockchain to act?")]),e._v(" "),a("li",[e._v("How do you sanitize the new information inputs?")]),e._v(" "),a("li",[e._v("How would you get rid of stale games as part of the protocol, that is "),a("em",[e._v("without user inputs")]),e._v("?")]),e._v(" "),a("li",[e._v("How do you optimize performance and data structures so that a few stale games do not cause your blockchain to grind to a halt?")]),e._v(" "),a("li",[e._v("How can you be sure that your blockchain is safe from attacks?")]),e._v(" "),a("li",[e._v("How do you make your changes compatible with future plans for wagers?")]),e._v(" "),a("li",[e._v("Are there errors to report back?")]),e._v(" "),a("li",[e._v("What event should you emit?")])]),e._v(" "),a("p",[e._v("These are important questions, but not all are answered in this section. For instance, the question about performance and data structures is solved in the following sections.")]),e._v(" "),a("h2",{attrs:{id:"new-information"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#new-information"}},[e._v("#")]),e._v(" New information")]),e._v(" "),a("p",[e._v("To prepare the field, add in the "),a("code",[e._v("StoredGame")]),e._v("'s Protobuf definition:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-protobuf",base64:"ICAgIG1lc3NhZ2UgU3RvcmVkR2FtZSB7CiAgICAgICAgLi4uCisgICAgICBzdHJpbmcgZGVhZGxpbmUgPSA3OwogICAgfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/proto/checkers/stored_game.proto#L13"}}),e._v(" "),a("p",[e._v("To have Ignite CLI and Protobuf recompile this file, use:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgZ2VuZXJhdGUgcHJvdG8tZ28K"}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2hlY2tlcnMgXAogICAgLXcgL2NoZWNrZXJzIFwKICAgIGNoZWNrZXJzX2kgXAogICAgaWduaXRlIGdlbmVyYXRlIHByb3RvLWdvCg=="}})],1)],1),e._v(" "),a("p",[e._v("On each update the deadline will always be "),a("em",[e._v("now")]),e._v(" plus a fixed duration. In this context, "),a("em",[e._v("now")]),e._v(" refers to "),a("strong",[e._v("the block's time")]),e._v(". If you tried to use the "),a("em",[e._v("node's")]),e._v(" time at the time of execution you would break the consensus, as no two nodes would have the same execution time.")]),e._v(" "),a("p",[e._v("Declare this duration as a new constant, plus how the date is to be represented â€“ encoded in the saved game as a string:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgKAogICAgTWF4VHVybkR1cmF0aW9uID0gdGltZS5EdXJhdGlvbigyNCAqIDNfNjAwICogMTAwMF8wMDBfMDAwKSAvLyAxIGRheQogICAgRGVhZGxpbmVMYXlvdXQgID0gJnF1b3Q7MjAwNi0wMS0wMiAxNTowNDowNS45OTk5OTk5OTkgKzAwMDAgVVRDJnF1b3Q7CikK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/types/keys.go#L48-L51"}}),e._v(" "),a("h2",{attrs:{id:"date-manipulation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#date-manipulation"}},[e._v("#")]),e._v(" Date manipulation")]),e._v(" "),a("p",[e._v("Helper functions can encode and decode the deadline in the storage.")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Define a new error:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIHZhciAoCiAgICAgICAgLi4uCisgICAgICBFcnJJbnZhbGlkRGVhZGxpbmUgPSBzZGtlcnJvcnMuUmVnaXN0ZXIoTW9kdWxlTmFtZSwgMTEwOCwgJnF1b3Q7ZGVhZGxpbmUgY2Fubm90IGJlIHBhcnNlZDogJXMmcXVvdDspCiAgICApCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/types/errors.go#L22"}})],1),e._v(" "),a("li",[a("p",[e._v("Add your date helpers. A reasonable location to pick is "),a("code",[e._v("full_game.go")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3RvcmVkR2FtZSAqU3RvcmVkR2FtZSkgR2V0RGVhZGxpbmVBc1RpbWUoKSAoZGVhZGxpbmUgdGltZS5UaW1lLCBlcnIgZXJyb3IpIHsKICAgIGRlYWRsaW5lLCBlcnJEZWFkbGluZSA6PSB0aW1lLlBhcnNlKERlYWRsaW5lTGF5b3V0LCBzdG9yZWRHYW1lLkRlYWRsaW5lKQogICAgcmV0dXJuIGRlYWRsaW5lLCBzZGtlcnJvcnMuV3JhcGYoZXJyRGVhZGxpbmUsIEVyckludmFsaWREZWFkbGluZS5FcnJvcigpLCBzdG9yZWRHYW1lLkRlYWRsaW5lKQp9CgpmdW5jIEZvcm1hdERlYWRsaW5lKGRlYWRsaW5lIHRpbWUuVGltZSkgc3RyaW5nIHsKICAgIHJldHVybiBkZWFkbGluZS5VVEMoKS5Gb3JtYXQoRGVhZGxpbmVMYXlvdXQpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/types/full_game.go#L55-L62"}}),e._v(" "),a("p",[e._v("Note that "),a("code",[e._v("sdkerrors.Wrapf(err, ...)")]),e._v(" conveniently returns "),a("code",[e._v("nil")]),e._v(" if "),a("code",[e._v("err")]),e._v(" is "),a("code",[e._v("nil")]),e._v(".")])],1),e._v(" "),a("li",[a("p",[e._v("At the same time, add this to the "),a("code",[e._v("Validate")]),e._v(" function:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIC4uLgogICAgXywgZXJyID0gc3RvcmVkR2FtZS5QYXJzZUdhbWUoKQorICBpZiBlcnIgIT0gbmlsIHsKKyAgICAgIHJldHVybiBlcnIKKyAgfQorICBfLCBlcnIgPSBzdG9yZWRHYW1lLkdldERlYWRsaW5lQXNUaW1lKCkKICAgIHJldHVybiBlcnIK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/types/full_game.go#L78-L81"}})],1),e._v(" "),a("li",[a("p",[e._v("Add a function that encapsulates how the next deadline is calculated in the same file:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBHZXROZXh0RGVhZGxpbmUoY3R4IHNkay5Db250ZXh0KSB0aW1lLlRpbWUgewogICAgcmV0dXJuIGN0eC5CbG9ja1RpbWUoKS5BZGQoTWF4VHVybkR1cmF0aW9uKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/types/full_game.go#L64-L66"}})],1)]),e._v(" "),a("h2",{attrs:{id:"updated-deadline"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#updated-deadline"}},[e._v("#")]),e._v(" Updated deadline")]),e._v(" "),a("p",[e._v("Next, you need to update this new field with its appropriate value:")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("At creation, in the message handler for game creation:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIC4uLgogICAgc3RvcmVkR2FtZSA6PSB0eXBlcy5TdG9yZWRHYW1lewogICAgICAgIC4uLgorICAgICAgRGVhZGxpbmU6IHR5cGVzLkZvcm1hdERlYWRsaW5lKHR5cGVzLkdldE5leHREZWFkbGluZShjdHgpKSwKICAgIH0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/keeper/msg_server_create_game.go#L29"}})],1),e._v(" "),a("li",[a("p",[e._v("After a move, in the message handler:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIC4uLgorICBzdG9yZWRHYW1lLkRlYWRsaW5lID0gdHlwZXMuRm9ybWF0RGVhZGxpbmUodHlwZXMuR2V0TmV4dERlYWRsaW5lKGN0eCkpCiAgICBzdG9yZWRHYW1lLlR1cm4gPSBydWxlcy5QaWVjZVN0cmluZ3NbZ2FtZS5UdXJuXQogICAgLi4uCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/keeper/msg_server_play_move.go#L70"}})],1)]),e._v(" "),a("p",[e._v("Confirm that your project still compiles:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgY2hhaW4gYnVpbGQK"}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC0tbmFtZSBjaGVja2VycyBcCiAgICAtdiAkKHB3ZCk6L2NoZWNrZXJzIFwKICAgIC13IC9jaGVja2VycyBcCiAgICBjaGVja2Vyc19pIFwKICAgIGlnbml0ZSBjaGFpbiBidWlsZAo="}})],1)],1),e._v(" "),a("h2",{attrs:{id:"unit-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#unit-tests"}},[e._v("#")]),e._v(" Unit tests")]),e._v(" "),a("p",[e._v("After these changes, your previous unit tests fail. Fix them by adding "),a("code",[e._v("Deadline")]),e._v(" wherever it should be. Do not forget that the time is taken from the block's timestamp. In the case of tests, it is stored in the context's "),a("code",[e._v("ctx.BlockTime()")]),e._v(". In effect, you need to add this single line:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjb250ZXh0KQogICAgLi4uCiAgICByZXF1aXJlLkVxdWFsVmFsdWVzKHQsIHR5cGVzLlN0b3JlZEdhbWV7CiAgICAgICAgLi4uCisgICAgICBEZWFkbGluZTogIHR5cGVzLkZvcm1hdERlYWRsaW5lKGN0eC5CbG9ja1RpbWUoKS5BZGQodHlwZXMuTWF4VHVybkR1cmF0aW9uKSksCiAgICB9LCBnYW1lMSkK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/keeper/msg_server_play_move_test.go#L108"}}),e._v(" "),a("p",[e._v("Also add a couple of unit tests that confirm the "),a("code",[e._v("GetDeadlineAsTime")]),e._v(" function "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/types/full_game_test.go#L178-L192",target:"_blank",rel:"noopener noreferrer"}},[e._v("works as intended"),a("OutboundLink")],1),e._v(" and that the dates saved "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/keeper/msg_server_create_game_test.go#L298-L310",target:"_blank",rel:"noopener noreferrer"}},[e._v("on create"),a("OutboundLink")],1),e._v(" and "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/game-deadline/x/checkers/keeper/msg_server_play_move_test.go#L379-L394",target:"_blank",rel:"noopener noreferrer"}},[e._v("on play"),a("OutboundLink")],1),e._v(" are parseable.")]),e._v(" "),a("h2",{attrs:{id:"interact-via-the-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#interact-via-the-cli"}},[e._v("#")]),e._v(" Interact via the CLI")]),e._v(" "),a("p",[e._v("There is not much to test here. Remember that you added a new field, but if your blockchain state already contains games then they are missing the new field:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgcXVlcnkgY2hlY2tlcnMgc2hvdy1zdG9yZWQtZ2FtZSAxCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHF1ZXJ5IGNoZWNrZXJzIHNob3ctc3RvcmVkLWdhbWUgMQo="}})],1)],1),e._v(" "),a("p",[e._v("This demonstrates some missing information:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-txt",base64:"ICAgIC4uLgorICBkZWFkbGluZTogJnF1b3Q7JnF1b3Q7CiAgICAuLi4K"}}),e._v(" "),a("p",[e._v("In effect, your blockchain state is broken. Eventually examine the "),a("RouterLink",{attrs:{to:"/hands-on-exercise/4-run-in-prod/2-migration-info.html"}},[e._v("section on migrations")]),e._v(" to see how to update your blockchain state to avoid such a breaking change. This broken state still lets you test the update of the deadline on play:")],1),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgcGxheS1tb3ZlIDEgMSAyIDIgMyAtLWZyb20gJGFsaWNlCiQgY2hlY2tlcnNkIHF1ZXJ5IGNoZWNrZXJzIHNob3ctc3RvcmVkLWdhbWUgMQo="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHR4IGNoZWNrZXJzIHBsYXktbW92ZSAxIDEgMiAyIDMgLS1mcm9tICRhbGljZQokIGRvY2tlciBleGVjIC1pdCBjaGVja2VycyBcCiAgICBjaGVja2Vyc2QgcXVlcnkgY2hlY2tlcnMgc2hvdy1zdG9yZWQtZ2FtZSAxCg=="}})],1)],1),e._v(" "),a("p",[e._v("This contains:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-txt",base64:"ICAgIC4uLgorICBkZWFkbGluZTogMjAyMy0wMi0wNSAxNToyNjoyNi44MzI1MzMgKzAwMDAgVVRDCiAgICAuLi4K"}}),e._v(" "),a("p",[e._v("In the same vein, you can create a new game and confirm it contains the deadline.")]),e._v(" "),a("HighlightBox",{attrs:{type:"warn"}},[a("p",[e._v("Do you believe that all the elements are in place for you to start the forfeit mechanism? Are you thinking about doing something like this pseudo-code:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"javascript",base64:"YWxsR2FtZXMgPSBrZWVwZXIuR2V0QWxsU3RvcmVkR2FtZXMoKQpleHBpcmVkR2FtZXMgPSBhbGxHYW1lcy5maWx0ZXJXaGVyZShnYW1lID0mZ3Q7IG5vdyAmbHQ7IGdhbWUuRGVhZGxpbmUpCi4uLgo="}}),e._v(" "),a("p",[e._v("If you do so, your blockchain is in "),a("strong",[e._v("extreme danger")]),e._v(". The "),a("code",[e._v(".GetAllStoredGames")]),e._v(" call is O(n). Its execution time is proportional to the total number of games you have in storage. It is not proportional to the number of games that have expired.\n"),a("br"),a("br"),e._v("\nIf your project is successful, this may mean pulling a million games just to forfeit a handful... "),a("em",[e._v("on every block")]),e._v(". At this rate, each block would come out after 30 minutes, not 6 seconds.\n"),a("br"),a("br"),e._v("\nYou need better data structures, as you will see in the next sections.")])],1),e._v(" "),a("HighlightBox",{attrs:{type:"synopsis"}},[a("p",[e._v("To summarize, this section has explored:")]),e._v(" "),a("ul",[a("li",[e._v("How to implement a new "),a("code",[e._v("deadline")]),e._v(" field and work with dates to enable the application to check whether games which have not been recently updated have expired or not.")]),e._v(" "),a("li",[e._v("How the deadline must use the block's time as its reference point, since a non-deterministic "),a("code",[e._v("Date.now()")]),e._v(" would change with each execution.")]),e._v(" "),a("li",[e._v("How to test your code to ensure that it functions as desired.")]),e._v(" "),a("li",[e._v("How to interact with the CLI to create a new game with the deadline field in place")]),e._v(" "),a("li",[e._v("How, if your blockchain contains preexisting games, that the blockchain state is now effectively broken, since the deadline field of those games demonstrates missing information (which can be corrected through migration).")]),e._v(" "),a("li",[e._v("How, if you are not careful enough, you can quickly stall a successful blockchain.")])])])],1)}),[],!1,null,null,null);t.default=s.exports}}]);