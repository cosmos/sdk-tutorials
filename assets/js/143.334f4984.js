(window.webpackJsonp=window.webpackJsonp||[]).push([[143],{760:function(e,t,o){"use strict";o.r(t);var s=o(1),c=Object(s.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h1",{attrs:{id:"backend-script-for-game-indexing"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#backend-script-for-game-indexing"}},[e._v("#")]),e._v(" Backend Script for Game Indexing")]),e._v(" "),o("HighlightBox",{attrs:{type:"prerequisite"}},[o("p",[e._v("Make sure you have all you need before proceeding:")]),e._v(" "),o("ul",[o("li",[e._v("You understand the concepts of "),o("RouterLink",{attrs:{to:"/tutorials/7-cosmjs/1-cosmjs-intro.html"}},[e._v("CosmJS")]),e._v(".")],1),e._v(" "),o("li",[e._v("You have the checkers CosmJS codebase up to the integrated GUI. If not, follow the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/3-cosmjs-adv/4-cosmjs-gui.html"}},[e._v("previous steps")]),e._v(" or go ahead and clone and checkout "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/tree/gui",target:"_blank",rel:"noopener noreferrer"}},[e._v("this branch"),o("OutboundLink")],1),e._v(" to get the version needed for this tutorial.")],1)])]),e._v(" "),o("p",[e._v("This exercise assumes that:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("You are running your "),o("RouterLink",{attrs:{to:"/hands-on-exercise/3-cosmjs-adv/2-cosmjs-messages.html#prepare-your-checkers-chain"}},[e._v("checkers blockchain")]),e._v(" with:")],1),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgbmV0d29yayBjcmVhdGUgY2hlY2tlcnMtbmV0CiQgZG9ja2VyIHJ1biAtLXJtIC1pdCBcCiAgICAtcCAyNjY1NzoyNjY1NyBcCiAgICAtLW5hbWUgY2hlY2tlcnMgXAogICAgLS1uZXR3b3JrIGNoZWNrZXJzLW5ldCBcCiAgICAtLWRldGFjaCBcCiAgICBjaGVja2Vyc2RfaTpzdGFuZGFsb25lIHN0YXJ0CiQgc2xlZXAgMTAKJCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC1wIDQ1MDA6NDUwMCBcCiAgICAtLW5hbWUgY29zbW9zLWZhdWNldCBcCiAgICAtLW5ldHdvcmsgY2hlY2tlcnMtbmV0IFwKICAgIC0tZGV0YWNoIFwKICAgIGNvc21vcy1mYXVjZXRfaTowLjI4LjExIHN0YXJ0IGh0dHA6Ly9jaGVja2VyczoyNjY1NwokIHNsZWVwIDIwCg=="}})],1),e._v(" "),o("li",[o("p",[e._v("You have the following in "),o("code",[e._v(".env")]),e._v(":")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"ini",base64:"UlBDX1VSTD0mcXVvdDtodHRwOi8vbG9jYWxob3N0OjI2NjU3JnF1b3Q7CkZBVUNFVF9VUkw9JnF1b3Q7aHR0cDovL2xvY2FsaG9zdDo0NTAwJnF1b3Q7Cg=="}}),e._v(" "),o("p",[e._v("When you run "),o("code",[e._v("npm")]),e._v(" on your local computer.")])],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"ini",base64:"UlBDX1VSTD0mcXVvdDtodHRwOi8vY2hlY2tlcnM6MjY2NTcmcXVvdDsKRkFVQ0VUX1VSTD0mcXVvdDtodHRwOi8vY29zbW9zLWZhdWNldDo0NTAwJnF1b3Q7Cg=="}}),e._v(" "),o("p",[e._v("When you run "),o("code",[e._v("npm")]),e._v(" in a Docker container.")])],1)],1)],1)]),e._v(" "),o("p",[e._v("Now that your blockchain is complete, you can think about additional data and services that would add value without increasing cost or complexity on-chain.")]),e._v(" "),o("p",[e._v("For example, how do you list all of a player's games? Currently this information is not easily available. You can find the players of a given game, but not the games of a given player. Indexing this on-chain would add storage and computation costs.")]),e._v(" "),o("h2",{attrs:{id:"server-idea"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#server-idea"}},[e._v("#")]),e._v(" Server idea")]),e._v(" "),o("p",[e._v("To implement this functionality, build a Web 2.0 server to do the indexing. The server:")]),e._v(" "),o("ol",[o("li",[e._v("Listens to updates from the checkers chain:\n"),o("ol",[o("li",[e._v("On a game creation event, adds the game ID under each player.")]),e._v(" "),o("li",[e._v("On a game deletion event, removes it.")])])]),e._v(" "),o("li",[e._v("When asked about its status, returns the latest block height up to which it has indexed players.")]),e._v(" "),o("li",[e._v("When asked about a given player, returns the list of game IDs for this player.")]),e._v(" "),o("li",[e._v("When a game ID is submitted, patches its information about that game ID on a best effort basis (to palliate potential de-synchronization).")])]),e._v(" "),o("h2",{attrs:{id:"barebones-server"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#barebones-server"}},[e._v("#")]),e._v(" Barebones server")]),e._v(" "),o("p",[e._v("As a fast and simple Web 2.0 solution, navigate to the "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui",target:"_blank",rel:"noopener noreferrer"}},[e._v("checkers CosmJS repository"),o("OutboundLink")],1),e._v(" for the checkers blockchain, in the existing "),o("code",[e._v("gui")]),e._v(" branch, and perform the following steps:")]),e._v(" "),o("ol",[o("li",[e._v("Create a sub-directory of the "),o("code",[e._v("src")]),e._v(" folder (e.g. "),o("code",[e._v("server")]),e._v(").")]),e._v(" "),o("li",[e._v("Use the "),o("code",[e._v("express")]),e._v(" Node.js module to create an HTTP REST API.")]),e._v(" "),o("li",[e._v("Use a local "),o("code",[e._v("db.json")]),e._v(" as a "),o("em",[e._v("database")]),e._v(". This is obviously primitive and not thread-safe. In a production setting use a proper database.")]),e._v(" "),o("li",[e._v("Poll the blockchain at regular intervals. As part of an advanced topic, you can use WebSockets.")])]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBucG0gaW5zdGFsbCBleHByZXNzQDQuMTguMSAtLXNhdmUtZXhhY3QKJCBucG0gaW5zdGFsbCBAdHlwZXMvZXhwcmVzc0A0LjE3LjEzIC0tc2F2ZS1kZXYgLS1zYXZlLWV4YWN0Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gXAogICAgLXYgJChwd2QpOi9jbGllbnQgXAogICAgLXcgL2NsaWVudCBcCiAgICBub2RlOjE4Ljctc2xpbSBcCiAgICBucG0gaW5zdGFsbCBleHByZXNzQDQuMTguMSAtLXNhdmUtZXhhY3QKJCBkb2NrZXIgcnVuIC0tcm0gXAogICAgLXYgJChwd2QpOi9jbGllbnQgXAogICAgLXcgL2NsaWVudCBcCiAgICBub2RlOjE4Ljctc2xpbSBcCiAgICBucG0gaW5zdGFsbCBAdHlwZXMvZXhwcmVzc0A0LjE3LjEzIC0tc2F2ZS1kZXYgLS1zYXZlLWV4YWN0Cg=="}})],1)],1),e._v(" "),o("h3",{attrs:{id:"data-types"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#data-types"}},[e._v("#")]),e._v(" Data types")]),e._v(" "),o("p",[e._v("To keep the code type-safe, define the types of your "),o("code",[e._v("db.json")]),e._v(" in "),o("code",[e._v("types.ts")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"ZXhwb3J0IGludGVyZmFjZSBMYXRlc3RCbG9ja1N0YXR1cyB7CiAgICBoZWlnaHQ6IG51bWJlcgp9CgpleHBvcnQgaW50ZXJmYWNlIERiU3RhdHVzIHsKICAgIGJsb2NrOiBMYXRlc3RCbG9ja1N0YXR1cwp9CgpleHBvcnQgaW50ZXJmYWNlIFBsYXllckluZm8gewogICAgZ2FtZUlkczogc3RyaW5nW10KfQoKZXhwb3J0IGludGVyZmFjZSBQbGF5ZXJzSW5mbyB7CiAgICBbcGxheWVyQWRkcmVzczogc3RyaW5nXTogUGxheWVySW5mbwp9CgpleHBvcnQgaW50ZXJmYWNlIEdhbWVJbmZvIHsKICAgIHJlZEFkZHJlc3M6IHN0cmluZwogICAgYmxhY2tBZGRyZXNzOiBzdHJpbmcKICAgIGRlbGV0ZWQ6IGJvb2xlYW4KfQoKZXhwb3J0IGludGVyZmFjZSBHYW1lc0luZm8gewogICAgW2dhbWVJZDogc3RyaW5nXTogR2FtZUluZm8KfQoKZXhwb3J0IGludGVyZmFjZSBEYlR5cGUgewogICAgc3RhdHVzOiBEYlN0YXR1cwogICAgcGxheWVyczogUGxheWVyc0luZm8KICAgIGdhbWVzOiBHYW1lc0luZm8KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/types.ts#L1-L31"}}),e._v(" "),o("p",[e._v("Not only does this keep information about players, it also keeps a copy of games. This gets around a current limitation of CosmJS, where you cannot get information about a game that has just been erased from the latest state. In practice you would need to query the game at an earlier block height, but this functionality is not yet available with CosmJS. Note that nodes may prune the old state, especially if they migrate, which may unpredictably impact any query at an earlier block height.")]),e._v(" "),o("ExpansionPanel",{attrs:{title:"Deleting data from blockchains"}},[o("p",[e._v("State storage is the most expensive resource a blockchain application uses. Wasteful use of storage burdens nodes with unnecessarily large storage requirements.")]),e._v(" "),o("p",[e._v("From an engineering perspective, it is important to separate strict protocol needs from overall requirements. If no state-changing, on-chain logic relies on a stored value, then by definition that value's usefulness is limited to reporting. Such a value is a candidate for deletion from the blockchain state. Reporting is important, but consider more efficient methods of addressing it.")]),e._v(" "),o("p",[e._v("An off-chain indexer - think block explorers - can record historic facts before they are purged. This will support queries about details that are no longer present on the chain. This can also support queries about details that are still present on the chain, but at a much cheaper cost per query than querying blockchain nodes.")]),e._v(" "),o("p",[e._v('Preventing duplication of unique identifiers is a common requirement. The rule can be enforced even if the details are purged, as long as you keep a list of used keys or observed hashes that must not be used again. For example, keep IDs for games that used to exist while deleting the details about the moves and results that have no further relevance to the protocol because the games are "over". If needed, you can keep the complete move-by-move history of the game in cheaper, off-chain storage. This is possible if you designed your chain with proper reporting mechanisms, for instance via events.')]),e._v(" "),o("p",[e._v("In most cases, the most elegant code proceeds on the basis that referential integrity is guaranteed, avoiding messy exceptions like orphaned keys. Internal referential integrity is entirely the responsibility of the application developer, so consider using techniques like cascade deletions or preventing deletion if a record is referenced elsewhere.")]),e._v(" "),o("p",[e._v("Generally, it is a good idea to use deletes to prevent the state from simply growing forever. A simple rule of thumb is to delete everything you can, but no more.")])]),e._v(" "),o("h3",{attrs:{id:"empty-indexer-module"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#empty-indexer-module"}},[e._v("#")]),e._v(" Empty indexer module")]),e._v(" "),o("p",[e._v("Define a barebones server without any Cosmos elements in an "),o("code",[e._v("indexer.ts")]),e._v(". This is not CosmJS related, so start from something else if you prefer.")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgd3JpdGVGaWxlIH0gZnJvbSAmcXVvdDtmcy9wcm9taXNlcyZxdW90OwppbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICZxdW90O2h0dHAmcXVvdDsKaW1wb3J0IGV4cHJlc3MsIHsgRXhwcmVzcywgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICZxdW90O2V4cHJlc3MmcXVvdDsKaW1wb3J0IHsgRGJUeXBlIH0gZnJvbSAmcXVvdDsuL3R5cGVzJnF1b3Q7CgpleHBvcnQgY29uc3QgY3JlYXRlSW5kZXhlciA9IGFzeW5jICgpID0mZ3Q7IHsKICAgIGNvbnN0IHBvcnQgPSAmcXVvdDszMDAxJnF1b3Q7CiAgICBjb25zdCBkYkZpbGUgPSBgJHtfX2Rpcm5hbWV9L2RiLmpzb25gCiAgICBjb25zdCBkYjogRGJUeXBlID0gcmVxdWlyZShkYkZpbGUpCiAgICBjb25zdCBwb2xsSW50ZXJ2YWxNcyA9IDVfMDAwIC8vIDUgc2Vjb25kcwogICAgbGV0IHRpbWVyOiBOb2RlSlMuVGltZXIgfCB1bmRlZmluZWQKCiAgICBjb25zdCBhcHA6IEV4cHJlc3MgPSBleHByZXNzKCkKICAgIGFwcC5nZXQoJnF1b3Q7LyZxdW90OywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPSZndDsgewogICAgICAgIHJlcy5zZW5kKHsKICAgICAgICAgICAgZXJyb3I6ICZxdW90O05vdCBpbXBsZW1lbnRlZCZxdW90OywKICAgICAgICB9KQogICAgfSkKCiAgICBhcHAuZ2V0KCZxdW90Oy9zdGF0dXMmcXVvdDssIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0mZ3Q7IHsKICAgICAgICByZXMuanNvbih7CiAgICAgICAgICAgIGJsb2NrOiB7CiAgICAgICAgICAgICAgICBoZWlnaHQ6IGRiLnN0YXR1cy5ibG9jay5oZWlnaHQsCiAgICAgICAgICAgIH0sCiAgICAgICAgfSkKICAgIH0pCgogICAgYXBwLmdldCgmcXVvdDsvcGxheWVycy86cGxheWVyQWRkcmVzcyZxdW90OywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPSZndDsgewogICAgICAgIHJlcy5qc29uKHsKICAgICAgICAgICAgZ2FtZUNvdW50OiBkYi5wbGF5ZXJzW3JlcS5wYXJhbXMucGxheWVyQWRkcmVzc10/LmdhbWVJZHM/Lmxlbmd0aCA/PyAwLAogICAgICAgICAgICBnYW1lSWRzOiBkYi5wbGF5ZXJzW3JlcS5wYXJhbXMucGxheWVyQWRkcmVzc10/LmdhbWVJZHMgPz8gW10sCiAgICAgICAgfSkKICAgIH0pCgogICAgYXBwLmdldCgmcXVvdDsvcGxheWVycy86cGxheWVyQWRkcmVzcy9nYW1lSWRzJnF1b3Q7LCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9Jmd0OyB7CiAgICAgICAgcmVzLmpzb24oZGIucGxheWVyc1tyZXEucGFyYW1zLnBsYXllckFkZHJlc3NdPy5nYW1lSWRzID8/IFtdKQogICAgfSkKCiAgICBhcHAucGF0Y2goJnF1b3Q7L2dhbWVzLzpnYW1lSWQmcXVvdDssIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0mZ3Q7IHsKICAgICAgICByZXMuanNvbih7CiAgICAgICAgICAgIHJlc3VsdDogJnF1b3Q7Tm90IGltcGxlbWVudGVkJnF1b3Q7LAogICAgICAgIH0pCiAgICB9KQoKICAgIGNvbnN0IHNhdmVEYiA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBhd2FpdCB3cml0ZUZpbGUoZGJGaWxlLCBKU09OLnN0cmluZ2lmeShkYiwgbnVsbCwgNCkpCiAgICB9CgogICAgY29uc3QgaW5pdCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBzZXRUaW1lb3V0KHBvbGwsIDEpCiAgICB9CgogICAgY29uc3QgcG9sbCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBjb25zb2xlLmxvZyhuZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpLCAmcXVvdDtUT0RPIHBvbGwmcXVvdDspCiAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIHBvbGxJbnRlcnZhbE1zKQogICAgfQoKICAgIHByb2Nlc3Mub24oJnF1b3Q7U0lHSU5UJnF1b3Q7LCAoKSA9Jmd0OyB7CiAgICAgICAgaWYgKHRpbWVyKSBjbGVhclRpbWVvdXQodGltZXIpCiAgICAgICAgc2F2ZURiKCkKICAgICAgICAgICAgLnRoZW4oKCkgPSZndDsgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7ZGJGaWxlfSBzYXZlZGApCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaChjb25zb2xlLmVycm9yKQogICAgICAgICAgICAuZmluYWxseSgoKSA9Jmd0OyB7CiAgICAgICAgICAgICAgICBzZXJ2ZXIuY2xvc2UoKCkgPSZndDsgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCZxdW90O3NlcnZlciBjbG9zZWQmcXVvdDspCiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KQogICAgfSkKCiAgICBjb25zdCBzZXJ2ZXI6IFNlcnZlciA9IGFwcC5saXN0ZW4ocG9ydCwgKCkgPSZndDsgewogICAgICAgIGluaXQoKQogICAgICAgICAgICAuY2F0Y2goY29uc29sZS5lcnJvcikKICAgICAgICAgICAgLnRoZW4oKCkgPSZndDsgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFxuc2VydmVyIHN0YXJ0ZWQgYXQgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9YCkKICAgICAgICAgICAgfSkKICAgIH0pCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("Note:")]),e._v(" "),o("ol",[o("li",[e._v("The timer is set at the end of the previous poll, in case indexing takes longer than the interval.")]),e._v(" "),o("li",[e._v("The "),o("em",[e._v("database")]),e._v(" is, for now, purely in memory as it runs and is saved on exit by catching the interruption signal.")])])]),e._v(" "),o("h3",{attrs:{id:"files-for-execution"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#files-for-execution"}},[e._v("#")]),e._v(" Files for execution")]),e._v(" "),o("p",[e._v("Prepare these files around the "),o("code",[e._v("indexer")]),e._v(" to run it in the terminal:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("Create an "),o("code",[e._v("index.ts")]),e._v(" that describes how to run the "),o("code",[e._v("indexer")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"cmVxdWlyZSgmcXVvdDsuL2luZGV4ZXImcXVvdDspLmNyZWF0ZUluZGV4ZXIoKS50aGVuKGNvbnNvbGUubG9nKS5jYXRjaChjb25zb2xlLmVycm9yKQpleHBvcnQge30K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/index.ts"}}),e._v(" "),o("p",[e._v("The "),o("code",[e._v("export {}")]),e._v(" prevents Visual Studio Code from complaining.")])],1),e._v(" "),o("li",[o("p",[e._v("Add a specific "),o("code",[e._v("tsconfig.json")]),e._v(" file if necessary:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7ZXh0ZW5kcyZxdW90OzogJnF1b3Q7Li4vLi4vdHNjb25maWcuanNvbiZxdW90OywKICAgICZxdW90O2NvbXBpbGVyT3B0aW9ucyZxdW90OzogewogICAgICAgICZxdW90O3RhcmdldCZxdW90OzogJnF1b3Q7RVNOZXh0JnF1b3Q7LAogICAgICAgICZxdW90O2lzb2xhdGVkTW9kdWxlcyZxdW90OzogZmFsc2UsCiAgICAgICAgJnF1b3Q7bW9kdWxlJnF1b3Q7OiAmcXVvdDtDb21tb25KUyZxdW90OwogICAgfQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/tsconfig.json"}})],1),e._v(" "),o("li",[o("p",[e._v("In "),o("code",[e._v("package.json")]),e._v(", add a "),o("code",[e._v("run")]),e._v(" target:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-json",base64:"ICAgICZxdW90O3NjcmlwdHMmcXVvdDs6IHsKICAgICAgICAuLi4KKyAgICAgICZxdW90O2luZGV4ZXItZGV2JnF1b3Q7OiAmcXVvdDtucHggdHMtbm9kZSBzcmMvc2VydmVyL2luZGV4LnRzJnF1b3Q7CiAgICB9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/package.json#L13"}})],1),e._v(" "),o("li",[o("p",[e._v("Add your "),o("em",[e._v("database")]),e._v(", "),o("code",[e._v("db.json")]),e._v(" by making a copy of the sample:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAgICAgJnF1b3Q7YmxvY2smcXVvdDs6IHsKICAgICAgICAgICAgJnF1b3Q7aGVpZ2h0JnF1b3Q7OiAwCiAgICAgICAgfQogICAgfSwKICAgICZxdW90O3BsYXllcnMmcXVvdDs6IHt9LAogICAgJnF1b3Q7Z2FtZXMmcXVvdDs6IHt9Cn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/db.json.sample"}}),e._v(" "),o("p",[e._v("You cannot ask for block at height "),o("code",[e._v("0")]),e._v(", so the indexer first asks for the next block at "),o("code",[e._v("1")]),e._v(".")])],1)]),e._v(" "),o("h3",{attrs:{id:"quick-test"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#quick-test"}},[e._v("#")]),e._v(" Quick test")]),e._v(" "),o("p",[e._v("Check that the "),o("code",[e._v("indexer")]),e._v(" works:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBucG0gcnVuIGluZGV4ZXItZGV2Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2xpZW50IC13IC9jbGllbnQgXAogICAgLXAgMzAwMTozMDAxIFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1uZXQgXAogICAgLS1lbnYgUlBDX1VSTD0mcXVvdDtodHRwOi8vY2hlY2tlcnM6MjY2NTcmcXVvdDsgXAogICAgbm9kZToxOC43LXNsaW0gXAogICAgbnBtIHJ1biBpbmRleGVyLWRldgo="}})],1)],1),e._v(" "),o("p",[e._v("It should print:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Jmd0OyBjaGVja2Vycy1zZXJ2ZXJAMS4wLjAgZGV2CiZndDsgbnB4IHRzLW5vZGUgaW5kZXgudHMKCnNlcnZlciBzdGFydGVkIGF0IGh0dHA6Ly9sb2NhbGhvc3Q6MzAwMQo="}}),e._v(" "),o("p",[e._v("Now, in another terminal, test the endpoints. Omit the "),o("code",[e._v("| jq")]),e._v(" beautifier if it is not installed on your system:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"status",active:""}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIGxvY2FsaG9zdDozMDAxL3N0YXR1cyB8IGpxCg=="}}),e._v(" "),o("p",[e._v("It should return:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O2Jsb2NrJnF1b3Q7OiB7CiAgICAmcXVvdDtoZWlnaHQmcXVvdDs6IDAKICB9Cn0K"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"player info"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIGxvY2FsaG9zdDozMDAxL3BsYXllcnMvY29zbW9zMTIzIHwganEK"}}),e._v(" "),o("p",[e._v("It should return:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O2dhbWVDb3VudCZxdW90OzogMCwKICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbXQp9Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"player games"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIGxvY2FsaG9zdDozMDAxL3BsYXllcnMvY29zbW9zMTIzL2dhbWVJZHMgfCBqcQo="}}),e._v(" "),o("p",[e._v("It should return:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"W10K"}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"game update"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIC1YIFBBVENIIGxvY2FsaG9zdDozMDAxL2dhbWVzLzQ0NSB8IGpxCg=="}}),e._v(" "),o("p",[e._v("It should return:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O3Jlc3VsdCZxdW90OzogJnF1b3Q7Tm90IGltcGxlbWVudGVkJnF1b3Q7Cn0K"}})],1)],1),e._v(" "),o("hr"),e._v(" "),o("h2",{attrs:{id:"add-cosmjs-stargateclient"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#add-cosmjs-stargateclient"}},[e._v("#")]),e._v(" Add CosmJS "),o("code",[e._v("StargateClient")])]),e._v(" "),o("p",[e._v("You need to create a client to connect to your checkers blockchain. The client only needs read-only functionality because this server does not submit transactions. Your repository already contains useful elements:")]),e._v(" "),o("ul",[o("li",[e._v("The "),o("code",[e._v("CheckersStargateClient")]),e._v(".")]),e._v(" "),o("li",[e._v("An "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/.env",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v(".env")]),o("OutboundLink")],1),e._v(" file.")])]),e._v(" "),o("p",[e._v("Add the following to "),o("code",[e._v("indexer.ts")]),e._v(":")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("The declarations:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgY29uZmlnIH0gZnJvbSAmcXVvdDtkb3RlbnYmcXVvdDsKaW1wb3J0IHsgQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudCB9IGZyb20gJnF1b3Q7Li4vY2hlY2tlcnNfc3RhcmdhdGVjbGllbnQmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L5"}}),e._v(" "),o("p",[e._v("The pickup of "),o("code",[e._v("RPC_URL")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uZmlnKCkK",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L14"}}),e._v(" "),o("p",[e._v("The client in the indexer:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"bGV0IGNsaWVudDogQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudAo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L22"}})],1),e._v(" "),o("li",[o("p",[e._v("The modified "),o("code",[e._v("init")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaW5pdCA9IGFzeW5jKCkgPSZndDsgewogICAgY2xpZW50ID0gYXdhaXQgQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudC5jb25uZWN0KHByb2Nlc3MuZW52LlJQQ19VUkwhKQogICAgY29uc29sZS5sb2coJnF1b3Q7Q29ubmVjdGVkIHRvIGNoYWluLWlkOiZxdW90OywgYXdhaXQgY2xpZW50LmdldENoYWluSWQoKSkKICAgIHNldFRpbWVvdXQocG9sbCwgMSkKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L64-L68"}})],1),e._v(" "),o("li",[o("p",[e._v("The modified "),o("code",[e._v("poll")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgcG9sbCA9IGFzeW5jKCkgPSZndDsgewogICAgY29uc3QgY3VycmVudEhlaWdodCA9IGF3YWl0IGNsaWVudC5nZXRIZWlnaHQoKQogICAgY29uc29sZS5sb2coCiAgICAgICAgbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSwKICAgICAgICAmcXVvdDtDdXJyZW50IGhlaWdodHM6JnF1b3Q7LAogICAgICAgIGRiLnN0YXR1cy5ibG9jay5oZWlnaHQsCiAgICAgICAgJnF1b3Q7Jmx0Oz0mcXVvdDssCiAgICAgICAgY3VycmVudEhlaWdodCwKICAgICkKICAgIHRpbWVyID0gc2V0VGltZW91dChwb2xsLCBwb2xsSW50ZXJ2YWxNcykKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L70-L85"}})],1)]),e._v(" "),o("p",[e._v("If you have not done it yet, start your checkers chain as described at the beginning of this section.")]),e._v(" "),o("p",[e._v("Relaunch the indexer:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Local"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBucG0gcnVuIGluZGV4ZXItZGV2Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Docker"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2xpZW50IC13IC9jbGllbnQgXAogICAgLXAgMzAwMTozMDAxIFwKICAgIC0tbmV0d29yayBjaGVja2Vycy1uZXQgXAogICAgLS1lbnYgUlBDX1VSTD0mcXVvdDtodHRwOi8vY2hlY2tlcnM6MjY2NTcmcXVvdDsgXAogICAgbm9kZToxOC43LXNsaW0gXAogICAgbnBtIHJ1biBpbmRleGVyLWRldgo="}}),e._v(" "),o("HighlightBox",{attrs:{type:"tip"}},[o("p",[e._v("Note how the container is started inside "),o("code",[e._v("checkers-net")]),e._v(" alongside the checkers blockchain.")])])],1)],1),e._v(" "),o("p",[e._v("You should see the current height rising:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Q29ubmVjdGVkIHRvIGNoYWluLWlkOiBjaGVja2Vycy0xCgpzZXJ2ZXIgc3RhcnRlZCBhdCBodHRwOi8vbG9jYWxob3N0OjMwMDEKMjAyMi0wNC0yMFQxNzo0NjoyOS45NjJaIEN1cnJlbnQgaGVpZ2h0czogMCAmbHQ7PSAxMzUzCjIwMjItMDQtMjBUMTc6NDY6MzQuOTY4WiBDdXJyZW50IGhlaWdodHM6IDAgJmx0Oz0gMTM1Nwo="}}),e._v(" "),o("h2",{attrs:{id:"handle-blocks"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-blocks"}},[e._v("#")]),e._v(" Handle blocks")]),e._v(" "),o("p",[e._v("To index games, take each block and listen for the following relevant events:")]),e._v(" "),o("ol",[o("li",[e._v("A transaction with a "),o("code",[e._v("new-game-created")]),e._v(" event.")]),e._v(" "),o("li",[e._v("An "),o("code",[e._v("EndBlock")]),e._v(" with a "),o("code",[e._v("game-forfeited")]),e._v(" event.")])]),e._v(" "),o("p",[e._v("Start by getting each block from your last saved state. Update "),o("code",[e._v("poll")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgcG9sbCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgIGNvbnN0IGN1cnJlbnRIZWlnaHQgPSBhd2FpdCBjbGllbnQuZ2V0SGVpZ2h0KCkKICAgIGlmIChkYi5zdGF0dXMuYmxvY2suaGVpZ2h0ICZsdDs9IGN1cnJlbnRIZWlnaHQgLSAxMDApCiAgICAgICAgY29uc29sZS5sb2coYENhdGNoaW5nIHVwICR7ZGIuc3RhdHVzLmJsb2NrLmhlaWdodH0uLiR7Y3VycmVudEhlaWdodH1gKQogICAgd2hpbGUgKGRiLnN0YXR1cy5ibG9jay5oZWlnaHQgJmx0OyBjdXJyZW50SGVpZ2h0KSB7CiAgICAgICAgY29uc3QgcHJvY2Vzc2luZyA9IGRiLnN0YXR1cy5ibG9jay5oZWlnaHQgKyAxCiAgICAgICAgcHJvY2Vzcy5zdGRvdXQuY3Vyc29yVG8oMCkKICAgICAgICAvLyBHZXQgdGhlIGJsb2NrCiAgICAgICAgY29uc3QgYmxvY2s6IEJsb2NrID0gYXdhaXQgY2xpZW50LmdldEJsb2NrKHByb2Nlc3NpbmcpCiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYEhhbmRsaW5nIGJsb2NrOiAke3Byb2Nlc3Npbmd9IHdpdGggJHtibG9jay50eHMubGVuZ3RofSB0eHNgKQogICAgICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgICAgIGF3YWl0IGhhbmRsZUJsb2NrKGJsb2NrKQogICAgICAgIGRiLnN0YXR1cy5ibG9jay5oZWlnaHQgPSBwcm9jZXNzaW5nCiAgICB9CiAgICBhd2FpdCBzYXZlRGIoKQogICAgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIHBvbGxJbnRlcnZhbE1zKQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L70-L85"}}),e._v(" "),o("p",[e._v("This needs a new import:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgQmxvY2sgfSBmcm9tICZxdW90O0Bjb3NtanMvc3RhcmdhdGUmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L3"}}),e._v(" "),o("p",[e._v("The indexer:")]),e._v(" "),o("ul",[o("li",[e._v("Declares a new function "),o("code",[e._v("handleBlock")]),e._v(". Create one and put "),o("code",[e._v("console.log(block)")]),e._v(" inside to explore what this object is and consider what actions you would take with it.")]),e._v(" "),o("li",[e._v("Saves the "),o("code",[e._v("db")]),e._v(" after a poll, so "),o("em",[e._v("you")]),e._v(" can watch it in real time.")]),e._v(" "),o("li",[e._v("Uses "),o("code",[e._v("process.stdout.write")]),e._v(" and "),o("code",[e._v("process.stdout.cursorTo(0)")]),e._v(" so that the repetitive logging happens on a single line.")])]),e._v(" "),o("p",[e._v("Observe the relevant content in "),o("code",[e._v("handleBlock")]),e._v(". It must:")]),e._v(" "),o("ol",[o("li",[e._v("Extract the events from transactions.")]),e._v(" "),o("li",[e._v("Extract the events from "),o("code",[e._v("EndBlock")]),e._v(".")])]),e._v(" "),o("p",[e._v("If you examine "),o("code",[e._v("block.txs")]),e._v(" directly you find transactions as they were posted. However, this does not reveal any execution results, such as if a transaction executed as expected or what game ID it used for the new game. To get this extra information:")]),e._v(" "),o("ol",[o("li",[e._v("Calculate "),o("code",[e._v("txHash")]),e._v(" from the transaction.")]),e._v(" "),o("li",[e._v("Call "),o("code",[e._v("await client.getTx(txHash)")]),e._v(", which returns an "),o("code",[e._v("IndexedTx")]),e._v(".")])]),e._v(" "),o("p",[e._v("The "),o("code",[e._v("handleBlock")]),e._v(" function can be:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlQmxvY2sgPSBhc3luYyAoYmxvY2s6IEJsb2NrKSA9Jmd0OyB7CiAgICBpZiAoMCAmbHQ7IGJsb2NrLnR4cy5sZW5ndGgpIGNvbnNvbGUubG9nKCZxdW90OyZxdW90OykKICAgIGxldCB0eEluZGV4ID0gMAogICAgd2hpbGUgKHR4SW5kZXggJmx0OyBibG9jay50eHMubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgdHhIYXNoOiBzdHJpbmcgPSB0b0hleChzaGEyNTYoYmxvY2sudHhzW3R4SW5kZXhdKSkudG9VcHBlckNhc2UoKQogICAgICAgIGNvbnN0IGluZGV4ZWQ6IEluZGV4ZWRUeCB8IG51bGwgPSBhd2FpdCBjbGllbnQuZ2V0VHgodHhIYXNoKQogICAgICAgIGlmICghaW5kZXhlZCkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBpbmRleGVkIHR4OiAke3R4SGFzaH1gKQogICAgICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgICAgIGF3YWl0IGhhbmRsZVR4KGluZGV4ZWQpCiAgICAgICAgdHhJbmRleCsrCiAgICB9CiAgICAvLyBUT0RPIGhhbmRsZSBFbmRCbG9jawp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L87-L96"}}),e._v(" "),o("p",[e._v("This needs new imports:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-typescript",base64:"KyAgaW1wb3J0IHsgc2hhMjU2IH0gZnJvbSAmcXVvdDtAY29zbWpzL2NyeXB0byZxdW90OworICBpbXBvcnQgeyB0b0hleCB9IGZyb20gJnF1b3Q7QGNvc21qcy9lbmNvZGluZyZxdW90OwotICBpbXBvcnQgeyBCbG9jayB9IGZyb20gJnF1b3Q7QGNvc21qcy9zdGFyZ2F0ZSZxdW90OworICBpbXBvcnQgeyBCbG9jaywgSW5kZXhlZFR4IH0gZnJvbSAmcXVvdDtAY29zbWpzL3N0YXJnYXRlJnF1b3Q7Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L1-L3"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("code",[e._v("while() { await }")]),e._v(" simplifies the syntax of "),o("code",[e._v("await")]),e._v("ing multiple times sequentially.")]),e._v(" "),o("li",[e._v("The hash is calculated this way as per "),o("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/v0.28.11/packages%2Fstargate%2Fsrc%2Fstargateclient.ts#L77",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("li",[o("code",[e._v('console.log("")')]),e._v(" puts a new line ("),o("code",[e._v("poll")]),e._v(" does a "),o("code",[e._v("process.stdout.write")]),e._v(" which adds no line).")]),e._v(" "),o("li",[e._v("The "),o("code",[e._v("handleBlock")]),e._v(" function uses a new function, "),o("code",[e._v("handleTx")]),e._v(". Create one and put "),o("code",[e._v("console.log(indexed)")]),e._v(" inside to explore what this object is and consider what actions you can take with it.")]),e._v(" "),o("li",[e._v("The "),o("code",[e._v("EndBlock")]),e._v(" part has not yet been incorporated. This is explained in "),o("strong",[e._v("Prepare for EndBlock")]),e._v(".")])])]),e._v(" "),o("h2",{attrs:{id:"handle-a-transaction"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-a-transaction"}},[e._v("#")]),e._v(" Handle a transaction")]),e._v(" "),o("p",[e._v("Define the "),o("code",[e._v("handleTx")]),e._v(" function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlVHggPSBhc3luYyAoaW5kZXhlZDogSW5kZXhlZFR4KSA9Jmd0OyB7CiAgICBjb25zdCByYXdMb2c6IGFueSA9IEpTT04ucGFyc2UoaW5kZXhlZC5yYXdMb2cpCiAgICBjb25zdCBldmVudHM6IFN0cmluZ0V2ZW50W10gPSByYXdMb2cuZmxhdE1hcCgobG9nOiBBQkNJTWVzc2FnZUxvZykgPSZndDsgbG9nLmV2ZW50cykKICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgYXdhaXQgaGFuZGxlRXZlbnRzKGV2ZW50cykKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L102-L106"}}),e._v(" "),o("p",[e._v("This needs new imports:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgQUJDSU1lc3NhZ2VMb2csIFN0cmluZ0V2ZW50IH0gZnJvbSAmcXVvdDtjb3NtanMtdHlwZXMvY29zbW9zL2Jhc2UvYWJjaS92MWJldGExL2FiY2kmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L4"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flatMap",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v(".flatMap")]),o("OutboundLink")],1),e._v(" transforms an array of arrays into a flattened array.")]),e._v(" "),o("li",[e._v("The "),o("code",[e._v("handleTx")]),e._v(" function uses a new function, "),o("code",[e._v("handleEvents")]),e._v(". Create one and put "),o("code",[e._v("console.log(events)")]),e._v(" in it to explore what this object is and consider what actions you can take with it.")])])]),e._v(" "),o("h2",{attrs:{id:"handle-events"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-events"}},[e._v("#")]),e._v(" Handle events")]),e._v(" "),o("p",[e._v("Define the "),o("code",[e._v("handleEvents")]),e._v(" function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRzID0gYXN5bmMgKGV2ZW50czogU3RyaW5nRXZlbnRbXSk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgdHJ5IHsKICAgICAgICBsZXQgZXZlbnRJbmRleCA9IDAKICAgICAgICB3aGlsZSAoZXZlbnRJbmRleCAmbHQ7IGV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgLy8gRnVuY3Rpb24geWV0IHRvIGJlIGRlY2xhcmVkCiAgICAgICAgICAgIGF3YWl0IGhhbmRsZUV2ZW50KGV2ZW50c1tldmVudEluZGV4XSkKICAgICAgICAgICAgZXZlbnRJbmRleCsrCiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFNraXBwaW5nIGlmIHRoZSBoYW5kbGluZyBmYWlsZWQuIE1vc3QgbGlrZWx5IHRoZSB0cmFuc2FjdGlvbiBmYWlsZWQuCiAgICB9Cn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L108-L118"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("code",[e._v("while() {}")]),e._v(" simplifies the syntax of "),o("code",[e._v("await")]),e._v("ing multiple times sequentially.")]),e._v(" "),o("li",[e._v("The "),o("code",[e._v("handleEvents")]),e._v(" function only keeps events that emanate from the "),o("code",[e._v("checkers")]),e._v(" module.")]),e._v(" "),o("li",[e._v("It uses a new function, "),o("code",[e._v("handleEvent")]),e._v(". Create one and put "),o("code",[e._v("console.log(event)")]),e._v(" inside to explore what this object is and consider what actions you can take with it.")]),e._v(" "),o("li",[e._v("It skips in case of error, as the likely cause is that the transactions in fact failed. This is not good enough if the goal is to be absolutely accurate.")])])]),e._v(" "),o("h2",{attrs:{id:"handle-one-event"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-event"}},[e._v("#")]),e._v(" Handle one event")]),e._v(" "),o("p",[e._v("Define "),o("code",[e._v("handleEvent")]),e._v(" as follows:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnQgPSBhc3luYyAoZXZlbnQ6IFN0cmluZ0V2ZW50KTogUHJvbWlzZSZsdDt2b2lkJmd0OyA9Jmd0OyB7CiAgICBpZiAoZXZlbnQudHlwZSA9PSAmcXVvdDtuZXctZ2FtZS1jcmVhdGVkJnF1b3Q7KSB7CiAgICAgICAgLy8gRnVuY3Rpb24geWV0IHRvIGJlIGRlY2xhcmVkCiAgICAgICAgYXdhaXQgaGFuZGxlRXZlbnRDcmVhdGUoZXZlbnQpCiAgICB9CiAgICBpZiAoZXZlbnQudHlwZSA9PSAmcXVvdDttb3ZlLXBsYXllZCZxdW90OykgewogICAgICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgICAgIGF3YWl0IGhhbmRsZUV2ZW50UGxheShldmVudCkKICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L120-L129"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/cosmjs-elements/x/checkers/types/keys.go#L31",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("new-game-created")]),o("OutboundLink")],1),e._v(" and "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/cosmjs-elements/x/checkers/types/keys.go#L41",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("move-played")]),o("OutboundLink")],1),e._v(" are constant values defined in your Go code. They are put as the "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/cosmjs-elements/x/checkers/keeper/msg_server_create_game.go#L50",target:"_blank",rel:"noopener noreferrer"}},[e._v("event's type"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("li",[o("code",[e._v("handleEvent")]),e._v(" uses two new functions: "),o("code",[e._v("handleEventCreate")]),e._v(" and "),o("code",[e._v("handleEventPlay")]),e._v(". Create them and put "),o("code",[e._v("console.log(event)")]),e._v(" inside each to explore what these objects are and consider what actions you would take with them.")])])]),e._v(" "),o("h2",{attrs:{id:"handle-one-create-event"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-create-event"}},[e._v("#")]),e._v(" Handle one create event")]),e._v(" "),o("p",[e._v("Now update your "),o("code",[e._v("db")]),e._v(" with the information provided. First, define a convenience function in "),o("code",[e._v("createIndexer")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgZ2V0QXR0cmlidXRlVmFsdWVCeUtleSA9IChhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVbXSwga2V5OiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQgPSZndDsgewogICAgcmV0dXJuIGF0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlOiBBdHRyaWJ1dGUpID0mZ3Q7IGF0dHJpYnV0ZS5rZXkgPT09IGtleSk/LnZhbHVlCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L135-L137"}}),e._v(" "),o("p",[e._v("This needs a new import:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-typescript",base64:"LSBpbXBvcnQgeyBBQkNJTWVzc2FnZUxvZywgU3RyaW5nRXZlbnQgfSBmcm9tICZxdW90O2Nvc21qcy10eXBlcy9jb3Ntb3MvYmFzZS9hYmNpL3YxYmV0YTEvYWJjaSZxdW90OworIGltcG9ydCB7IEFCQ0lNZXNzYWdlTG9nLCBBdHRyaWJ1dGUsIFN0cmluZ0V2ZW50IH0gZnJvbSAmcXVvdDtjb3NtanMtdHlwZXMvY29zbW9zL2Jhc2UvYWJjaS92MWJldGExL2FiY2kmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L4"}}),e._v(" "),o("p",[e._v("Now define "),o("code",[e._v("handleEventCreate")]),e._v(" as:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRDcmVhdGUgPSBhc3luYyAoZXZlbnQ6IFN0cmluZ0V2ZW50KTogUHJvbWlzZSZsdDt2b2lkJmd0OyA9Jmd0OyB7CiAgICBjb25zdCBuZXdJZDogc3RyaW5nIHwgdW5kZWZpbmVkID0gZ2V0QXR0cmlidXRlVmFsdWVCeUtleShldmVudC5hdHRyaWJ1dGVzLCAmcXVvdDtnYW1lLWluZGV4JnF1b3Q7KQogICAgaWYgKCFuZXdJZCkgdGhyb3cgbmV3IEVycm9yKGBDcmVhdGUgZXZlbnQgbWlzc2luZyBnYW1lLWluZGV4YCkKICAgIGNvbnN0IGJsYWNrQWRkcmVzczogc3RyaW5nIHwgdW5kZWZpbmVkID0gZ2V0QXR0cmlidXRlVmFsdWVCeUtleShldmVudC5hdHRyaWJ1dGVzLCAmcXVvdDtibGFjayZxdW90OykKICAgIGlmICghYmxhY2tBZGRyZXNzKSB0aHJvdyBuZXcgRXJyb3IoYENyZWF0ZSBldmVudCBtaXNzaW5nIGJsYWNrIGFkZHJlc3NgKQogICAgY29uc3QgcmVkQWRkcmVzczogc3RyaW5nIHwgdW5kZWZpbmVkID0gZ2V0QXR0cmlidXRlVmFsdWVCeUtleShldmVudC5hdHRyaWJ1dGVzLCAmcXVvdDtyZWQmcXVvdDspCiAgICBpZiAoIXJlZEFkZHJlc3MpIHRocm93IG5ldyBFcnJvcihgQ3JlYXRlIGV2ZW50IG1pc3NpbmcgcmVkIGFkZHJlc3NgKQogICAgY29uc29sZS5sb2coYE5ldyBnYW1lOiAke25ld0lkfSwgYmxhY2s6ICR7YmxhY2tBZGRyZXNzfSwgcmVkOiAke3JlZEFkZHJlc3N9YCkKICAgIGNvbnN0IGJsYWNrSW5mbzogUGxheWVySW5mbyA9IGRiLnBsYXllcnNbYmxhY2tBZGRyZXNzXSA/PyB7CiAgICAgICAgZ2FtZUlkczogW10sCiAgICB9CiAgICBjb25zdCByZWRJbmZvOiBQbGF5ZXJJbmZvID0gZGIucGxheWVyc1tyZWRBZGRyZXNzXSA/PyB7CiAgICAgICAgZ2FtZUlkczogW10sCiAgICB9CiAgICBpZiAoYmxhY2tJbmZvLmdhbWVJZHMuaW5kZXhPZihuZXdJZCkgJmx0OyAwKSBibGFja0luZm8uZ2FtZUlkcy5wdXNoKG5ld0lkKQogICAgaWYgKHJlZEluZm8uZ2FtZUlkcy5pbmRleE9mKG5ld0lkKSAmbHQ7IDApIHJlZEluZm8uZ2FtZUlkcy5wdXNoKG5ld0lkKQogICAgZGIucGxheWVyc1tibGFja0FkZHJlc3NdID0gYmxhY2tJbmZvCiAgICBkYi5wbGF5ZXJzW3JlZEFkZHJlc3NdID0gcmVkSW5mbwogICAgZGIuZ2FtZXNbbmV3SWRdID0gewogICAgICAgIHJlZEFkZHJlc3M6IHJlZEFkZHJlc3MsCiAgICAgICAgYmxhY2tBZGRyZXNzOiBibGFja0FkZHJlc3MsCiAgICAgICAgZGVsZXRlZDogZmFsc2UsCiAgICB9Cn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L139-L162"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/cosmjs-elements/x/checkers/keeper/msg_server_create_game.go#L52",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("game-index")]),o("OutboundLink")],1),e._v(", "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/cosmjs-elements/x/checkers/keeper/msg_server_create_game.go#L53",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("black")]),o("OutboundLink")],1),e._v(", and "),o("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/cosmjs-elements/x/checkers/keeper/msg_server_create_game.go#L54",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("red")]),o("OutboundLink")],1),e._v(" are constants from the Go code.")]),e._v(" "),o("li",[e._v("You have implemented error handling.")]),e._v(" "),o("li",[o("code",[e._v("handleEventCreate")]),e._v(" is careful not to double-add a given game ID.")]),e._v(" "),o("li",[e._v("It does not save "),o("code",[e._v("db")]),e._v(" as this is under the purview of "),o("code",[e._v("poll()")]),e._v(".")])])]),e._v(" "),o("h2",{attrs:{id:"handle-one-play-event"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-play-event"}},[e._v("#")]),e._v(" Handle one play event")]),e._v(" "),o("p",[e._v("Not all play events are equal. "),o("code",[e._v("handleEventPlay")]),e._v(" is only interested when there is a winner. Until then, there is no need to take any action.")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRQbGF5ID0gYXN5bmMgKGV2ZW50OiBTdHJpbmdFdmVudCk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgY29uc3QgcGxheWVkSWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGdldEF0dHJpYnV0ZVZhbHVlQnlLZXkoZXZlbnQuYXR0cmlidXRlcywgJnF1b3Q7Z2FtZS1pbmRleCZxdW90OykKICAgIGlmICghcGxheWVkSWQpIHRocm93IG5ldyBFcnJvcihgUGxheSBldmVudCBtaXNzaW5nIGdhbWUtaW5kZXhgKQogICAgY29uc3Qgd2lubmVyOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBnZXRBdHRyaWJ1dGVWYWx1ZUJ5S2V5KGV2ZW50LmF0dHJpYnV0ZXMsICZxdW90O3dpbm5lciZxdW90OykKICAgIGlmICghd2lubmVyKSB0aHJvdyBuZXcgRXJyb3IoJnF1b3Q7UGxheSBldmVudCBtaXNzaW5nIHdpbm5lciZxdW90OykKICAgIGlmICh3aW5uZXIgPT09ICZxdW90OyomcXVvdDspIHJldHVybgogICAgY29uc3QgYmxhY2tBZGRyZXNzOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBkYi5nYW1lc1twbGF5ZWRJZF0/LmJsYWNrQWRkcmVzcwogICAgY29uc3QgcmVkQWRkcmVzczogc3RyaW5nIHwgdW5kZWZpbmVkID0gZGIuZ2FtZXNbcGxheWVkSWRdPy5yZWRBZGRyZXNzCiAgICBjb25zb2xlLmxvZyhgV2luIGdhbWU6ICR7cGxheWVkSWR9LCBibGFjazogJHtibGFja0FkZHJlc3N9LCByZWQ6ICR7cmVkQWRkcmVzc30sIHdpbm5lcjogJHt3aW5uZXJ9YCkKICAgIGNvbnN0IGJsYWNrR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tibGFja0FkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zdCByZWRHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW3JlZEFkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zdCBpbmRleEluQmxhY2s6IG51bWJlciA9IGJsYWNrR2FtZXMuaW5kZXhPZihwbGF5ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgY29uc3QgaW5kZXhJblJlZDogbnVtYmVyID0gcmVkR2FtZXMuaW5kZXhPZihwbGF5ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5SZWQpIHJlZEdhbWVzLnNwbGljZShpbmRleEluUmVkLCAxKQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L179-L194"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("ul",[o("li",[o("code",[e._v("handleEventPlay")]),e._v(" returns quietly if there is no winner, because this means there is nothing to do.")]),e._v(" "),o("li",[e._v("It keeps the game information in the "),o("code",[e._v("db")]),e._v(".")]),e._v(" "),o("li",[e._v("It removes the id from both players' list of games.")])])]),e._v(" "),o("h2",{attrs:{id:"test-time"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#test-time"}},[e._v("#")]),e._v(" Test time")]),e._v(" "),o("p",[e._v("You can now test what happens when a game is created and played on. Restart "),o("code",[e._v("npm run indexer-dev")]),e._v(" locally or in Docker.")]),e._v(" "),o("p",[e._v("You can choose how to create and play games:")]),e._v(" "),o("ul",[o("li",[e._v("Run the GUI prepared in the "),o("RouterLink",{attrs:{to:"/hands-on-exercise/3-cosmjs-adv/4-cosmjs-gui.html"}},[e._v("previous section")]),e._v(" with "),o("code",[e._v("npm start")]),e._v(".")],1),e._v(" "),o("li",[e._v("Run "),o("code",[e._v("checkersd")]),e._v(" command lines.")]),e._v(" "),o("li",[e._v("Any other way available.")])]),e._v(" "),o("p",[e._v("Via command lines, in another terminal:")]),e._v(" "),o("CodeGroup",[o("CodeGroupItem",{attrs:{title:"Create game"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgc2ggLWMgXAogICAgJnF1b3Q7Y2hlY2tlcnNkIHR4IGNoZWNrZXJzIFwKICAgIGNyZWF0ZS1nYW1lIFwkQUxJQ0UgY29zbW9zMXQ4OGZrd3VybG51c2Y2YWd2cHRzbm0zM3Q0MGtyNGhscTZoMDhzIDAgc3Rha2UgXAogICAgLS1mcm9tIGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QgXAogICAgLS15ZXMmcXVvdDsK"}}),e._v(" "),o("p",[e._v("Alternatively, use a GUI if preferred. The indexer should log something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"TmV3IGdhbWU6IDEsIGJsYWNrOiBjb3Ntb3MxYW0zZm5wNWRkNm5uZGs1anlqcTltcHFoM3l2dDJqbW1kdjgzeG4sIHJlZDogY29zbW9zMXQ4OGZrd3VybG51c2Y2YWd2cHRzbm0zM3Q0MGtyNGhscTZoMDhzCg=="}}),e._v(" "),o("p",[e._v("It should update "),o("code",[e._v("db.json")]),e._v(" to:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAgICAgJnF1b3Q7YmxvY2smcXVvdDs6IHsKICAgICAgICAgICAgJnF1b3Q7aGVpZ2h0JnF1b3Q7OiAxMDAKICAgICAgICB9CiAgICB9LAogICAgJnF1b3Q7cGxheWVycyZxdW90OzogewogICAgICAgICZxdW90O2Nvc21vczFhbTNmbnA1ZGQ2bm5kazVqeWpxOW1wcWgzeXZ0MmptbWR2ODN4biZxdW90OzogewogICAgICAgICAgICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbCiAgICAgICAgICAgICAgICAmcXVvdDsxJnF1b3Q7CiAgICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgICZxdW90O2Nvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cyZxdW90OzogewogICAgICAgICAgICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbCiAgICAgICAgICAgICAgICAmcXVvdDsxJnF1b3Q7CiAgICAgICAgICAgIF0KICAgICAgICB9CiAgICB9LAogICAgJnF1b3Q7Z2FtZXMmcXVvdDs6IHsKICAgICAgICAmcXVvdDsxJnF1b3Q7OiB7CiAgICAgICAgICAgICZxdW90O3JlZEFkZHJlc3MmcXVvdDs6ICZxdW90O2Nvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cyZxdW90OywKICAgICAgICAgICAgJnF1b3Q7YmxhY2tBZGRyZXNzJnF1b3Q7OiAmcXVvdDtjb3Ntb3MxYW0zZm5wNWRkNm5uZGs1anlqcTltcHFoM3l2dDJqbW1kdjgzeG4mcXVvdDssCiAgICAgICAgICAgICZxdW90O2RlbGV0ZWQmcXVvdDs6IGZhbHNlCiAgICAgICAgfQogICAgfQp9Cg=="}})],1),e._v(" "),o("CodeGroupItem",{attrs:{title:"Play game"}},[o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHR4IGNoZWNrZXJzIFwKICAgIHBsYXktbW92ZSAxIDEgMiAyIDMgXAogICAgLS1mcm9tIGFsaWNlIC0ta2V5cmluZy1iYWNrZW5kIHRlc3QgXAogICAgLS15ZXMK"}}),e._v(" "),o("p",[e._v("In this case the indexer should not log anything.")]),e._v(" "),o("p",[e._v("Because performing moves from the command line is laborious, using the GUI is advisable.")])],1)],1),e._v(" "),o("hr"),e._v(" "),o("p",[e._v("What remains is handling the games that get removed or forfeited in "),o("code",[e._v("EndBlock")]),e._v(".")]),e._v(" "),o("h2",{attrs:{id:"prepare-for-endblock"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#prepare-for-endblock"}},[e._v("#")]),e._v(" Prepare for "),o("code",[e._v("EndBlock")])]),e._v(" "),o("p",[e._v("Nicely formatted "),o("code",[e._v("EndBlock")]),e._v(" events are still missing from CosmJS, so these require a little extra work:")]),e._v(" "),o("ol",[o("li",[e._v("To get a block's "),o("code",[e._v("EndBlock")]),e._v(" events, you need to ask for the block information from a CometBFT client. This client is a "),o("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/902f21b/packages%2Fstargate%2Fsrc%2Fstargateclient.ts#L140",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("private")]),e._v(" field"),o("OutboundLink")],1),e._v(" of "),o("code",[e._v("StargateClient")]),e._v(".")]),e._v(" "),o("li",[e._v("The function to call is "),o("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/5ee3f82/packages/tendermint-rpc/src/tendermint34/tendermint34client.ts#L88",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("blockResults")]),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("li",[e._v("It returns a "),o("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/ca969f2/packages/tendermint-rpc/src/tendermint34/responses.ts#L55",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("BlockResultsResponse")]),o("OutboundLink")],1),e._v(", of which "),o("code",[e._v("endBlockEvents: Event")]),e._v(" is of interest.")]),e._v(" "),o("li",[e._v("This "),o("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/ca969f2/packages/tendermint-rpc/src/tendermint34/responses.ts#L182",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("Event")]),o("OutboundLink")],1),e._v(" type has "),o("code",[e._v("attributes: Attribute[]")]),e._v(" of interest.")]),e._v(" "),o("li",[e._v("The "),o("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/ca969f2/packages/tendermint-rpc/src/tendermint34/responses.ts#L177-L180",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("Attribute")]),o("OutboundLink")],1),e._v(" type is coded as "),o("code",[e._v("Uint8Array")]),e._v(".")])]),e._v(" "),o("p",[e._v("With this information, you can do the necessary actions:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("To handle the conversion of CometBFT "),o("code",[e._v("Event")]),e._v("s into "),o("code",[e._v("StringEvent")]),e._v("s, create a helper in a new "),o("code",[e._v("src/server/events.ts")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgZnJvbVV0ZjggfSBmcm9tICZxdW90O0Bjb3NtanMvZW5jb2RpbmcmcXVvdDsKaW1wb3J0IHsgQXR0cmlidXRlIGFzIFRlbmRlcm1pbnRBdHRyaWJ1dGUsIEV2ZW50IH0gZnJvbSAmcXVvdDtAY29zbWpzL3RlbmRlcm1pbnQtcnBjJnF1b3Q7CmltcG9ydCB7IEF0dHJpYnV0ZSwgU3RyaW5nRXZlbnQgfSBmcm9tICZxdW90O2Nvc21qcy10eXBlcy9jb3Ntb3MvYmFzZS9hYmNpL3YxYmV0YTEvYWJjaSZxdW90OwoKZXhwb3J0IGNvbnN0IGNvbnZlcnRUZW5kZXJtaW50RXZlbnRzID0gKGV2ZW50czogcmVhZG9ubHkgRXZlbnRbXSk6IFN0cmluZ0V2ZW50W10gPSZndDsgewogICAgcmV0dXJuIGV2ZW50cy5tYXAoCiAgICAgICAgKGV2ZW50OiBFdmVudCk6IFN0cmluZ0V2ZW50ID0mZ3Q7ICh7CiAgICAgICAgICAgIHR5cGU6IGV2ZW50LnR5cGUsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IGV2ZW50LmF0dHJpYnV0ZXMubWFwKAogICAgICAgICAgICAgICAgKGF0dHJpYnV0ZTogVGVuZGVybWludEF0dHJpYnV0ZSk6IEF0dHJpYnV0ZSA9Jmd0OyAoewogICAgICAgICAgICAgICAgICAgIGtleTogZnJvbVV0ZjgoYXR0cmlidXRlLmtleSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZyb21VdGY4KGF0dHJpYnV0ZS52YWx1ZSksCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgKSwKICAgICAgICB9KSwKICAgICkKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/events.ts#L1-L17"}})],1),e._v(" "),o("li",[o("p",[e._v("To handle the call to "),o("code",[e._v("blockResults")]),e._v(", you need access to a CometBFT client. One option is to make a copy of the private CometBFT client. You can do this only on construction, so create a child class of "),o("code",[e._v("CheckersStargateClient")]),e._v(" to do that. It is recommended to keep it close by "),o("code",[e._v("indexer.ts")]),e._v(". In a new "),o("code",[e._v("indexer_stargateclient.ts")]),e._v(":")])])]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgU3RhcmdhdGVDbGllbnRPcHRpb25zIH0gZnJvbSAmcXVvdDtAY29zbWpzL3N0YXJnYXRlJnF1b3Q7CmltcG9ydCB7IEJsb2NrUmVzdWx0c1Jlc3BvbnNlLCBUZW5kZXJtaW50MzRDbGllbnQgfSBmcm9tICZxdW90O0Bjb3NtanMvdGVuZGVybWludC1ycGMmcXVvdDsKaW1wb3J0IHsgU3RyaW5nRXZlbnQgfSBmcm9tICZxdW90O2Nvc21qcy10eXBlcy9jb3Ntb3MvYmFzZS9hYmNpL3YxYmV0YTEvYWJjaSZxdW90OwppbXBvcnQgeyBjb252ZXJ0VGVuZGVybWludEV2ZW50cyB9IGZyb20gJnF1b3Q7Li9ldmVudHMmcXVvdDsKaW1wb3J0IHsgQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudCB9IGZyb20gJnF1b3Q7Li4vY2hlY2tlcnNfc3RhcmdhdGVjbGllbnQmcXVvdDsKCmV4cG9ydCBjbGFzcyBJbmRleGVyU3RhcmdhdGVDbGllbnQgZXh0ZW5kcyBDaGVja2Vyc1N0YXJnYXRlQ2xpZW50IHsKICAgIHByaXZhdGUgcmVhZG9ubHkgbXlUbUNsaWVudDogVGVuZGVybWludDM0Q2xpZW50CgogICAgcHVibGljIHN0YXRpYyBhc3luYyBjb25uZWN0KAogICAgICAgIGVuZHBvaW50OiBzdHJpbmcsCiAgICAgICAgb3B0aW9uczogU3RhcmdhdGVDbGllbnRPcHRpb25zID0ge30sCiAgICApOiBQcm9taXNlJmx0O0luZGV4ZXJTdGFyZ2F0ZUNsaWVudCZndDsgewogICAgICAgIGNvbnN0IHRtQ2xpZW50ID0gYXdhaXQgVGVuZGVybWludDM0Q2xpZW50LmNvbm5lY3QoZW5kcG9pbnQpCiAgICAgICAgcmV0dXJuIG5ldyBJbmRleGVyU3RhcmdhdGVDbGllbnQodG1DbGllbnQsIG9wdGlvbnMpCiAgICB9CgogICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHRtQ2xpZW50OiBUZW5kZXJtaW50MzRDbGllbnQsIG9wdGlvbnM6IFN0YXJnYXRlQ2xpZW50T3B0aW9ucykgewogICAgICAgIHN1cGVyKHRtQ2xpZW50LCBvcHRpb25zKQogICAgICAgIHRoaXMubXlUbUNsaWVudCA9IHRtQ2xpZW50CiAgICB9CgogICAgcHVibGljIGFzeW5jIGdldEVuZEJsb2NrRXZlbnRzKGhlaWdodDogbnVtYmVyKTogUHJvbWlzZSZsdDtTdHJpbmdFdmVudFtdJmd0OyB7CiAgICAgICAgY29uc3QgcmVzdWx0czogQmxvY2tSZXN1bHRzUmVzcG9uc2UgPSBhd2FpdCB0aGlzLm15VG1DbGllbnQuYmxvY2tSZXN1bHRzKGhlaWdodCkKICAgICAgICByZXR1cm4gY29udmVydFRlbmRlcm1pbnRFdmVudHMocmVzdWx0cy5lbmRCbG9ja0V2ZW50cykKICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer_stargateclient.ts"}}),e._v(" "),o("p",[e._v("Now swap out "),o("code",[e._v("CheckersStargateClient")]),e._v(" with "),o("code",[e._v("IndexerStargateClient")]),e._v(":")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgSW5kZXhlclN0YXJnYXRlQ2xpZW50IH0gZnJvbSAmcXVvdDsuL2luZGV4ZXJfc3RhcmdhdGVjbGllbnQmcXVvdDsKCmV4cG9ydCBjb25zdCBjcmVhdGVJbmRleGVyID0gYXN5bmMgKCkgPSZndDsgewogICAgLi4uCiAgICBsZXQgY2xpZW50OiBJbmRleGVyU3RhcmdhdGVDbGllbnQKCiAgICAuLi4KICAgIGNvbnN0IGluaXQgPSBhc3luYyAoKSA9Jmd0OyB7CiAgICAgICAgY2xpZW50ID0gYXdhaXQgSW5kZXhlclN0YXJnYXRlQ2xpZW50LmNvbm5lY3QocHJvY2Vzcy5lbnYuUlBDX1VSTCEpCiAgICAgICAgLi4uCiAgICB9Cn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L22-L65"}}),e._v(" "),o("p",[e._v("With this in place, go back to "),o("code",[e._v("handleBlock")]),e._v(" and work on the remaining TODO.")]),e._v(" "),o("h2",{attrs:{id:"handle-one-block-s-endblock"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-block-s-endblock"}},[e._v("#")]),e._v(" Handle one block's "),o("code",[e._v("EndBlock")])]),e._v(" "),o("p",[e._v("Go to the function and update it:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlQmxvY2sgPSBhc3luYyAoYmxvY2s6IEJsb2NrKSA9Jmd0OyB7CiAgICAuLi4KICAgIGNvbnN0IGV2ZW50czogU3RyaW5nRXZlbnRbXSA9IGF3YWl0IGNsaWVudC5nZXRFbmRCbG9ja0V2ZW50cyhibG9jay5oZWFkZXIuaGVpZ2h0KQogICAgaWYgKDAgJmx0OyBldmVudHMubGVuZ3RoKSBjb25zb2xlLmxvZygmcXVvdDsmcXVvdDspCiAgICBhd2FpdCBoYW5kbGVFdmVudHMoZXZlbnRzKQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L97-L99"}}),e._v(" "),o("p",[e._v("The events that you have converted are compatible with those emanating from transactions, so you can just pass them on. You still need to update "),o("code",[e._v("handleEvent")]),e._v(" so that it acts on the new event type:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-typescript",base64:"ICAgIGNvbnN0IGhhbmRsZUV2ZW50ID0gYXN5bmMgKGV2ZW50OiBTdHJpbmdFdmVudCk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgICAgIC4uLgorICAgICAgaWYgKGV2ZW50LnR5cGUgPT0gJnF1b3Q7Z2FtZS1mb3JmZWl0ZWQmcXVvdDspIHsKKyAgICAgICAgICAvLyBGdW5jdGlvbiB5ZXQgdG8gYmUgZGVjbGFyZWQKKyAgICAgICAgICBhd2FpdCBoYW5kbGVFdmVudEZvcmZlaXQoZXZlbnQpCisgICAgICB9CiAgICB9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L130-L132"}}),e._v(" "),o("p",[e._v("To achieve this, add a new function:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRGb3JmZWl0ID0gYXN5bmMgKGV2ZW50OiBTdHJpbmdFdmVudCk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgY29uc3QgZm9yZmVpdGVkSWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGdldEF0dHJpYnV0ZVZhbHVlQnlLZXkoZXZlbnQuYXR0cmlidXRlcywgJnF1b3Q7Z2FtZS1pbmRleCZxdW90OykKICAgIGlmICghZm9yZmVpdGVkSWQpIHRocm93IG5ldyBFcnJvcihgRm9yZmVpdCBldmVudCBtaXNzaW5nIGZvcmZlaXRlZElkYCkKICAgIGNvbnN0IHdpbm5lcjogc3RyaW5nIHwgdW5kZWZpbmVkID0gZ2V0QXR0cmlidXRlVmFsdWVCeUtleShldmVudC5hdHRyaWJ1dGVzLCAmcXVvdDt3aW5uZXImcXVvdDspCiAgICBjb25zdCBibGFja0FkZHJlc3M6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGRiLmdhbWVzW2ZvcmZlaXRlZElkXT8uYmxhY2tBZGRyZXNzCiAgICBjb25zdCByZWRBZGRyZXNzOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBkYi5nYW1lc1tmb3JmZWl0ZWRJZF0/LnJlZEFkZHJlc3MKICAgIGNvbnNvbGUubG9nKAogICAgICAgIGBGb3JmZWl0IGdhbWU6ICR7Zm9yZmVpdGVkSWR9LCBibGFjazogJHtibGFja0FkZHJlc3N9LCByZWQ6ICR7cmVkQWRkcmVzc30sIHdpbm5lcjogJHt3aW5uZXJ9YCwKICAgICkKICAgIGNvbnN0IGJsYWNrR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tibGFja0FkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zdCByZWRHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW3JlZEFkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zdCBpbmRleEluQmxhY2s6IG51bWJlciA9IGJsYWNrR2FtZXMuaW5kZXhPZihmb3JmZWl0ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgY29uc3QgaW5kZXhJblJlZDogbnVtYmVyID0gcmVkR2FtZXMuaW5kZXhPZihmb3JmZWl0ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5SZWQpIHJlZEdhbWVzLnNwbGljZShpbmRleEluUmVkLCAxKQogICAgaWYgKGRiLmdhbWVzW2ZvcmZlaXRlZElkXSkgZGIuZ2FtZXNbZm9yZmVpdGVkSWRdLmRlbGV0ZWQgPSB0cnVlCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L196-L212"}}),e._v(" "),o("HighlightBox",{attrs:{type:"note"}},[o("p",[e._v("Again there is a lot of error handling. "),o("code",[e._v("handleEvent")]),e._v(" only soft-deletes the game, although it removes it from the list of games for the players.")])]),e._v(" "),o("h2",{attrs:{id:"test-time-of-forfeit"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#test-time-of-forfeit"}},[e._v("#")]),e._v(" Test time of forfeit")]),e._v(" "),o("p",[e._v("Run the previous tests again. Create a game and see how the deletion event is picked up:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"Rm9yZmVpdCBnYW1lOiAxLCBibGFjazogY29zbW9zMWFtM2ZucDVkZDZubmRrNWp5anE5bXBxaDN5dnQyam1tZHY4M3huLCByZWQ6IGNvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cywgd2lubmVyOiAqCg=="}}),e._v(" "),o("HighlightBox",{attrs:{type:"tip"}},[o("p",[e._v("In the standalone checkers in Docker, the deadline is unfortunately set at 24 hours, so feedback is not exactly coming fast. At this state of the exercise, if you want to test the expiry quickly, you will have to run Ignite CLI and adjust the "),o("code",[e._v("MaxTurnDuration")]),e._v(" as described "),o("RouterLink",{attrs:{to:"/hands-on-exercise/2-ignite-cli-adv/4-game-forfeit.html#interact-via-the-cli"}},[e._v("here")]),e._v(".")],1)]),e._v(" "),o("h2",{attrs:{id:"patch-a-game"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#patch-a-game"}},[e._v("#")]),e._v(" Patch a game")]),e._v(" "),o("p",[e._v("In the actions that the Express server exposes, "),o("code",[e._v("app.patch")]),e._v(" still remains to be implemented. This allows a user to inform the server that its database is no longer synchronized, and that it should look at a specific game. It is a matter of data re-synchronization:")]),e._v(" "),o("ol",[o("li",[e._v("If the game can be found in the blockchain state, update the indexer's database accordingly:\n"),o("ol",[o("li",[e._v("If there is a winner, then the game should be removed from its players' lists of games.")]),e._v(" "),o("li",[e._v("If there is no winner, then the game should be added to its players' lists of games.")])])]),e._v(" "),o("li",[e._v("If the game cannot be found in the blockchain state, but is present in the indexer's database, then the game should be removed from the lists of games of its players, and marked as soft-deleted. This shows the usefulness of keeping "),o("em",[e._v("old")]),e._v(" games.")]),e._v(" "),o("li",[e._v("If the game cannot be found either in the blockchain state nor in the indexer's database, then it is better not to do anything. To remove it from all players' lists of games is potentially expensive. This could expose the server to a DoS attack.")])]),e._v(" "),o("p",[e._v("Code the following:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgcGF0Y2hHYW1lID0gYXN5bmMgKGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZSZsdDtib29sZWFuJmd0OyA9Jmd0OyB7CiAgICBjb25zdCBnYW1lOiBTdG9yZWRHYW1lIHwgdW5kZWZpbmVkID0gYXdhaXQgY2xpZW50LmNoZWNrZXJzUXVlcnlDbGllbnQ/LmNoZWNrZXJzLmdldFN0b3JlZEdhbWUoZ2FtZUlkKQogICAgY29uc3QgY2FjaGVkR2FtZTogR2FtZUluZm8gfCB1bmRlZmluZWQgPSBkYi5nYW1lc1tnYW1lSWRdCiAgICBpZiAoIWdhbWUgJmFtcDsmYW1wOyBjYWNoZWRHYW1lKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAgIGBQYXRjaCBnYW1lOiBkZWxldGVkLCAke2dhbWVJZH0sIGJsYWNrOiAke2NhY2hlZEdhbWUuYmxhY2tBZGRyZXNzfSwgcmVkOiAke2NhY2hlZEdhbWUucmVkQWRkcmVzc31gLAogICAgICAgICkKICAgICAgICBjb25zdCBibGFja0dhbWVzOiBzdHJpbmdbXSA9IGRiLnBsYXllcnNbY2FjaGVkR2FtZS5ibGFja0FkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICAgICAgY29uc3QgcmVkR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tjYWNoZWRHYW1lLnJlZEFkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICAgICAgY29uc3QgaW5kZXhJbkJsYWNrOiBudW1iZXIgPSBibGFja0dhbWVzLmluZGV4T2YoZ2FtZUlkKQogICAgICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgICAgIGNvbnN0IGluZGV4SW5SZWQ6IG51bWJlciA9IHJlZEdhbWVzLmluZGV4T2YoZ2FtZUlkKQogICAgICAgIGlmICgwICZsdDs9IGluZGV4SW5SZWQpIHJlZEdhbWVzLnNwbGljZShpbmRleEluUmVkLCAxKQogICAgICAgIGNhY2hlZEdhbWUuZGVsZXRlZCA9IHRydWUKICAgICAgICByZXR1cm4gdHJ1ZQogICAgfSBlbHNlIGlmICghZ2FtZSkgewogICAgICAgIC8vIE5vIGluZm9ybWF0aW9uIHRvIHdvcmsgZnJvbS4KICAgICAgICAvLyBJZiB3ZSB0cnkgdG8gcmVtb3ZlIGl0IGZyb20gYWxsIHBsYXllcnMsIGl0IGlzIHZlcnkgZXhwZW5zaXZlIGFuZCB3ZSBhcmUgYXQgcmlzayBvZiBhIERvUyBhdHRhY2suCiAgICAgICAgY29uc29sZS5sb2coYFBhdGNoIGdhbWU6IG5vdCBmb3VuZCwgJHtnYW1lSWR9YCkKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0gZWxzZSBpZiAoZ2FtZS53aW5uZXIgIT09ICZxdW90OyomcXVvdDspIHsKICAgICAgICBjb25zdCBibGFja0dhbWVzOiBzdHJpbmdbXSA9IGRiLnBsYXllcnNbZ2FtZS5ibGFja10/LmdhbWVJZHMgPz8gW10KICAgICAgICBjb25zdCByZWRHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW2dhbWUucmVkXT8uZ2FtZUlkcyA/PyBbXQogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICBgUGF0Y2ggZ2FtZTogZW5kZWQsICR7Z2FtZUlkfSwgYmxhY2s6ICR7Z2FtZS5ibGFja30sIHJlZDogJHtnYW1lLnJlZH0sIHdpbm5lcjogJHtnYW1lLndpbm5lcn1gLAogICAgICAgICkKICAgICAgICBjb25zdCBpbmRleEluQmxhY2s6IG51bWJlciA9IGJsYWNrR2FtZXMuaW5kZXhPZihnYW1lSWQpCiAgICAgICAgaWYgKDAgJmx0Oz0gaW5kZXhJbkJsYWNrKSBibGFja0dhbWVzLnNwbGljZShpbmRleEluQmxhY2ssIDEpCiAgICAgICAgY29uc3QgaW5kZXhJblJlZDogbnVtYmVyID0gcmVkR2FtZXMuaW5kZXhPZihnYW1lSWQpCiAgICAgICAgaWYgKDAgJmx0Oz0gaW5kZXhJblJlZCkgcmVkR2FtZXMuc3BsaWNlKGluZGV4SW5SZWQsIDEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYmxhY2tJbmZvOiBQbGF5ZXJJbmZvID0gZGIucGxheWVyc1tnYW1lLmJsYWNrXSA/PyB7CiAgICAgICAgICAgIGdhbWVJZHM6IFtdLAogICAgICAgIH0KICAgICAgICBjb25zdCByZWRJbmZvOiBQbGF5ZXJJbmZvID0gZGIucGxheWVyc1tnYW1lLnJlZF0gPz8gewogICAgICAgICAgICBnYW1lSWRzOiBbXSwKICAgICAgICB9CiAgICAgICAgY29uc29sZS5sb2coYFBhdGNoIGdhbWU6IG5ldywgJHtnYW1lSWR9LCBibGFjazogJHtnYW1lLmJsYWNrfSwgcmVkOiAke2dhbWUucmVkfWApCiAgICAgICAgaWYgKGJsYWNrSW5mby5nYW1lSWRzLmluZGV4T2YoZ2FtZUlkKSAmbHQ7IDApIGJsYWNrSW5mby5nYW1lSWRzLnB1c2goZ2FtZUlkKQogICAgICAgIGlmIChyZWRJbmZvLmdhbWVJZHMuaW5kZXhPZihnYW1lSWQpICZsdDsgMCkgcmVkSW5mby5nYW1lSWRzLnB1c2goZ2FtZUlkKQogICAgICAgIGRiLnBsYXllcnNbZ2FtZS5ibGFja10gPSBibGFja0luZm8KICAgICAgICBkYi5wbGF5ZXJzW2dhbWUucmVkXSA9IHJlZEluZm8KICAgICAgICBkYi5nYW1lc1tnYW1lSWRdID0gewogICAgICAgICAgICByZWRBZGRyZXNzOiBnYW1lLnJlZCwKICAgICAgICAgICAgYmxhY2tBZGRyZXNzOiBnYW1lLmJsYWNrLAogICAgICAgICAgICBkZWxldGVkOiBmYWxzZSwKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L214-L264"}}),e._v(" "),o("p",[e._v("There are some issues to be aware of:")]),e._v(" "),o("ol",[o("li",[e._v("JavaScript is not thread-safe, so you could cause two opposite actions: one coming from the polling and the other from a patch submission, or even from two concurrent patch submissions. To reduce this risk the "),o("em",[e._v("database")]),e._v(" is not saved to disk in this function, but instead relies on the polling to save it at the next run.")]),e._v(" "),o("li",[e._v("Assuming that "),o("em",[e._v("there is no such game when you cannot find it")]),e._v(" can result in deleting data that is simply taking time to appear on your blockchain node.")])]),e._v(" "),o("p",[e._v("Next, you need to call "),o("code",[e._v("patchGame")]),e._v(" from the "),o("code",[e._v("app.patch")]),e._v(" callback:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"YXBwLnBhdGNoKCZxdW90Oy9nYW1lcy86Z2FtZUlkJnF1b3Q7LCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9Jmd0OyB7CiAgICBjb25zdCBmb3VuZCA9IGF3YWl0IHBhdGNoR2FtZShyZXEucGFyYW1zLmdhbWVJZCkKICAgIGlmICghZm91bmQpIHJlcy5zdGF0dXMoNDA0KQogICAgZWxzZSB7CiAgICAgICAgcmVzLmpzb24oewogICAgICAgICAgICByZXN1bHQ6ICZxdW90O1RoYW5rIHlvdSZxdW90OywKICAgICAgICB9KQogICAgfQp9KQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/server-indexing/src/server/indexer.ts#L50-L58"}}),e._v(" "),o("h2",{attrs:{id:"test-time-of-patch"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#test-time-of-patch"}},[e._v("#")]),e._v(" Test time of patch")]),e._v(" "),o("p",[e._v("To simulate a case where the game is in the blockchain state but not the indexer's:")]),e._v(" "),o("ol",[o("li",[o("p",[e._v("Stop your indexer.")])]),e._v(" "),o("li",[o("p",[e._v("Create a game and check at what block it is included (for example, at index "),o("code",[e._v("3")]),e._v(" and block "),o("code",[e._v("1001")]),e._v(").")])]),e._v(" "),o("li",[o("p",[e._v("Update your indexer's "),o("code",[e._v("db.json")]),e._v(" to pretend that it already indexed the game's block by setting:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"JnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAmcXVvdDtibG9jayZxdW90OzogewogICAgICAgICZxdW90O2hlaWdodCZxdW90OzogMTAwMQogICAgfQp9Cg=="}})],1),e._v(" "),o("li",[o("p",[e._v("Restart the indexer.")])]),e._v(" "),o("li",[o("p",[e._v("From another terminal, make a call to it:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIC1YIFBBVENIIGxvY2FsaG9zdDozMDAxL2dhbWVzLzMgfCBqcQo="}})],1)]),e._v(" "),o("p",[e._v("It should return:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O3Jlc3VsdCZxdW90OzogJnF1b3Q7VGhhbmsgeW91JnF1b3Q7Cn0K"}}),e._v(" "),o("p",[e._v("And the indexer should log something like:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"UGF0Y2ggZ2FtZTogbmV3LCAzLCBibGFjazogY29zbW9zMWFtM2ZucDVkZDZubmRrNWp5anE5bXBxaDN5dnQyam1tZHY4M3huLCByZWQ6IGNvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cwo="}}),e._v(" "),o("p",[e._v("Develop your own ways to test the other scenarios.")]),e._v(" "),o("p",[e._v("If you started the chain in Docker, when you are done you can stop the containers with:")]),e._v(" "),o("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgc3RvcCBjb3Ntb3MtZmF1Y2V0IGNoZWNrZXJzCiQgZG9ja2VyIG5ldHdvcmsgcm0gY2hlY2tlcnMtbmV0Cg=="}}),e._v(" "),o("h2",{attrs:{id:"conclusion"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[e._v("#")]),e._v(" Conclusion")]),e._v(" "),o("p",[e._v("You have created a small server that:")]),e._v(" "),o("ul",[o("li",[e._v("Polls the blockchain to get events about created, won, and forfeited games.")]),e._v(" "),o("li",[e._v("Maintains a database with information indexed in real time.")]),e._v(" "),o("li",[e._v("Offers this information as a Web service.")]),e._v(" "),o("li",[e._v("Accepts requests for patches.")])]),e._v(" "),o("p",[e._v("These are examples of server-side scripts, which can improve user experience.")]),e._v(" "),o("p",[e._v("You can find the complete code "),o("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/tree/server-indexing",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),o("OutboundLink")],1),e._v(".")])],1)}),[],!1,null,null,null);t.default=c.exports}}]);