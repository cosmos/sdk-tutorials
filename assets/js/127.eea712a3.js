(window.webpackJsonp=window.webpackJsonp||[]).push([[127],{746:function(e,t,a){"use strict";a.r(t);var o=a(1),s=Object(o.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"handle-wager-payments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#handle-wager-payments"}},[e._v("#")]),e._v(" Handle Wager Payments")]),e._v(" "),a("HighlightBox",{attrs:{type:"prerequisite"}},[a("p",[e._v("Make sure you have everything you need before proceeding:")]),e._v(" "),a("ul",[a("li",[e._v("You understand the concepts of "),a("RouterLink",{attrs:{to:"/academy/2-cosmos-concepts/5-modules.html"}},[e._v("modules")]),e._v(" and "),a("RouterLink",{attrs:{to:"/academy/2-cosmos-concepts/7-multistore-keepers.html"}},[e._v("keepers")]),e._v(".")],1),e._v(" "),a("li",[e._v("Go is installed.")]),e._v(" "),a("li",[e._v("You have the checkers blockchain codebase up to the game wager. If not, follow the "),a("RouterLink",{attrs:{to:"/hands-on-exercise/2-ignite-cli-adv/4-game-wager.html"}},[e._v("previous steps")]),e._v(" or check out "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/tree/game-wager",target:"_blank",rel:"noopener noreferrer"}},[e._v("the relevant version"),a("OutboundLink")],1),e._v(".")],1)])]),e._v(" "),a("HighlightBox",{attrs:{type:"learning"}},[a("p",[e._v("In this section, you will:")]),e._v(" "),a("ul",[a("li",[e._v("Work with the bank module.")]),e._v(" "),a("li",[e._v("Handle money.")]),e._v(" "),a("li",[e._v("Use mocks.")]),e._v(" "),a("li",[e._v("Add integration tests.")])])]),e._v(" "),a("p",[e._v("In the "),a("RouterLink",{attrs:{to:"/hands-on-exercise/2-ignite-cli-adv/4-game-wager.html"}},[e._v("previous section")]),e._v(", you introduced a wager. On its own, having a "),a("code",[e._v("Wager")]),e._v(" field is just a piece of information, it does not transfer tokens just by existing.")],1),e._v(" "),a("p",[e._v("Transferring tokens is what this section is about.")]),e._v(" "),a("h2",{attrs:{id:"some-initial-thoughts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#some-initial-thoughts"}},[e._v("#")]),e._v(" Some initial thoughts")]),e._v(" "),a("p",[e._v("When thinking about implementing a wager on games, ask:")]),e._v(" "),a("ul",[a("li",[e._v("Is there any desirable atomicity of actions?")]),e._v(" "),a("li",[e._v("At what junctures do you need to handle payments, refunds, and wins?")]),e._v(" "),a("li",[e._v("Are there errors to report back?")]),e._v(" "),a("li",[e._v("What event should you emit?")])]),e._v(" "),a("p",[e._v("In the case of this example, you can consider that:")]),e._v(" "),a("ul",[a("li",[e._v("Although a game creator can decide on a wager, it should only be the holder of the tokens that can decide when they are being taken from their balance.")]),e._v(" "),a("li",[e._v("You might think of adding a new message type, one that indicates that a player puts its wager in escrow. On the other hand, you can leverage the existing messages and consider that when a player makes their first move, this expresses a willingness to participate, and therefore the tokens can be transferred at this juncture.")]),e._v(" "),a("li",[e._v("For wins and losses, it is easy to imagine that the code handles the payout at the time a game is resolved.")])]),e._v(" "),a("h2",{attrs:{id:"code-needs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#code-needs"}},[e._v("#")]),e._v(" Code needs")]),e._v(" "),a("p",[e._v("When it comes to your code:")]),e._v(" "),a("ul",[a("li",[e._v("What Ignite CLI commands, if any, will assist you?")]),e._v(" "),a("li",[e._v("How do you adjust what Ignite CLI created for you?")]),e._v(" "),a("li",[e._v("Where do you make your changes?")]),e._v(" "),a("li",[e._v("How would you unit-test these new elements?")]),e._v(" "),a("li",[e._v("Are unit tests sufficient here?")]),e._v(" "),a("li",[e._v("How would you use Ignite CLI to locally run a one-node blockchain and interact with it via the CLI to see what you get?")])]),e._v(" "),a("p",[e._v("Here are some elements of response:")]),e._v(" "),a("ul",[a("li",[e._v("Your module needs to call the bank to tell it to move tokens.")]),e._v(" "),a("li",[e._v("Your module needs to be allowed by the bank to keep tokens in escrow.")]),e._v(" "),a("li",[e._v("How would you test your module when it has such dependencies on the bank?")])]),e._v(" "),a("h2",{attrs:{id:"what-is-to-be-done"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-to-be-done"}},[e._v("#")]),e._v(" What is to be done")]),e._v(" "),a("p",[e._v("A lot is to be done. In order you will:")]),e._v(" "),a("ul",[a("li",[e._v("Make it possible for your checkers module to call certain functions of the bank to transfer tokens.")]),e._v(" "),a("li",[e._v("Tell the bank to allow your checkers module to hold tokens in escrow.")]),e._v(" "),a("li",[e._v("Create helper functions that encapsulate some knowledge about when and how to transfer tokens.")]),e._v(" "),a("li",[e._v("Use these helper functions at the right places in your code.")]),e._v(" "),a("li",[e._v("Update your unit tests and make use of mocks for that. You will create the mocks, create helper functions and use all that.")]),e._v(" "),a("li",[e._v("Prepare your code to accept integration tests.")]),e._v(" "),a("li",[e._v("Create helper functions that will make your integration tests more succinct.")]),e._v(" "),a("li",[e._v("Add integration tests that create a full app and test proper token bank balances.")])]),e._v(" "),a("h2",{attrs:{id:"declaring-expectations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#declaring-expectations"}},[e._v("#")]),e._v(" Declaring expectations")]),e._v(" "),a("p",[e._v("On its own the "),a("code",[e._v("Wager")]),e._v(" field does not make players pay the wager or receive rewards. You need to add handling actions that ask the "),a("code",[e._v("bank")]),e._v(" module to perform the required token transfers. For that, your keeper needs to ask for a "),a("code",[e._v("bank")]),e._v(" instance during setup.")]),e._v(" "),a("HighlightBox",{attrs:{type:"info"}},[a("p",[e._v("The only way to have access to a capability with the object-capability model of the Cosmos SDK is to be given the reference to an instance which already has this capability.")])]),e._v(" "),a("p",[e._v("Payment handling is implemented by having your keeper hold wagers "),a("strong",[e._v("in escrow")]),e._v(" while the game is being played. The "),a("code",[e._v("bank")]),e._v(" module has functions to transfer tokens from any account to your module and vice-versa.")]),e._v(" "),a("p",[e._v("Alternatively, your keeper could burn tokens instead of keeping them in escrow and mint them again when paying out. However, this makes your blockchain's total supply "),a("em",[e._v("falsely")]),e._v(" fluctuate. Additionally, this burning and minting may prove questionable when you later introduce IBC tokens.")]),e._v(" "),a("HighlightBox",{attrs:{type:"best-practice"}},[a("p",[e._v("Declare an interface that narrowly declares the functions from other modules that you expect for your module. The conventional file for these declarations is "),a("code",[e._v("x/checkers/types/expected_keepers.go")]),e._v(".")])]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("bank")]),e._v(" module has many capabilities, but all you need here are two functions. Your module already expects one function of the bank keeper: "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/types/expected_keepers.go#L15-L18",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("SpendableCoins")]),a("OutboundLink")],1),e._v(". Instead of expanding this interface, you add a new one and "),a("em",[e._v("redeclare")]),e._v(" the extra functions you need like so:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBCYW5rRXNjcm93S2VlcGVyIGludGVyZmFjZSB7CiAgICBTZW5kQ29pbnNGcm9tTW9kdWxlVG9BY2NvdW50KGN0eCBzZGsuQ29udGV4dCwgc2VuZGVyTW9kdWxlIHN0cmluZywgcmVjaXBpZW50QWRkciBzZGsuQWNjQWRkcmVzcywgYW10IHNkay5Db2lucykgZXJyb3IKICAgIFNlbmRDb2luc0Zyb21BY2NvdW50VG9Nb2R1bGUoY3R4IHNkay5Db250ZXh0LCBzZW5kZXJBZGRyIHNkay5BY2NBZGRyZXNzLCByZWNpcGllbnRNb2R1bGUgc3RyaW5nLCBhbXQgc2RrLkNvaW5zKSBlcnJvcgp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/types/expected_keepers.go#L20-L23"}}),e._v(" "),a("p",[e._v("These two functions must exactly match the functions declared in the "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/x/bank/keeper/keeper.go#L35-L37",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("bank")]),e._v("'s keeper.go file"),a("OutboundLink")],1),e._v(". Copy the declarations directly from the "),a("code",[e._v("bank")]),e._v("'s file. In Go, any object with these two functions is a "),a("code",[e._v("BankEscrowKeeper")]),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"obtaining-the-capability"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#obtaining-the-capability"}},[e._v("#")]),e._v(" Obtaining the capability")]),e._v(" "),a("p",[e._v("With your requirements declared, it is time to make sure your keeper receives a reference to a bank keeper. First add a "),a("code",[e._v("BankEscrowKeeper")]),e._v(" to your keeper in "),a("code",[e._v("x/checkers/keeper/keeper.go")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIHR5cGUgKAogICAgICAgIEtlZXBlciBzdHJ1Y3QgeworICAgICAgICAgIGJhbmsgdHlwZXMuQmFua0VzY3Jvd0tlZXBlcgogICAgICAgICAgICAuLi4KICAgICAgICB9CiAgICApCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/keeper.go#L16"}}),e._v(" "),a("p",[e._v("This "),a("code",[e._v("BankEscrowKeeper")]),e._v(" is your newly declared narrow interface. Do not forget to adjust the constructor accordingly:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGZ1bmMgTmV3S2VlcGVyKAorICAgICAgYmFuayB0eXBlcy5CYW5rRXNjcm93S2VlcGVyLAogICAgICAgIC4uLgogICAgKSAqS2VlcGVyIHsKICAgICAgICByZXR1cm4gJmFtcDtLZWVwZXJ7CisgICAgICAgICAgYmFuazogYmFuaywKICAgICAgICAgICAgLi4uCiAgICAgICAgfQogICAgfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/keeper.go#L25-L38"}}),e._v(" "),a("p",[e._v("Next, update where the constructor is called and pass a proper instance of "),a("code",[e._v("BankKeeper")]),e._v(". This happens in "),a("code",[e._v("app/app.go")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGFwcC5DaGVja2Vyc0tlZXBlciA9ICpjaGVja2Vyc21vZHVsZWtlZXBlci5OZXdLZWVwZXIoCisgICAgICBhcHAuQmFua0tlZXBlciwKICAgICAgICAuLi4KICAgICkK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/app/app.go#L394"}}),e._v(" "),a("p",[e._v("This "),a("code",[e._v("app.BankKeeper")]),e._v(" is a full "),a("code",[e._v("bank")]),e._v(" keeper that also conforms to your "),a("code",[e._v("BankEscrowKeeper")]),e._v(" interface.")]),e._v(" "),a("p",[e._v("Finally, inform the app that your checkers module is going to hold balances in escrow by adding it to the "),a("strong",[e._v("whitelist")]),e._v(" of permitted modules:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIG1hY2NQZXJtcyA9IG1hcFtzdHJpbmddW11zdHJpbmd7CiAgICAgICAgLi4uCisgICAgICBjaGVja2Vyc21vZHVsZXR5cGVzLk1vZHVsZU5hbWU6IG5pbCwKICAgIH0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/app/app.go#L173"}}),e._v(" "),a("p",[e._v("If you compare it to the other "),a("code",[e._v("maccperms")]),e._v(" lines, the new line does not mention any "),a("code",[e._v("authtypes.Minter")]),e._v(" or "),a("code",[e._v("authtypes.Burner")]),e._v(". Indeed "),a("code",[e._v("nil")]),e._v(" is what you need to keep in escrow. For your information, the bank creates an "),a("em",[e._v("address")]),e._v(" for your module's escrow account. When you have the full "),a("code",[e._v("app")]),e._v(", you can access it with:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aW1wb3J0KAogICAgJnF1b3Q7Z2l0aHViLmNvbS9hbGljZS9jaGVja2Vycy94L2NoZWNrZXJzL3R5cGVzJnF1b3Q7CikKY2hlY2tlcnNNb2R1bGVBZGRyZXNzIDo9IGFwcC5BY2NvdW50S2VlcGVyLkdldE1vZHVsZUFkZHJlc3ModHlwZXMuTW9kdWxlTmFtZSkK"}}),e._v(" "),a("h2",{attrs:{id:"preparing-expected-errors"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preparing-expected-errors"}},[e._v("#")]),e._v(" Preparing expected errors")]),e._v(" "),a("p",[e._v("There are several new error situations that you can enumerate with new variables:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIHZhciAoCiAgICAgICAgLi4uCisgICAgICBFcnJCbGFja0Nhbm5vdFBheSAgICA9IHNka2Vycm9ycy5SZWdpc3RlcihNb2R1bGVOYW1lLCAxMTEwLCAmcXVvdDtibGFjayBjYW5ub3QgcGF5IHRoZSB3YWdlciZxdW90OykKKyAgICAgIEVyclJlZENhbm5vdFBheSAgICAgID0gc2RrZXJyb3JzLlJlZ2lzdGVyKE1vZHVsZU5hbWUsIDExMTEsICZxdW90O3JlZCBjYW5ub3QgcGF5IHRoZSB3YWdlciZxdW90OykKKyAgICAgIEVyck5vdGhpbmdUb1BheSAgICAgID0gc2RrZXJyb3JzLlJlZ2lzdGVyKE1vZHVsZU5hbWUsIDExMTIsICZxdW90O3RoZXJlIGlzIG5vdGhpbmcgdG8gcGF5LCBzaG91bGQgbm90IGhhdmUgYmVlbiBjYWxsZWQmcXVvdDspCisgICAgICBFcnJDYW5ub3RSZWZ1bmRXYWdlciA9IHNka2Vycm9ycy5SZWdpc3RlcihNb2R1bGVOYW1lLCAxMTEzLCAmcXVvdDtjYW5ub3QgcmVmdW5kIHdhZ2VyIHRvOiAlcyZxdW90OykKKyAgICAgIEVyckNhbm5vdFBheVdpbm5pbmdzID0gc2RrZXJyb3JzLlJlZ2lzdGVyKE1vZHVsZU5hbWUsIDExMTQsICZxdW90O2Nhbm5vdCBwYXkgd2lubmluZ3MgdG8gd2lubmVyOiAlcyZxdW90OykKKyAgICAgIEVyck5vdEluUmVmdW5kU3RhdGUgID0gc2RrZXJyb3JzLlJlZ2lzdGVyKE1vZHVsZU5hbWUsIDExMTUsICZxdW90O2dhbWUgaXMgbm90IGluIGEgc3RhdGUgdG8gcmVmdW5kLCBtb3ZlIGNvdW50OiAlZCZxdW90OykKICAgICkK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/types/errors.go#L23-L28"}}),e._v(" "),a("h2",{attrs:{id:"money-handling-steps"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#money-handling-steps"}},[e._v("#")]),e._v(" Money handling steps")]),e._v(" "),a("p",[e._v("With the "),a("code",[e._v("bank")]),e._v(" now in your keeper, it is time to have your keeper handle the money. Keep this concern in its own file, as the functions are reused on play and forfeit.")]),e._v(" "),a("p",[e._v("Create the new file "),a("code",[e._v("x/checkers/keeper/wager_handler.go")]),e._v(" and add three functions to collect a wager, refund a wager, and pay winnings:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBDb2xsZWN0V2FnZXIoY3R4IHNkay5Db250ZXh0LCBzdG9yZWRHYW1lICp0eXBlcy5TdG9yZWRHYW1lKSBlcnJvcgpmdW5jIChrICpLZWVwZXIpIE11c3RQYXlXaW5uaW5ncyhjdHggc2RrLkNvbnRleHQsIHN0b3JlZEdhbWUgKnR5cGVzLlN0b3JlZEdhbWUpCmZ1bmMgKGsgKktlZXBlcikgTXVzdFJlZnVuZFdhZ2VyKGN0eCBzZGsuQ29udGV4dCwgc3RvcmVkR2FtZSAqdHlwZXMuU3RvcmVkR2FtZSkK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go"}}),e._v(" "),a("p",[e._v("The "),a("code",[e._v("Must")]),e._v(" prefix in the function expresses the fact that the transaction either takes place or a "),a("code",[e._v("panic")]),e._v(" is issued. Indeed, if a player cannot pay the wager, it is a user-side error and the user must be informed of a failed transaction. If the module cannot pay, it means the escrow account has failed. This latter error is much more serious: an invariant may have been violated and the whole application must be terminated.")]),e._v(" "),a("p",[e._v("Now set up collecting a wager, paying winnings, and refunding a wager:")]),e._v(" "),a("ol",[a("li",[a("p",[a("strong",[e._v("Collecting wagers")]),e._v(" happens on a player's first move. Therefore, differentiate between players:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMCB7CiAgICAvLyBCbGFjayBwbGF5cyBmaXJzdAp9IGVsc2UgaWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMSB7CiAgICAvLyBSZWQgcGxheXMgc2Vjb25kCn0KcmV0dXJuIG5pbAo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L12-L33"}}),e._v(" "),a("p",[e._v("When there are no moves, get the address for the black player:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"YmxhY2ssIGVyciA6PSBzdG9yZWRHYW1lLkdldEJsYWNrQWRkcmVzcygpCmlmIGVyciAhPSBuaWwgewogICAgcGFuaWMoZXJyLkVycm9yKCkpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L14-L17"}}),e._v(" "),a("p",[e._v("Try to transfer into the escrow:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZXJyID0gay5iYW5rLlNlbmRDb2luc0Zyb21BY2NvdW50VG9Nb2R1bGUoY3R4LCBibGFjaywgdHlwZXMuTW9kdWxlTmFtZSwgc2RrLk5ld0NvaW5zKHN0b3JlZEdhbWUuR2V0V2FnZXJDb2luKCkpKQppZiBlcnIgIT0gbmlsIHsKICAgIHJldHVybiBzZGtlcnJvcnMuV3JhcGYoZXJyLCB0eXBlcy5FcnJCbGFja0Nhbm5vdFBheS5FcnJvcigpKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L18-L21"}}),e._v(" "),a("p",[e._v("Then do the same for the "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L24-L31",target:"_blank",rel:"noopener noreferrer"}},[e._v("red player"),a("OutboundLink")],1),e._v(" when there is a single move.")])],1),e._v(" "),a("li",[a("p",[a("strong",[e._v("Paying winnings")]),e._v(' takes place when the game has a declared winner. First get the winner. "No winner" is '),a("strong",[e._v("not")]),e._v(" an acceptable situation in this "),a("code",[e._v("MustPayWinnings")]),e._v(". The caller of the function must ensure there is a winner:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"d2lubmVyQWRkcmVzcywgZm91bmQsIGVyciA6PSBzdG9yZWRHYW1lLkdldFdpbm5lckFkZHJlc3MoKQppZiBlcnIgIT0gbmlsIHsKICAgIHBhbmljKGVyci5FcnJvcigpKQp9CmlmICFmb3VuZCB7CiAgICBwYW5pYyhmbXQuU3ByaW50Zih0eXBlcy5FcnJDYW5ub3RGaW5kV2lubmVyQnlDb2xvci5FcnJvcigpLCBzdG9yZWRHYW1lLldpbm5lcikpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L37-L43"}}),e._v(" "),a("p",[e._v("Then calculate the winnings to pay:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"d2lubmluZ3MgOj0gc3RvcmVkR2FtZS5HZXRXYWdlckNvaW4oKQppZiBzdG9yZWRHYW1lLk1vdmVDb3VudCA9PSAwIHsKICAgIHBhbmljKHR5cGVzLkVyck5vdGhpbmdUb1BheS5FcnJvcigpKQp9IGVsc2UgaWYgMSAmbHQ7IHN0b3JlZEdhbWUuTW92ZUNvdW50IHsKICAgIHdpbm5pbmdzID0gd2lubmluZ3MuQWRkKHdpbm5pbmdzKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L44-L49"}}),e._v(" "),a("p",[e._v("You double the wager only if the red player has also played and therefore both players have paid their wagers.")]),e._v(" "),a("p",[e._v("If you did this wrongly, you could end up in a situation where a game with a single move pays out as if both players had played. This would be a serious bug that an attacker could exploit to drain your module's escrow fund.")]),e._v(" "),a("p",[e._v("Then pay the winner:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZXJyID0gay5iYW5rLlNlbmRDb2luc0Zyb21Nb2R1bGVUb0FjY291bnQoY3R4LCB0eXBlcy5Nb2R1bGVOYW1lLCB3aW5uZXJBZGRyZXNzLCBzZGsuTmV3Q29pbnMod2lubmluZ3MpKQppZiBlcnIgIT0gbmlsIHsKICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVyckNhbm5vdFBheVdpbm5pbmdzLkVycm9yKCksIGVyci5FcnJvcigpKSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L50-L53"}})],1),e._v(" "),a("li",[a("p",[e._v("Finally, "),a("strong",[e._v("refunding wagers")]),e._v(" takes place when the game has partially started, i.e. only one party has paid, or when the game ends in a draw. In this narrow case of "),a("code",[e._v("MustRefundWager")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgPT0gMSB7CiAgICAvLyBSZWZ1bmQKfSBlbHNlIGlmIHN0b3JlZEdhbWUuTW92ZUNvdW50ID09IDAgewogICAgLy8gRG8gbm90aGluZwp9IGVsc2UgewogICAgLy8gVE9ETyBJbXBsZW1lbnQgYSBkcmF3IG1lY2hhbmlzbS4KICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVyck5vdEluUmVmdW5kU3RhdGUuRXJyb3IoKSwgc3RvcmVkR2FtZS5Nb3ZlQ291bnQpKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L57-L72"}}),e._v(" "),a("p",[e._v("Refund the black player when there has been a single move:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"YmxhY2ssIGVyciA6PSBzdG9yZWRHYW1lLkdldEJsYWNrQWRkcmVzcygpCmlmIGVyciAhPSBuaWwgewogICAgcGFuaWMoZXJyLkVycm9yKCkpCn0KZXJyID0gay5iYW5rLlNlbmRDb2luc0Zyb21Nb2R1bGVUb0FjY291bnQoY3R4LCB0eXBlcy5Nb2R1bGVOYW1lLCBibGFjaywgc2RrLk5ld0NvaW5zKHN0b3JlZEdhbWUuR2V0V2FnZXJDb2luKCkpKQppZiBlcnIgIT0gbmlsIHsKICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVyckNhbm5vdFJlZnVuZFdhZ2VyLkVycm9yKCksIGVyci5FcnJvcigpKSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler.go#L59-L66"}}),e._v(" "),a("p",[e._v("If the module cannot pay, then there is a panic as the escrow has failed.")])],1)]),e._v(" "),a("p",[e._v("You will notice that no special case is made when the wager is zero. This is a design choice here, and which way you choose to go is up to you. Not contacting the bank unnecessarily is cheaper in gas. On the other hand, why not outsource the zero check to the bank?")]),e._v(" "),a("h2",{attrs:{id:"insert-wager-handling"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#insert-wager-handling"}},[e._v("#")]),e._v(" Insert wager handling")]),e._v(" "),a("p",[e._v("With the desired steps defined in the wager handling functions, it is time to invoke them at the right places in the message handlers.")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("When a player plays for the first time:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIC4uLgogICAgaWYgIWdhbWUuVHVybklzKHBsYXllcikgewogICAgICAgIHJldHVybiBuaWwsIHNka2Vycm9ycy5XcmFwZih0eXBlcy5FcnJOb3RQbGF5ZXJUdXJuLCAmcXVvdDslcyZxdW90OywgcGxheWVyKQogICAgfQoKKyAgZXJyID0gay5LZWVwZXIuQ29sbGVjdFdhZ2VyKGN0eCwgJmFtcDtzdG9yZWRHYW1lKQorICBpZiBlcnIgIT0gbmlsIHsKKyAgICAgIHJldHVybiBuaWwsIGVycgorICB9CiAgICAuLi4K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/msg_server_play_move.go#L47-L50"}})],1),e._v(" "),a("li",[a("p",[e._v("When a player wins as a result of a move:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGlmIHN0b3JlZEdhbWUuV2lubmVyID09IHJ1bGVzLlBpZWNlU3RyaW5nc1tydWxlcy5OT19QTEFZRVJdIHsKICAgICAgICAuLi4KICAgIH0gZWxzZSB7CiAgICAgICAgLi4uCiAgICAgICAgay5LZWVwZXIuUmVtb3ZlRnJvbUZpZm8oY3R4LCAmYW1wO3N0b3JlZEdhbWUsICZhbXA7c3lzdGVtSW5mbykKKyAgICAgIGsuS2VlcGVyLk11c3RQYXlXaW5uaW5ncyhjdHgsICZhbXA7c3RvcmVkR2FtZSkKICAgIH0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/msg_server_play_move.go#L79"}})],1),e._v(" "),a("li",[a("p",[e._v("When a game expires and there is a forfeit, make sure to only refund or pay full winnings when applicable. The logic needs to be adjusted:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGlmIGRlYWRsaW5lLkJlZm9yZShjdHguQmxvY2tUaW1lKCkpIHsKICAgICAgICAuLi4KICAgICAgICBpZiBzdG9yZWRHYW1lLk1vdmVDb3VudCAmbHQ7PSAxIHsKICAgICAgICAgICAgay5SZW1vdmVTdG9yZWRHYW1lKGN0eCwgZ2FtZUluZGV4KQorICAgICAgICAgIGlmIHN0b3JlZEdhbWUuTW92ZUNvdW50ID09IDEgeworICAgICAgICAgICAgICBrLk11c3RSZWZ1bmRXYWdlcihjdHgsICZhbXA7c3RvcmVkR2FtZSkKKyAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLi4uCisgICAgICAgICAgay5NdXN0UGF5V2lubmluZ3MoY3R4LCAmYW1wO3N0b3JlZEdhbWUpCiAgICAgICAgICAgIHN0b3JlZEdhbWUuQm9hcmQgPSAmcXVvdDsmcXVvdDsKICAgICAgICAgICAgLi4uCiAgICAgICAgfQogICAgfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/end_block_server_game.go#L45-L56"}})],1)]),e._v(" "),a("h2",{attrs:{id:"unit-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#unit-tests"}},[e._v("#")]),e._v(" Unit tests")]),e._v(" "),a("p",[e._v("If you try running your existing tests you get a compilation error on the "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/testutil/keeper/checkers.go#L44-L49",target:"_blank",rel:"noopener noreferrer"}},[e._v("test keeper builder"),a("OutboundLink")],1),e._v(". Passing "),a("code",[e._v("nil")]),e._v(" would not get you far with the tests and creating a full-fledged bank keeper would be a lot of work and not a unit test. See the integration tests below for that.")]),e._v(" "),a("p",[e._v("Instead, you create mocks and use them in unit tests, not only to get the existing tests to pass but also to verify that the bank is called as expected.")]),e._v(" "),a("h3",{attrs:{id:"prepare-mocks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prepare-mocks"}},[e._v("#")]),e._v(" Prepare mocks")]),e._v(" "),a("p",[e._v("It is better to create some "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Mock_object",target:"_blank",rel:"noopener noreferrer"}},[e._v("mocks"),a("OutboundLink")],1),e._v(". The Cosmos SDK does not offer mocks of its objects so you have to create your own. For that, the "),a("a",{attrs:{href:"https://github.com/golang/mock",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("gomock")]),a("OutboundLink")],1),e._v(" library is a good resource. Install it:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnbyBpbnN0YWxsIGdpdGh1Yi5jb20vZ29sYW5nL21vY2svbW9ja2dlbkB2MS42LjAK"}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"ockerfile",base64:"Li4uCkVOViBOT0RFX1ZFUlNJT049MTgueApFTlYgTU9DS0dFTl9WRVJTSU9OPTEuNi4wCi4uLgpSVU4gYXB0LWdldCBpbnN0YWxsIC15IG5vZGVqcwoKIyBJbnN0YWxsIE1vY2tnZW4KUlVOIGdvIGluc3RhbGwgZ2l0aHViLmNvbS9nb2xhbmcvbW9jay9tb2NrZ2VuQHYke01PQ0tHRU5fVkVSU0lPTn0KLi4uCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/Dockerfile-ubuntu#L8-L33"}}),e._v(" "),a("p",[e._v("Rebuild your Docker image.")])],1)],1),e._v(" "),a("p",[e._v("With the library installed, you still need to do a one time creation of the mocks. Run:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBtb2NrZ2VuIC1zb3VyY2U9eC9jaGVja2Vycy90eXBlcy9leHBlY3RlZF9rZWVwZXJzLmdvIFwKICAgIC1wYWNrYWdlIHRlc3R1dGlsIFwKICAgIC1kZXN0aW5hdGlvbj14L2NoZWNrZXJzL3Rlc3R1dGlsL2V4cGVjdGVkX2tlZXBlcnNfbW9ja3MuZ28gCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2hlY2tlcnMgXAogICAgLXcgL2NoZWNrZXJzIFwKICAgIGNoZWNrZXJzX2kgXAogICAgbW9ja2dlbiBcCiAgICAtc291cmNlPXgvY2hlY2tlcnMvdHlwZXMvZXhwZWN0ZWRfa2VlcGVycy5nbyBcCiAgICAtcGFja2FnZSB0ZXN0dXRpbCBcCiAgICAtZGVzdGluYXRpb249eC9jaGVja2Vycy90ZXN0dXRpbC9leHBlY3RlZF9rZWVwZXJzX21vY2tzLmdvIAo="}})],1)],1),e._v(" "),a("p",[e._v("If your expected keepers change, you will have to run this command again. It can be a good idea to save the command for future reference. You may use a "),a("code",[e._v("Makefile")]),e._v(" for that. Ensure you install the "),a("code",[e._v("make")]),e._v(" tool for your computer. If you use Docker, add it to the packages and rebuild the image:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"ockerfile",base64:"RU5WIFBBQ0tBR0VTIGN1cmwgZ2NjIGpxIG1ha2UK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/Dockerfile-ubuntu#L18"}}),e._v(" "),a("p",[e._v("Create the "),a("code",[e._v("Makefile")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"lang-makefile",base64:"bW9jay1leHBlY3RlZC1rZWVwZXJzOgogICAgbW9ja2dlbiAtc291cmNlPXgvY2hlY2tlcnMvdHlwZXMvZXhwZWN0ZWRfa2VlcGVycy5nbyBcCiAgICAgICAgLXBhY2thZ2UgdGVzdHV0aWwgXAogICAgICAgIC1kZXN0aW5hdGlvbj14L2NoZWNrZXJzL3Rlc3R1dGlsL2V4cGVjdGVkX2tlZXBlcnNfbW9ja3MuZ28gCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/Makefile#L1-L4"}}),e._v(" "),a("p",[e._v("At any time, you can rebuild the mocks with:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBtYWtlIG1vY2stZXhwZWN0ZWQta2VlcGVycwo="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2hlY2tlcnMgXAogICAgLXcgL2NoZWNrZXJzIFwKICAgIGNoZWNrZXJzX2kgXAogICAgbWFrZSBtb2NrLWV4cGVjdGVkLWtlZXBlcnMK"}})],1)],1),e._v(" "),a("p",[e._v("You are going to set the expectations on this "),a("code",[e._v("BankEscrowKeeper")]),e._v(" mock many times, including when you do not care about the result. So instead of setting the verbose expectations in every test, it is in your interest to create helper functions that will make setting up the expectations more succinct and therefore readable, which is always a benefit when unit testing. Create a new "),a("code",[e._v("bank_escrow_helpers.go")]),e._v(" file with:")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("A function to "),a("em",[e._v("unset")]),e._v(" expectations (ie where anything can go). This is useful when your test does not check things around the escrow:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoZXNjcm93ICpNb2NrQmFua0VzY3Jvd0tlZXBlcikgRXhwZWN0QW55KGNvbnRleHQgY29udGV4dC5Db250ZXh0KSB7CiAgICBlc2Nyb3cuRVhQRUNUKCkuU2VuZENvaW5zRnJvbUFjY291bnRUb01vZHVsZShzZGsuVW53cmFwU0RLQ29udGV4dChjb250ZXh0KSwgZ29tb2NrLkFueSgpLCBnb21vY2suQW55KCksIGdvbW9jay5BbnkoKSkuQW55VGltZXMoKQogICAgZXNjcm93LkVYUEVDVCgpLlNlbmRDb2luc0Zyb21Nb2R1bGVUb0FjY291bnQoc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCksIGdvbW9jay5BbnkoKSwgZ29tb2NrLkFueSgpLCBnb21vY2suQW55KCkpLkFueVRpbWVzKCkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/testutil/bank_escrow_helpers.go#L11-L14"}})],1),e._v(" "),a("li",[a("p",[e._v("A function to quickly create the right type and value of coins to use for expectations:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBjb2luc09mKGFtb3VudCB1aW50NjQpIHNkay5Db2lucyB7CiAgICByZXR1cm4gc2RrLkNvaW5zewogICAgICAgIHNkay5Db2luewogICAgICAgICAgICBEZW5vbTogIHNkay5EZWZhdWx0Qm9uZERlbm9tLAogICAgICAgICAgICBBbW91bnQ6IHNkay5OZXdJbnQoaW50NjQoYW1vdW50KSksCiAgICAgICAgfSwKICAgIH0KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/testutil/bank_escrow_helpers.go#L16-L23"}})],1),e._v(" "),a("li",[a("p",[e._v("A function to define an expectation of payment from a player:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoZXNjcm93ICpNb2NrQmFua0VzY3Jvd0tlZXBlcikgRXhwZWN0UGF5KGNvbnRleHQgY29udGV4dC5Db250ZXh0LCB3aG8gc3RyaW5nLCBhbW91bnQgdWludDY0KSAqZ29tb2NrLkNhbGwgewogICAgd2hvQWRkciwgZXJyIDo9IHNkay5BY2NBZGRyZXNzRnJvbUJlY2gzMih3aG8pCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICBwYW5pYyhlcnIpCiAgICB9CiAgICByZXR1cm4gZXNjcm93LkVYUEVDVCgpLlNlbmRDb2luc0Zyb21BY2NvdW50VG9Nb2R1bGUoc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCksIHdob0FkZHIsIHR5cGVzLk1vZHVsZU5hbWUsIGNvaW5zT2YoYW1vdW50KSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/testutil/bank_escrow_helpers.go#L25-L31"}})],1),e._v(" "),a("li",[a("p",[e._v("A function to define an expectation of payment from the module:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoZXNjcm93ICpNb2NrQmFua0VzY3Jvd0tlZXBlcikgRXhwZWN0UmVmdW5kKGNvbnRleHQgY29udGV4dC5Db250ZXh0LCB3aG8gc3RyaW5nLCBhbW91bnQgdWludDY0KSAqZ29tb2NrLkNhbGwgewogICAgd2hvQWRkciwgZXJyIDo9IHNkay5BY2NBZGRyZXNzRnJvbUJlY2gzMih3aG8pCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICBwYW5pYyhlcnIpCiAgICB9CiAgICByZXR1cm4gZXNjcm93LkVYUEVDVCgpLlNlbmRDb2luc0Zyb21Nb2R1bGVUb0FjY291bnQoc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCksIHR5cGVzLk1vZHVsZU5hbWUsIHdob0FkZHIsIGNvaW5zT2YoYW1vdW50KSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/testutil/bank_escrow_helpers.go#L33-L39"}})],1)]),e._v(" "),a("p",[e._v("Note that the two main expectation functions return "),a("code",[e._v("*gomock.Call")]),e._v(". This is so that you can continue adding expectations such as:")]),e._v(" "),a("ul",[a("li",[e._v("Instructing the number of times the call is expected to be made: for instance "),a("code",[e._v(".Times(1)")]),e._v(".")]),e._v(" "),a("li",[e._v("Instructing the order of the expected calls: for instance "),a("code",[e._v(".After(<the previous call>)")]),e._v(".")])]),e._v(" "),a("h3",{attrs:{id:"make-use-of-mocks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#make-use-of-mocks"}},[e._v("#")]),e._v(" Make use of mocks")]),e._v(" "),a("p",[e._v("With the helpers in place, you can add a new function similar to "),a("code",[e._v("CheckersKeeper(t testing.TB)")]),e._v(" but which uses mocks. Keep the original function, which passes a "),a("code",[e._v("nil")]),e._v(" for bank:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGZ1bmMgQ2hlY2tlcnNLZWVwZXIodCB0ZXN0aW5nLlRCKSAoKmtlZXBlci5LZWVwZXIsIHNkay5Db250ZXh0KSB7CisgICAgICByZXR1cm4gQ2hlY2tlcnNLZWVwZXJXaXRoTW9ja3ModCwgbmlsKQorICB9CgorICBmdW5jIENoZWNrZXJzS2VlcGVyV2l0aE1vY2tzKHQgdGVzdGluZy5UQiwgYmFuayAqdGVzdHV0aWwuTW9ja0JhbmtFc2Nyb3dLZWVwZXIpICgqa2VlcGVyLktlZXBlciwgc2RrLkNvbnRleHQpIHsKICAgICAgICAuLi4KICAgICAgICBrIDo9IGtlZXBlci5OZXdLZWVwZXIoCisgICAgICAgICAgYmFuaywKICAgICAgICAgICAgLi4uCiAgICAgICAgKQogICAgICAgIC4uLgogICAgfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/testutil/keeper/checkers.go#L21-L58"}}),e._v(" "),a("p",[e._v("The "),a("code",[e._v("CheckersKeeperWithMocks")]),e._v(" function takes the mock in its arguments for more versatility. The "),a("code",[e._v("CheckersKeeper")]),e._v(" remains for the tests that never call the escrow.")]),e._v(" "),a("p",[e._v("Now adjust the small functions that set up the keeper before each test. You do not need to change them for the "),a("em",[e._v("create")]),e._v(" tests, because they never call the bank. You have to do it for "),a("em",[e._v("play")]),e._v(" and "),a("em",[e._v("forfeit")]),e._v(".")]),e._v(" "),a("p",[e._v("For "),a("em",[e._v("play")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"LSAgZnVuYyBzZXR1cE1zZ1NlcnZlcldpdGhPbmVHYW1lRm9yUGxheU1vdmUodCB0ZXN0aW5nLlRCKSAodHlwZXMuTXNnU2VydmVyLCBrZWVwZXIuS2VlcGVyLCBjb250ZXh0LkNvbnRleHQpIHsKLSAgICAgIGssIGN0eCA6PSBrZWVwZXJ0ZXN0LkNoZWNrZXJzS2VlcGVyKHQpCisgIGZ1bmMgc2V0dXBNc2dTZXJ2ZXJXaXRoT25lR2FtZUZvclBsYXlNb3ZlKHQgdGVzdGluZy5UQikgKHR5cGVzLk1zZ1NlcnZlciwga2VlcGVyLktlZXBlciwgY29udGV4dC5Db250ZXh0LAorICAgICAgKmdvbW9jay5Db250cm9sbGVyLCAqdGVzdHV0aWwuTW9ja0JhbmtFc2Nyb3dLZWVwZXIpIHsKKyAgICAgIGN0cmwgOj0gZ29tb2NrLk5ld0NvbnRyb2xsZXIodCkKKyAgICAgIGJhbmtNb2NrIDo9IHRlc3R1dGlsLk5ld01vY2tCYW5rRXNjcm93S2VlcGVyKGN0cmwpCisgICAgICBrLCBjdHggOj0ga2VlcGVydGVzdC5DaGVja2Vyc0tlZXBlcldpdGhNb2Nrcyh0LCBiYW5rTW9jaykKICAgICAgICBjaGVja2Vycy5Jbml0R2VuZXNpcyhjdHgsICprLCAqdHlwZXMuRGVmYXVsdEdlbmVzaXMoKSkKICAgICAgICBzZXJ2ZXIgOj0ga2VlcGVyLk5ld01zZ1NlcnZlckltcGwoKmspCiAgICAgICAgY29udGV4dCA6PSBzZGsuV3JhcFNES0NvbnRleHQoY3R4KQogICAgICAgIHNlcnZlci5DcmVhdGVHYW1lKGNvbnRleHQsICZhbXA7dHlwZXMuTXNnQ3JlYXRlR2FtZXsKICAgICAgICAgICAgQ3JlYXRvcjogYWxpY2UsCiAgICAgICAgICAgIEJsYWNrOiAgIGJvYiwKICAgICAgICAgICAgUmVkOiAgICAgY2Fyb2wsCiAgICAgICAgICAgIFdhZ2VyOiAgIDQ1LAogICAgICAgIH0pCi0gICAgICByZXR1cm4gc2VydmVyLCAqaywgY29udGV4dAorICAgICAgcmV0dXJuIHNlcnZlciwgKmssIGNvbnRleHQsIGN0cmwsIGJhbmtNb2NrCiAgICB9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/msg_server_play_move_test.go#L17-L32"}}),e._v(" "),a("p",[e._v("This function creates the mock and returns two new objects:")]),e._v(" "),a("ul",[a("li",[e._v("The mock controller, so that the "),a("code",[e._v(".Finish()")]),e._v(" method can be called within the test itself. This is the function that will verify the call expectations placed on the mocks.")]),e._v(" "),a("li",[e._v("The mocked bank escrow. This is the instance on which you place the call expectations.")])]),e._v(" "),a("p",[e._v("Both objects will be used from the tests proper.")]),e._v(" "),a("p",[e._v("Do the same for "),a("em",[e._v("forfeit")]),e._v(" if their unit tests do not use the above "),a("code",[e._v("setupMsgServerWithOneGameForPlayMove")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"adjust-the-unit-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#adjust-the-unit-tests"}},[e._v("#")]),e._v(" Adjust the unit tests")]),e._v(" "),a("p",[e._v("With these changes, you need to adjust many unit tests for "),a("em",[e._v("play")]),e._v(" and "),a("em",[e._v("forfeit")]),e._v(". Often you may only want to make the tests pass again without checking any meaningful bank call expectations. There are different situations:")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("The mocked bank is not called. Therefore, you do not add any expectation and still call the controller:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGZ1bmMgVGVzdEZvcmZlaXRVbnBsYXllZCh0ICp0ZXN0aW5nLlQpIHsKLSAgICAgIF8sIGtlZXBlciwgY29udGV4dCA6PSBzZXR1cE1zZ1NlcnZlcldpdGhPbmVHYW1lRm9yUGxheU1vdmUodCkKKyAgICAgIF8sIGtlZXBlciwgY29udGV4dCwgY3RybCwgXyA6PSBzZXR1cE1zZ1NlcnZlcldpdGhPbmVHYW1lRm9yUGxheU1vdmUodCkKICAgICAgICBjdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCkKKyAgICAgIGRlZmVyIGN0cmwuRmluaXNoKCkKICAgICAgICAuLi4KICAgIH0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/end_block_server_game_test.go#L13-L15"}}),e._v(" "),a("p",[e._v("When you expect the mocked bank "),a("strong",[e._v("not")]),e._v(" to be called, it is important that you do not put any expectations on it. This means the test will fail if it is called by mistake.")])],1),e._v(" "),a("li",[a("p",[e._v("The mocked bank is called, but you do not care about how it is called:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"LSAgbXNnU2VydmVyLCBfLCBjb250ZXh0IDo9IHNldHVwTXNnU2VydmVyV2l0aE9uZUdhbWVGb3JSZWplY3RHYW1lKHQpCisgIG1zZ1NlcnZlciwgXywgY29udGV4dCwgY3RybCwgZXNjcm93IDo9IHNldHVwTXNnU2VydmVyV2l0aE9uZUdhbWVGb3JSZWplY3RHYW1lKHQpCisgIGRlZmVyIGN0cmwuRmluaXNoKCkKKyAgZXNjcm93LkV4cGVjdEFueShjb250ZXh0KQo="}}),e._v(" "),a("p",[e._v("Here you do not want to be distracted by escrow concerns.")])],1),e._v(" "),a("li",[a("p",[e._v("The mocked bank is called, and you want to add call expectations:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"diff-go",base64:"ICAgIGZ1bmMgVGVzdEZvcmZlaXRQbGF5ZWRPbmNlKHQgKnRlc3RpbmcuVCkgewotICAgICAgbXNnU2VydmVyLCBrZWVwZXIsIGNvbnRleHQgOj0gc2V0dXBNc2dTZXJ2ZXJXaXRoT25lR2FtZUZvclBsYXlNb3ZlKHQpCisgICAgICBtc2dTZXJ2ZXIsIGtlZXBlciwgY29udGV4dCwgY3RybCwgZXNjcm93IDo9IHNldHVwTXNnU2VydmVyV2l0aE9uZUdhbWVGb3JQbGF5TW92ZSh0KQogICAgICAgIGN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjb250ZXh0KQorICAgICAgZGVmZXIgY3RybC5GaW5pc2goKQorICAgICAgcGF5IDo9IGVzY3Jvdy5FeHBlY3RQYXkoY29udGV4dCwgYm9iLCA0NSkuVGltZXMoMSkKKyAgICAgIGVzY3Jvdy5FeHBlY3RSZWZ1bmQoY29udGV4dCwgYm9iLCA0NSkuVGltZXMoMSkuQWZ0ZXIocGF5KQogICAgICAgIC4uLgogICAgfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/end_block_server_game_test.go#L139-L143"}})],1)]),e._v(" "),a("p",[e._v("Go ahead and make the many necessary changes as you see fit.")]),e._v(" "),a("h3",{attrs:{id:"wager-handler-unit-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#wager-handler-unit-tests"}},[e._v("#")]),e._v(" Wager handler unit tests")]),e._v(" "),a("p",[e._v("After these adjustments, it is a good idea to add unit tests directly on the wager handling functions of the keeper. Create a new "),a("code",[e._v("wager_handler_test.go")]),e._v(" file. In it:")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Add a setup helper function that does not create any message server:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBzZXR1cEtlZXBlckZvcldhZ2VySGFuZGxlcih0IHRlc3RpbmcuVEIpIChrZWVwZXIuS2VlcGVyLCBjb250ZXh0LkNvbnRleHQsCiAgICAqZ29tb2NrLkNvbnRyb2xsZXIsICp0ZXN0dXRpbC5Nb2NrQmFua0VzY3Jvd0tlZXBlcikgewogICAgY3RybCA6PSBnb21vY2suTmV3Q29udHJvbGxlcih0KQogICAgYmFua01vY2sgOj0gdGVzdHV0aWwuTmV3TW9ja0JhbmtFc2Nyb3dLZWVwZXIoY3RybCkKICAgIGssIGN0eCA6PSBrZWVwZXJ0ZXN0LkNoZWNrZXJzS2VlcGVyV2l0aE1vY2tzKHQsIGJhbmtNb2NrKQogICAgY2hlY2tlcnMuSW5pdEdlbmVzaXMoY3R4LCAqaywgKnR5cGVzLkRlZmF1bHRHZW5lc2lzKCkpCiAgICBjb250ZXh0IDo9IHNkay5XcmFwU0RLQ29udGV4dChjdHgpCiAgICByZXR1cm4gKmssIGNvbnRleHQsIGN0cmwsIGJhbmtNb2NrCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L18-L26"}})],1),e._v(" "),a("li",[a("p",[e._v("Add tests on the "),a("code",[e._v("CollectWager")]),e._v(" function. For instance, when the game is malformed:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0V2FnZXJIYW5kbGVyQ29sbGVjdFdyb25nTm9CbGFjayh0ICp0ZXN0aW5nLlQpIHsKICAgIGtlZXBlciwgY29udGV4dCwgY3RybCwgXyA6PSBzZXR1cEtlZXBlckZvcldhZ2VySGFuZGxlcih0KQogICAgY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGNvbnRleHQpCiAgICBkZWZlciBjdHJsLkZpbmlzaCgpCiAgICBkZWZlciBmdW5jKCkgewogICAgICAgIHIgOj0gcmVjb3ZlcigpCiAgICAgICAgcmVxdWlyZS5Ob3ROaWwodCwgciwgJnF1b3Q7VGhlIGNvZGUgZGlkIG5vdCBwYW5pYyZxdW90OykKICAgICAgICByZXF1aXJlLkVxdWFsKHQsICZxdW90O2JsYWNrIGFkZHJlc3MgaXMgaW52YWxpZDogOiBlbXB0eSBhZGRyZXNzIHN0cmluZyBpcyBub3QgYWxsb3dlZCZxdW90OywgcikKICAgIH0oKQogICAga2VlcGVyLkNvbGxlY3RXYWdlcihjdHgsICZhbXA7dHlwZXMuU3RvcmVkR2FtZXsKICAgICAgICBNb3ZlQ291bnQ6IDAsCiAgICB9KQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L28-L40"}}),e._v(" "),a("p",[e._v("Or when the black player failed to escrow the wager:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0V2FnZXJIYW5kbGVyQ29sbGVjdEZhaWxlZE5vTW92ZSh0ICp0ZXN0aW5nLlQpIHsKICAgIGtlZXBlciwgY29udGV4dCwgY3RybCwgZXNjcm93IDo9IHNldHVwS2VlcGVyRm9yV2FnZXJIYW5kbGVyKHQpCiAgICBjdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCkKICAgIGRlZmVyIGN0cmwuRmluaXNoKCkKICAgIGJsYWNrLCBfIDo9IHNkay5BY2NBZGRyZXNzRnJvbUJlY2gzMihhbGljZSkKICAgIGVzY3Jvdy5FWFBFQ1QoKS4KICAgICAgICBTZW5kQ29pbnNGcm9tQWNjb3VudFRvTW9kdWxlKGN0eCwgYmxhY2ssIHR5cGVzLk1vZHVsZU5hbWUsIGdvbW9jay5BbnkoKSkuCiAgICAgICAgUmV0dXJuKGVycm9ycy5OZXcoJnF1b3Q7T29wcyZxdW90OykpCiAgICBlcnIgOj0ga2VlcGVyLkNvbGxlY3RXYWdlcihjdHgsICZhbXA7dHlwZXMuU3RvcmVkR2FtZXsKICAgICAgICBCbGFjazogICAgIGFsaWNlLAogICAgICAgIE1vdmVDb3VudDogMCwKICAgICAgICBXYWdlcjogICAgIDQ1LAogICAgfSkKICAgIHJlcXVpcmUuTm90TmlsKHQsIGVycikKICAgIHJlcXVpcmUuRXF1YWxFcnJvcih0LCBlcnIsICZxdW90O2JsYWNrIGNhbm5vdCBwYXkgdGhlIHdhZ2VyOiBPb3BzJnF1b3Q7KQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L42-L57"}}),e._v(" "),a("p",[e._v("Or when the collection of a wager works:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0V2FnZXJIYW5kbGVyQ29sbGVjdE5vTW92ZSh0ICp0ZXN0aW5nLlQpIHsKICAgIGtlZXBlciwgY29udGV4dCwgY3RybCwgZXNjcm93IDo9IHNldHVwS2VlcGVyRm9yV2FnZXJIYW5kbGVyKHQpCiAgICBjdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoY29udGV4dCkKICAgIGRlZmVyIGN0cmwuRmluaXNoKCkKICAgIGVzY3Jvdy5FeHBlY3RQYXkoY29udGV4dCwgYWxpY2UsIDQ1KQogICAgZXJyIDo9IGtlZXBlci5Db2xsZWN0V2FnZXIoY3R4LCAmYW1wO3R5cGVzLlN0b3JlZEdhbWV7CiAgICAgICAgQmxhY2s6ICAgICBhbGljZSwKICAgICAgICBNb3ZlQ291bnQ6IDAsCiAgICAgICAgV2FnZXI6ICAgICA0NSwKICAgIH0pCiAgICByZXF1aXJlLk5pbCh0LCBlcnIpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L90-L101"}})],1),e._v(" "),a("li",[a("p",[e._v("Add similar tests to the payment of winnings from the escrow. When it fails:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0V2FnZXJIYW5kbGVyUGF5V3JvbmdFc2Nyb3dGYWlsZWQodCAqdGVzdGluZy5UKSB7CiAgICBrZWVwZXIsIGNvbnRleHQsIGN0cmwsIGVzY3JvdyA6PSBzZXR1cEtlZXBlckZvcldhZ2VySGFuZGxlcih0KQogICAgY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGNvbnRleHQpCiAgICBkZWZlciBjdHJsLkZpbmlzaCgpCiAgICBibGFjaywgXyA6PSBzZGsuQWNjQWRkcmVzc0Zyb21CZWNoMzIoYWxpY2UpCiAgICBlc2Nyb3cuRVhQRUNUKCkuCiAgICAgICAgU2VuZENvaW5zRnJvbU1vZHVsZVRvQWNjb3VudChjdHgsIHR5cGVzLk1vZHVsZU5hbWUsIGJsYWNrLCBnb21vY2suQW55KCkpLgogICAgICAgIFRpbWVzKDEpLgogICAgICAgIFJldHVybihlcnJvcnMuTmV3KCZxdW90O09vcHMmcXVvdDspKQogICAgZGVmZXIgZnVuYygpIHsKICAgICAgICByIDo9IHJlY292ZXIoKQogICAgICAgIHJlcXVpcmUuTm90TmlsKHQsIHIsICZxdW90O1RoZSBjb2RlIGRpZCBub3QgcGFuaWMmcXVvdDspCiAgICAgICAgcmVxdWlyZS5FcXVhbCh0LCByLCAmcXVvdDtjYW5ub3QgcGF5IHdpbm5pbmdzIHRvIHdpbm5lcjogT29wcyZxdW90OykKICAgIH0oKQogICAga2VlcGVyLk11c3RQYXlXaW5uaW5ncyhjdHgsICZhbXA7dHlwZXMuU3RvcmVkR2FtZXsKICAgICAgICBCbGFjazogICAgIGFsaWNlLAogICAgICAgIFJlZDogICAgICAgYm9iLAogICAgICAgIFdpbm5lcjogICAgJnF1b3Q7YiZxdW90OywKICAgICAgICBNb3ZlQ291bnQ6IDEsCiAgICAgICAgV2FnZXI6ICAgICA0NSwKICAgIH0pCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L163-L184"}}),e._v(" "),a("p",[e._v("Or when it works:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0V2FnZXJIYW5kbGVyUGF5RXNjcm93Q2FsbGVkVHdvTW92ZXModCAqdGVzdGluZy5UKSB7CiAgICBrZWVwZXIsIGNvbnRleHQsIGN0cmwsIGVzY3JvdyA6PSBzZXR1cEtlZXBlckZvcldhZ2VySGFuZGxlcih0KQogICAgY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGNvbnRleHQpCiAgICBkZWZlciBjdHJsLkZpbmlzaCgpCiAgICBlc2Nyb3cuRXhwZWN0UmVmdW5kKGNvbnRleHQsIGFsaWNlLCA5MCkKICAgIGtlZXBlci5NdXN0UGF5V2lubmluZ3MoY3R4LCAmYW1wO3R5cGVzLlN0b3JlZEdhbWV7CiAgICAgICAgQmxhY2s6ICAgICBhbGljZSwKICAgICAgICBSZWQ6ICAgICAgIGJvYiwKICAgICAgICBXaW5uZXI6ICAgICZxdW90O2ImcXVvdDssCiAgICAgICAgTW92ZUNvdW50OiAyLAogICAgICAgIFdhZ2VyOiAgICAgNDUsCiAgICB9KQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L200-L212"}})],1),e._v(" "),a("li",[a("p",[e._v("You will also need a test for "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/wager_handler_test.go#L251-L270",target:"_blank",rel:"noopener noreferrer"}},[e._v("refund"),a("OutboundLink")],1),e._v(" situations.")])])]),e._v(" "),a("h3",{attrs:{id:"add-bank-escrow-unit-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-bank-escrow-unit-tests"}},[e._v("#")]),e._v(" Add bank escrow unit tests")]),e._v(" "),a("p",[e._v("Now that the wager handling has been convincingly tested, you want to confirm that its functions are called at the right junctures. Add dedicated tests with message servers that confirm how the bank is called. Add them in existing files, for instance:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0UGxheU1vdmVVcFRvV2lubmVyQ2FsbGVkQmFuayh0ICp0ZXN0aW5nLlQpIHsKICAgIG1zZ1NlcnZlciwgXywgY29udGV4dCwgY3RybCwgZXNjcm93IDo9IHNldHVwTXNnU2VydmVyV2l0aE9uZUdhbWVGb3JQbGF5TW92ZSh0KQogICAgZGVmZXIgY3RybC5GaW5pc2goKQogICAgcGF5Qm9iIDo9IGVzY3Jvdy5FeHBlY3RQYXkoY29udGV4dCwgYm9iLCA0NSkuVGltZXMoMSkKICAgIHBheUNhcm9sIDo9IGVzY3Jvdy5FeHBlY3RQYXkoY29udGV4dCwgY2Fyb2wsIDQ1KS5UaW1lcygxKS5BZnRlcihwYXlCb2IpCiAgICBlc2Nyb3cuRXhwZWN0UmVmdW5kKGNvbnRleHQsIGJvYiwgOTApLlRpbWVzKDEpLkFmdGVyKHBheUNhcm9sKQoKICAgIHBsYXlBbGxNb3Zlcyh0LCBtc2dTZXJ2ZXIsIGNvbnRleHQsICZxdW90OzEmcXVvdDssIHRlc3R1dGlsLkdhbWUxTW92ZXMpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/payment-winning/x/checkers/keeper/msg_server_play_move_winner_test.go#L57-L65"}}),e._v(" "),a("p",[e._v("After doing all that, confirm that your tests run.")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnbyB0ZXN0IGdpdGh1Yi5jb20vYWxpY2UvY2hlY2tlcnMveC9jaGVja2Vycy9rZWVwZXIK"}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2hlY2tlcnMgXAogICAgLXcgL2NoZWNrZXJzIFwKICAgIGNoZWNrZXJzX2kgXAogICAgZ28gdGVzdCBnaXRodWIuY29tL2FsaWNlL2NoZWNrZXJzL3gvY2hlY2tlcnMva2VlcGVyCg=="}})],1)],1),e._v(" "),a("h2",{attrs:{id:"integration-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#integration-tests"}},[e._v("#")]),e._v(" Integration tests")]),e._v(" "),a("p",[e._v("Your unit tests pass, and they confirm that the bank is called as per your expectations. It would be nice to add further tests that use a "),a("em",[e._v("real")]),e._v(" bank. This is possible with the help of integration tests.")]),e._v(" "),a("HighlightBox",{attrs:{type:"remember"}},[a("p",[e._v("As a reminder:")]),e._v(" "),a("ul",[a("li",[e._v("At version 0.45.4 of the Cosmos SDK, an integration test creates a full app.")]),e._v(" "),a("li",[e._v("At version 0.47 of the SDK, an integration test creates a minimal app, and a test that creates a full app is called an end-to-end test (E2E).")])])]),e._v(" "),a("p",[e._v("Fortunately, you do not have to do this from scratch: taking inspiration from "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/x/bank/keeper/keeper_test.go#L66-L110",target:"_blank",rel:"noopener noreferrer"}},[e._v("tests on the bank module"),a("OutboundLink")],1),e._v(", prepare your code so as to accommodate and create a full app that will contain a bank keeper, and add new tests.")]),e._v(" "),a("p",[e._v("For unit tests, each function takes a "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/x/checkers/keeper/end_block_server_game_test.go#L12",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("t *testing.T")]),a("OutboundLink")],1),e._v(" object. For integration tests, each function will be a method on a test suite that inherits from "),a("a",{attrs:{href:"https://pkg.go.dev/github.com/stretchr/testify/suite",target:"_blank",rel:"noopener noreferrer"}},[e._v("testify's suite"),a("OutboundLink")],1),e._v(". This has the advantage that your test suite can have as many fields as is necessary or useful. The objects that you have used and would welcome in the suite are:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"a2VlcGVyICAgIGtlZXBlci5LZWVwZXIKbXNnU2VydmVyIHR5cGVzLk1zZ1NlcnZlcgpjdHggICAgICAgc2RrLkNvbnRleHQK"}}),e._v(" "),a("p",[e._v("You can spread the suite's methods to different files, so as to keep consistent naming for your test files.")]),e._v(" "),a("p",[e._v("When testing, "),a("code",[e._v("go test")]),e._v(" will find the suite because you add a "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/x/bank/keeper/keeper_test.go#L1233-L1235",target:"_blank",rel:"noopener noreferrer"}},[a("em",[e._v("regular")]),e._v(" test"),a("OutboundLink")],1),e._v(" that initializes the suite and runs it. The test suite is then automatically initialized with its "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/x/bank/keeper/keeper_test.go#L96",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("SetupTest")]),a("OutboundLink")],1),e._v(" function via its parent "),a("code",[e._v("suite")]),e._v(" class. After that, all the methods of the test suite are run.")]),e._v(" "),a("h3",{attrs:{id:"accommodate-your-code"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#accommodate-your-code"}},[e._v("#")]),e._v(" Accommodate your code")]),e._v(" "),a("p",[e._v("Copy and adjust from the Cosmos SDK.")]),e._v(" "),a("PanelList",[a("PanelListItem",{attrs:{number:"1"}},[a("p",[e._v("Ignite CLI created a default constructor for your App with a "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/app/app.go#L245-L256",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("cosmoscmd.App")]),a("OutboundLink")],1),e._v(" return type, but this is not convenient. Instead of risking breaking other dependencies, add a new constructor with "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/app/app.go#L257-L281",target:"_blank",rel:"noopener noreferrer"}},[e._v("your "),a("code",[e._v("App")]),a("OutboundLink")],1),e._v(" as the return type.")])]),e._v(" "),a("PanelListItem",{attrs:{number:"2"}},[a("p",[e._v("Use "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/app/encoding.go",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("encoding.go")]),a("OutboundLink")],1),e._v(" taken from "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/simapp/encoding.go",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(", where you:")]),e._v(" "),a("ul",[a("li",[e._v("Import "),a("code",[e._v('"github.com/ignite-hq/cli/ignite/pkg/cosmoscmd"')]),e._v(".")]),e._v(" "),a("li",[e._v("Replace "),a("code",[e._v("simappparams.EncodingConfig")]),e._v(" with "),a("code",[e._v("cosmoscmd.EncodingConfig")]),e._v(".")]),e._v(" "),a("li",[e._v("Replace "),a("code",[e._v("simappparams.MakeTestEncodingConfig")]),e._v(" with "),a("code",[e._v("appparams.MakeTestEncodingConfig")]),e._v(".")])])]),e._v(" "),a("PanelListItem",{attrs:{number:"3"}},[a("p",[e._v("Use "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/app/params/proto.go",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("proto.go")]),a("OutboundLink")],1),e._v(" taken from "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/simapp/params/proto.go",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(", where you:")]),e._v(" "),a("ul",[a("li",[e._v("Import "),a("code",[e._v('"github.com/ignite-hq/cli/ignite/pkg/cosmoscmd"')]),e._v(".")]),e._v(" "),a("li",[e._v("Replace "),a("code",[e._v("EncodingConfig")]),e._v(" with "),a("code",[e._v("cosmoscmd.EncodingConfig")]),e._v(".")])])]),e._v(" "),a("PanelListItem",{attrs:{number:"4"}},[a("p",[e._v("Use "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/app/test_helpers.go",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("test_helpers.go")]),a("OutboundLink")],1),e._v(" taken from "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.45.4/simapp/test_helpers.go",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(", in which you:")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("Adjust from "),a("code",[e._v("SimApp")]),e._v(" to "),a("code",[e._v("App")])])]),e._v(" "),a("li",[a("p",[e._v("Adjust from "),a("code",[e._v("New()")]),e._v(" to "),a("code",[e._v("NewApp()")])])]),e._v(" "),a("li",[a("p",[e._v("Initialize your checkers genesis:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y2hlY2tlcnNHZW5lc2lzIDo9IHR5cGVzLkRlZmF1bHRHZW5lc2lzKCkKZ2VuZXNpc1N0YXRlW3R5cGVzLk1vZHVsZU5hbWVdID0gYXBwLkFwcENvZGVjKCkuTXVzdE1hcnNoYWxKU09OKGNoZWNrZXJzR2VuZXNpcykK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/app/test_helpers.go#L146-L147"}})],1)])]),e._v(" "),a("PanelListItem",{attrs:{number:"5"}},[a("p",[e._v("Define your test suite in a new "),a("code",[e._v("keeper_integration_suite_test.go")]),e._v(" file in a dedicated folder "),a("code",[e._v("tests/integration/checkers/keeper")]),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBJbnRlZ3JhdGlvblRlc3RTdWl0ZSBzdHJ1Y3QgewogICAgc3VpdGUuU3VpdGUKCiAgICBhcHAgICAgICAgICAqY2hlY2tlcnNhcHAuQXBwCiAgICBtc2dTZXJ2ZXIgICB0eXBlcy5Nc2dTZXJ2ZXIKICAgIGN0eCAgICAgICAgIHNkay5Db250ZXh0CiAgICBxdWVyeUNsaWVudCB0eXBlcy5RdWVyeUNsaWVudAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L30-L37"}})],1),e._v(" "),a("PanelListItem",{attrs:{number:"6"}},[a("p",[e._v("Direct "),a("code",[e._v("go test")]),e._v(" to it:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBUZXN0Q2hlY2tlcnNLZWVwZXJUZXN0U3VpdGUodCAqdGVzdGluZy5UKSB7CiAgICBzdWl0ZS5SdW4odCwgbmV3KEludGVncmF0aW9uVGVzdFN1aXRlKSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L43-L45"}})],1),e._v(" "),a("PanelListItem",{attrs:{number:"7",last:!0}},[a("p",[e._v("Create the "),a("code",[e._v("suite.SetupTest")]),e._v(" function, taking inspiration from the "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/9e1ec7b/x/bank/keeper/keeper_test.go#L96-L110",target:"_blank",rel:"noopener noreferrer"}},[e._v("bank tests"),a("OutboundLink")],1),e._v(":")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3VpdGUgKkludGVncmF0aW9uVGVzdFN1aXRlKSBTZXR1cFRlc3QoKSB7CiAgICBhcHAgOj0gY2hlY2tlcnNhcHAuU2V0dXAoZmFsc2UpCiAgICBjdHggOj0gYXBwLkJhc2VBcHAuTmV3Q29udGV4dChmYWxzZSwgdG1wcm90by5IZWFkZXJ7VGltZTogdGltZS5Ob3coKX0pCgogICAgYXBwLkFjY291bnRLZWVwZXIuU2V0UGFyYW1zKGN0eCwgYXV0aHR5cGVzLkRlZmF1bHRQYXJhbXMoKSkKICAgIGFwcC5CYW5rS2VlcGVyLlNldFBhcmFtcyhjdHgsIGJhbmt0eXBlcy5EZWZhdWx0UGFyYW1zKCkpCiAgICBjaGVja2Vyc01vZHVsZUFkZHJlc3MgPSBhcHAuQWNjb3VudEtlZXBlci5HZXRNb2R1bGVBZGRyZXNzKHR5cGVzLk1vZHVsZU5hbWUpLlN0cmluZygpCgogICAgcXVlcnlIZWxwZXIgOj0gYmFzZWFwcC5OZXdRdWVyeVNlcnZlclRlc3RIZWxwZXIoY3R4LCBhcHAuSW50ZXJmYWNlUmVnaXN0cnkoKSkKICAgIHR5cGVzLlJlZ2lzdGVyUXVlcnlTZXJ2ZXIocXVlcnlIZWxwZXIsIGFwcC5DaGVja2Vyc0tlZXBlcikKICAgIHF1ZXJ5Q2xpZW50IDo9IHR5cGVzLk5ld1F1ZXJ5Q2xpZW50KHF1ZXJ5SGVscGVyKQoKICAgIHN1aXRlLmFwcCA9IGFwcAogICAgc3VpdGUubXNnU2VydmVyID0ga2VlcGVyLk5ld01zZ1NlcnZlckltcGwoYXBwLkNoZWNrZXJzS2VlcGVyKQogICAgc3VpdGUuY3R4ID0gY3R4CiAgICBzdWl0ZS5xdWVyeUNsaWVudCA9IHF1ZXJ5Q2xpZW50Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L47-L63"}}),e._v(" "),a("p",[e._v("This "),a("a",{attrs:{href:"https://github.com/stretchr/testify/blob/v1.7.0/suite/interfaces.go#L18-L22",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("SetupTest")]),e._v(" function"),a("OutboundLink")],1),e._v(" is like a "),a("code",[e._v("beforeEach")]),e._v(" as found in other test libraries. With it, you always get a new "),a("code",[e._v("app")]),e._v(" in each test, without interference between them. Do not "),a("a",{attrs:{href:"https://github.com/stretchr/testify/blob/v1.7.0/suite/suite.go#L147",target:"_blank",rel:"noopener noreferrer"}},[e._v("omit it"),a("OutboundLink")],1),e._v(" unless you have specific reasons to do so.")]),e._v(" "),a("HighlightBox",{attrs:{type:"note"}},[a("p",[e._v("It collects your "),a("code",[e._v("checkersModuleAddress")]),e._v(" for later use in tests that check events and balances:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dmFyICgKICAgIGNoZWNrZXJzTW9kdWxlQWRkcmVzcyBzdHJpbmcKKQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L39-L41"}})],1)],1)],1),e._v(" "),a("h3",{attrs:{id:"test-the-test-suite"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-the-test-suite"}},[e._v("#")]),e._v(" Test the test suite")]),e._v(" "),a("p",[e._v("You can now confirm you did all this correctly by running these new keeper integration tests, although the suite has no tests. Note how the path to call has changed:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBnbyB0ZXN0IGdpdGh1Yi5jb20vYWxpY2UvY2hlY2tlcnMvdGVzdHMvaW50ZWdyYXRpb24vY2hlY2tlcnMva2VlcGVyCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgcnVuIC0tcm0gLWl0IFwKICAgIC12ICQocHdkKTovY2hlY2tlcnMgXAogICAgLXcgL2NoZWNrZXJzIFwKICAgIGNoZWNrZXJzX2kgXAogICAgZ28gdGVzdCBnaXRodWIuY29tL2FsaWNlL2NoZWNrZXJzL3Rlc3RzL2ludGVncmF0aW9uL2NoZWNrZXJzL2tlZXBlcgo="}})],1)],1),e._v(" "),a("h3",{attrs:{id:"helpers-for-money-checking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#helpers-for-money-checking"}},[e._v("#")]),e._v(" Helpers for money checking")]),e._v(" "),a("p",[e._v("Your upcoming integration tests will include checks on wagers being paid, lost, and won, so your tests need to initialize some bank balances for your players. This is made easier with a few helpers, including a helper to confirm a bank balance.")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Make a bank genesis "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/9e1ec7b6/x/bank/types/genesis.pb.go#L105-L110",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("Balance")]),a("OutboundLink")],1),e._v(" type from primitives:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBtYWtlQmFsYW5jZShhZGRyZXNzIHN0cmluZywgYmFsYW5jZSBpbnQ2NCkgYmFua3R5cGVzLkJhbGFuY2UgewogICAgcmV0dXJuIGJhbmt0eXBlcy5CYWxhbmNlewogICAgICAgIEFkZHJlc3M6IGFkZHJlc3MsCiAgICAgICAgQ29pbnM6IHNkay5Db2luc3sKICAgICAgICAgICAgc2RrLkNvaW57CiAgICAgICAgICAgICAgICBEZW5vbTogIHNkay5EZWZhdWx0Qm9uZERlbm9tLAogICAgICAgICAgICAgICAgQW1vdW50OiBzZGsuTmV3SW50KGJhbGFuY2UpLAogICAgICAgICAgICB9LAogICAgICAgIH0sCiAgICB9Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L65-L75"}})],1),e._v(" "),a("li",[a("p",[e._v("Declare default accounts and balances that will be useful for you:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aW1wb3J0ICgKICAgICZxdW90O2dpdGh1Yi5jb20vYWxpY2UvY2hlY2tlcnMveC9jaGVja2Vycy90ZXN0dXRpbCZxdW90OwopIAoKY29uc3QgKAogICAgYWxpY2UgPSB0ZXN0dXRpbC5BbGljZQogICAgYm9iICAgPSB0ZXN0dXRpbC5Cb2IKICAgIGNhcm9sID0gdGVzdHV0aWwuQ2Fyb2wKKQpjb25zdCAoCiAgICBiYWxBbGljZSA9IDUwMDAwMDAwCiAgICBiYWxCb2IgICA9IDIwMDAwMDAwCiAgICBiYWxDYXJvbCA9IDEwMDAwMDAwCikK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L19-L28"}})],1),e._v(" "),a("li",[a("p",[e._v("Make your preferred bank genesis state:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBnZXRCYW5rR2VuZXNpcygpICpiYW5rdHlwZXMuR2VuZXNpc1N0YXRlIHsKICAgIGNvaW5zIDo9IFtdYmFua3R5cGVzLkJhbGFuY2V7CiAgICAgICAgbWFrZUJhbGFuY2UoYWxpY2UsIGJhbEFsaWNlKSwKICAgICAgICBtYWtlQmFsYW5jZShib2IsIGJhbEJvYiksCiAgICAgICAgbWFrZUJhbGFuY2UoY2Fyb2wsIGJhbENhcm9sKSwKICAgIH0KICAgIHN1cHBseSA6PSBiYW5rdHlwZXMuU3VwcGx5ewogICAgICAgIFRvdGFsOiBjb2luc1swXS5Db2lucy5BZGQoY29pbnNbMV0uQ29pbnMuLi4pLkFkZChjb2luc1syXS5Db2lucy4uLikKICAgIH0KCiAgICBzdGF0ZSA6PSBiYW5rdHlwZXMuTmV3R2VuZXNpc1N0YXRlKAogICAgICAgIGJhbmt0eXBlcy5EZWZhdWx0UGFyYW1zKCksCiAgICAgICAgY29pbnMsCiAgICAgICAgc3VwcGx5LkdldFRvdGFsKCksCiAgICAgICAgW11iYW5rdHlwZXMuTWV0YWRhdGF7fSkKCiAgICByZXR1cm4gc3RhdGUKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L77-L94"}})],1),e._v(" "),a("li",[a("p",[e._v("Add a simple function to prepare your suite with your desired balances:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3VpdGUgKkludGVncmF0aW9uVGVzdFN1aXRlKSBzZXR1cFN1aXRlV2l0aEJhbGFuY2VzKCkgewogICAgc3VpdGUuYXBwLkJhbmtLZWVwZXIuSW5pdEdlbmVzaXMoc3VpdGUuY3R4LCBnZXRCYW5rR2VuZXNpcygpKQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L96-L98"}})],1),e._v(" "),a("li",[a("p",[e._v("Add a function to check balances from primitives:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3VpdGUgKkludGVncmF0aW9uVGVzdFN1aXRlKSBSZXF1aXJlQmFua0JhbGFuY2UoZXhwZWN0ZWQgaW50LCBhdEFkZHJlc3Mgc3RyaW5nKSB7CiAgICBzZGtBZGQsIGVyciA6PSBzZGsuQWNjQWRkcmVzc0Zyb21CZWNoMzIoYXRBZGRyZXNzKQogICAgc3VpdGUuUmVxdWlyZSgpLk5pbChlcnIsICZxdW90O0ZhaWxlZCB0byBwYXJzZSBhZGRyZXNzOiAlcyZxdW90OywgYXRBZGRyZXNzKQogICAgc3VpdGUuUmVxdWlyZSgpLkVxdWFsKAogICAgICAgIGludDY0KGV4cGVjdGVkKSwKICAgICAgICBzdWl0ZS5hcHAuQmFua0tlZXBlci5HZXRCYWxhbmNlKHN1aXRlLmN0eCwgc2RrQWRkLCBzZGsuRGVmYXVsdEJvbmREZW5vbSkuQW1vdW50LkludDY0KCkpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/keeper_integration_suite_test.go#L100-L106"}})],1)]),e._v(" "),a("p",[e._v("With the preparation done, what does an integration test method look like?")]),e._v(" "),a("h3",{attrs:{id:"anatomy-of-an-integration-suite-test"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#anatomy-of-an-integration-suite-test"}},[e._v("#")]),e._v(" Anatomy of an integration suite test")]),e._v(" "),a("p",[e._v("Now you must add integration tests for your keeper in new files. What does an integration test look like? Take the example of a "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/x/checkers/keeper/msg_server_create_game_test.go#L35-L66",target:"_blank",rel:"noopener noreferrer"}},[e._v("simple unit test"),a("OutboundLink")],1),e._v(" ported to the integration test suite:")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("The method has a declaration:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3VpdGUgKkludGVncmF0aW9uVGVzdFN1aXRlKSBUZXN0Q3JlYXRlMUdhbWVIYXNTYXZlZCgpCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_create_game_test.go#L8"}}),e._v(" "),a("p",[e._v("It is declared as a member of your test suite, and is prefixed with "),a("a",{attrs:{href:"https://github.com/stretchr/testify/blob/v1.7.0/suite/suite.go#L181-L182",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("Test")]),a("OutboundLink")],1),e._v(".")])],1),e._v(" "),a("li",[a("p",[e._v("The "),a("strong",[e._v("setup")]),e._v(" can be done as you like, but just like for unit tests you ought to create a helper and use it. Here one exists already:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"c3VpdGUuc2V0dXBTdWl0ZVdpdGhCYWxhbmNlcygpCmdvQ3R4IDo9IHNkay5XcmFwU0RLQ29udGV4dChzdWl0ZS5jdHgpCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_create_game_test.go#L9-L10"}})],1),e._v(" "),a("li",[a("p",[e._v("The "),a("strong",[e._v("action")]),e._v(" is no different from a unit test's action, other than that you get the "),a("code",[e._v("keeper")]),e._v(" or "),a("code",[e._v("msgServer")]),e._v(" from the suite's fields:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"c3VpdGUubXNnU2VydmVyLkNyZWF0ZUdhbWUoZ29DdHgsICZhbXA7dHlwZXMuTXNnQ3JlYXRlR2FtZXsKICAgIENyZWF0b3I6IGFsaWNlLAogICAgUmVkOiAgICAgYm9iLAogICAgQmxhY2s6ICAgY2Fyb2wsCiAgICBXYWdlcjogICA0NSwKfSkKa2VlcGVyIDo9IHN1aXRlLmFwcC5DaGVja2Vyc0tlZXBlcgo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_create_game_test.go#L11-L17"}})],1),e._v(" "),a("li",[a("p",[e._v("The "),a("strong",[e._v("verification")]),e._v(" is done with "),a("code",[e._v("suite.Require().X")]),e._v(", but otherwise looks similar to the shorter "),a("code",[e._v("require.X")]),e._v(" of unit tests:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"c3lzdGVtSW5mbywgZm91bmQgOj0ga2VlcGVyLkdldFN5c3RlbUluZm8oc3VpdGUuY3R4KQpzdWl0ZS5SZXF1aXJlKCkuVHJ1ZShmb3VuZCkKc3VpdGUuUmVxdWlyZSgpLkVxdWFsVmFsdWVzKHR5cGVzLlN5c3RlbUluZm97CiAgICBOZXh0SWQ6ICAgICAgICAyLAogICAgRmlmb0hlYWRJbmRleDogJnF1b3Q7MSZxdW90OywKICAgIEZpZm9UYWlsSW5kZXg6ICZxdW90OzEmcXVvdDssCn0sIHN5c3RlbUluZm8pCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_create_game_test.go#L18-L24"}}),e._v(" "),a("p",[e._v("In fact, it is exactly the "),a("a",{attrs:{href:"https://github.com/stretchr/testify/blob/v1.7.0/suite/suite.go#L24",target:"_blank",rel:"noopener noreferrer"}},[e._v("same "),a("code",[e._v("require")]),a("OutboundLink")],1),e._v(" object.")])],1)]),e._v(" "),a("p",[e._v("You have added an integration test that copies an existing unit test. It demonstrates the concept but is of limited additional utility.")]),e._v(" "),a("h3",{attrs:{id:"extra-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#extra-tests"}},[e._v("#")]),e._v(" Extra tests")]),e._v(" "),a("p",[e._v("It is time to add extra tests that check money handling by the bank. Before jumping in, as you did in "),a("em",[e._v("play")]),e._v(" unit tests you can add a method that prepares your suite's keeper with a game ready to be played on:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoc3VpdGUgKkludGVncmF0aW9uVGVzdFN1aXRlKSBzZXR1cFN1aXRlV2l0aE9uZUdhbWVGb3JQbGF5TW92ZSgpIHsKICAgIHN1aXRlLnNldHVwU3VpdGVXaXRoQmFsYW5jZXMoKQogICAgZ29DdHggOj0gc2RrLldyYXBTREtDb250ZXh0KHN1aXRlLmN0eCkKICAgIHN1aXRlLm1zZ1NlcnZlci5DcmVhdGVHYW1lKGdvQ3R4LCAmYW1wO3R5cGVzLk1zZ0NyZWF0ZUdhbWV7CiAgICAgICAgQ3JlYXRvcjogYWxpY2UsCiAgICAgICAgUmVkOiAgICAgYm9iLAogICAgICAgIEJsYWNrOiAgIGNhcm9sLAogICAgICAgIFdhZ2VyOiAgIDQ1LAogICAgfSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L9-L18"}}),e._v(" "),a("p",[e._v("You will call this function from the relevant tests.")]),e._v(" "),a("p",[e._v("For the tests proper, before an action that you expect to transfer money (or not) you can verify the initial position:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"c3VpdGUuUmVxdWlyZUJhbmtCYWxhbmNlKGJhbEFsaWNlLCBhbGljZSkKc3VpdGUuUmVxdWlyZUJhbmtCYWxhbmNlKGJhbEJvYiwgYm9iKQpzdWl0ZS5SZXF1aXJlQmFua0JhbGFuY2UoYmFsQ2Fyb2wsIGNhcm9sKQpzdWl0ZS5SZXF1aXJlQmFua0JhbGFuY2UoMCwgY2hlY2tlcnNNb2R1bGVBZGRyZXNzKQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L59-L62"}}),e._v(" "),a("p",[e._v("After the action you can test the new balances, for instance:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"c3VpdGUuUmVxdWlyZUJhbmtCYWxhbmNlKGJhbEFsaWNlLCBhbGljZSkKc3VpdGUuUmVxdWlyZUJhbmtCYWxhbmNlKGJhbEJvYi00NSwgYm9iKQpzdWl0ZS5SZXF1aXJlQmFua0JhbGFuY2UoYmFsQ2Fyb2wsIGNhcm9sKQpzdWl0ZS5SZXF1aXJlQmFua0JhbGFuY2UoNDUsIGNoZWNrZXJzTW9kdWxlQWRkcmVzcykK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L71-L74"}}),e._v(" "),a("p",[e._v("How you subdivide your tests and where you insert these balance checks is up to you. You can find examples here for:")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_create_game_test.go#L42-L59",target:"_blank",rel:"noopener noreferrer"}},[e._v("Creating a game"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L56-L75",target:"_blank",rel:"noopener noreferrer"}},[e._v("Playing the first move"),a("OutboundLink")],1),e._v(", "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L209-L236",target:"_blank",rel:"noopener noreferrer"}},[e._v("the second move"),a("OutboundLink")],1),e._v(", including "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L308-L315",target:"_blank",rel:"noopener noreferrer"}},[e._v("up to a resolution"),a("OutboundLink")],1),e._v(". You can also "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L129-L164",target:"_blank",rel:"noopener noreferrer"}},[e._v("check the events"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[e._v("Failing to play a game because of a failure to pay the wager on the "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L104-L127",target:"_blank",rel:"noopener noreferrer"}},[e._v("first move"),a("OutboundLink")],1),e._v(" and the "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/msg_server_play_move_test.go#L238-L269",target:"_blank",rel:"noopener noreferrer"}},[e._v("second move"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/end_block_server_game_test.go#L10-L30",target:"_blank",rel:"noopener noreferrer"}},[e._v("Forfeiting a game"),a("OutboundLink")],1),e._v(", including when "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/end_block_server_game_test.go#L32-L60",target:"_blank",rel:"noopener noreferrer"}},[e._v("there has been one move played"),a("OutboundLink")],1),e._v(" or "),a("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/end_block_server_game_test.go#L185-L222",target:"_blank",rel:"noopener noreferrer"}},[e._v("two"),a("OutboundLink")],1),e._v(".")])]),e._v(" "),a("h3",{attrs:{id:"what-happened-to-the-events"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-happened-to-the-events"}},[e._v("#")]),e._v(" What happened to the events?")]),e._v(" "),a("p",[e._v("With the new tests, you may think that the events are compromised. For instance, the event type "),a("code",[e._v('"transfer"')]),e._v(" normally comes with three attributes, but when the bank has made two transfers the "),a("code",[e._v('"transfer"')]),e._v(" event ends up with 6 attributes. This is just the way events are organized: per type, with the attributes piled in.")]),e._v(" "),a("p",[e._v("When checking emitted events, you need to skip over the attributes you are not checking. You can easily achieve that with "),a("RouterLink",{attrs:{to:"/tutorials/4-golang-intro/5-arrays.html"}},[e._v("Go slices")]),e._v(".")],1),e._v(" "),a("p",[e._v("For instance, here "),a("code",[e._v("transferEvent.Attributes[6:]")]),e._v(" discards the first six attributes:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHJhbnNmZXJFdmVudCA6PSBldmVudHNbNl0Kc3VpdGUuUmVxdWlyZSgpLkVxdWFsKHRyYW5zZmVyRXZlbnQuVHlwZSwgJnF1b3Q7dHJhbnNmZXImcXVvdDspCnN1aXRlLlJlcXVpcmUoKS5FcXVhbFZhbHVlcyhbXXNkay5BdHRyaWJ1dGV7CiAgICB7S2V5OiAmcXVvdDtyZWNpcGllbnQmcXVvdDssIFZhbHVlOiBjYXJvbH0sCiAgICB7S2V5OiAmcXVvdDtzZW5kZXImcXVvdDssIFZhbHVlOiBjaGVja2Vyc01vZHVsZUFkZHJlc3N9LAogICAge0tleTogJnF1b3Q7YW1vdW50JnF1b3Q7LCBWYWx1ZTogJnF1b3Q7OTBzdGFrZSZxdW90O30sCn0sIHRyYW5zZmVyRXZlbnQuQXR0cmlidXRlc1s2Ol0pCg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/integration-tests/tests/integration/checkers/keeper/end_block_server_game_test.go#L264-L270"}}),e._v(" "),a("h3",{attrs:{id:"debug-your-suite"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#debug-your-suite"}},[e._v("#")]),e._v(" Debug your suite")]),e._v(" "),a("p",[e._v("You learned in a "),a("RouterLink",{attrs:{to:"/hands-on-exercise/1-ignite-cli/3-stored-game.html"}},[e._v("previous section")]),e._v(" how to launch a test in debug mode. It is still possible to do so when using a suite. Depending on the versions of your Go installation and your Visual Studio Code, you can launch it in two ways:")],1),e._v(" "),a("ol",[a("li",[a("p",[e._v("Right-click on the arrow to the left of the suite's runner "),a("code",[e._v("func TestCheckersKeeperTestSuite")]),e._v(":")]),e._v(" "),a("p",[a("tm-image",{attrs:{src:"/hands-on-exercise/2-ignite-cli-adv/images/go_test_debug_suite.png"}})],1),e._v(" "),a("HighlightBox",{attrs:{type:"note"}},[a("p",[e._v("In this case, you can only launch debug for "),a("strong",[e._v("all")]),e._v(" of the suite's test methods and not just a single one (as is possible with a simple test).")])])],1),e._v(" "),a("li",[a("p",[e._v("Right-click on the arrow to the left of the separate test of the suite:")]),e._v(" "),a("p",[a("tm-image",{attrs:{src:"/hands-on-exercise/2-ignite-cli-adv/images/go_test_debug_suite_test.png"}})],1),e._v(" "),a("HighlightBox",{attrs:{type:"note"}},[a("p",[e._v("This option may not be available. If being able to debug only a few tests at a time is important to you, a solution is to create more granular suites, for example using one or more test suites per file and falling back on the first option.")])])],1)]),e._v(" "),a("h2",{attrs:{id:"interact-via-the-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#interact-via-the-cli"}},[e._v("#")]),e._v(" Interact via the CLI")]),e._v(" "),a("p",[e._v("With the tests done, see what happens at the command-line.")]),e._v(" "),a("p",[e._v("Keep the game expiry at 5 minutes to be able to test a forfeit, as done in a "),a("RouterLink",{attrs:{to:"/hands-on-exercise/2-ignite-cli-adv/4-game-forfeit.html"}},[e._v("previous section")]),e._v(". Now, you need to check balances after relevant steps to test that wagers are being withheld and paid.")],1),e._v(" "),a("p",[e._v("How much do Alice and Bob have to start with?")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgcXVlcnkgYmFuayBiYWxhbmNlcyAkYWxpY2UKJCBjaGVja2Vyc2QgcXVlcnkgYmFuayBiYWxhbmNlcyAkYm9iCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHF1ZXJ5IGJhbmsgYmFsYW5jZXMgJGFsaWNlCiQgZG9ja2VyIGV4ZWMgLWl0IGNoZWNrZXJzIFwKICAgIGNoZWNrZXJzZCBxdWVyeSBiYW5rIGJhbGFuY2VzICRib2IK"}})],1)],1),e._v(" "),a("p",[e._v("This prints:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"YmFsYW5jZXM6Ci0gYW1vdW50OiAmcXVvdDsxMDAwMDAwMDAmcXVvdDsKICBkZW5vbTogc3Rha2UKLSBhbW91bnQ6ICZxdW90OzIwMDAwJnF1b3Q7CiAgZGVub206IHRva2VuCiAgcGFnaW5hdGlvbjoKICBuZXh0X2tleTogbnVsbAogIHRvdGFsOiAmcXVvdDswJnF1b3Q7CmJhbGFuY2VzOgotIGFtb3VudDogJnF1b3Q7MTAwMDAwMDAwJnF1b3Q7CiAgZGVub206IHN0YWtlCi0gYW1vdW50OiAmcXVvdDsxMDAwMCZxdW90OwogIGRlbm9tOiB0b2tlbgogIHBhZ2luYXRpb246CiAgbmV4dF9rZXk6IG51bGwKICB0b3RhbDogJnF1b3Q7MCZxdW90Owo="}}),e._v(" "),a("h3",{attrs:{id:"a-game-that-expires"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#a-game-that-expires"}},[e._v("#")]),e._v(" A game that expires")]),e._v(" "),a("p",[e._v("Create a game on which the wager will be refunded because the player playing "),a("code",[e._v("red")]),e._v(" did not join:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgY3JlYXRlLWdhbWUgJGFsaWNlICRib2IgMTAwMDAwMCAtLWZyb20gJGFsaWNlCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHR4IGNoZWNrZXJzIGNyZWF0ZS1nYW1lICRhbGljZSAkYm9iIDEwMDAwMDAgLS1mcm9tICRhbGljZQo="}})],1)],1),e._v(" "),a("p",[e._v("Confirm that the balances of both Alice and Bob are unchanged - as they have not played yet.")]),e._v(" "),a("HighlightBox",{attrs:{type:"note"}},[a("p",[e._v("In this example, Alice paid no gas fees, other than the transaction costs, to create a game. The gas price is likely "),a("code",[e._v("0")]),e._v(" here anyway. This is fixed in the "),a("RouterLink",{attrs:{to:"/hands-on-exercise/2-ignite-cli-adv/6-gas-meter.html"}},[e._v("next section")]),e._v(".")],1)]),e._v(" "),a("p",[e._v("Have Alice play:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgcGxheS1tb3ZlIDEgMSAyIDIgMyAtLWZyb20gJGFsaWNlCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHR4IGNoZWNrZXJzIHBsYXktbW92ZSAxIDEgMiAyIDMgLS1mcm9tICRhbGljZQo="}})],1)],1),e._v(" "),a("p",[e._v("Confirm that Alice has paid her wager:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgcXVlcnkgYmFuayBiYWxhbmNlcyAkYWxpY2UK"}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHF1ZXJ5IGJhbmsgYmFsYW5jZXMgJGFsaWNlCg=="}})],1)],1),e._v(" "),a("p",[e._v("This prints:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"YmFsYW5jZXM6Ci0gYW1vdW50OiAmcXVvdDs5OTAwMDAwMCZxdW90OyAjICZsdDstIDEsMDAwLDAwMCBmZXdlcgogIGRlbm9tOiBzdGFrZQotIGFtb3VudDogJnF1b3Q7MjAwMDAmcXVvdDsKICBkZW5vbTogdG9rZW4KcGFnaW5hdGlvbjoKICBuZXh0X2tleTogbnVsbAogIHRvdGFsOiAmcXVvdDswJnF1b3Q7Cg=="}}),e._v(" "),a("p",[e._v("Wait 5 minutes for the game to expire and check again:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgcXVlcnkgYmFuayBiYWxhbmNlcyAkYWxpY2UK"}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHF1ZXJ5IGJhbmsgYmFsYW5jZXMgJGFsaWNlCg=="}})],1)],1),e._v(" "),a("p",[e._v("This prints:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"YmFsYW5jZXM6Ci0gYW1vdW50OiAmcXVvdDsxMDAwMDAwMDAmcXVvdDsgIyAmbHQ7LSAxLDAwMCwwMDAgYXJlIGJhY2sKICBkZW5vbTogc3Rha2UKLSBhbW91bnQ6ICZxdW90OzIwMDAwJnF1b3Q7CiAgZGVub206IHRva2VuCnBhZ2luYXRpb246CiAgbmV4dF9rZXk6IG51bGwKICB0b3RhbDogJnF1b3Q7MCZxdW90Owo="}}),e._v(" "),a("h3",{attrs:{id:"a-game-played-twice"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#a-game-played-twice"}},[e._v("#")]),e._v(" A game played twice")]),e._v(" "),a("p",[e._v("Now create a game in which both players only play once each, i.e. where the player playing "),a("code",[e._v("black")]),e._v(" forfeits:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgY3JlYXRlLWdhbWUgJGFsaWNlICRib2IgMTAwMDAwMCAtLWZyb20gJGFsaWNlCiQgY2hlY2tlcnNkIHR4IGNoZWNrZXJzIHBsYXktbW92ZSAyIDEgMiAyIDMgLS1mcm9tICRhbGljZQokIGNoZWNrZXJzZCB0eCBjaGVja2VycyBwbGF5LW1vdmUgMiAwIDUgMSA0IC0tZnJvbSAkYm9iCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHR4IGNoZWNrZXJzIGNyZWF0ZS1nYW1lICRhbGljZSAkYm9iIDEwMDAwMDAgLS1mcm9tICRhbGljZQokIGRvY2tlciBleGVjIC1pdCBjaGVja2VycyBcCiAgICBjaGVja2Vyc2QgdHggY2hlY2tlcnMgcGxheS1tb3ZlIDIgMSAyIDIgMyAtLWZyb20gJGFsaWNlCiQgZG9ja2VyIGV4ZWMgLWl0IGNoZWNrZXJzIFwKICAgIGNoZWNrZXJzZCB0eCBjaGVja2VycyBwbGF5LW1vdmUgMiAwIDUgMSA0IC0tZnJvbSAkYm9iCg=="}})],1)],1),e._v(" "),a("p",[e._v("Confirm that both Alice and Bob paid their wagers. Wait 5 minutes for the game to expire and check again:")]),e._v(" "),a("CodeGroup",[a("CodeGroupItem",{attrs:{title:"Local",active:""}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgcXVlcnkgYmFuayBiYWxhbmNlcyAkYWxpY2UKJCBjaGVja2Vyc2QgcXVlcnkgYmFuayBiYWxhbmNlcyAkYm9iCg=="}})],1),e._v(" "),a("CodeGroupItem",{attrs:{title:"Docker"}},[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBkb2NrZXIgZXhlYyAtaXQgY2hlY2tlcnMgXAogICAgY2hlY2tlcnNkIHF1ZXJ5IGJhbmsgYmFsYW5jZXMgJGFsaWNlCiQgZG9ja2VyIGV4ZWMgLWl0IGNoZWNrZXJzIFwKICAgIGNoZWNrZXJzZCBxdWVyeSBiYW5rIGJhbGFuY2VzICRib2IK"}})],1)],1),e._v(" "),a("p",[e._v("This shows:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"txt",base64:"YmFsYW5jZXM6Ci0gYW1vdW50OiAmcXVvdDs5OTAwMDAwMCZxdW90OyAjICZsdDstIGhlciAxLDAwMCwwMDAgYXJlIGdvbmUgZm9yIGdvb2QKICBkZW5vbTogc3Rha2UKLi4uCmJhbGFuY2VzOgotIGFtb3VudDogJnF1b3Q7MTAxMDAwMDAwJnF1b3Q7ICMgJmx0Oy0gMSwwMDAsMDAwIG1vcmUgdGhhbiBhdCB0aGUgYmVnaW5uaW5nCiAgZGVub206IHN0YWtlCi4uLgo="}}),e._v(" "),a("p",[e._v("This is correct: Bob was the winner by forfeit.")]),e._v(" "),a("p",[e._v("Similarly, you can test that Alice gets her wager back when Alice creates a game, Alice plays, and then Bob rejects it.")]),e._v(" "),a("p",[e._v("It would be difficult to test by CLI when there is a winner after a full game. That would be better tested with a GUI, or by using integration tests as you did above.")]),e._v(" "),a("HighlightBox",{attrs:{type:"synopsis"}},[a("p",[e._v("To summarize, this section has explored:")]),e._v(" "),a("ul",[a("li",[e._v("How to work with the Bank module and handle players making wagers on games, now that the application supports live games playing to completion (with the winner claiming both wagers) or expiring through inactivity (with the inactive player forfeiting their wager as if losing), and no possibility of withheld value being stranded in inactive games.")]),e._v(" "),a("li",[e._v("How to add handling actions that ask the "),a("code",[e._v("bank")]),e._v(" module to perform the token transfers required by the wager, and where to invoke them in the message handlers.")]),e._v(" "),a("li",[e._v("How to create a new wager-handling file with functions to collect a wager, refund a wager, and pay winnings, in which "),a("code",[e._v("must")]),e._v(" prefixes indicate either a user-side error (leading to a failed transaction) or a failure of the application's escrow account (requiring the whole application be terminated).")]),e._v(" "),a("li",[e._v("How to run integration tests, which requires you to first build a proper bank keeper, create new helpers, refactor your existing keeper tests, account for the new events being emitted from the bank, and add extra checks of money handling.")]),e._v(" "),a("li",[e._v("How to interact with the CLI to check account balances to test that wagers are being withheld and paid.")])])])],1)}),[],!1,null,null,null);t.default=s.exports}}]);