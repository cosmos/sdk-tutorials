(window.webpackJsonp=window.webpackJsonp||[]).push([[151],{769:function(e,t,c){"use strict";c.r(t);var o=c(1),a=Object(o.a)({},(function(){var e=this,t=e.$createElement,c=e._self._c||t;return c("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[c("h1",{attrs:{id:"cosmjs-on-a-backend-script-for-game-indexing"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#cosmjs-on-a-backend-script-for-game-indexing"}},[e._v("#")]),e._v(" CosmJS on a Backend Script for Game Indexing")]),e._v(" "),c("p",[e._v("Now that your blockchain is complete, you can think about additional data and services that would add value without increasing cost or complexity on-chain.")]),e._v(" "),c("p",[e._v("For example, how do you list all of a player's games? Currently this information is not easily available. You can find the players of a given game, but not the games of a given player. Indexing this on-chain would add storage and computation costs.")]),e._v(" "),c("h2",{attrs:{id:"server-idea"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#server-idea"}},[e._v("#")]),e._v(" Server idea")]),e._v(" "),c("p",[e._v("To implement this functionality, build a Web 2.0 server to do the indexing. The server:")]),e._v(" "),c("ol",[c("li",[e._v("Listens to updates from the Checkers chain:\n"),c("ol",[c("li",[e._v("On a game creation event, adds the game ID under each player.")]),e._v(" "),c("li",[e._v("On a game deletion event, removes it. This happens either because of a rejection or in an end-block.")])])]),e._v(" "),c("li",[e._v("When asked about its status, returns the latest block height up to which it has indexed players.")]),e._v(" "),c("li",[e._v("When asked about a given player, returns the list of game IDs for this player.")]),e._v(" "),c("li",[e._v("When a game ID is submitted, patches its information about that game ID (to palliate potential de-synchronization).")])]),e._v(" "),c("h2",{attrs:{id:"barebones-server"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#barebones-server"}},[e._v("#")]),e._v(" Barebones server")]),e._v(" "),c("p",[e._v("As a fast and simple Web 2.0 solution, navigate to the "),c("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui",target:"_blank",rel:"noopener noreferrer"}},[e._v("CosmJS repository"),c("OutboundLink")],1),e._v(" for the checkers blockchain and perform the following steps:")]),e._v(" "),c("ol",[c("li",[e._v("Create a sub-directory of the "),c("code",[e._v("src")]),e._v(" folder (e.g. "),c("code",[e._v("server")]),e._v(").")]),e._v(" "),c("li",[e._v("Use the "),c("code",[e._v("express")]),e._v(" Node.js module to create an HTTP REST API.")]),e._v(" "),c("li",[e._v("Use a local "),c("code",[e._v("db.json")]),e._v(" as a "),c("em",[e._v("database")]),e._v(". This is obviously primitive and not thread-safe. In a production setting use a proper database.")]),e._v(" "),c("li",[e._v("Poll the blockchain at regular intervals. As part of an advanced topic, you can use WebSockets.")])]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjZCBzcmMvc2VydmVyCiQgbnBtIGluc3RhbGwgZXhwcmVzc0A0LjE3LjMgLS1zYXZlLWV4YWN0CiQgbnBtIGluc3RhbGwgdHMtbm9kZUAxMC43LjAgQHR5cGVzL2V4cHJlc3NANC4xNy4xMyAtLXNhdmUtZGV2IC0tc2F2ZS1leGFjdAo="}}),e._v(" "),c("h3",{attrs:{id:"data-types"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#data-types"}},[e._v("#")]),e._v(" Data types")]),e._v(" "),c("p",[e._v("To keep the code type-safe, define the types of your "),c("code",[e._v("db.json")]),e._v(" in "),c("code",[e._v("types.ts")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"ZXhwb3J0IGludGVyZmFjZSBMYXRlc3RCbG9ja1N0YXR1cyB7CiAgICBoZWlnaHQ6IG51bWJlcgp9CgpleHBvcnQgaW50ZXJmYWNlIERiU3RhdHVzIHsKICAgIGJsb2NrOiBMYXRlc3RCbG9ja1N0YXR1cwp9CgpleHBvcnQgaW50ZXJmYWNlIFBsYXllckluZm8gewogICAgZ2FtZUlkczogc3RyaW5nW10KfQoKZXhwb3J0IGludGVyZmFjZSBQbGF5ZXJzSW5mbyB7CiAgICBbcGxheWVyQWRkcmVzczogc3RyaW5nXTogUGxheWVySW5mbwp9CgpleHBvcnQgaW50ZXJmYWNlIEdhbWVJbmZvIHsKICAgIHJlZEFkZHJlc3M6IHN0cmluZwogICAgYmxhY2tBZGRyZXNzOiBzdHJpbmcKfQoKZXhwb3J0IGludGVyZmFjZSBHYW1lc0luZm8gewogICAgW2dhbWVJZDogc3RyaW5nXTogR2FtZUluZm8KfQoKZXhwb3J0IGludGVyZmFjZSBEYlR5cGUgewogICAgc3RhdHVzOiBEYlN0YXR1cwogICAgcGxheWVyczogUGxheWVyc0luZm8KICAgIGdhbWVzOiBHYW1lc0luZm8KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/2e400d1/src/server/types.ts#L1-L30"}}),e._v(" "),c("p",[e._v("Not only does this keep information about players, it also keeps a copy of games. This gets around a current limitation of CosmJS, where you cannot get information about a game that has just been erased from the latest state. In practice you would need to query the game at an earlier block height, but this functionality is not available. Note that nodes may prune the old state, especially if they migrate, which may unpredictably impact any query at an earlier block height.")]),e._v(" "),c("HighlightBox",{attrs:{type:"info"}},[c("p",[e._v('In blockchain, when "deleted" records are materially important, use a soft delete that removes them from the set of active records but doesn\'t terminate their existence. This principle helps ensure that historically important information is available at the latest block height.')])]),e._v(" "),c("h3",{attrs:{id:"empty-indexer-module"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#empty-indexer-module"}},[e._v("#")]),e._v(" Empty indexer module")]),e._v(" "),c("p",[e._v("A barebones server without any Cosmos elements is defined in an "),c("code",[e._v("indexer.ts")]),e._v(". This is not CosmJS related, so start from something else if you prefer.")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgd3JpdGVGaWxlIH0gZnJvbSAmcXVvdDtmcy9wcm9taXNlcyZxdW90OwppbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICZxdW90O2h0dHAmcXVvdDsKaW1wb3J0IGV4cHJlc3MsIHsgRXhwcmVzcywgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICZxdW90O2V4cHJlc3MmcXVvdDsKaW1wb3J0IHsgRGJUeXBlIH0gZnJvbSAmcXVvdDsuL3R5cGVzJnF1b3Q7CgpleHBvcnQgY29uc3QgY3JlYXRlSW5kZXhlciA9IGFzeW5jICgpID0mZ3Q7IHsKICAgIGNvbnN0IHBvcnQgPSAmcXVvdDszMDAxJnF1b3Q7CiAgICBjb25zdCBkYkZpbGUgPSBgJHtfX2Rpcm5hbWV9L2RiLmpzb25gCiAgICBjb25zdCBkYjogRGJUeXBlID0gcmVxdWlyZShkYkZpbGUpCiAgICBjb25zdCBwb2xsSW50ZXJ2YWxNcyA9IDVfMDAwIC8vIDUgc2Vjb25kcwogICAgbGV0IHRpbWVyOiBOb2RlSlMuVGltZXIgfCB1bmRlZmluZWQKCiAgICBjb25zdCBhcHA6IEV4cHJlc3MgPSBleHByZXNzKCkKICAgIGFwcC5nZXQoJnF1b3Q7LyZxdW90OywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPSZndDsgewogICAgICAgIHJlcy5zZW5kKHsKICAgICAgICAgICAgZXJyb3I6ICZxdW90O05vdCBpbXBsZW1lbnRlZCZxdW90OywKICAgICAgICB9KQogICAgfSkKCiAgICBhcHAuZ2V0KCZxdW90Oy9zdGF0dXMmcXVvdDssIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0mZ3Q7IHsKICAgICAgICByZXMuanNvbih7CiAgICAgICAgICAgIGJsb2NrOiB7CiAgICAgICAgICAgICAgICBoZWlnaHQ6IGRiLnN0YXR1cy5ibG9jay5oZWlnaHQsCiAgICAgICAgICAgIH0sCiAgICAgICAgfSkKICAgIH0pCgogICAgYXBwLmdldCgmcXVvdDsvcGxheWVycy86cGxheWVyQWRkcmVzcyZxdW90OywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPSZndDsgewogICAgICAgIHJlcy5qc29uKHsKICAgICAgICAgICAgZ2FtZUNvdW50OgogICAgICAgICAgICAgICAgZGIucGxheWVyc1tyZXEucGFyYW1zLnBsYXllckFkZHJlc3NdPy5nYW1lSWRzPy5sZW5ndGggPz8gMCwKICAgICAgICAgICAgICAgIGdhbWVJZHM6IGRiLnBsYXllcnNbcmVxLnBhcmFtcy5wbGF5ZXJBZGRyZXNzXT8uZ2FtZUlkcyA/PyBbXSwKICAgICAgICB9KQogICAgfSkKCiAgICBhcHAuZ2V0KAogICAgICAgICZxdW90Oy9wbGF5ZXJzLzpwbGF5ZXJBZGRyZXNzL2dhbWVJZHMmcXVvdDssIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0mZ3Q7IHsKICAgICAgICAgICAgcmVzLmpzb24oZGIucGxheWVyc1tyZXEucGFyYW1zLnBsYXllckFkZHJlc3NdPy5nYW1lSWRzID8/IFtdKQogICAgICAgIH0KICAgICkKCiAgICBhcHAucGF0Y2goJnF1b3Q7L2dhbWVzLzpnYW1lSWQmcXVvdDssIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0mZ3Q7IHsKICAgICAgICByZXMuanNvbih7CiAgICAgICAgICAgIHJlc3VsdDogJnF1b3Q7Tm90IGltcGxlbWVudGVkJnF1b3Q7LAogICAgICAgIH0pCiAgICB9KQoKICAgIGNvbnN0IHNhdmVEYiA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBhd2FpdCB3cml0ZUZpbGUoZGJGaWxlLCBKU09OLnN0cmluZ2lmeShkYiwgbnVsbCwgNCkpCiAgICB9CgogICAgY29uc3QgaW5pdCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBzZXRUaW1lb3V0KHBvbGwsIDEpCiAgICB9CgogICAgY29uc3QgcG9sbCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBjb25zb2xlLmxvZyhuZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpLCAmcXVvdDtUT0RPIHBvbGwmcXVvdDspCiAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIHBvbGxJbnRlcnZhbE1zKQogICAgfQoKICAgIHByb2Nlc3Mub24oJnF1b3Q7U0lHSU5UJnF1b3Q7LCAoKSA9Jmd0OyB7CiAgICAgICAgaWYgKHRpbWVyKSBjbGVhclRpbWVvdXQodGltZXIpCiAgICAgICAgc2F2ZURiKCkKICAgICAgICAgICAgLnRoZW4oKCkgPSZndDsgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7ZGJGaWxlfSBzYXZlZGApCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaChjb25zb2xlLmVycm9yKQogICAgICAgICAgICAuZmluYWxseSgoKSA9Jmd0OyB7CiAgICAgICAgICAgICAgICBzZXJ2ZXIuY2xvc2UoKCkgPSZndDsgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCZxdW90O3NlcnZlciBjbG9zZWQmcXVvdDspCiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KQogICAgfSkKCiAgICBjb25zdCBzZXJ2ZXI6IFNlcnZlciA9IGFwcC5saXN0ZW4ocG9ydCwgKCkgPSZndDsgewogICAgICAgIGluaXQoKQogICAgICAgICAgICAuY2F0Y2goY29uc29sZS5lcnJvcikKICAgICAgICAgICAgLnRoZW4oKCkgPSZndDsgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFxuc2VydmVyIHN0YXJ0ZWQgYXQgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9YCkKICAgICAgICAgICAgfSkKICAgIH0pCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/20e6149/src/server/indexer.ts"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("p",[e._v("Note:")]),e._v(" "),c("ol",[c("li",[e._v("The timer is set at the end of the previous poll, in case indexing takes longer than the interval.")]),e._v(" "),c("li",[e._v("The "),c("em",[e._v("database")]),e._v(" is purely in memory as it runs and is saved on exit by catching the interruption signal.")])])]),e._v(" "),c("h3",{attrs:{id:"files-for-execution"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#files-for-execution"}},[e._v("#")]),e._v(" Files for execution")]),e._v(" "),c("p",[e._v("Prepare these files around the "),c("code",[e._v("indexer")]),e._v(" to run it in the terminal:")]),e._v(" "),c("ol",[c("li",[c("p",[e._v("Create an "),c("code",[e._v("index.ts")]),e._v(" that describes how to run the "),c("code",[e._v("indexer")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"cmVxdWlyZSgmcXVvdDsuL2luZGV4ZXImcXVvdDspLmNyZWF0ZUluZGV4ZXIoKS50aGVuKGNvbnNvbGUubG9nKS5jYXRjaChjb25zb2xlLmVycm9yKQpleHBvcnQge30K",url:"https://github.com/cosmos/academy-checkers-ui/blob/31c05e1/src/server/index.ts"}}),e._v(" "),c("p",[e._v("The "),c("code",[e._v("export {}")]),e._v(" prevents Visual Studio Code from complaining.")])],1),e._v(" "),c("li",[c("p",[e._v("Add a specific "),c("code",[e._v("tsconfig.json")]),e._v(" file if necessary:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7ZXh0ZW5kcyZxdW90OzogJnF1b3Q7Li4vLi4vdHNjb25maWcuanNvbiZxdW90OywKICAgICZxdW90O2NvbXBpbGVyT3B0aW9ucyZxdW90OzogewogICAgICAgICZxdW90O3RhcmdldCZxdW90OzogJnF1b3Q7RVNOZXh0JnF1b3Q7LAogICAgICAgICZxdW90O2lzb2xhdGVkTW9kdWxlcyZxdW90OzogZmFsc2UsCiAgICAgICAgJnF1b3Q7bW9kdWxlJnF1b3Q7OiAmcXVvdDtDb21tb25KUyZxdW90OwogICAgfQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/6f6d9bd/src/server/tsconfig.json"}})],1),e._v(" "),c("li",[c("p",[e._v("In "),c("code",[e._v("package.json")]),e._v(", add a "),c("code",[e._v("run")]),e._v(" target:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"JnF1b3Q7c2NyaXB0cyZxdW90OzogewogICAgLi4uCiAgICAmcXVvdDtpbmRleGVyLWRldiZxdW90OzogJnF1b3Q7bnB4IHRzLW5vZGUgc3JjL3NlcnZlci9pbmRleC50cyZxdW90Owp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/31c05e1/package.json#L12"}})],1),e._v(" "),c("li",[c("p",[e._v("Add your "),c("em",[e._v("database")]),e._v(", "),c("code",[e._v("db.json")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAgICAgJnF1b3Q7YmxvY2smcXVvdDs6IHsKICAgICAgICAgICAgJnF1b3Q7aGVpZ2h0JnF1b3Q7OiAwCiAgICAgICAgfQogICAgfSwKICAgICZxdW90O3BsYXllcnMmcXVvdDs6IHt9LAogICAgJnF1b3Q7Z2FtZXMmcXVvdDs6IHt9Cn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/31c05e1/src/server/db.json.sample"}}),e._v(" "),c("p",[e._v("You cannot ask for block at height "),c("code",[e._v("0")]),e._v(", so the indexer first asks for the next block at "),c("code",[e._v("1")]),e._v(".")])],1)]),e._v(" "),c("h3",{attrs:{id:"quick-test"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#quick-test"}},[e._v("#")]),e._v(" Quick test")]),e._v(" "),c("p",[e._v("Check the "),c("code",[e._v("indexer")]),e._v(" works:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBucG0gcnVuIGluZGV4ZXItZGV2Cg=="}}),e._v(" "),c("p",[e._v("It should print:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"Jmd0OyBjaGVja2Vycy1zZXJ2ZXJAMS4wLjAgZGV2CiZndDsgbnB4IHRzLW5vZGUgaW5kZXgudHMKCnNlcnZlciBzdGFydGVkIGF0IGh0dHA6Ly9sb2NhbGhvc3Q6MzAwMQo="}}),e._v(" "),c("p",[e._v("Now test the endpoints. Omit the "),c("code",[e._v("| jq")]),e._v(" beautifier if it is not installed on your system:")]),e._v(" "),c("CodeGroup",[c("CodeGroupItem",{attrs:{title:"status",active:""}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIGxvY2FsaG9zdDozMDAxL3N0YXR1cyB8IGpxCg=="}}),e._v(" "),c("p",[e._v("It should return:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O2Jsb2NrJnF1b3Q7OiB7CiAgICAmcXVvdDtoZWlnaHQmcXVvdDs6IC0xCiAgfQp9Cg=="}})],1),e._v(" "),c("CodeGroupItem",{attrs:{title:"player info"}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIGxvY2FsaG9zdDozMDAxL3BsYXllcnMvY29zbW9zMTIzIHwganEK"}}),e._v(" "),c("p",[e._v("It should return:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O2dhbWVDb3VudCZxdW90OzogMCwKICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbXQp9Cg=="}})],1),e._v(" "),c("CodeGroupItem",{attrs:{title:"player games"}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIGxvY2FsaG9zdDozMDAxL3BsYXllcnMvY29zbW9zMTIzL2dhbWVJZHMgfCBqcQo="}}),e._v(" "),c("p",[e._v("It should return:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"W10K"}})],1),e._v(" "),c("CodeGroupItem",{attrs:{title:"game update"}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIC1YIFBBVENIIGxvY2FsaG9zdDozMDAxL2dhbWVzLzQ0NSB8IGpxCg=="}}),e._v(" "),c("p",[e._v("It should return:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O3Jlc3VsdCZxdW90OzogJnF1b3Q7Tm90IGltcGxlbWVudGVkJnF1b3Q7Cn0K"}})],1)],1),e._v(" "),c("hr"),e._v(" "),c("h2",{attrs:{id:"add-cosmjs-stargateclient"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#add-cosmjs-stargateclient"}},[e._v("#")]),e._v(" Add CosmJS "),c("code",[e._v("StargateClient")])]),e._v(" "),c("p",[e._v("You need to create a client to connect to your Checkers blockchain. The client only needs read-only functionality because this server does not submit transactions. Your repository already contains useful elements:")]),e._v(" "),c("ul",[c("li",[e._v("The "),c("code",[e._v("CheckersStargateClient")]),e._v(".")]),e._v(" "),c("li",[e._v("An "),c("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/blob/2e400d1/.env",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v(".env")]),c("OutboundLink")],1),e._v(" file.")])]),e._v(" "),c("p",[e._v("Add the following to "),c("code",[e._v("indexer.ts")]),e._v(":")]),e._v(" "),c("ol",[c("li",[c("p",[e._v("The declarations:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgY29uZmlnIH0gZnJvbSAmcXVvdDtkb3RlbnYmcXVvdDsKaW1wb3J0IHsgQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudCB9IGZyb20gJnF1b3Q7Li4vY2hlY2tlcnNfc3RhcmdhdGVjbGllbnQmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/6f6d9bd/src/server/indexer.ts#L1-L5"}}),e._v(" "),c("p",[e._v("The pickup of "),c("code",[e._v("RPC_URL")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uZmlnKCkK",url:"https://github.com/cosmos/academy-checkers-ui/blob/6f6d9bd/src/server/indexer.ts#L8"}}),e._v(" "),c("p",[e._v("The client in the indexer:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"bGV0IGNsaWVudDogQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudAo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/6f6d9bd/src/server/indexer.ts#L16"}})],1),e._v(" "),c("li",[c("p",[e._v("The modified "),c("code",[e._v("init")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaW5pdCA9IGFzeW5jKCkgPSZndDsgewogICAgY2xpZW50ID0gYXdhaXQgQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudC5jb25uZWN0KHByb2Nlc3MuZW52LlJQQ19VUkwhKQogICAgY29uc29sZS5sb2coJnF1b3Q7Q29ubmVjdGVkIHRvIGNoYWluLWlkOiZxdW90OywgYXdhaXQgY2xpZW50LmdldENoYWluSWQoKSkKICAgIHNldFRpbWVvdXQocG9sbCwgMSkKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/6f6d9bd/src/server/indexer.ts#L54-L58"}})],1),e._v(" "),c("li",[c("p",[e._v("The modified "),c("code",[e._v("poll")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgcG9sbCA9IGFzeW5jKCkgPSZndDsgewogICAgY29uc3QgY3VycmVudEhlaWdodCA9IGF3YWl0IGNsaWVudC5nZXRIZWlnaHQoKQogICAgY29uc29sZS5sb2coCiAgICAgICAgbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSwKICAgICAgICAmcXVvdDtDdXJyZW50IGhlaWdodHM6JnF1b3Q7LAogICAgICAgIGRiLnN0YXR1cy5ibG9jay5oZWlnaHQsCiAgICAgICAgJnF1b3Q7Jmx0Oz0mcXVvdDssCiAgICAgICAgY3VycmVudEhlaWdodCwKICAgICkKICAgIHRpbWVyID0gc2V0VGltZW91dChwb2xsLCBwb2xsSW50ZXJ2YWxNcykKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/6f6d9bd/src/server/indexer.ts#L60-L70"}})],1)]),e._v(" "),c("p",[e._v("The "),c("code",[e._v(".env")]),e._v(" file contains the "),c("code",[e._v("RPC_URL")]),e._v(", adjust it to your situation. If necessary, launch the Checkers blockchain:")]),e._v(" "),c("ul",[c("li",[c("p",[e._v("If you are running it locally with Ignite CLI:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgY2hhaW4gc2VydmUK"}})],1),e._v(" "),c("li",[c("p",[e._v("If not, follow the relevant instructions to run it, or access a testnet.")])])]),e._v(" "),c("p",[e._v("Relaunch "),c("code",[e._v("npm run indexer-dev")]),e._v(". You should see the current height rising:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"Q29ubmVjdGVkIHRvIGNoYWluLWlkOiBjaGVja2VycwoKc2VydmVyIHN0YXJ0ZWQgYXQgaHR0cDovL2xvY2FsaG9zdDozMDAxCjIwMjItMDQtMjBUMTc6NDY6MjkuOTYyWiBDdXJyZW50IGhlaWdodHM6IC0xICZsdDs9IDEzNTMKMjAyMi0wNC0yMFQxNzo0NjozNC45NjhaIEN1cnJlbnQgaGVpZ2h0czogLTEgJmx0Oz0gMTM1Nwo="}}),e._v(" "),c("h2",{attrs:{id:"handle-blocks"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-blocks"}},[e._v("#")]),e._v(" Handle blocks")]),e._v(" "),c("p",[e._v("To index games, take each block and listen for the following relevant events:")]),e._v(" "),c("ol",[c("li",[e._v("A transaction with a "),c("code",[e._v("NewGameCreated")]),e._v(" event.")]),e._v(" "),c("li",[e._v("A transaction with a "),c("code",[e._v("GameRejected")]),e._v(" event.")]),e._v(" "),c("li",[e._v("An "),c("code",[e._v("EndBlock")]),e._v(" with a "),c("code",[e._v("GameForfeited")]),e._v(" event.")])]),e._v(" "),c("p",[e._v("Start by getting each block from your last saved state. Update "),c("code",[e._v("poll")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgcG9sbCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgIGNvbnN0IGN1cnJlbnRIZWlnaHQgPSBhd2FpdCBjbGllbnQuZ2V0SGVpZ2h0KCkKICAgIGlmIChkYi5zdGF0dXMuYmxvY2suaGVpZ2h0ICZsdDs9IGN1cnJlbnRIZWlnaHQgLSAxMDApCiAgICAgICAgY29uc29sZS5sb2coYENhdGNoaW5nIHVwICR7ZGIuc3RhdHVzLmJsb2NrLmhlaWdodH0uLiR7Y3VycmVudEhlaWdodH1gKQogICAgd2hpbGUgKGRiLnN0YXR1cy5ibG9jay5oZWlnaHQgJmx0OyBjdXJyZW50SGVpZ2h0KSB7CiAgICAgICAgY29uc3QgcHJvY2Vzc2luZyA9IGRiLnN0YXR1cy5ibG9jay5oZWlnaHQgKyAxCiAgICAgICAgcHJvY2Vzcy5zdGRvdXQuY3Vyc29yVG8oMCkKICAgICAgICAvLyBHZXQgdGhlIGJsb2NrCiAgICAgICAgY29uc3QgYmxvY2s6IEJsb2NrID0gYXdhaXQgY2xpZW50LmdldEJsb2NrKHByb2Nlc3NpbmcpCiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYEhhbmRsaW5nIGJsb2NrOiAke3Byb2Nlc3Npbmd9IHdpdGggJHtibG9jay50eHMubGVuZ3RofSB0eHNgKQogICAgICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgICAgIGF3YWl0IGhhbmRsZUJsb2NrKGJsb2NrKQogICAgICAgIGRiLnN0YXR1cy5ibG9jay5oZWlnaHQgPSBwcm9jZXNzaW5nCiAgICB9CiAgICBhd2FpdCBzYXZlRGIoKQogICAgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIHBvbGxJbnRlcnZhbE1zKQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L64-L79"}}),e._v(" "),c("p",[e._v("This needs a new import:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgQmxvY2sgfSBmcm9tICZxdW90O0Bjb3NtanMvc3RhcmdhdGUmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L3"}}),e._v(" "),c("p",[e._v("The indexer:")]),e._v(" "),c("ul",[c("li",[e._v("Declares a new function "),c("code",[e._v("handleBlock")]),e._v(". Create one and put "),c("code",[e._v("console.log(block)")]),e._v(" inside to explore what this object is and consider what actions you would take with it.")]),e._v(" "),c("li",[e._v("Saves the "),c("code",[e._v("db")]),e._v(" after a poll, so "),c("em",[e._v("you")]),e._v(" can watch it in real time.")]),e._v(" "),c("li",[e._v("Uses "),c("code",[e._v("process.stdout.write")]),e._v(" and "),c("code",[e._v("process.stdout.cursorTo(0)")]),e._v(" so that the repetitive logging happens on a single line.")])]),e._v(" "),c("p",[e._v("Observe the relevant content in "),c("code",[e._v("handleBlock")]),e._v(". It must:")]),e._v(" "),c("ol",[c("li",[e._v("Extract the events from transactions.")]),e._v(" "),c("li",[e._v("Extract the events from "),c("code",[e._v("EndBlock")]),e._v(".")])]),e._v(" "),c("p",[e._v("If you examine "),c("code",[e._v("block.txs")]),e._v(" directly you find transactions as they were posted. However, this does not reveal any execution results, such as if a transaction executed as expected or what game ID it used for the new game. To get this extra information:")]),e._v(" "),c("ol",[c("li",[e._v("Calculate "),c("code",[e._v("txHash")]),e._v(" from the transaction.")]),e._v(" "),c("li",[e._v("Call "),c("code",[e._v("await client.getTx(txHash)")]),e._v(", which returns an "),c("code",[e._v("IndexedTx")]),e._v(".")])]),e._v(" "),c("p",[e._v("The "),c("code",[e._v("handleBlock")]),e._v(" function can be:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlQmxvY2sgPSBhc3luYyAoYmxvY2s6IEJsb2NrKSA9Jmd0OyB7CiAgICBpZiAoMCAmbHQ7IGJsb2NrLnR4cy5sZW5ndGgpIGNvbnNvbGUubG9nKCZxdW90OyZxdW90OykKICAgIGxldCB0eEluZGV4ID0gMAogICAgd2hpbGUgKHR4SW5kZXggJmx0OyBibG9jay50eHMubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgdHhIYXNoOiBzdHJpbmcgPSB0b0hleChzaGEyNTYoYmxvY2sudHhzW3R4SW5kZXhdKSkudG9VcHBlckNhc2UoKQogICAgICAgIGNvbnN0IGluZGV4ZWQ6IEluZGV4ZWRUeCB8IG51bGwgPSBhd2FpdCBjbGllbnQuZ2V0VHgodHhIYXNoKQogICAgICAgIGlmICghaW5kZXhlZCkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBpbmRleGVkIHR4OiAke3R4SGFzaH1gKQogICAgICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgICAgIGF3YWl0IGhhbmRsZVR4KGluZGV4ZWQpCiAgICAgICAgdHhJbmRleCsrCiAgICB9CiAgICAvLyBUT0RPIGhhbmRsZSBFbmRCbG9jawp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L81-L92"}}),e._v(" "),c("p",[e._v("This needs new imports:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgc2hhMjU2IH0gZnJvbSAmcXVvdDtAY29zbWpzL2NyeXB0byZxdW90OwppbXBvcnQgeyB0b0hleCB9IGZyb20gJnF1b3Q7QGNvc21qcy9lbmNvZGluZyZxdW90OwppbXBvcnQgeyBCbG9jaywgSW5kZXhlZFR4IH0gZnJvbSAmcXVvdDtAY29zbWpzL3N0YXJnYXRlJnF1b3Q7Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L1-L3"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("code",[e._v("while() {}")]),e._v(" simplifies the syntax of "),c("code",[e._v("await")]),e._v("ing multiple times.")]),e._v(" "),c("li",[e._v("The hash is calculated this way as per "),c("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/902f21b/packages%2Fstargate%2Fsrc%2Fstargateclient.ts#L74",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),c("OutboundLink")],1),e._v(".")]),e._v(" "),c("li",[c("code",[e._v('console.log("")')]),e._v(" puts a new line ("),c("code",[e._v("poll")]),e._v(" does a "),c("code",[e._v("process.stdout.write")]),e._v(" which adds no line).")]),e._v(" "),c("li",[e._v("The "),c("code",[e._v("handleBlock")]),e._v(" function uses a new function, "),c("code",[e._v("handleTx")]),e._v(". Create one and put "),c("code",[e._v("console.log(indexed)")]),e._v(" inside to explore what this object is and consider what actions you can take with it.")]),e._v(" "),c("li",[e._v("The "),c("code",[e._v("EndBlock")]),e._v(" part has not yet been incorporated. This is explained in "),c("strong",[e._v("Prepare for EndBlock")]),e._v(".")])])]),e._v(" "),c("h2",{attrs:{id:"handle-a-transaction"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-a-transaction"}},[e._v("#")]),e._v(" Handle a transaction")]),e._v(" "),c("p",[e._v("Define the "),c("code",[e._v("handleTx")]),e._v(" function:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlVHggPSBhc3luYyAoaW5kZXhlZDogSW5kZXhlZFR4KSA9Jmd0OyB7CiAgICBjb25zdCByYXdMb2c6IGFueSA9IEpTT04ucGFyc2UoaW5kZXhlZC5yYXdMb2cpCiAgICBjb25zdCBldmVudHM6IFN0cmluZ0V2ZW50W10gPSByYXdMb2cuZmxhdE1hcCgobG9nOiBBQkNJTWVzc2FnZUxvZykgPSZndDsgbG9nLmV2ZW50cykKICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgYXdhaXQgaGFuZGxlRXZlbnRzKGV2ZW50cykKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L94-L98"}}),e._v(" "),c("p",[e._v("This needs new imports:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgQUJDSU1lc3NhZ2VMb2csIFN0cmluZ0V2ZW50IH0gZnJvbSAmcXVvdDtjb3NtanMtdHlwZXMvY29zbW9zL2Jhc2UvYWJjaS92MWJldGExL2FiY2kmcXVvdDsK",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L4"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flatMap",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v(".flatMap")]),c("OutboundLink")],1),e._v(" transforms an array of arrays into a flattened array.")]),e._v(" "),c("li",[e._v("The "),c("code",[e._v("handleTx")]),e._v(" function uses a new function, "),c("code",[e._v("handleEvents")]),e._v(". Create one and put "),c("code",[e._v("console.log(events)")]),e._v(" in it to explore what this object is and consider what actions you can take with it.")])])]),e._v(" "),c("h2",{attrs:{id:"handle-events"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-events"}},[e._v("#")]),e._v(" Handle events")]),e._v(" "),c("p",[e._v("Define the "),c("code",[e._v("handleEvents")]),e._v(" function:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRzID0gYXN5bmMgKGV2ZW50czogU3RyaW5nRXZlbnRbXSk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBteUV2ZW50czogU3RyaW5nRXZlbnRbXSA9IGV2ZW50cwogICAgICAgICAgICAuZmlsdGVyKChldmVudDogU3RyaW5nRXZlbnQpID0mZ3Q7IGV2ZW50LnR5cGUgPT09ICZxdW90O21lc3NhZ2UmcXVvdDspCiAgICAgICAgICAgIC5maWx0ZXIoKGV2ZW50OiBTdHJpbmdFdmVudCkgPSZndDsKICAgICAgICAgICAgICAgIGV2ZW50LmF0dHJpYnV0ZXMuc29tZSgKICAgICAgICAgICAgICAgICAgICAoYXR0cmlidXRlOiBBdHRyaWJ1dGUpID0mZ3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZS5rZXkgPT09ICZxdW90O21vZHVsZSZxdW90OyAmYW1wOyZhbXA7IGF0dHJpYnV0ZS52YWx1ZSA9PT0gJnF1b3Q7Y2hlY2tlcnMmcXVvdDssCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICApCiAgICAgICAgbGV0IGV2ZW50SW5kZXggPSAwCiAgICAgICAgd2hpbGUgKGV2ZW50SW5kZXggJmx0OyBteUV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgLy8gRnVuY3Rpb24geWV0IHRvIGJlIGRlY2xhcmVkCiAgICAgICAgICAgIGF3YWl0IGhhbmRsZUV2ZW50KG15RXZlbnRzW2V2ZW50SW5kZXhdKQogICAgICAgICAgICBldmVudEluZGV4KysKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy8gU2tpcHBpbmcgaWYgdGhlIGhhbmRsaW5nIGZhaWxlZC4gTW9zdCBsaWtlbHkgdGhlIHRyYW5zYWN0aW9uIGZhaWxlZC4KICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L100-L118"}}),e._v(" "),c("p",[e._v("This needs a new import:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgQUJDSU1lc3NhZ2VMb2csIEF0dHJpYnV0ZSwgU3RyaW5nRXZlbnQgfSBmcm9tICZxdW90O2Nvc21qcy10eXBlcy9jb3Ntb3MvYmFzZS9hYmNpL3YxYmV0YTEvYWJjaSZxdW90Owo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L4"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("code",[e._v("while() {}")]),e._v(" simplifies the syntax of "),c("code",[e._v("await")]),e._v("ing multiple times.")]),e._v(" "),c("li",[e._v("The "),c("code",[e._v("handleEvents")]),e._v(" function only keeps events that have a "),c("code",[e._v("message")]),e._v(" type.")]),e._v(" "),c("li",[e._v("It only keeps events that emanate from the "),c("code",[e._v("checkers")]),e._v(" module.")]),e._v(" "),c("li",[e._v("It uses a new function, "),c("code",[e._v("handleEvent")]),e._v(". Create one and put "),c("code",[e._v("console.log(event)")]),e._v(" inside to explore what this object is and consider what actions you can take with it.")])])]),e._v(" "),c("h2",{attrs:{id:"handle-one-event"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-event"}},[e._v("#")]),e._v(" Handle one event")]),e._v(" "),c("p",[e._v("Define "),c("code",[e._v("handleEvent")]),e._v(" as follows:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnQgPSBhc3luYyAoZXZlbnQ6IFN0cmluZ0V2ZW50KTogUHJvbWlzZSZsdDt2b2lkJmd0OyA9Jmd0OyB7CiAgICBjb25zdCBpc0FjdGlvbk9mID0gKGFjdGlvblZhbHVlOiBzdHJpbmcpOiBib29sZWFuID0mZ3Q7CiAgICAgICAgZXZlbnQuYXR0cmlidXRlcy5zb21lKAogICAgICAgICAgICAoYXR0cmlidXRlOiBBdHRyaWJ1dGUpID0mZ3Q7IGF0dHJpYnV0ZS5rZXkgPT09ICZxdW90O2FjdGlvbiZxdW90OyAmYW1wOyZhbXA7IGF0dHJpYnV0ZS52YWx1ZSA9PT0gYWN0aW9uVmFsdWUsCiAgICAgICAgKQogICAgaWYgKGlzQWN0aW9uT2YoJnF1b3Q7TmV3R2FtZUNyZWF0ZWQmcXVvdDspKSB7CiAgICAgICAgLy8gRnVuY3Rpb24geWV0IHRvIGJlIGRlY2xhcmVkCiAgICAgICAgYXdhaXQgaGFuZGxlRXZlbnRDcmVhdGUoZXZlbnQpCiAgICB9CiAgICBpZiAoaXNBY3Rpb25PZigmcXVvdDtHYW1lUmVqZWN0ZWQmcXVvdDspKSB7CiAgICAgICAgLy8gRnVuY3Rpb24geWV0IHRvIGJlIGRlY2xhcmVkCiAgICAgICAgYXdhaXQgaGFuZGxlRXZlbnRSZWplY3QoZXZlbnQpCiAgICB9CiAgICBpZiAoaXNBY3Rpb25PZigmcXVvdDtNb3ZlUGxheWVkJnF1b3Q7KSkgewogICAgICAgIC8vIEZ1bmN0aW9uIHlldCB0byBiZSBkZWNsYXJlZAogICAgICAgIGF3YWl0IGhhbmRsZUV2ZW50UGxheShldmVudCkKICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L120-L134"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/types/keys.go#L50",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("NewGameCreated")]),c("OutboundLink")],1),e._v(", "),c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/types/keys.go#L60",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("GameRejected")]),c("OutboundLink")],1),e._v(", and "),c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/types/keys.go#L66",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("MovePlayed")]),c("OutboundLink")],1),e._v(" are constant values defined in your Go code. They were associated with a "),c("code",[e._v("key")]),e._v(" of "),c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/keeper/msg_server_create_game.go#L52",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v('"action"')]),c("OutboundLink")],1),e._v(".")]),e._v(" "),c("li",[e._v("Because events are arrays of key/value pairs you must go through them to find what you want, unless you proactively index events as part of a later optimization.")]),e._v(" "),c("li",[c("code",[e._v("handleEvent")]),e._v(" uses three new functions: "),c("code",[e._v("handleEventCreate")]),e._v(", "),c("code",[e._v("handleEventReject")]),e._v(", and "),c("code",[e._v("handleEventPlay")]),e._v(". Create them and put "),c("code",[e._v("console.log(event)")]),e._v(" inside each to explore what these objects are and consider what actions you would take with them.")])])]),e._v(" "),c("h2",{attrs:{id:"handle-one-create-event"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-create-event"}},[e._v("#")]),e._v(" Handle one create event")]),e._v(" "),c("p",[e._v("Now update your "),c("code",[e._v("db")]),e._v(" with the information provided. First, define a convenience function in "),c("code",[e._v("createIndexer")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgZ2V0QXR0cmlidXRlVmFsdWVCeUtleSA9IChhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVbXSwga2V5OiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQgPSZndDsgewogICAgcmV0dXJuIGF0dHJpYnV0ZXMuZmluZCgoYXR0cmlidXRlOiBBdHRyaWJ1dGUpID0mZ3Q7IGF0dHJpYnV0ZS5rZXkgPT09IGtleSk/LnZhbHVlCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L191-L193"}}),e._v(" "),c("p",[e._v("Now define "),c("code",[e._v("handleEventCreate")]),e._v(" as:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRDcmVhdGUgPSBhc3luYyAoZXZlbnQ6IFN0cmluZ0V2ZW50KTogUHJvbWlzZSZsdDt2b2lkJmd0OyA9Jmd0OyB7CiAgICBjb25zdCBuZXdJZDogc3RyaW5nIHwgdW5kZWZpbmVkID0gZ2V0QXR0cmlidXRlVmFsdWVCeUtleShldmVudC5hdHRyaWJ1dGVzLCAmcXVvdDtJbmRleCZxdW90OykKICAgIGlmICghbmV3SWQpIHRocm93IG5ldyBFcnJvcihgQ3JlYXRlIGV2ZW50IG1pc3NpbmcgSW5kZXhgKQogICAgY29uc3QgYmxhY2tBZGRyZXNzOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBnZXRBdHRyaWJ1dGVWYWx1ZUJ5S2V5KGV2ZW50LmF0dHJpYnV0ZXMsICZxdW90O0JsYWNrJnF1b3Q7KQogICAgaWYgKCFibGFja0FkZHJlc3MpIHRocm93IG5ldyBFcnJvcihgQ3JlYXRlIGV2ZW50IG1pc3NpbmcgQmxhY2sgYWRkcmVzc2ApCiAgICBjb25zdCByZWRBZGRyZXNzOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBnZXRBdHRyaWJ1dGVWYWx1ZUJ5S2V5KGV2ZW50LmF0dHJpYnV0ZXMsICZxdW90O1JlZCZxdW90OykKICAgIGlmICghcmVkQWRkcmVzcykgdGhyb3cgbmV3IEVycm9yKGBDcmVhdGUgZXZlbnQgbWlzc2luZyBSZWQgYWRkcmVzc2ApCiAgICBjb25zb2xlLmxvZyhgTmV3IGdhbWU6ICR7bmV3SWR9LCBibGFjazogJHtibGFja0FkZHJlc3N9LCByZWQ6ICR7cmVkQWRkcmVzc31gKQogICAgY29uc3QgYmxhY2tJbmZvOiBQbGF5ZXJJbmZvID0gZGIucGxheWVyc1tibGFja0FkZHJlc3NdID8/IHsKICAgICAgICBnYW1lSWRzOiBbXSwKICAgIH0KICAgIGNvbnN0IHJlZEluZm86IFBsYXllckluZm8gPSBkYi5wbGF5ZXJzW3JlZEFkZHJlc3NdID8/IHsKICAgICAgICBnYW1lSWRzOiBbXSwKICAgIH0KICAgIGlmIChibGFja0luZm8uZ2FtZUlkcy5pbmRleE9mKG5ld0lkKSAmbHQ7IDApIGJsYWNrSW5mby5nYW1lSWRzLnB1c2gobmV3SWQpCiAgICBpZiAocmVkSW5mby5nYW1lSWRzLmluZGV4T2YobmV3SWQpICZsdDsgMCkgcmVkSW5mby5nYW1lSWRzLnB1c2gobmV3SWQpCiAgICBkYi5wbGF5ZXJzW2JsYWNrQWRkcmVzc10gPSBibGFja0luZm8KICAgIGRiLnBsYXllcnNbcmVkQWRkcmVzc10gPSByZWRJbmZvCiAgICBkYi5nYW1lc1tuZXdJZF0gPSB7CiAgICAgICAgcmVkQWRkcmVzczogcmVkQWRkcmVzcywKICAgICAgICBibGFja0FkZHJlc3M6IGJsYWNrQWRkcmVzcywKICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L136-L158"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/keeper/msg_server_create_game.go#L54",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("Index")]),c("OutboundLink")],1),e._v(", "),c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/keeper/msg_server_create_game.go#L56",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("Black")]),c("OutboundLink")],1),e._v(", and "),c("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/9a22cd21/x/checkers/keeper/msg_server_create_game.go#L55",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("Red")]),c("OutboundLink")],1),e._v(" are constants from the Go code.")]),e._v(" "),c("li",[e._v("You have implemented error handling.")]),e._v(" "),c("li",[c("code",[e._v("handleEventCreate")]),e._v(" is careful not to double-add a given game ID.")]),e._v(" "),c("li",[e._v("It does not save "),c("code",[e._v("db")]),e._v(" as this is under the purview of "),c("code",[e._v("poll()")]),e._v(".")])])]),e._v(" "),c("h2",{attrs:{id:"handle-one-reject-event"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-reject-event"}},[e._v("#")]),e._v(" Handle one reject event")]),e._v(" "),c("p",[c("code",[e._v("handleEventReject")]),e._v(" is the counterpart of "),c("code",[e._v("handleEventCreate")]),e._v(", as it removes games from the system.")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRSZWplY3QgPSBhc3luYyAoZXZlbnQ6IFN0cmluZ0V2ZW50KTogUHJvbWlzZSZsdDt2b2lkJmd0OyA9Jmd0OyB7CiAgICBjb25zdCByZWplY3RlZElkOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBnZXRBdHRyaWJ1dGVWYWx1ZUJ5S2V5KGV2ZW50LmF0dHJpYnV0ZXMsICZxdW90O0lkVmFsdWUmcXVvdDspCiAgICBpZiAoIXJlamVjdGVkSWQpIHRocm93IG5ldyBFcnJvcihgUmVqZWN0IGV2ZW50IG1pc3NpbmcgcmVqZWN0ZWRJZGApCiAgICBjb25zdCBibGFja0FkZHJlc3M6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGRiLmdhbWVzW3JlamVjdGVkSWRdPy5ibGFja0FkZHJlc3MKICAgIGNvbnN0IHJlZEFkZHJlc3M6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGRiLmdhbWVzW3JlamVjdGVkSWRdPy5yZWRBZGRyZXNzCiAgICBjb25zdCBibGFja0dhbWVzOiBzdHJpbmdbXSA9IGRiLnBsYXllcnNbYmxhY2tBZGRyZXNzXT8uZ2FtZUlkcyA/PyBbXQogICAgY29uc3QgcmVkR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tyZWRBZGRyZXNzXT8uZ2FtZUlkcyA/PyBbXQogICAgY29uc29sZS5sb2coYFJlamVjdCBnYW1lOiAke3JlamVjdGVkSWR9LCBibGFjazogJHtibGFja0FkZHJlc3N9LCByZWQ6ICR7cmVkQWRkcmVzc31gKQogICAgY29uc3QgaW5kZXhJbkJsYWNrOiBudW1iZXIgPSBibGFja0dhbWVzLmluZGV4T2YocmVqZWN0ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgY29uc3QgaW5kZXhJblJlZDogbnVtYmVyID0gcmVkR2FtZXMuaW5kZXhPZihyZWplY3RlZElkKQogICAgaWYgKDAgJmx0Oz0gaW5kZXhJblJlZCkgcmVkR2FtZXMuc3BsaWNlKGluZGV4SW5SZWQsIDEpCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L160-L172"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("code",[e._v("handleEventReject")]),e._v(" keeps the game information in the "),c("code",[e._v("db")]),e._v(". This is a debatable choice, but helps the "),c("code",[e._v("patch")]),e._v(" function identify old games that once existed as opposed to games that never existed.")]),e._v(" "),c("li",[e._v("There is additional error handling.")])])]),e._v(" "),c("h2",{attrs:{id:"handle-one-play-event"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-play-event"}},[e._v("#")]),e._v(" Handle one play event")]),e._v(" "),c("p",[e._v("Not all play events are equal. "),c("code",[e._v("handleEventPlay")]),e._v(" is only interested when there is a winner. Until then, there is no need to take any action.")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRQbGF5ID0gYXN5bmMgKGV2ZW50OiBTdHJpbmdFdmVudCk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgY29uc3QgcGxheWVkSWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGdldEF0dHJpYnV0ZVZhbHVlQnlLZXkoZXZlbnQuYXR0cmlidXRlcywgJnF1b3Q7SWRWYWx1ZSZxdW90OykKICAgIGlmICghcGxheWVkSWQpIHRocm93IG5ldyBFcnJvcihgUGxheSBldmVudCBtaXNzaW5nIHJlamVjdGVkSWRgKQogICAgY29uc3Qgd2lubmVyOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBnZXRBdHRyaWJ1dGVWYWx1ZUJ5S2V5KGV2ZW50LmF0dHJpYnV0ZXMsICZxdW90O1dpbm5lciZxdW90OykKICAgIGlmICghd2lubmVyKSB0aHJvdyBuZXcgRXJyb3IoJnF1b3Q7UGxheSBldmVudCBtaXNzaW5nIHdpbm5lciZxdW90OykKICAgIGlmICh3aW5uZXIgPT09ICZxdW90O05PX1BMQVlFUiZxdW90OykgcmV0dXJuCiAgICBjb25zdCBibGFja0FkZHJlc3M6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGRiLmdhbWVzW3BsYXllZElkXT8uYmxhY2tBZGRyZXNzCiAgICBjb25zdCByZWRBZGRyZXNzOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBkYi5nYW1lc1twbGF5ZWRJZF0/LnJlZEFkZHJlc3MKICAgIGNvbnN0IGJsYWNrR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tibGFja0FkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zdCByZWRHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW3JlZEFkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zb2xlLmxvZyhgV2luIGdhbWU6ICR7cGxheWVkSWR9LCBibGFjazogJHtibGFja0FkZHJlc3N9LCByZWQ6ICR7cmVkQWRkcmVzc30sIHdpbm5lcjogJHt3aW5uZXJ9YCkKICAgIGNvbnN0IGluZGV4SW5CbGFjazogbnVtYmVyID0gYmxhY2tHYW1lcy5pbmRleE9mKHBsYXllZElkKQogICAgaWYgKDAgJmx0Oz0gaW5kZXhJbkJsYWNrKSBibGFja0dhbWVzLnNwbGljZShpbmRleEluQmxhY2ssIDEpCiAgICBjb25zdCBpbmRleEluUmVkOiBudW1iZXIgPSByZWRHYW1lcy5pbmRleE9mKHBsYXllZElkKQogICAgaWYgKDAgJmx0Oz0gaW5kZXhJblJlZCkgcmVkR2FtZXMuc3BsaWNlKGluZGV4SW5SZWQsIDEpCn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/b030b2f/src/server/indexer.ts#L174-L189"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[c("code",[e._v("handleEventPlay")]),e._v(" returns quietly if there is no winner.")]),e._v(" "),c("li",[e._v("As when there is a rejected game, it keeps the game information in the "),c("code",[e._v("db")]),e._v(".")])])]),e._v(" "),c("h2",{attrs:{id:"test-time"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#test-time"}},[e._v("#")]),e._v(" Test time")]),e._v(" "),c("p",[e._v("You can now test what happens when a game is created and rejected. Restart "),c("code",[e._v("npm run indexer-dev")]),e._v(".")]),e._v(" "),c("p",[e._v("You can choose how to create and reject games:")]),e._v(" "),c("ul",[c("li",[e._v("Run the GUI with "),c("code",[e._v("npm start")]),e._v(", although it does not have a reject function at the time of writing.")]),e._v(" "),c("li",[e._v("Run "),c("code",[e._v("checkersd")]),e._v(" command lines.")]),e._v(" "),c("li",[e._v("Any other way available.")])]),e._v(" "),c("p",[e._v("And in another terminal 3:")]),e._v(" "),c("CodeGroup",[c("CodeGroupItem",{attrs:{title:"Create game"}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgY3JlYXRlLWdhbWUgJGFsaWNlICRib2IgMSB0b2tlbiAtLWZyb20gJGFsaWNlCg=="}}),e._v(" "),c("p",[e._v("Alternatively, use a GUI if preferred. The indexer should log something like:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"TmV3IGdhbWU6IDEsIGJsYWNrOiBjb3Ntb3MxYWM2c3J6OHdoODQ4emMwOHdyZmdoeWdodWY1Y2YzdHZkNDVwbncsIHJlZDogY29zbW9zMXQ4OGZrd3VybG51c2Y2YWd2cHRzbm0zM3Q0MGtyNGhscTZoMDhzCg=="}}),e._v(" "),c("p",[e._v("It should update "),c("code",[e._v("db.json")]),e._v(" to:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAgICAgJnF1b3Q7YmxvY2smcXVvdDs6IHsKICAgICAgICAgICAgJnF1b3Q7aGVpZ2h0JnF1b3Q7OiAxMDAKICAgICAgICB9CiAgICB9LAogICAgJnF1b3Q7cGxheWVycyZxdW90OzogewogICAgICAgICZxdW90O2Nvc21vczFhYzZzcno4d2g4NDh6YzA4d3JmZ2h5Z2h1ZjVjZjN0dmQ0NXBudyZxdW90OzogewogICAgICAgICAgICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbCiAgICAgICAgICAgICAgICAmcXVvdDsxJnF1b3Q7CiAgICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgICZxdW90O2Nvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cyZxdW90OzogewogICAgICAgICAgICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbCiAgICAgICAgICAgICAgICAmcXVvdDsxJnF1b3Q7CiAgICAgICAgICAgIF0KICAgICAgICB9CiAgICB9LAogICAgJnF1b3Q7Z2FtZXMmcXVvdDs6IHsKICAgICAgICAmcXVvdDsxJnF1b3Q7OiB7CiAgICAgICAgICAgICZxdW90O3JlZEFkZHJlc3MmcXVvdDs6ICZxdW90O2Nvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cyZxdW90OywKICAgICAgICAgICAgJnF1b3Q7YmxhY2tBZGRyZXNzJnF1b3Q7OiAmcXVvdDtjb3Ntb3MxYWM2c3J6OHdoODQ4emMwOHdyZmdoeWdodWY1Y2YzdHZkNDVwbncmcXVvdDsKICAgICAgICB9CiAgICB9Cn0K"}})],1),e._v(" "),c("CodeGroupItem",{attrs:{title:"Reject game"}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgcmVqZWN0LWdhbWUgMSAtLWZyb20gJGJvYiAteQo="}}),e._v(" "),c("p",[e._v("The indexer should log something like:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"UmVqZWN0IGdhbWU6IDEsIGJsYWNrOiBjb3Ntb3MxYWM2c3J6OHdoODQ4emMwOHdyZmdoeWdodWY1Y2YzdHZkNDVwbncsIHJlZDogY29zbW9zMXQ4OGZrd3VybG51c2Y2YWd2cHRzbm0zM3Q0MGtyNGhscTZoMDhzCg=="}}),e._v(" "),c("p",[e._v("It should update "),c("code",[e._v("db.json")]),e._v(" to:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICAgJnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAgICAgJnF1b3Q7YmxvY2smcXVvdDs6IHsKICAgICAgICAgICAgJnF1b3Q7aGVpZ2h0JnF1b3Q7OiAxMDAKICAgICAgICB9CiAgICB9LAogICAgJnF1b3Q7cGxheWVycyZxdW90OzogewogICAgICAgICZxdW90O2Nvc21vczFhYzZzcno4d2g4NDh6YzA4d3JmZ2h5Z2h1ZjVjZjN0dmQ0NXBudyZxdW90OzogewogICAgICAgICAgICAmcXVvdDtnYW1lSWRzJnF1b3Q7OiBbXQogICAgICAgIH0sCiAgICAgICAgJnF1b3Q7Y29zbW9zMXQ4OGZrd3VybG51c2Y2YWd2cHRzbm0zM3Q0MGtyNGhscTZoMDhzJnF1b3Q7OiB7CiAgICAgICAgICAgICZxdW90O2dhbWVJZHMmcXVvdDs6IFtdCiAgICAgICAgfQogICAgfSwKICAgICZxdW90O2dhbWVzJnF1b3Q7OiB7CiAgICAgICAgJnF1b3Q7MSZxdW90OzogewogICAgICAgICAgICAmcXVvdDtyZWRBZGRyZXNzJnF1b3Q7OiAmcXVvdDtjb3Ntb3MxdDg4Zmt3dXJsbnVzZjZhZ3ZwdHNubTMzdDQwa3I0aGxxNmgwOHMmcXVvdDssCiAgICAgICAgICAgICZxdW90O2JsYWNrQWRkcmVzcyZxdW90OzogJnF1b3Q7Y29zbW9zMWFjNnNyejh3aDg0OHpjMDh3cmZnaHlnaHVmNWNmM3R2ZDQ1cG53JnF1b3Q7CiAgICAgICAgfQogICAgfQp9Cg=="}})],1),e._v(" "),c("CodeGroupItem",{attrs:{title:"Play game"}},[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjaGVja2Vyc2QgdHggY2hlY2tlcnMgcGxheS1tb3ZlIDEgMSAyIDIgMyAtLWZyb20gJGJvYiAteQo="}}),e._v(" "),c("p",[e._v("In this case the indexer should not log anything. Because performing moves from the command line is laborious, using the GUI is advisable.")])],1)],1),e._v(" "),c("hr"),e._v(" "),c("p",[e._v("What remains is handling the games that get removed or forfeited in "),c("code",[e._v("EndBlock")]),e._v(".")]),e._v(" "),c("h2",{attrs:{id:"prepare-for-endblock"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#prepare-for-endblock"}},[e._v("#")]),e._v(" Prepare for "),c("code",[e._v("EndBlock")])]),e._v(" "),c("p",[e._v("Nicely formatted "),c("code",[e._v("EndBlock")]),e._v(" events are still missing from CosmJS, so these require a little extra work:")]),e._v(" "),c("ol",[c("li",[e._v("To get a block's "),c("code",[e._v("EndBlock")]),e._v(" events, you need to ask for the block information from a Tendermint client. This client is a "),c("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/902f21b/packages%2Fstargate%2Fsrc%2Fstargateclient.ts#L140",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("private")]),e._v(" field"),c("OutboundLink")],1),e._v(" of "),c("code",[e._v("StargateClient")]),e._v(".")]),e._v(" "),c("li",[e._v("The function to call is "),c("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/5ee3f82/packages/tendermint-rpc/src/tendermint34/tendermint34client.ts#L88",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("blockResults")]),c("OutboundLink")],1),e._v(".")]),e._v(" "),c("li",[e._v("It returns a "),c("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/ca969f2/packages/tendermint-rpc/src/tendermint34/responses.ts#L55",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("BlockResultsResponse")]),c("OutboundLink")],1),e._v(", of which "),c("code",[e._v("endBlockEvents: Event")]),e._v(" is of interest.")]),e._v(" "),c("li",[e._v("This "),c("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/ca969f2/packages/tendermint-rpc/src/tendermint34/responses.ts#L182",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("Event")]),c("OutboundLink")],1),e._v(" type has "),c("code",[e._v("attributes: Attribute[]")]),e._v(" of interest.")]),e._v(" "),c("li",[e._v("The "),c("a",{attrs:{href:"https://github.com/cosmos/cosmjs/blob/ca969f2/packages/tendermint-rpc/src/tendermint34/responses.ts#L177-L180",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("Attribute")]),c("OutboundLink")],1),e._v(" type is coded as "),c("code",[e._v("Uint8Array")]),e._v(".")])]),e._v(" "),c("p",[e._v("With this information, you can do the necessary actions:")]),e._v(" "),c("ol",[c("li",[c("p",[e._v("To handle the conversion of Tendermint "),c("code",[e._v("Event")]),e._v("s into "),c("code",[e._v("StringEvent")]),e._v("s, create a helper in your existing "),c("code",[e._v("src/types/checkers/events.ts")]),e._v(" file alongside the "),c("code",[e._v("getCreatedGameId")]),e._v(" helper:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgZnJvbVV0ZjggfSBmcm9tICZxdW90O0Bjb3NtanMvZW5jb2RpbmcmcXVvdDsKaW1wb3J0IHsgQXR0cmlidXRlIGFzIFRlbmRlcm1pbnRBdHRyaWJ1dGUsIEV2ZW50IH0gZnJvbSAmcXVvdDtAY29zbWpzL3RlbmRlcm1pbnQtcnBjJnF1b3Q7CmltcG9ydCB7IEF0dHJpYnV0ZSwgU3RyaW5nRXZlbnQgfSBmcm9tICZxdW90O2Nvc21qcy10eXBlcy9jb3Ntb3MvYmFzZS9hYmNpL3YxYmV0YTEvYWJjaSZxdW90OwoKZXhwb3J0IGNvbnN0IGNvbnZlcnRUZW5kZXJtaW50RXZlbnRzID0gKGV2ZW50czogcmVhZG9ubHkgRXZlbnRbXSk6IFN0cmluZ0V2ZW50W10gPSZndDsgewogICAgcmV0dXJuIGV2ZW50cy5tYXAoCiAgICAgICAgKGV2ZW50OiBFdmVudCk6IFN0cmluZ0V2ZW50ID0mZ3Q7ICh7CiAgICAgICAgICAgIHR5cGU6IGV2ZW50LnR5cGUsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IGV2ZW50LmF0dHJpYnV0ZXMubWFwKAogICAgICAgICAgICAgICAgKGF0dHJpYnV0ZTogVGVuZGVybWludEF0dHJpYnV0ZSk6IEF0dHJpYnV0ZSA9Jmd0OyAoewogICAgICAgICAgICAgICAgICAgIGtleTogZnJvbVV0ZjgoYXR0cmlidXRlLmtleSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZyb21VdGY4KGF0dHJpYnV0ZS52YWx1ZSksCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgKSwKICAgICAgICB9KSwKICAgICkKfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/d623ae0/src/types/checkers/events.ts#L12-L24"}})],1),e._v(" "),c("li",[c("p",[e._v("To handle the call to "),c("code",[e._v("blockResults")]),e._v(", you need access to a Tendermint client. One option is to make a copy of the private Tendermint client. You can do this only on construction, so create a child class of "),c("code",[e._v("CheckersStargateClient")]),e._v(" to do that. It is recommended to keep it close by "),c("code",[e._v("indexer.ts")]),e._v(". In a new "),c("code",[e._v("indexer_stargateclient.ts")]),e._v(":")])])]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgU3RhcmdhdGVDbGllbnRPcHRpb25zIH0gZnJvbSAmcXVvdDtAY29zbWpzL3N0YXJnYXRlJnF1b3Q7CmltcG9ydCB7IEJsb2NrUmVzdWx0c1Jlc3BvbnNlLCBUZW5kZXJtaW50MzRDbGllbnQgfSBmcm9tICZxdW90O0Bjb3NtanMvdGVuZGVybWludC1ycGMmcXVvdDsKaW1wb3J0IHsgU3RyaW5nRXZlbnQgfSBmcm9tICZxdW90O2Nvc21qcy10eXBlcy9jb3Ntb3MvYmFzZS9hYmNpL3YxYmV0YTEvYWJjaSZxdW90OwppbXBvcnQgeyBjb252ZXJ0VGVuZGVybWludEV2ZW50cyB9IGZyb20gJnF1b3Q7Li4vdHlwZXMvY2hlY2tlcnMvZXZlbnRzJnF1b3Q7CmltcG9ydCB7IENoZWNrZXJzU3RhcmdhdGVDbGllbnQgfSBmcm9tICZxdW90Oy4uL2NoZWNrZXJzX3N0YXJnYXRlY2xpZW50JnF1b3Q7CgpleHBvcnQgY2xhc3MgSW5kZXhlclN0YXJnYXRlQ2xpZW50IGV4dGVuZHMgQ2hlY2tlcnNTdGFyZ2F0ZUNsaWVudCB7CiAgICBwcml2YXRlIHJlYWRvbmx5IG15VG1DbGllbnQ6IFRlbmRlcm1pbnQzNENsaWVudAoKICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgY29ubmVjdCgKICAgICAgICBlbmRwb2ludDogc3RyaW5nLAogICAgICAgIG9wdGlvbnM6IFN0YXJnYXRlQ2xpZW50T3B0aW9ucyA9IHt9LAogICAgKTogUHJvbWlzZSZsdDtJbmRleGVyU3RhcmdhdGVDbGllbnQmZ3Q7IHsKICAgICAgICBjb25zdCB0bUNsaWVudCA9IGF3YWl0IFRlbmRlcm1pbnQzNENsaWVudC5jb25uZWN0KGVuZHBvaW50KQogICAgICAgIHJldHVybiBuZXcgSW5kZXhlclN0YXJnYXRlQ2xpZW50KHRtQ2xpZW50LCBvcHRpb25zKQogICAgfQoKICAgIHByb3RlY3RlZCBjb25zdHJ1Y3Rvcih0bUNsaWVudDogVGVuZGVybWludDM0Q2xpZW50LCBvcHRpb25zOiBTdGFyZ2F0ZUNsaWVudE9wdGlvbnMpIHsKICAgICAgICBzdXBlcih0bUNsaWVudCwgb3B0aW9ucykKICAgICAgICB0aGlzLm15VG1DbGllbnQgPSB0bUNsaWVudAogICAgfQoKICAgIHB1YmxpYyBhc3luYyBnZXRFbmRCbG9ja0V2ZW50cyhoZWlnaHQ6IG51bWJlcik6IFByb21pc2UmbHQ7U3RyaW5nRXZlbnRbXSZndDsgewogICAgICAgIGNvbnN0IHJlc3VsdHM6IEJsb2NrUmVzdWx0c1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5teVRtQ2xpZW50LmJsb2NrUmVzdWx0cyhoZWlnaHQpCiAgICAgICAgcmV0dXJuIGNvbnZlcnRUZW5kZXJtaW50RXZlbnRzKHJlc3VsdHMuZW5kQmxvY2tFdmVudHMpCiAgICB9Cn0K",url:"https://github.com/cosmos/academy-checkers-ui/blob/d623ae0/src/server/indexer_stargateclient.ts"}}),e._v(" "),c("p",[e._v("Now swap out "),c("code",[e._v("CheckersStargateClient")]),e._v(" with "),c("code",[e._v("IndexerStargateClient")]),e._v(":")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"aW1wb3J0IHsgSW5kZXhlclN0YXJnYXRlQ2xpZW50IH0gZnJvbSAmcXVvdDsuL0luZGV4ZXJTdGFyZ2F0ZUNsaWVudCZxdW90OwoKZXhwb3J0IGNvbnN0IGNyZWF0ZUluZGV4ZXIgPSBhc3luYyAoKSA9Jmd0OyB7CiAgICAuLi4KICAgIGxldCBjbGllbnQ6IEluZGV4ZXJTdGFyZ2F0ZUNsaWVudAoKICAgIC4uLgogICAgY29uc3QgaW5pdCA9IGFzeW5jICgpID0mZ3Q7IHsKICAgICAgICBjbGllbnQgPSBhd2FpdCBJbmRleGVyU3RhcmdhdGVDbGllbnQuY29ubmVjdChwcm9jZXNzLmVudi5SUENfVVJMISkKICAgICAgICAuLi4KICAgIH0KfQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/d623ae0/src/server/indexer.ts#L20"}}),e._v(" "),c("p",[e._v("With this in place, go back to "),c("code",[e._v("handleBlock")]),e._v(" and work on the remaining TODO.")]),e._v(" "),c("h2",{attrs:{id:"handle-one-block-s-endblock"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#handle-one-block-s-endblock"}},[e._v("#")]),e._v(" Handle one block's "),c("code",[e._v("EndBlock")])]),e._v(" "),c("p",[e._v("Go to the function and update it:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlQmxvY2sgPSBhc3luYyAoYmxvY2s6IEJsb2NrKSA9Jmd0OyB7CiAgICAuLi4KICAgIGNvbnN0IGV2ZW50czogU3RyaW5nRXZlbnRbXSA9IGF3YWl0IGNsaWVudC5nZXRFbmRCbG9ja0V2ZW50cyhibG9jay5oZWFkZXIuaGVpZ2h0KQogICAgaWYgKDAgJmx0OyBldmVudHMubGVuZ3RoKSBjb25zb2xlLmxvZygmcXVvdDsmcXVvdDspCiAgICBhd2FpdCBoYW5kbGVFdmVudHMoZXZlbnRzKQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/d623ae0/src/server/indexer.ts#L91-L93"}}),e._v(" "),c("p",[e._v("The events that you have converted are compatible with those emanating from transactions, so you can just pass them on. You still need to update "),c("code",[e._v("handleEvent")]),e._v(" so that it acts on the new event type:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnQgPSBhc3luYyAoZXZlbnQ6IFN0cmluZ0V2ZW50KTogUHJvbWlzZSZsdDt2b2lkJmd0OyA9Jmd0OyB7CiAgICAuLi4KICAgIGlmIChpc0FjdGlvbk9mKCZxdW90O0dhbWVGb3JmZWl0ZWQmcXVvdDspKSB7CiAgICAgICAgLy8gRnVuY3Rpb24geWV0IHRvIGJlIGRlY2xhcmVkCiAgICAgICAgYXdhaXQgaGFuZGxlRXZlbnRGb3JmZWl0KGV2ZW50KQogICAgfQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/d623ae0/src/server/indexer.ts#L136-L138"}}),e._v(" "),c("p",[e._v("To achieve this, add a new function:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgaGFuZGxlRXZlbnRGb3JmZWl0ID0gYXN5bmMgKGV2ZW50OiBTdHJpbmdFdmVudCk6IFByb21pc2UmbHQ7dm9pZCZndDsgPSZndDsgewogICAgY29uc3QgZm9yZmVpdGVkSWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGdldEF0dHJpYnV0ZVZhbHVlQnlLZXkoZXZlbnQuYXR0cmlidXRlcywgJnF1b3Q7SWRWYWx1ZSZxdW90OykKICAgIGlmICghZm9yZmVpdGVkSWQpIHRocm93IG5ldyBFcnJvcihgRm9yZmVpdCBldmVudCBtaXNzaW5nIGZvcmZlaXRlZElkYCkKICAgIGNvbnN0IHdpbm5lcjogc3RyaW5nIHwgdW5kZWZpbmVkID0gZ2V0QXR0cmlidXRlVmFsdWVCeUtleShldmVudC5hdHRyaWJ1dGVzLCAmcXVvdDtXaW5uZXImcXVvdDspCiAgICBjb25zdCBibGFja0FkZHJlc3M6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGRiLmdhbWVzW2ZvcmZlaXRlZElkXT8uYmxhY2tBZGRyZXNzCiAgICBjb25zdCByZWRBZGRyZXNzOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBkYi5nYW1lc1tmb3JmZWl0ZWRJZF0/LnJlZEFkZHJlc3MKICAgIGNvbnN0IGJsYWNrR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tibGFja0FkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zdCByZWRHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW3JlZEFkZHJlc3NdPy5nYW1lSWRzID8/IFtdCiAgICBjb25zb2xlLmxvZygKICAgICAgICBgRm9yZmVpdCBnYW1lOiAke2ZvcmZlaXRlZElkfSwgYmxhY2s6ICR7YmxhY2tBZGRyZXNzfSwgcmVkOiAke3JlZEFkZHJlc3N9LCB3aW5uZXI6ICR7d2lubmVyfWAsCiAgICApCiAgICBjb25zdCBpbmRleEluQmxhY2s6IG51bWJlciA9IGJsYWNrR2FtZXMuaW5kZXhPZihmb3JmZWl0ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgY29uc3QgaW5kZXhJblJlZDogbnVtYmVyID0gcmVkR2FtZXMuaW5kZXhPZihmb3JmZWl0ZWRJZCkKICAgIGlmICgwICZsdDs9IGluZGV4SW5SZWQpIHJlZEdhbWVzLnNwbGljZShpbmRleEluUmVkLCAxKQogICAgaWYgKHdpbm5lciA9PT0gJnF1b3Q7Tk9fUExBWUVSJnF1b3Q7KSB7CiAgICAgICAgZGVsZXRlIGRiLmdhbWVzW2ZvcmZlaXRlZElkXQogICAgfQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/d623ae0/src/server/indexer.ts#L196-L214"}}),e._v(" "),c("HighlightBox",{attrs:{type:"note"}},[c("ul",[c("li",[e._v("Again there is a lot of error handling.")]),e._v(" "),c("li",[c("code",[e._v("handleEvent")]),e._v(" deletes the game only if there are no winners, which means that it was a deletion, not a forfeit.")])])]),e._v(" "),c("h2",{attrs:{id:"test-time-of-forfeit"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#test-time-of-forfeit"}},[e._v("#")]),e._v(" Test time of forfeit")]),e._v(" "),c("p",[e._v("Run the previous tests again. Create a game and see how the deletion event is picked up:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"Rm9yZmVpdCBnYW1lOiAxLCBibGFjazogY29zbW9zMWFjNnNyejh3aDg0OHpjMDh3cmZnaHlnaHVmNWNmM3R2ZDQ1cG53LCByZWQ6IGNvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cywgd2lubmVyOiAqCg=="}}),e._v(" "),c("h2",{attrs:{id:"patch-a-game"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#patch-a-game"}},[e._v("#")]),e._v(" Patch a game")]),e._v(" "),c("p",[e._v("In the actions that the Express server exposes, "),c("code",[e._v("app.patch")]),e._v(" must still be implemented. This allows a user to inform the server that its database is no longer synchronized, and that it should look at a specific game. It is a matter of data re-synchronization:")]),e._v(" "),c("ol",[c("li",[e._v("If the game can be found in the blockchain state, update the indexer's database accordingly:\n"),c("ol",[c("li",[e._v("If there is a winner, then the game should be removed from its players' lists of games.")]),e._v(" "),c("li",[e._v("If there is no winner, then the game should be added to its players' lists of games.")])])]),e._v(" "),c("li",[e._v("If the game cannot be found in the blockchain state, but is present in the indexer's database, then the game should be removed from the lists of games of its players. This shows the usefulness of keeping "),c("em",[e._v("old")]),e._v(" games.")]),e._v(" "),c("li",[e._v("If the game cannot be found either in the blockchain state nor in the indexer's database, then it is better not to do anything. To remove it from all players' lists of games is potentially expensive. This could expose the server to a DoS attack.")])]),e._v(" "),c("p",[e._v("Code the following:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"Y29uc3QgcGF0Y2hHYW1lID0gYXN5bmMgKGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZSZsdDtib29sZWFuJmd0OyA9Jmd0OyB7CiAgICBjb25zdCBnYW1lOiBTdG9yZWRHYW1lIHwgdW5kZWZpbmVkID0gYXdhaXQgY2xpZW50LmNoZWNrZXJzUXVlcnlDbGllbnQ/LmNoZWNrZXJzLmdldFN0b3JlZEdhbWUoZ2FtZUlkKQogICAgY29uc3QgY2FjaGVkR2FtZTogR2FtZUluZm8gfCB1bmRlZmluZWQgPSBkYi5nYW1lc1tnYW1lSWRdCiAgICBpZiAoIWdhbWUgJmFtcDsmYW1wOyBjYWNoZWRHYW1lKSB7CiAgICAgICAgY29uc3QgYmxhY2tHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW2NhY2hlZEdhbWUuYmxhY2tBZGRyZXNzXT8uZ2FtZUlkcyA/PyBbXQogICAgICAgIGNvbnN0IHJlZEdhbWVzOiBzdHJpbmdbXSA9IGRiLnBsYXllcnNbY2FjaGVkR2FtZS5yZWRBZGRyZXNzXT8uZ2FtZUlkcyA/PyBbXQogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICBgUGF0Y2ggZ2FtZTogZGVsZXRlZCwgJHtnYW1lSWR9LCBibGFjazogJHtjYWNoZWRHYW1lLmJsYWNrQWRkcmVzc30sIHJlZDogJHtjYWNoZWRHYW1lLnJlZEFkZHJlc3N9YCwKICAgICAgICApCiAgICAgICAgY29uc3QgaW5kZXhJbkJsYWNrOiBudW1iZXIgPSBibGFja0dhbWVzLmluZGV4T2YoZ2FtZUlkKQogICAgICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgICAgIGNvbnN0IGluZGV4SW5SZWQ6IG51bWJlciA9IHJlZEdhbWVzLmluZGV4T2YoZ2FtZUlkKQogICAgICAgIGlmICgwICZsdDs9IGluZGV4SW5SZWQpIHJlZEdhbWVzLnNwbGljZShpbmRleEluUmVkLCAxKQogICAgICAgIHJldHVybiB0cnVlCiAgICB9IGVsc2UgaWYgKCFnYW1lKSB7CiAgICAgICAgLy8gTm8gaW5mb3JtYXRpb24gdG8gd29yayBmcm9tLgogICAgICAgIC8vIElmIHdlIHRyeSB0byByZW1vdmUgaXQgZnJvbSBhbGwgcGxheWVycywgaXQgaXMgdmVyeSBleHBlbnNpdmUgYW5kIHdlIGFyZSBhdCByaXNrIG9mIGEgRG9TIGF0dGFjay4KICAgICAgICBjb25zb2xlLmxvZyhgUGF0Y2ggZ2FtZTogbm90IGZvdW5kLCAke2dhbWVJZH1gKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfSBlbHNlIGlmIChnYW1lLndpbm5lciAhPT0gJnF1b3Q7Tk9fUExBWUVSJnF1b3Q7KSB7CiAgICAgICAgY29uc3QgYmxhY2tHYW1lczogc3RyaW5nW10gPSBkYi5wbGF5ZXJzW2dhbWUuYmxhY2tdPy5nYW1lSWRzID8/IFtdCiAgICAgICAgY29uc3QgcmVkR2FtZXM6IHN0cmluZ1tdID0gZGIucGxheWVyc1tnYW1lLnJlZF0/LmdhbWVJZHMgPz8gW10KICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICAgYFBhdGNoIGdhbWU6IGVuZGVkLCAke2dhbWVJZH0sIGJsYWNrOiAke2dhbWUuYmxhY2t9LCByZWQ6ICR7Z2FtZS5yZWR9LCB3aW5uZXI6ICR7Z2FtZS53aW5uZXJ9YCwKICAgICAgICApCiAgICAgICAgY29uc3QgaW5kZXhJbkJsYWNrOiBudW1iZXIgPSBibGFja0dhbWVzLmluZGV4T2YoZ2FtZUlkKQogICAgICAgIGlmICgwICZsdDs9IGluZGV4SW5CbGFjaykgYmxhY2tHYW1lcy5zcGxpY2UoaW5kZXhJbkJsYWNrLCAxKQogICAgICAgIGNvbnN0IGluZGV4SW5SZWQ6IG51bWJlciA9IHJlZEdhbWVzLmluZGV4T2YoZ2FtZUlkKQogICAgICAgIGlmICgwICZsdDs9IGluZGV4SW5SZWQpIHJlZEdhbWVzLnNwbGljZShpbmRleEluUmVkLCAxKQogICAgICAgIHJldHVybiB0cnVlCiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGJsYWNrSW5mbzogUGxheWVySW5mbyA9IGRiLnBsYXllcnNbZ2FtZS5ibGFja10gPz8gewogICAgICAgICAgICBnYW1lSWRzOiBbXSwKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVkSW5mbzogUGxheWVySW5mbyA9IGRiLnBsYXllcnNbZ2FtZS5yZWRdID8/IHsKICAgICAgICAgICAgZ2FtZUlkczogW10sCiAgICAgICAgfQogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICBgUGF0Y2ggZ2FtZTogbmV3LCAke2dhbWVJZH0sIGJsYWNrOiAke2dhbWUuYmxhY2t9LCByZWQ6ICR7Z2FtZS5yZWR9YCwKICAgICAgICApCiAgICAgICAgaWYgKGJsYWNrSW5mby5nYW1lSWRzLmluZGV4T2YoZ2FtZUlkKSAmbHQ7IDApIGJsYWNrSW5mby5nYW1lSWRzLnB1c2goZ2FtZUlkKQogICAgICAgIGlmIChyZWRJbmZvLmdhbWVJZHMuaW5kZXhPZihnYW1lSWQpICZsdDsgMCkgcmVkSW5mby5nYW1lSWRzLnB1c2goZ2FtZUlkKQogICAgICAgIGRiLnBsYXllcnNbZ2FtZS5ibGFja10gPSBibGFja0luZm8KICAgICAgICBkYi5wbGF5ZXJzW2dhbWUucmVkXSA9IHJlZEluZm8KICAgICAgICBkYi5nYW1lc1tnYW1lSWRdID0gewogICAgICAgICAgICByZWRBZGRyZXNzOiBnYW1lLnJlZCwKICAgICAgICAgICAgYmxhY2tBZGRyZXNzOiBnYW1lLmJsYWNrLAogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgfQp9Cg==",url:"https://github.com/cosmos/academy-checkers-ui/blob/2e400d1/src/server/indexer.ts#L225-L275"}}),e._v(" "),c("p",[e._v("There are some issues to be aware of:")]),e._v(" "),c("ol",[c("li",[e._v("JavaScript is not thread-safe, so you could cause two opposite actions: one coming from the polling and the other from a patch submission, or even from two concurrent patch submissions. To reduce this risk the "),c("em",[e._v("database")]),e._v(" is not saved to disk in this function, but instead relies on the polling to save it at the next run.")]),e._v(" "),c("li",[e._v("Assuming that "),c("em",[e._v("there is no such game when you cannot find it")]),e._v(" can result in deleting data that is simply taking time to appear on your blockchain node.")])]),e._v(" "),c("p",[e._v("Next, you need to call "),c("code",[e._v("patchGame")]),e._v(" from the "),c("code",[e._v("app.patch")]),e._v(" callback:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"typescript",base64:"YXBwLnBhdGNoKCZxdW90Oy9nYW1lcy86Z2FtZUlkJnF1b3Q7LCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9Jmd0OyB7CiAgICBjb25zdCBmb3VuZCA9IGF3YWl0IHBhdGNoR2FtZShyZXEucGFyYW1zLmdhbWVJZCkKICAgIGlmICghZm91bmQpIHJlcy5zdGF0dXMoNDA0KQogICAgZWxzZSB7CiAgICAgICAgcmVzLmpzb24oewogICAgICAgICAgICByZXN1bHQ6ICZxdW90O1RoYW5rIHlvdSZxdW90OywKICAgICAgICB9KQogICAgfQp9KQo=",url:"https://github.com/cosmos/academy-checkers-ui/blob/2e400d1/src/server/indexer.ts#L49-L57"}}),e._v(" "),c("h2",{attrs:{id:"test-time-of-patch"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#test-time-of-patch"}},[e._v("#")]),e._v(" Test time of patch")]),e._v(" "),c("p",[e._v("To simulate a case where the game is in the blockchain state but not the indexer's:")]),e._v(" "),c("ol",[c("li",[c("p",[e._v("Stop your indexer.")])]),e._v(" "),c("li",[c("p",[e._v("Create a game and check at what block it is included (for example, at index "),c("code",[e._v("3")]),e._v(" and block "),c("code",[e._v("1001")]),e._v(").")])]),e._v(" "),c("li",[c("p",[e._v("Update your indexer's "),c("code",[e._v("db.json")]),e._v(" and pretend that it already indexed the game's block by setting:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"JnF1b3Q7c3RhdHVzJnF1b3Q7OiB7CiAgICAmcXVvdDtibG9jayZxdW90OzogewogICAgICAgICZxdW90O2hlaWdodCZxdW90OzogMTAwMQogICAgfQp9Cg=="}})],1),e._v(" "),c("li",[c("p",[e._v("Restart the indexer.")])]),e._v(" "),c("li",[c("p",[e._v("From another terminal, make a call to it:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBjdXJsIC1YIFBBVENIIGxvY2FsaG9zdDozMDAxL2dhbWVzLzMgfCBqcQo="}})],1)]),e._v(" "),c("p",[e._v("It should return:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"json",base64:"ewogICZxdW90O3Jlc3VsdCZxdW90OzogJnF1b3Q7VGhhbmsgeW91JnF1b3Q7Cn0K"}}),e._v(" "),c("p",[e._v("And the indexer should log something like:")]),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"undefined",base64:"UGF0Y2ggZ2FtZTogbmV3LCAzLCBibGFjazogY29zbW9zMWFjNnNyejh3aDg0OHpjMDh3cmZnaHlnaHVmNWNmM3R2ZDQ1cG53LCByZWQ6IGNvc21vczF0ODhma3d1cmxudXNmNmFndnB0c25tMzN0NDBrcjRobHE2aDA4cwo="}}),e._v(" "),c("p",[e._v("Develop your own ways to test the other scenarios.")]),e._v(" "),c("h2",{attrs:{id:"conclusion"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[e._v("#")]),e._v(" Conclusion")]),e._v(" "),c("p",[e._v("You have created a small server that:")]),e._v(" "),c("ul",[c("li",[e._v("Polls the blockchain to get events about created, rejected, won, and forfeited games.")]),e._v(" "),c("li",[e._v("Maintains a database with information indexed in real time.")]),e._v(" "),c("li",[e._v("Offers this information as a Web service.")]),e._v(" "),c("li",[e._v("Accepts requests for patches.")])]),e._v(" "),c("p",[e._v("These are examples of server-side scripts, which can improve user experience.")]),e._v(" "),c("p",[e._v("You can find the complete code "),c("a",{attrs:{href:"https://github.com/cosmos/academy-checkers-ui/tree/server-indexing",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),c("OutboundLink")],1),e._v(".")]),e._v(" "),c("p",[e._v("So what's next? The Cosmos is vast, with lots of projects, people and concepts to discover:")]),e._v(" "),c("ul",[c("li",[e._v("Reach out to the community.")]),e._v(" "),c("li",[e._v("Contribute to the Cosmos SDK, IBC, and Tendermint BFT consensus development.")]),e._v(" "),c("li",[e._v("Get support for enterprise solutions which you are developing.")])]),e._v(" "),c("p",[e._v("Head to the "),c("RouterLink",{attrs:{to:"/academy/6-whats-next/"}},[e._v("What's Next section")]),e._v(" to find useful information to launch your journey into the Cosmos universe.")],1)],1)}),[],!1,null,null,null);t.default=a.exports}}]);