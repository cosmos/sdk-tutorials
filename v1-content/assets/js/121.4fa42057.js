(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{739:function(e,a,t){"use strict";t.r(a);var o=t(1),l=Object(o.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"migration-introduce-a-leaderboard-after-production"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#migration-introduce-a-leaderboard-after-production"}},[e._v("#")]),e._v(" Migration - Introduce a Leaderboard After Production")]),e._v(" "),t("HighlightBox",{attrs:{type:"prerequisite"}},[t("p",[e._v("Make sure you have all you need before proceeding:")]),e._v(" "),t("ul",[t("li",[e._v("You understand the concepts of "),t("RouterLink",{attrs:{to:"/academy/2-main-concepts/protobuf.html"}},[e._v("Protobuf")]),e._v(" and "),t("RouterLink",{attrs:{to:"/academy/2-main-concepts/migrations.html"}},[e._v("migrations")]),e._v(".")],1),e._v(" "),t("li",[e._v("Go is installed.")]),e._v(" "),t("li",[e._v("You have the checkers blockchain codebase up to the wager denomination. If not, follow the "),t("RouterLink",{attrs:{to:"/academy/3-my-own-chain/wager-denom.html"}},[e._v("previous steps")]),e._v(" or check out the "),t("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/tree/v1-wager-denomination",target:"_blank",rel:"noopener noreferrer"}},[e._v("relevant version"),t("OutboundLink")],1),e._v(".")],1)])]),e._v(" "),t("HighlightBox",{attrs:{type:"learning"}},[t("p",[e._v("In this section, you will:")]),e._v(" "),t("ul",[t("li",[e._v("Add a leaderboard.")]),e._v(" "),t("li",[e._v("Upgrade your blockchain in production.")]),e._v(" "),t("li",[e._v("Deal with data migrations and logic upgrades.")])])]),e._v(" "),t("p",[e._v("If you have been running "),t("em",[e._v("v1")]),e._v(" of your checkers blockchain for a while, games have been created, played on, won, and lost. In this section you will introduce "),t("em",[e._v("v2")]),e._v(" of your blockchain with leaderboard support. A good leaderboard fulfills these conditions:")]),e._v(" "),t("ul",[t("li",[e._v("Any player who has "),t("strong",[e._v("ever")]),e._v(" played should have a tally of games won, lost, and forfeited.")]),e._v(" "),t("li",[e._v("The leaderboard should list the players with the most wins up to a pre-determined number. For example, the leaderboard could only include the top 100 scores.")]),e._v(" "),t("li",[e._v("To avoid squatting and increase engagement, when equal in value the most recent score takes precedence over an "),t("em",[e._v("older")]),e._v(" one, so the player with the recent score is listed higher on the leaderboard.")])]),e._v(" "),t("p",[e._v("When you introduce the leaderboard, you also have to decide what to do with your existing players and their scores from your v1 checkers blockchain.")]),e._v(" "),t("p",[e._v("Start your v2's leaderboard as if all played past games had been counted for the leaderboard. You "),t("em",[e._v("only")]),e._v(" need to go through all played games, update the players with their tallies, and add a leaderboard including the information. This is possible because all past games and their outcomes are kept in the chain's state. Migration is a good method to tackle the initial leaderboard.")]),e._v(" "),t("h2",{attrs:{id:"introducing-a-leaderboard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#introducing-a-leaderboard"}},[e._v("#")]),e._v(" Introducing a leaderboard")]),e._v(" "),t("p",[e._v("Several things need to be addressed before you can focus all your attention on the migration:")]),e._v(" "),t("ol",[t("li",[e._v("Save and mark as v1 the current data types about to be modified with the new version. Data types which will remain unmodified need not be identified as such.")]),e._v(" "),t("li",[e._v("Prepare your v2 blockchain:\n"),t("ol",[t("li",[e._v("Define your new data types.")]),e._v(" "),t("li",[e._v("Add helper functions to encapsulate clearly defined actions, like leaderboard sorting.")]),e._v(" "),t("li",[e._v("Adjust the existing code to make use of and update the new data types.")])])]),e._v(" "),t("li",[e._v("Prepare for your v1-to-v2 migration:\n"),t("ol",[t("li",[e._v("Add helper functions to take large amounts of data from the latest chain state under the shape of a v1 genesis.")]),e._v(" "),t("li",[e._v("Add a function to migrate from v1 to v2 genesis.")]),e._v(" "),t("li",[e._v("Make sure you can handle large amounts of data.")])])])]),e._v(" "),t("p",[t("em",[e._v("Why do you need to make sure you can handle large amounts of data?")]),e._v(" The full state at the point of migration will be passed in the form of a gigantic v1 genesis when your migration function is called. You do not want your process to grind to a halt because of a lack of memory.")]),e._v(" "),t("h2",{attrs:{id:"save-your-v1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#save-your-v1"}},[e._v("#")]),e._v(" Save your v1")]),e._v(" "),t("p",[e._v("Your migration steps will be handled in a new folder, "),t("code",[e._v("x/checkers/migrations/v1tov2")]),e._v(", which needs to be created:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBta2RpciAtcCB4L2NoZWNrZXJzL21pZ3JhdGlvbnMvdjF0b3YyCg=="}}),e._v(" "),t("p",[e._v("The only "),t("strong",[e._v("data structure")]),e._v(" you will eventually change is the genesis structure. The other data structures are new, so you can treat them "),t("em",[e._v("as usual")]),e._v(". Copy and paste your v1 genesis from the current commit and save it under another name in "),t("code",[e._v("v1tov2/types.go")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBHZW5lc2lzU3RhdGVWMSBzdHJ1Y3QgewogICAgU3RvcmVkR2FtZUxpc3QgW10qdHlwZXMuU3RvcmVkR2FtZSBgcHJvdG9idWY6JnF1b3Q7Ynl0ZXMsMixyZXAsbmFtZT1zdG9yZWRHYW1lTGlzdCxwcm90bzMmcXVvdDsganNvbjomcXVvdDtzdG9yZWRHYW1lTGlzdCxvbWl0ZW1wdHkmcXVvdDtgCiAgICBOZXh0R2FtZSAgICAgICAqdHlwZXMuTmV4dEdhbWUgICAgIGBwcm90b2J1ZjomcXVvdDtieXRlcywxLG9wdCxuYW1lPW5leHRHYW1lLHByb3RvMyZxdW90OyBqc29uOiZxdW90O25leHRHYW1lLG9taXRlbXB0eSZxdW90O2AKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/types.go#L7-L10"}}),e._v(" "),t("p",[e._v("Your current genesis definition becomes your v2 genesis. This should be the only data structure requiring a change. However, if for example you also changed the structure of "),t("code",[e._v("StoredGame")]),e._v(", then you would have to save its v1 version in the same "),t("code",[e._v("types.go")]),e._v(" file.")]),e._v(" "),t("h2",{attrs:{id:"new-v2-information"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#new-v2-information"}},[e._v("#")]),e._v(" New v2 information")]),e._v(" "),t("p",[e._v("It is time to take a closer look at the new data structures being introduced with the version upgrade.")]),e._v(" "),t("HighlightBox",{attrs:{type:"tip"}},[t("p",[e._v("If you feel unsure about creating new data structures with Ignite CLI, look at the "),t("RouterLink",{attrs:{to:"/academy/3-my-own-chain/create-message.html"}},[e._v("previous sections")]),e._v(" of the exercise again.")],1)]),e._v(" "),t("p",[e._v("To give the new v2 information a data structure, you need the following:")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("Add a set of "),t("strong",[e._v("stats per player")]),e._v(": it makes sense to save one "),t("code",[e._v("struct")]),e._v(" for each player and map it by address. Remember that a game is stored at "),t("code",[e._v("StoredGame-value-123")]),e._v(", where "),t("code",[e._v("StoredGame-value-")]),e._v(" is a constant prefix. In a similar fashion, Ignite CLI creates a new constant to use as the prefix for players:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgc2NhZmZvbGQgbWFwIHBsYXllckluZm8gd29uQ291bnQ6dWludCBsb3N0Q291bnQ6dWludCBmb3JmZWl0ZWRDb3VudDp1aW50IC0tbW9kdWxlIGNoZWNrZXJzIC0tbm8tbWVzc2FnZQo="}}),e._v(" "),t("HighlightBox",{attrs:{type:"info"}},[t("p",[e._v("The new "),t("code",[e._v("PlayerInfo-value-")]),e._v(" prefix for players helps differentiate between the value for players and the value for games prefixed with "),t("code",[e._v("StoredGame-value-")]),e._v(". Now you can safely have both "),t("code",[e._v("StoredGame-value-123")]),e._v(" and "),t("code",[e._v("PlayerInfo-value-123")]),e._v(" side by side in storage.")])]),e._v(" "),t("p",[e._v("This creates a Protobuf file:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBQbGF5ZXJJbmZvIHsKICAgIHN0cmluZyBpbmRleCA9IDE7CiAgICB1aW50NjQgd29uQ291bnQgPSAyOwogICAgdWludDY0IGxvc3RDb3VudCA9IDM7CiAgICB1aW50NjQgZm9yZmVpdGVkQ291bnQgPSA0Owp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/proto/checkers/player_info.proto#L8-L13"}}),e._v(" "),t("p",[e._v("Remove "),t("code",[e._v("creator")]),e._v(" from the Protobuf file because it serves no purpose. Remember to add the new object to the genesis, effectively your v2 genesis:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"aW1wb3J0ICZxdW90O2NoZWNrZXJzL3BsYXllcl9pbmZvLnByb3RvJnF1b3Q7OwoKbWVzc2FnZSBHZW5lc2lzU3RhdGUgewogICAgLi4uCiAgICByZXBlYXRlZCBQbGF5ZXJJbmZvIHBsYXllckluZm9MaXN0ID0gMzsKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/proto/checkers/genesis.proto#L16"}})],1),e._v(" "),t("li",[t("p",[e._v("Add a "),t("strong",[e._v("leaderboard rung structure")]),e._v(" to be repeated inside the leaderboard: this stores the information of a player scoring high enough to be included in the leaderboard. It is not meant to be kept directly in storage as it is only a part of the leaderboard. Instead of involving Ignite CLI, create the structure by hand in its own file:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"bWVzc2FnZSBXaW5uaW5nUGxheWVyIHsKICAgIHN0cmluZyBwbGF5ZXJBZGRyZXNzID0gMTsKICAgIHVpbnQ2NCB3b25Db3VudCA9IDI7CiAgICBzdHJpbmcgZGF0ZUFkZGVkID0gMzsKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/proto/checkers/winning_player.proto#L8-L12"}}),e._v(" "),t("HighlightBox",{attrs:{type:"note"}},[t("ul",[t("li",[t("code",[e._v("playerAddress")]),e._v(" indicates the player, and gives information regarding "),t("code",[e._v("PlayerInfo.index")]),e._v(".")]),e._v(" "),t("li",[t("code",[e._v("wonCount")]),e._v(" determines the ranking on the leaderboard - the higher the count, the closer to the "),t("code",[e._v("0")]),e._v(" index in the array. This should exactly match the value found in the corresponding player stats. This duplication of data is a lesser evil, because if "),t("code",[e._v("wonCount")]),e._v(" was missing you would have to access the player stats to sort the leaderboard.")]),e._v(" "),t("li",[t("code",[e._v("dateAdded")]),e._v(" indicates when the player's "),t("code",[e._v("wonCount")]),e._v(" was last updated and determines the ranking when there is a tie in "),t("code",[e._v("wonCount")]),e._v(" - the more recent, the closer to the "),t("code",[e._v("0")]),e._v(" slot in the array.")])])])],1),e._v(" "),t("li",[t("p",[e._v("Add a structure for "),t("strong",[e._v("the leaderboard")]),e._v(": there is a single stored leaderboard for the whole application. Let Ignite CLI help you implement a structure:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"sh",base64:"JCBpZ25pdGUgc2NhZmZvbGQgc2luZ2xlIGxlYWRlcmJvYXJkIHdpbm5lcnMgLS1tb2R1bGUgY2hlY2tlcnMgLS1uby1tZXNzYWdlCg=="}}),e._v(" "),t("p",[e._v("This creates a Protobuf file that you update with your preferred type and its "),t("code",[e._v("import")]),e._v(". Again, remove the "),t("code",[e._v("creator")]),e._v(":")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"aW1wb3J0ICZxdW90O2NoZWNrZXJzL3dpbm5pbmdfcGxheWVyLnByb3RvJnF1b3Q7OwoKbWVzc2FnZSBMZWFkZXJib2FyZCB7CiAgICByZXBlYXRlZCBXaW5uaW5nUGxheWVyIHdpbm5lcnMgPSAxOwp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/proto/checkers/leaderboard.proto#L9-L11"}}),e._v(" "),t("p",[e._v("Now update the v2 genesis file by adding the leaderboard:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"protobuf",base64:"aW1wb3J0ICZxdW90O2NoZWNrZXJzL2xlYWRlcmJvYXJkLnByb3RvJnF1b3Q7OwoKbWVzc2FnZSBHZW5lc2lzU3RhdGUgewogICAgLi4uCiAgICBMZWFkZXJib2FyZCBsZWFkZXJib2FyZCA9IDQ7Cn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/proto/checkers/genesis.proto#L15"}}),e._v(" "),t("p",[e._v("Remember to make sure the initial value stored for the leaderboard is not "),t("code",[e._v("nil")]),e._v(" but instead is empty. In "),t("code",[e._v("genesis.go")]),e._v(" adjust:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBEZWZhdWx0R2VuZXNpcygpICpHZW5lc2lzU3RhdGUgewogICAgcmV0dXJuICZhbXA7R2VuZXNpc1N0YXRlewogICAgICAgIC4uLgogICAgICAgIExlYWRlcmJvYXJkOiAmYW1wO0xlYWRlcmJvYXJkewogICAgICAgICAgICBXaW5uZXJzOiBbXSpXaW5uaW5nUGxheWVye30sCiAgICAgICAgfSwKICAgIH0KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/genesis.go#L16-L18"}}),e._v(" "),t("p",[e._v('This function returns a default genesis. This step is important if you start fresh. In your case, you do not begin with an "empty" genesis but with one resulting from the upcoming genesis migration in this exercise.')])],1)]),e._v(" "),t("p",[e._v("With the structure set up it is time to add the code using these new elements in normal operations.")]),e._v(" "),t("h2",{attrs:{id:"v2-player-information-helpers"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v2-player-information-helpers"}},[e._v("#")]),e._v(" v2 player information helpers")]),e._v(" "),t("p",[e._v("When a game reaches its resolution, one of the "),t("code",[e._v("count")]),e._v("s needs to add "),t("code",[e._v("+1")]),e._v(".")]),e._v(" "),t("ExpansionPanel",{attrs:{title:"A detailed look into the code"}},[t("p",[e._v("To start, add a private helper function that gets the stats from the storage, updates the numbers as instructed, and saves it back:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBtdXN0QWRkRGVsdGFHYW1lUmVzdWx0VG9QbGF5ZXIoCiAgICBrICpLZWVwZXIsCiAgICBjdHggc2RrLkNvbnRleHQsCiAgICBwbGF5ZXIgc2RrLkFjY0FkZHJlc3MsCiAgICB3b25EZWx0YSB1aW50NjQsCiAgICBsb3N0RGVsdGEgdWludDY0LAogICAgZm9yZmVpdGVkRGVsdGEgdWludDY0LAopIChwbGF5ZXJJbmZvIHR5cGVzLlBsYXllckluZm8pIHsKICAgIHBsYXllckluZm8sIGZvdW5kIDo9IGsuR2V0UGxheWVySW5mbyhjdHgsIHBsYXllci5TdHJpbmcoKSkKICAgIGlmICFmb3VuZCB7CiAgICAgICAgcGxheWVySW5mbyA9IHR5cGVzLlBsYXllckluZm97CiAgICAgICAgICAgIEluZGV4OiAgICAgICAgICBwbGF5ZXIuU3RyaW5nKCksCiAgICAgICAgICAgIFdvbkNvdW50OiAgICAgICAwLAogICAgICAgICAgICBMb3N0Q291bnQ6ICAgICAgMCwKICAgICAgICAgICAgRm9yZmVpdGVkQ291bnQ6IDAsCiAgICAgICAgfQogICAgfQogICAgcGxheWVySW5mby5Xb25Db3VudCArPSB3b25EZWx0YQogICAgcGxheWVySW5mby5Mb3N0Q291bnQgKz0gbG9zdERlbHRhCiAgICBwbGF5ZXJJbmZvLkZvcmZlaXRlZENvdW50ICs9IGZvcmZlaXRlZERlbHRhCiAgICBrLlNldFBsYXllckluZm8oY3R4LCBwbGF5ZXJJbmZvKQogICAgcmV0dXJuIHBsYXllckluZm8KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/player_info_handler.go#L11-L33"}}),e._v(" "),t("p",[e._v("You can easily call this from these public one-liner functions added to the keeper:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBNdXN0QWRkV29uR2FtZVJlc3VsdFRvUGxheWVyKGN0eCBzZGsuQ29udGV4dCwgcGxheWVyIHNkay5BY2NBZGRyZXNzKSB0eXBlcy5QbGF5ZXJJbmZvIHsKICAgIHJldHVybiBtdXN0QWRkRGVsdGFHYW1lUmVzdWx0VG9QbGF5ZXIoaywgY3R4LCBwbGF5ZXIsIDEsIDAsIDApCn0KCmZ1bmMgKGsgKktlZXBlcikgTXVzdEFkZExvc3RHYW1lUmVzdWx0VG9QbGF5ZXIoY3R4IHNkay5Db250ZXh0LCBwbGF5ZXIgc2RrLkFjY0FkZHJlc3MpIHR5cGVzLlBsYXllckluZm8gewogICAgcmV0dXJuIG11c3RBZGREZWx0YUdhbWVSZXN1bHRUb1BsYXllcihrLCBjdHgsIHBsYXllciwgMCwgMSwgMCkKfQoKZnVuYyAoayAqS2VlcGVyKSBNdXN0QWRkRm9yZmVpdGVkR2FtZVJlc3VsdFRvUGxheWVyKGN0eCBzZGsuQ29udGV4dCwgcGxheWVyIHNkay5BY2NBZGRyZXNzKSB0eXBlcy5QbGF5ZXJJbmZvIHsKICAgIHJldHVybiBtdXN0QWRkRGVsdGFHYW1lUmVzdWx0VG9QbGF5ZXIoaywgY3R4LCBwbGF5ZXIsIDAsIDAsIDEpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/player_info_handler.go#L35-L45"}}),e._v(" "),t("p",[e._v("Which player should get "),t("code",[e._v("+1")]),e._v(", and on what count? You need to identify the loser and the winner of a game to determine this. Create another private helper:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBnZXRXaW5uZXJBbmRMb3NlckFkZHJlc3NlcyhzdG9yZWRHYW1lICp0eXBlcy5TdG9yZWRHYW1lKSAod2lubmVyQWRkcmVzcyBzZGsuQWNjQWRkcmVzcywgbG9zZXJBZGRyZXNzIHNkay5BY2NBZGRyZXNzKSB7CiAgICBpZiBzdG9yZWRHYW1lLldpbm5lciA9PSBydWxlcy5OT19QTEFZRVIuQ29sb3IgewogICAgICAgIHBhbmljKHR5cGVzLkVyclRoZXJlSXNOb1dpbm5lci5FcnJvcigpKQogICAgfQogICAgcmVkQWRkcmVzcywgZXJyIDo9IHN0b3JlZEdhbWUuR2V0UmVkQWRkcmVzcygpCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICBwYW5pYyhlcnIuRXJyb3IoKSkKICAgIH0KICAgIGJsYWNrQWRkcmVzcywgZXJyIDo9IHN0b3JlZEdhbWUuR2V0QmxhY2tBZGRyZXNzKCkKICAgIGlmIGVyciAhPSBuaWwgewogICAgICAgIHBhbmljKGVyci5FcnJvcigpKQogICAgfQogICAgaWYgc3RvcmVkR2FtZS5XaW5uZXIgPT0gcnVsZXMuUkVEX1BMQVlFUi5Db2xvciB7CiAgICAgICAgd2lubmVyQWRkcmVzcyA9IHJlZEFkZHJlc3MKICAgICAgICBsb3NlckFkZHJlc3MgPSBibGFja0FkZHJlc3MKICAgIH0gZWxzZSBpZiBzdG9yZWRHYW1lLldpbm5lciA9PSBydWxlcy5CTEFDS19QTEFZRVIuQ29sb3IgewogICAgICAgIHdpbm5lckFkZHJlc3MgPSBibGFja0FkZHJlc3MKICAgICAgICBsb3NlckFkZHJlc3MgPSByZWRBZGRyZXNzCiAgICB9IGVsc2UgewogICAgICAgIHBhbmljKGZtdC5TcHJpbnRmKHR5cGVzLkVycldpbm5lck5vdFBhcnNlYWJsZS5FcnJvcigpLCBzdG9yZWRHYW1lLldpbm5lcikpCiAgICB9CiAgICByZXR1cm4gd2lubmVyQWRkcmVzcywgbG9zZXJBZGRyZXNzCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/player_info_handler.go#L47-L69"}}),e._v(" "),t("p",[e._v("You can call this from these public helper functions added to the keeper:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBNdXN0UmVnaXN0ZXJQbGF5ZXJXaW4oY3R4IHNkay5Db250ZXh0LCBzdG9yZWRHYW1lICp0eXBlcy5TdG9yZWRHYW1lKSAod2lubmVySW5mbyB0eXBlcy5QbGF5ZXJJbmZvLCBsb3NlckluZm8gdHlwZXMuUGxheWVySW5mbykgewogICAgd2lubmVyQWRkcmVzcywgbG9zZXJBZGRyZXNzIDo9IGdldFdpbm5lckFuZExvc2VyQWRkcmVzc2VzKHN0b3JlZEdhbWUpCiAgICByZXR1cm4gay5NdXN0QWRkV29uR2FtZVJlc3VsdFRvUGxheWVyKGN0eCwgd2lubmVyQWRkcmVzcyksCiAgICAgICAgay5NdXN0QWRkTG9zdEdhbWVSZXN1bHRUb1BsYXllcihjdHgsIGxvc2VyQWRkcmVzcykKfQoKZnVuYyAoayAqS2VlcGVyKSBNdXN0UmVnaXN0ZXJQbGF5ZXJGb3JmZWl0KGN0eCBzZGsuQ29udGV4dCwgc3RvcmVkR2FtZSAqdHlwZXMuU3RvcmVkR2FtZSkgKHdpbm5lckluZm8gdHlwZXMuUGxheWVySW5mbywgZm9yZmVpdGVySW5mbyB0eXBlcy5QbGF5ZXJJbmZvKSB7CiAgICB3aW5uZXJBZGRyZXNzLCBsb3NlckFkZHJlc3MgOj0gZ2V0V2lubmVyQW5kTG9zZXJBZGRyZXNzZXMoc3RvcmVkR2FtZSkKICAgIHJldHVybiBrLk11c3RBZGRXb25HYW1lUmVzdWx0VG9QbGF5ZXIoY3R4LCB3aW5uZXJBZGRyZXNzKSwKICAgICAgICBrLk11c3RBZGRGb3JmZWl0ZWRHYW1lUmVzdWx0VG9QbGF5ZXIoY3R4LCBsb3NlckFkZHJlc3MpCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/player_info_handler.go#L71-L81"}}),e._v(" "),t("HighlightBox",{attrs:{type:"note"}},[t("p",[e._v("Be aware of the two new error types "),t("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/errors.go#L31",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("ErrThereIsNoWinner")]),t("OutboundLink")],1),e._v(" and "),t("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/errors.go#L30",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("ErrWinnerNotParseable")]),t("OutboundLink")],1),e._v(".")])])],1),e._v(" "),t("h2",{attrs:{id:"v2-player-information-handling"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v2-player-information-handling"}},[e._v("#")]),e._v(" v2 player information handling")]),e._v(" "),t("p",[e._v("Now call your helper functions:")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("On a win:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCmlmIHN0b3JlZEdhbWUuV2lubmVyID09IHJ1bGVzLk5PX1BMQVlFUi5Db2xvciB7CiAgICAuLi4KfSBlbHNlIHsKICAgIC4uLgogICAgay5LZWVwZXIuTXVzdFBheVdpbm5pbmdzKGN0eCwgJmFtcDtzdG9yZWRHYW1lKQogICAgay5LZWVwZXIuTXVzdFJlZ2lzdGVyUGxheWVyV2luKGN0eCwgJmFtcDtzdG9yZWRHYW1lKQp9Ci4uLgo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/b7001370e1cdfe9fc7c40e7144122cf1d18c6ee8/x/checkers/keeper/msg_server_play_move.go#L82"}})],1),e._v(" "),t("li",[t("p",[e._v("On a forfeit:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Li4uCmlmIHN0b3JlZEdhbWUuTW92ZUNvdW50ICZsdDs9IDEgewogICAgLi4uCn0gZWxzZSB7CiAgICBrLk11c3RQYXlXaW5uaW5ncyhjdHgsICZhbXA7c3RvcmVkR2FtZSkKICAgIGsuTXVzdFJlZ2lzdGVyUGxheWVyRm9yZmVpdChjdHgsICZhbXA7c3RvcmVkR2FtZSkKfQouLi4K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/b7001370e1cdfe9fc7c40e7144122cf1d18c6ee8/x/checkers/keeper/end_block_server_game.go#L58"}})],1)]),e._v(" "),t("h2",{attrs:{id:"v2-leaderboard-helpers"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v2-leaderboard-helpers"}},[e._v("#")]),e._v(" v2 leaderboard helpers")]),e._v(" "),t("p",[e._v("Continue completing your v2 before tackling the migration. Your leaderboard helpers should:")]),e._v(" "),t("ol",[t("li",[e._v("Add a new candidate to your array.")]),e._v(" "),t("li",[e._v("Sort the array according to the rules.")]),e._v(" "),t("li",[e._v("Clip the array to a length of 100 and save the result.")])]),e._v(" "),t("p",[e._v("Sorting entails comparing dates in cases of a score tie. This is potentially expensive if you are deserializing the date in the comparator itself. Instead, the comparator should be presented with data already deserialized. Prepare a data structure that has already deserialized the "),t("code",[e._v("dateAdded")]),e._v(", which allows you to:")]),e._v(" "),t("ol",[t("li",[e._v("Deserialize all the elements of the whole leaderboard's array.")]),e._v(" "),t("li",[e._v("Sort its elements.")]),e._v(" "),t("li",[e._v("Only then reserialize its elements.")])]),e._v(" "),t("p",[e._v("You do not need to use this deserialized element type anywhere else, therefore you should keep it private. Create a new file "),t("code",[e._v("full_leaderboard.go")]),e._v(" to encapsulate all your leaderboard helpers:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSB3aW5uaW5nUGxheWVyUGFyc2VkIHN0cnVjdCB7CiAgICBQbGF5ZXJBZGRyZXNzIHN0cmluZwogICAgV29uQ291bnQgICAgICB1aW50NjQKICAgIERhdGVBZGRlZCAgICAgdGltZS5UaW1lCn0K",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L11-L15"}}),e._v(" "),t("ExpansionPanel",{attrs:{title:"How is dateAdded serialized?"}},[t("p",[e._v("You can reuse the "),t("RouterLink",{attrs:{to:"/academy/3-my-own-chain/game-deadline.html"}},[e._v("date format used for the deadline")]),e._v(":")],1),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgKAogICAgRGF0ZUFkZGVkTGF5b3V0ID0gRGVhZGxpbmVMYXlvdXQKKQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/keys.go#L50"}}),e._v(" "),t("p",[e._v("Add similar functions to it, as you did when adding a deadline:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAod2lubmluZ1BsYXllciAqV2lubmluZ1BsYXllcikgR2V0RGF0ZUFkZGVkQXNUaW1lKCkgKGRhdGVBZGRlZCB0aW1lLlRpbWUsIGVyciBlcnJvcikgewogICAgZGF0ZUFkZGVkLCBlcnJEYXRlQWRkZWQgOj0gdGltZS5QYXJzZShEYXRlQWRkZWRMYXlvdXQsIHdpbm5pbmdQbGF5ZXIuRGF0ZUFkZGVkKQogICAgcmV0dXJuIGRhdGVBZGRlZCwgc2RrZXJyb3JzLldyYXBmKGVyckRhdGVBZGRlZCwgRXJySW52YWxpZERhdGVBZGRlZC5FcnJvcigpLCB3aW5uaW5nUGxheWVyLkRhdGVBZGRlZCkKfQoKZnVuYyBHZXREYXRlQWRkZWQoY3R4IHNkay5Db250ZXh0KSB0aW1lLlRpbWUgewogICAgcmV0dXJuIGN0eC5CbG9ja1RpbWUoKQp9CgpmdW5jIEZvcm1hdERhdGVBZGRlZChkYXRlQWRkZWQgdGltZS5UaW1lKSBzdHJpbmcgewogICAgcmV0dXJuIGRhdGVBZGRlZC5VVEMoKS5Gb3JtYXQoRGF0ZUFkZGVkTGF5b3V0KQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L17-L28"}})],1),e._v(" "),t("ExpansionPanel",{attrs:{title:"Add functions to (de)serialize winningPlayerParsed"}},[t("p",[e._v("Create the methods:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAod2lubmluZ1BsYXllciAqV2lubmluZ1BsYXllcikgcGFyc2UoKSAocGFyc2VkICp3aW5uaW5nUGxheWVyUGFyc2VkLCBlcnIgZXJyb3IpIHsKICAgIGRhdGVBZGRlZCwgZXJyIDo9IHdpbm5pbmdQbGF5ZXIuR2V0RGF0ZUFkZGVkQXNUaW1lKCkKICAgIGlmIGVyciAhPSBuaWwgewogICAgICAgIHJldHVybiBuaWwsIGVycgogICAgfQogICAgcmV0dXJuICZhbXA7d2lubmluZ1BsYXllclBhcnNlZHsKICAgICAgICBQbGF5ZXJBZGRyZXNzOiB3aW5uaW5nUGxheWVyLlBsYXllckFkZHJlc3MsCiAgICAgICAgV29uQ291bnQ6ICAgICAgd2lubmluZ1BsYXllci5Xb25Db3VudCwKICAgICAgICBEYXRlQWRkZWQ6ICAgICBkYXRlQWRkZWQsCiAgICB9LCBuaWwKfQoKZnVuYyAocGFyc2VkICp3aW5uaW5nUGxheWVyUGFyc2VkKSBzdHJpbmdpZnkoKSAoc3RyaW5naWZpZWQgKldpbm5pbmdQbGF5ZXIpIHsKICAgIHJldHVybiAmYW1wO1dpbm5pbmdQbGF5ZXJ7CiAgICAgICAgUGxheWVyQWRkcmVzczogcGFyc2VkLlBsYXllckFkZHJlc3MsCiAgICAgICAgV29uQ291bnQ6ICAgICAgcGFyc2VkLldvbkNvdW50LAogICAgICAgIERhdGVBZGRlZDogICAgIEZvcm1hdERhdGVBZGRlZChwYXJzZWQuRGF0ZUFkZGVkKSwKICAgIH0KfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L30-L48"}}),e._v(" "),t("p",[e._v("The functions are called repeatedly when serializing or deserializing arrays:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAobGVhZGVyYm9hcmQgKkxlYWRlcmJvYXJkKSBwYXJzZVdpbm5lcnMoKSAod2lubmVycyBbXSp3aW5uaW5nUGxheWVyUGFyc2VkLCBlcnIgZXJyb3IpIHsKICAgIHdpbm5lcnMgPSBtYWtlKFtdKndpbm5pbmdQbGF5ZXJQYXJzZWQsIGxlbihsZWFkZXJib2FyZC5XaW5uZXJzKSkKICAgIHZhciBwYXJzZWQgKndpbm5pbmdQbGF5ZXJQYXJzZWQKICAgIGZvciBpbmRleCwgd2lubmluZ1BsYXllciA6PSByYW5nZSBsZWFkZXJib2FyZC5XaW5uZXJzIHsKICAgICAgICBwYXJzZWQsIGVyciA9IHdpbm5pbmdQbGF5ZXIucGFyc2UoKQogICAgICAgIGlmIGVyciAhPSBuaWwgewogICAgICAgICAgICByZXR1cm4gbmlsLCBlcnIKICAgICAgICB9CiAgICAgICAgd2lubmVyc1tpbmRleF0gPSBwYXJzZWQKICAgIH0KICAgIHJldHVybiB3aW5uZXJzLCBuaWwKfQoKZnVuYyBzdHJpbmdpZnlXaW5uZXJzKHdpbm5lcnMgW10qd2lubmluZ1BsYXllclBhcnNlZCkgKHN0cmluZ2lmaWVkIFtdKldpbm5pbmdQbGF5ZXIpIHsKICAgIHN0cmluZ2lmaWVkID0gbWFrZShbXSpXaW5uaW5nUGxheWVyLCBsZW4od2lubmVycykpCiAgICBmb3IgaW5kZXgsIHdpbm5lciA6PSByYW5nZSB3aW5uZXJzIHsKICAgICAgICBzdHJpbmdpZmllZFtpbmRleF0gPSB3aW5uZXIuc3RyaW5naWZ5KCkKICAgIH0KICAgIHJldHVybiBzdHJpbmdpZmllZAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L50-L69"}})],1),e._v(" "),t("p",[e._v("As you have a function to get an array of deserialized winning players, you can now add a function to sort the slice in place:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBzb3J0V2lubmVycyh3aW5uZXJzIFtdKndpbm5pbmdQbGF5ZXJQYXJzZWQpIHsKICAgIHNvcnQuU2xpY2VTdGFibGUod2lubmVyc1s6XSwgZnVuYyhpLCBqIGludCkgYm9vbCB7CiAgICAgICAgaWYgd2lubmVyc1tpXS5Xb25Db3VudCAmZ3Q7IHdpbm5lcnNbal0uV29uQ291bnQgewogICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgICBpZiB3aW5uZXJzW2ldLldvbkNvdW50ICZsdDsgd2lubmVyc1tqXS5Xb25Db3VudCB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgICByZXR1cm4gd2lubmVyc1tpXS5EYXRlQWRkZWQuQWZ0ZXIod2lubmVyc1tqXS5EYXRlQWRkZWQpCiAgICB9KQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L73-L83"}}),e._v(" "),t("p",[e._v("Test in descending order first for scores and then for the added dates. Note that there is no deserialization in this "),t("code",[e._v("func(i, j int) bool")]),e._v(" callback. It is possible to write a one-liner inside this function but at the expense of readability.")]),e._v(" "),t("ExpansionPanel",{attrs:{title:"Add a function to add a candidate and sort"}},[t("p",[e._v("When migrating the genesis more than one candidate will be added. Therefore, first add a helper on the deserialized elements:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBBZGRQYXJzZWRDYW5kaWRhdGVzQW5kU29ydChwYXJzZWRXaW5uZXJzIFtdKndpbm5pbmdQbGF5ZXJQYXJzZWQsIGNhbmRpZGF0ZXMgW10qd2lubmluZ1BsYXllclBhcnNlZCkgKHVwZGF0ZWQgW10qd2lubmluZ1BsYXllclBhcnNlZCkgewogICAgdXBkYXRlZCA9IGFwcGVuZChwYXJzZWRXaW5uZXJzLCBjYW5kaWRhdGVzLi4uKQogICAgc29ydFdpbm5lcnModXBkYXRlZCkKICAgIGlmIExlYWRlcmJvYXJkV2lubmVyTGVuZ3RoICZsdDsgbGVuKHVwZGF0ZWQpIHsKICAgICAgICB1cGRhdGVkID0gdXBkYXRlZFs6TGVhZGVyYm9hcmRXaW5uZXJMZW5ndGhdCiAgICB9CiAgICByZXR1cm4gdXBkYXRlZAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L85-L92"}}),e._v(" "),t("p",[e._v("Note the clipping at the leaderboard's length. Similarly, you need helpers on the leaderboard.\n"),t("br"),t("br"),e._v("\nYou can get these other helpers with a deserialization:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAobGVhZGVyYm9hcmQgKkxlYWRlcmJvYXJkKSBBZGRDYW5kaWRhdGVzQW5kU29ydEF0Tm93KG5vdyB0aW1lLlRpbWUsIHBsYXllckluZm9zIFtdKlBsYXllckluZm8pIChlcnIgZXJyb3IpIHsKICAgIHBhcnNlZFdpbm5lcnMsIGVyciA6PSBsZWFkZXJib2FyZC5wYXJzZVdpbm5lcnMoKQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcmV0dXJuIGVycgogICAgfQogICAgcGFyc2VkUGxheWVycyA6PSBtYWtlKFtdKndpbm5pbmdQbGF5ZXJQYXJzZWQsIGxlbihwbGF5ZXJJbmZvcykpCiAgICBmb3IgaW5kZXgsIHBsYXllckluZm8gOj0gcmFuZ2UgcGxheWVySW5mb3MgewogICAgICAgIHBhcnNlZFBsYXllcnNbaW5kZXhdID0gJmFtcDt3aW5uaW5nUGxheWVyUGFyc2VkewogICAgICAgICAgICBQbGF5ZXJBZGRyZXNzOiBwbGF5ZXJJbmZvLkluZGV4LAogICAgICAgICAgICBXb25Db3VudDogICAgICBwbGF5ZXJJbmZvLldvbkNvdW50LAogICAgICAgICAgICBEYXRlQWRkZWQ6ICAgICBub3csCiAgICAgICAgfQogICAgfQogICAgcGFyc2VkV2lubmVycyA9IEFkZFBhcnNlZENhbmRpZGF0ZXNBbmRTb3J0KHBhcnNlZFdpbm5lcnMsIHBhcnNlZFBsYXllcnMpCiAgICBsZWFkZXJib2FyZC5XaW5uZXJzID0gc3RyaW5naWZ5V2lubmVycyhwYXJzZWRXaW5uZXJzKQogICAgcmV0dXJuIG5pbAp9CgpmdW5jIChsZWFkZXJib2FyZCAqTGVhZGVyYm9hcmQpIEFkZENhbmRpZGF0ZXNBbmRTb3J0KGN0eCBzZGsuQ29udGV4dCwgcGxheWVySW5mb3MgW10qUGxheWVySW5mbykgKGVyciBlcnJvcikgewogICAgcmV0dXJuIGxlYWRlcmJvYXJkLkFkZENhbmRpZGF0ZXNBbmRTb3J0QXROb3coR2V0RGF0ZUFkZGVkKGN0eCksIHBsYXllckluZm9zKQp9CgpmdW5jIChsZWFkZXJib2FyZCAqTGVhZGVyYm9hcmQpIEFkZENhbmRpZGF0ZUFuZFNvcnQoY3R4IHNkay5Db250ZXh0LCBwbGF5ZXJJbmZvIFBsYXllckluZm8pIChlcnIgZXJyb3IpIHsKICAgIHJldHVybiBsZWFkZXJib2FyZC5BZGRDYW5kaWRhdGVzQW5kU29ydChjdHgsIFtdKlBsYXllckluZm97JmFtcDtwbGF5ZXJJbmZvfSkKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/full_leaderboard.go#L94-L118"}}),e._v(" "),t("p",[e._v("This assumes that a candidate is added at the current block time or migration time. A candidate is not an existing winning player but a new one.")])],1),e._v(" "),t("h2",{attrs:{id:"v2-leaderboard-handling"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v2-leaderboard-handling"}},[e._v("#")]),e._v(" v2 leaderboard handling")]),e._v(" "),t("p",[e._v("You have created the leaderboard helper functions. In a separate file, add one last function to the keeper to implement the leaderboard. This function makes it possible to add a candidate winner and save the updated leaderboard:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoayAqS2VlcGVyKSBNdXN0QWRkVG9MZWFkZXJib2FyZChjdHggc2RrLkNvbnRleHQsIHdpbm5lckluZm8gdHlwZXMuUGxheWVySW5mbykgdHlwZXMuTGVhZGVyYm9hcmQgewogICAgbGVhZGVyYm9hcmQsIGZvdW5kIDo9IGsuR2V0TGVhZGVyYm9hcmQoY3R4KQogICAgaWYgIWZvdW5kIHsKICAgICAgICBwYW5pYygmcXVvdDtMZWFkZXJib2FyZCBub3QgZm91bmQmcXVvdDspCiAgICB9CiAgICBlcnIgOj0gbGVhZGVyYm9hcmQuQWRkQ2FuZGlkYXRlQW5kU29ydChjdHgsIHdpbm5lckluZm8pCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICBwYW5pYyhmbXQuU3ByaW50Zih0eXBlcy5FcnJDYW5ub3RBZGRUb0xlYWRlcmJvYXJkLkVycm9yKCksIGVyci5FcnJvcigpKSkKICAgIH0KICAgIGsuU2V0TGVhZGVyYm9hcmQoY3R4LCBsZWFkZXJib2FyZCkKICAgIHJldHVybiBsZWFkZXJib2FyZAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/leaderboard_handler.go#L10-L21"}}),e._v(" "),t("HighlightBox",{attrs:{type:"note"}},[t("p",[e._v("Be aware of the new error "),t("a",{attrs:{href:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/types/errors.go#L33",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("ErrCannotAddToLeaderboard")]),t("OutboundLink")],1),e._v(".")])]),e._v(" "),t("p",[e._v("This completes most of the leaderboard preparation. The only task left is to call your new functions at the right junctures:")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("On a win:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5XaW5uZXIgPT0gcnVsZXMuTk9fUExBWUVSLkNvbG9yIHsKICAgIC4uLgp9IGVsc2UgewogICAgLi4uCiAgICB3aW5uZXJJbmZvLCBfIDo9IGsuS2VlcGVyLk11c3RSZWdpc3RlclBsYXllcldpbihjdHgsICZhbXA7c3RvcmVkR2FtZSkKICAgIGsuS2VlcGVyLk11c3RBZGRUb0xlYWRlcmJvYXJkKGN0eCwgd2lubmVySW5mbykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/msg_server_play_move.go#L82-L83"}})],1),e._v(" "),t("li",[t("p",[e._v("On a forfeit:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"aWYgc3RvcmVkR2FtZS5Nb3ZlQ291bnQgJmx0Oz0gMSB7CiAgICAuLi4KfSBlbHNlIHsKICAgIC4uLgogICAgd2lubmVySW5mbywgXyA6PSBrLk11c3RSZWdpc3RlclBsYXllckZvcmZlaXQoY3R4LCAmYW1wO3N0b3JlZEdhbWUpCiAgICBrLk11c3RBZGRUb0xlYWRlcmJvYXJkKGN0eCwgd2lubmVySW5mbykKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/keeper/end_block_server_game.go#L58-L59"}})],1)]),e._v(" "),t("p",[e._v("Your leaderboard will now be updated and saved on an on-going basis as part of your v2 blockchain.")]),e._v(" "),t("h2",{attrs:{id:"v1-to-v2-player-information-migration-helper"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v1-to-v2-player-information-migration-helper"}},[e._v("#")]),e._v(" v1 to v2 player information migration helper")]),e._v(" "),t("p",[e._v("With your v2 blockchain now fully operational, it is time to work on the issue of data migration.")]),e._v(" "),t("p",[e._v("First tackle the migration of player information. You will receive a giant "),t("em",[e._v("v1")]),e._v(" genesis when migrating which contains all the games played so far. You must go through them all and build the "),t("code",[e._v("PlayerInfoList")]),e._v(" part of the "),t("em",[e._v("v2")]),e._v(" genesis.")]),e._v(" "),t("p",[e._v("You need to apply "),t("code",[e._v("+1")]),e._v(" to the relevant player stats as you go through games. For performance reasons pick a "),t("code",[e._v("map[string]*types.PlayerInfo")]),e._v(" data type so that you can call up a player's stats by its ID in "),t("code",[e._v("O(1)")]),e._v(".")]),e._v(" "),t("p",[e._v("Create a function that gets or creates a new "),t("code",[e._v("PlayerInfo")]),e._v(" in a new file:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBnZXRPck5ld1BsYXllckluZm8oaW5mb1NvRmFyICptYXBbc3RyaW5nXSp0eXBlcy5QbGF5ZXJJbmZvLCBwbGF5ZXJJbmRleCBzdHJpbmcpIChwbGF5ZXJJbmZvICp0eXBlcy5QbGF5ZXJJbmZvKSB7CiAgICBwbGF5ZXJJbmZvLCBmb3VuZCA6PSAoKmluZm9Tb0ZhcilbcGxheWVySW5kZXhdCiAgICBpZiAhZm91bmQgewogICAgICAgIHBsYXllckluZm8gPSAmYW1wO3R5cGVzLlBsYXllckluZm97CiAgICAgICAgICAgIEluZGV4OiAgICAgICAgICBwbGF5ZXJJbmRleCwKICAgICAgICAgICAgV29uQ291bnQ6ICAgICAgIDAsCiAgICAgICAgICAgIExvc3RDb3VudDogICAgICAwLAogICAgICAgICAgICBGb3JmZWl0ZWRDb3VudDogMCwKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcGxheWVySW5mbwp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/winning_players_builder.go#L9-L20"}}),e._v(" "),t("p",[e._v("Then create a function that does the incrementing in the "),t("code",[e._v("map")]),e._v(" in place:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBQb3B1bGF0ZVBsYXllckluZm9zV2l0aChpbmZvU29GYXIgKm1hcFtzdHJpbmddKnR5cGVzLlBsYXllckluZm8sIGdhbWVzICpbXSp0eXBlcy5TdG9yZWRHYW1lKSAoZXJyIGVycm9yKSB7CiAgICB2YXIgd2lubmVyQWRkcmVzcywgbG9zZXJBZGRyZXNzIHNkay5BY2NBZGRyZXNzCiAgICB2YXIgd2lubmVySW5kZXgsIGxvc2VySW5kZXggc3RyaW5nCiAgICB2YXIgd2lubmVySW5mbywgbG9zZXJJbmZvICp0eXBlcy5QbGF5ZXJJbmZvCiAgICBmb3IgXywgZ2FtZSA6PSByYW5nZSAqZ2FtZXMgewogICAgICAgIHdpbm5lckFkZHJlc3MsIGVyciA9IGdhbWUuR2V0UmVkQWRkcmVzcygpCiAgICAgICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgICAgIHJldHVybiBlcnIKICAgICAgICB9CiAgICAgICAgbG9zZXJBZGRyZXNzLCBlcnIgPSBnYW1lLkdldEJsYWNrQWRkcmVzcygpCiAgICAgICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgICAgIHJldHVybiBlcnIKICAgICAgICB9CiAgICAgICAgaWYgZ2FtZS5XaW5uZXIgPT0gcnVsZXMuUkVEX1BMQVlFUi5Db2xvciB7CiAgICAgICAgICAgIC8vIEFscmVhZHkgY29ycmVjdAogICAgICAgIH0gZWxzZSBpZiBnYW1lLldpbm5lciA9PSBydWxlcy5CTEFDS19QTEFZRVIuQ29sb3IgewogICAgICAgICAgICB3aW5uZXJBZGRyZXNzLCBsb3NlckFkZHJlc3MgPSBsb3NlckFkZHJlc3MsIHdpbm5lckFkZHJlc3MKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBHYW1lIGlzIHN0aWxsIHVucmVzb2x2ZWQuCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICAgIHdpbm5lckluZGV4ID0gd2lubmVyQWRkcmVzcy5TdHJpbmcoKQogICAgICAgIGxvc2VySW5kZXggPSBsb3NlckFkZHJlc3MuU3RyaW5nKCkKICAgICAgICB3aW5uZXJJbmZvID0gZ2V0T3JOZXdQbGF5ZXJJbmZvKGluZm9Tb0Zhciwgd2lubmVySW5kZXgpCiAgICAgICAgbG9zZXJJbmZvID0gZ2V0T3JOZXdQbGF5ZXJJbmZvKGluZm9Tb0ZhciwgbG9zZXJJbmRleCkKICAgICAgICB3aW5uZXJJbmZvLldvbkNvdW50ICs9IDEKICAgICAgICBsb3NlckluZm8uTG9zdENvdW50ICs9IDEKICAgICAgICAoKmluZm9Tb0Zhcilbd2lubmVySW5kZXhdID0gd2lubmVySW5mbwogICAgICAgICgqaW5mb1NvRmFyKVtsb3NlckluZGV4XSA9IGxvc2VySW5mbwogICAgfQogICAgcmV0dXJuIG5pbAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/winning_players_builder.go#L22-L53"}}),e._v(" "),t("p",[e._v("This uses a "),t("code",[e._v("map")]),e._v(" of "),t("code",[e._v("PlayerIno")]),e._v(" only for performance reasons. Because the v2 genesis takes a list and not a map, you need to do a conversion. Add a helper:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBQbGF5ZXJJbmZvTWFwVG9MaXN0KGFsbCAqbWFwW3N0cmluZ10qdHlwZXMuUGxheWVySW5mbykgW10qdHlwZXMuUGxheWVySW5mbyB7CiAgICBhc0xpc3QgOj0gbWFrZShbXSp0eXBlcy5QbGF5ZXJJbmZvLCAwLCBsZW4oKmFsbCkpCiAgICBmb3IgXywgcGxheWVySW5mbyA6PSByYW5nZSAqYWxsIHsKICAgICAgICBhc0xpc3QgPSBhcHBlbmQoYXNMaXN0LCBwbGF5ZXJJbmZvKQogICAgfQogICAgcmV0dXJuIGFzTGlzdAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/winning_players_builder.go#L55-L61"}}),e._v(" "),t("h2",{attrs:{id:"v1-to-v2-leaderboard-migration-helper"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v1-to-v2-leaderboard-migration-helper"}},[e._v("#")]),e._v(" v1 to v2 leaderboard migration helper")]),e._v(" "),t("p",[e._v("You could decide to build the leaderboard as the player stats list is being built, mimicking the regular operation of your v2 checkers blockchain. Unfortunately, that would entail a lot of array sorting for what are just intermediate player stats. Instead, build the v2 genesis leaderboard only after all player stats have been gathered.")]),e._v(" "),t("p",[e._v("In practice you add "),t("em",[e._v("k")]),e._v(" new "),t("code",[e._v("winningPlayerParsed")]),e._v(" to the array, sort it, clip it to 100, and repeat. What constitutes a good "),t("em",[e._v("k")]),e._v(" value should be dictated by testing and performance measurements. For now use 200. Prepare a new file to encapsulate these v1-to-v2-only operations:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Y29uc3QgKAogICAgLy8gQWRqdXN0IHRoaXMgbGVuZ3RoIHRvIG9idGFpbiB0aGUgYmVzdCBwZXJmb3JtYW5jZSBvdmVyIGEgbGFyZ2UgbWFwLgogICAgSW50ZXJtZWRpYXJ5UGxheWVyTGVuZ3RoID0gdHlwZXMuTGVhZGVyYm9hcmRXaW5uZXJMZW5ndGggKiAyCikK",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/leaderboard_builder.go#L9-L12"}}),e._v(" "),t("p",[e._v("If your leaderboard length is 100, you would add 200 candidates for a total of 300. To accommodate such intermediate additions and sorting you can also encapsulate this in:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBDcmVhdGVMZWFkZXJib2FyZEZvckdlbmVzaXMoKSAqdHlwZXMuTGVhZGVyYm9hcmQgewogICAgcmV0dXJuICZhbXA7dHlwZXMuTGVhZGVyYm9hcmR7CiAgICAgICAgV2lubmVyczogbWFrZShbXSp0eXBlcy5XaW5uaW5nUGxheWVyLCAwLCB0eXBlcy5MZWFkZXJib2FyZFdpbm5lckxlbmd0aCtJbnRlcm1lZGlhcnlQbGF5ZXJMZW5ndGgpLAogICAgfQp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/leaderboard_builder.go#L16-L20"}}),e._v(" "),t("p",[e._v("Now write the function that adds "),t("em",[e._v("k")]),e._v(" candidates, sorts that intermediate result, and clips it, before adding further candidates:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBQb3B1bGF0ZUxlYWRlcmJvYXJkV2l0aChsZWFkZXJib2FyZCAqdHlwZXMuTGVhZGVyYm9hcmQsIGFkZGl0aW9uYWxQbGF5ZXJzICptYXBbc3RyaW5nXSp0eXBlcy5QbGF5ZXJJbmZvLCBub3cgdGltZS5UaW1lKSAoZXJyIGVycm9yKSB7CiAgICBwYXJ0aWFsUGxheWVycyA6PSBtYWtlKFtdKnR5cGVzLlBsYXllckluZm8sIEludGVybWVkaWFyeVBsYXllckxlbmd0aCkKICAgIGZvciBfLCBwbGF5ZXJJbmZvIDo9IHJhbmdlICphZGRpdGlvbmFsUGxheWVycyB7CiAgICAgICAgcGFydGlhbFBsYXllcnMgPSBhcHBlbmQocGFydGlhbFBsYXllcnMsIHBsYXllckluZm8pCiAgICAgICAgaWYgbGVuKHBhcnRpYWxQbGF5ZXJzKSAmZ3Q7PSBjYXAocGFydGlhbFBsYXllcnMpIHsKICAgICAgICAgICAgbGVhZGVyYm9hcmQuQWRkQ2FuZGlkYXRlc0FuZFNvcnRBdE5vdyhub3csIHBhcnRpYWxQbGF5ZXJzKQogICAgICAgICAgICBwYXJ0aWFsUGxheWVycyA9IHBhcnRpYWxQbGF5ZXJzWzowXQogICAgICAgIH0KICAgIH0KICAgIGxlYWRlcmJvYXJkLkFkZENhbmRpZGF0ZXNBbmRTb3J0QXROb3cobm93LCBwYXJ0aWFsUGxheWVycykKICAgIHJldHVybiBuaWwKfQo=",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/leaderboard_builder.go#L22-L33"}}),e._v(" "),t("h2",{attrs:{id:"a-proper-v1-to-v2-migration"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a-proper-v1-to-v2-migration"}},[e._v("#")]),e._v(" A proper v1 to v2 migration")]),e._v(" "),t("p",[e._v("Now your full chain state migration comes down to a genesis conversion from "),t("code",[e._v("GenesisStateV1")]),e._v(" to your v2 "),t("code",[e._v("GenesisState")]),e._v(". You can write it in its own new file:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoZ2VuZXNpc1YxIEdlbmVzaXNTdGF0ZVYxKSBDb252ZXJ0KG5vdyB0aW1lLlRpbWUpIChnZW5lc2lzICp0eXBlcy5HZW5lc2lzU3RhdGUsIGVyciBlcnJvcikgewogICAgcGxheWVySW5mb3MgOj0gbWFrZShtYXBbc3RyaW5nXSp0eXBlcy5QbGF5ZXJJbmZvLCAxMDAwKQogICAgZXJyID0gUG9wdWxhdGVQbGF5ZXJJbmZvc1dpdGgoJmFtcDtwbGF5ZXJJbmZvcywgJmFtcDtnZW5lc2lzVjEuU3RvcmVkR2FtZUxpc3QpCiAgICBpZiBlcnIgIT0gbmlsIHsKICAgICAgICByZXR1cm4gbmlsLCBlcnIKICAgIH0KICAgIGxlYWRlcmJvYXJkIDo9IENyZWF0ZUxlYWRlcmJvYXJkRm9yR2VuZXNpcygpCiAgICBlcnIgPSBQb3B1bGF0ZUxlYWRlcmJvYXJkV2l0aChsZWFkZXJib2FyZCwgJmFtcDtwbGF5ZXJJbmZvcywgbm93KQogICAgaWYgZXJyICE9IG5pbCB7CiAgICAgICAgcmV0dXJuIG5pbCwgZXJyCiAgICB9CiAgICByZXR1cm4gJmFtcDt0eXBlcy5HZW5lc2lzU3RhdGV7CiAgICAgICAgTGVhZGVyYm9hcmQ6ICAgIGxlYWRlcmJvYXJkLAogICAgICAgIFBsYXllckluZm9MaXN0OiBQbGF5ZXJJbmZvTWFwVG9MaXN0KCZhbXA7cGxheWVySW5mb3MpLAogICAgICAgIFN0b3JlZEdhbWVMaXN0OiBnZW5lc2lzVjEuU3RvcmVkR2FtZUxpc3QsCiAgICAgICAgTmV4dEdhbWU6ICAgICAgIGdlbmVzaXNWMS5OZXh0R2FtZSwKICAgIH0sIG5pbAp9Cg==",url:"https://github.com/cosmos/b9-checkers-academy-draft/blob/ed8c76836d797af891414391f21d2f5b5f1eb6fa/x/checkers/migrations/v1tov2/genesis_converter.go#L9-L26"}}),e._v(" "),t("h2",{attrs:{id:"next-up"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#next-up"}},[e._v("#")]),e._v(" Next up")]),e._v(" "),t("p",[e._v("Your checkers blockchain is done! It has a leaderboard, which was introduced later in production thanks to migrations.")]),e._v(" "),t("p",[e._v("You no doubt have many ideas about how to improve it. In particular, you could implement the missing "),t("em",[e._v("draw")]),e._v(" mechanism, which in effect has to be accepted by both players.")]),e._v(" "),t("p",[e._v("It is time to move away from the checkers blockchain learning exercise, and explore another helpful tool for working with the Cosmos SDK: "),t("RouterLink",{attrs:{to:"/academy/3-my-own-chain/cosmwasm.html"}},[e._v("CosmWasm")]),e._v(".")],1)],1)}),[],!1,null,null,null);a.default=l.exports}}]);